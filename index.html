<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HCM WebGIS â€” Quy hoáº¡ch & Báº£n Ä‘á»“ hÃ nh chÃ­nh</title>

<!-- Leaflet core -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Esri Leaflet -->
<script src="https://unpkg.com/esri-leaflet@3.0.11/dist/esri-leaflet.js"></script>

<!-- GoogleMutant (Ä‘Ã£ fix link) -->
<script src="https://unpkg.com/leaflet.gridlayer.googlemutant@0.13.5/dist/Leaflet.GoogleMutant.js"></script>

<!-- Bing layer -->
<script src="https://unpkg.com/leaflet-bing-layer/leaflet-bing-layer.js"></script>

<!-- Locate control -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.css">
<script src="https://unpkg.com/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.js"></script>

<!-- Measure control -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-measure@3.3.0/dist/leaflet-measure.css">
<script src="https://unpkg.com/leaflet-measure@3.3.0/dist/leaflet-measure.min.js"></script>

<!-- Geoman (draw/edit) -->
<link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.14.1/dist/leaflet-geoman.css">
<script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.14.1/dist/leaflet-geoman.min.js"></script>

<!-- Compass -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-compass@1.5.1/dist/leaflet-compass.css" />
<script src="https://unpkg.com/leaflet-compass@1.5.1/dist/leaflet-compass.min.js"></script>

<!-- FileSaver -->
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
html, body, #map { height:100%; margin:0; }
.topbar{position:absolute;left:64px;top:10px;z-index:1000;display:flex;gap:8px;}
.btn{background:#1f6feb;color:#fff;border:none;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer;}
.btn.secondary{background:#6e7781;}
#searchBox{width:380px;background:#fff;border-radius:12px;padding:8px 12px;box-shadow:0 2px 10px rgba(0,0,0,.15);}
.layers-card{position:absolute;right:10px;top:10px;z-index:1000;background:#fff;border-radius:12px;padding:12px;}
.coords{position:absolute;left:10px;bottom:6px;z-index:900;background:#fff;padding:4px 8px;border-radius:8px;font-size:12px;}
</style>
</head>
<body>
<div id="map"></div>

<div class="topbar">
  <input id="searchBox" placeholder="Nháº­p Ä‘á»‹a chá»‰ hoáº·c tÃªn phÆ°á»ng..." />
  <button id="clearPaint" class="btn">ðŸ§¹ XÃ³a tÃ´ mÃ u</button>
  <button id="exportGeoJSON" class="btn secondary">ðŸ“¦ Xuáº¥t GeoJSON</button>
</div>

<div class="layers-card">
  <b>Basemap</b><br/>
  <label><input type="radio" name="base" value="osm" checked> OpenStreetMap</label><br/>
  <label><input type="radio" name="base" value="esriStreet"> Esri Street</label><br/>
  <label><input type="radio" name="base" value="esriImg"> Esri Imagery</label><br/>
  <label><input type="radio" name="base" value="gStreet"> Google Street</label><br/>
  <label><input type="radio" name="base" value="gHybrid"> Google Hybrid</label><br/>
  <label><input type="radio" name="base" value="bingRoad"> Bing Road</label>
</div>

<div class="coords" id="coords">Lat: â€”, Lng: â€”</div>

<script>
/* ====== MAP INIT ====== */
const map = L.map('map').setView([10.776, 106.700], 12);

// Base layers
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:20, attribution:'&copy; OpenStreetMap'
}).addTo(map);
const esriStreet = L.esri.basemapLayer('Streets');
const esriImg = L.esri.basemapLayer('Imagery');

// GoogleMutant layers
if (!L.gridLayer.googleMutant) {
  alert("âš ï¸ KhÃ´ng thá»ƒ táº£i GoogleMutant. Kiá»ƒm tra máº¡ng hoáº·c CDN!");
}
let gStreet = L.gridLayer.googleMutant({ type:'roadmap' });
let gHybrid = L.gridLayer.googleMutant({ type:'hybrid' });

// Bing
const bingRoad = L.tileLayer.bing({
  bingMapsKey:'YOUR_BING_API_KEY',
  imagerySet:'Road'
});

// Layer switcher
document.querySelectorAll('input[name="base"]').forEach(r=>{
  r.addEventListener('change',()=>{
    [osm,esriStreet,esriImg,gStreet,gHybrid,bingRoad].forEach(l=>{
      if(map.hasLayer(l)) map.removeLayer(l);
    });
    switch(r.value){
      case 'osm': osm.addTo(map); break;
      case 'esriStreet': esriStreet.addTo(map); break;
      case 'esriImg': esriImg.addTo(map); break;
      case 'gStreet': gStreet.addTo(map); break;
      case 'gHybrid': gHybrid.addTo(map); break;
      case 'bingRoad': bingRoad.addTo(map); break;
    }
  });
});

// Locate + Measure + Compass
L.control.locate({ position:'topleft', strings:{title:'Äá»‹nh vá»‹ GPS'} }).addTo(map);
L.control.measure({ primaryLengthUnit:'meters', primaryAreaUnit:'sqmeters' }).addTo(map);
L.control.compass({autoActive:true, position:'topright'}).addTo(map);

// Show coordinates
map.on('mousemove', e=>{
  document.getElementById('coords').textContent =
    `Lat: ${e.latlng.lat.toFixed(5)}, Lng: ${e.latlng.lng.toFixed(5)}`;
});

/* ====== GOOGLE PLACES AUTOCOMPLETE ====== */
function initGoogleAutocomplete(){
  const input = document.getElementById('searchBox');
  if(!window.google || !google.maps || !google.maps.places){
    console.warn('Google Places chÆ°a sáºµn sÃ ng â€” fallback Nominatim');
    enableNominatimSearch();
    return;
  }
  const autocomplete = new google.maps.places.Autocomplete(input,{ componentRestrictions:{ country:'vn' }});
  autocomplete.addListener('place_changed',()=>{
    const place = autocomplete.getPlace();
    if(place?.geometry?.location){
      const lat = place.geometry.location.lat();
      const lng = place.geometry.location.lng();
      map.setView([lat,lng],17);
      L.marker([lat,lng]).addTo(map);
    }
  });
}

// Fallback OSM search
function enableNominatimSearch(){
  const input = document.getElementById('searchBox');
  input.addEventListener('keydown', async (ev)=>{
    if(ev.key==='Enter'){
      const q = input.value.trim();
      if(!q) return;
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
      const data = await res.json();
      if(data[0]){
        const lat = +data[0].lat, lon = +data[0].lon;
        map.setView([lat,lon],17);
        L.marker([lat,lon]).addTo(map).bindPopup(data[0].display_name).openPopup();
      } else alert('KhÃ´ng tÃ¬m tháº¥y káº¿t quáº£.');
    }
  });
}

/* ====== EXPORT DEMO ====== */
document.getElementById('clearPaint').onclick = ()=>alert('Demo: XÃ³a tÃ´ mÃ u');
document.getElementById('exportGeoJSON').onclick = ()=>alert('Demo: Xuáº¥t GeoJSON');

/* ====== LOAD GOOGLE MAPS API ====== */
window.addEventListener('load',()=>{
  const s = document.createElement('script');
  s.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places";
  s.onload = initGoogleAutocomplete;
  document.body.appendChild(s);
});
</script>
</body>
</html>

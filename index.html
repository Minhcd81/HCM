<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>HCM WebGIS + Google & ƒê·ªãa gi·ªõi h√†nh ch√≠nh</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
<style>
  html, body, #map {height:100%; margin:0; padding:0;}
  .leaflet-control-layers {
    max-height: 250px;
    overflow-y: auto;
  }
</style>
</head>
<body>
<div id="map"></div>

<!-- JS LIBRARIES -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<!-- ‚úÖ Google Maps API -->
<script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places">
</script>

<!-- ‚úÖ GoogleMutant FIXED CDN with fallback -->
<script src="https://cdn.jsdelivr.net/gh/IvanSanchez/Leaflet.GridLayer.GoogleMutant@master/dist/Leaflet.GoogleMutant.js"
onerror="console.warn('‚ö†Ô∏è GoogleMutant CDN l·ªói, th·ª≠ fallback...'); 
fetch('https://unpkg.com/leaflet.gridlayer.googlemutant@0.13.6/dist/Leaflet.GoogleMutant.min.js')
.then(r=>r.text()).then(t=>eval(t));"></script>

<script>
// ======================= KH·ªûI T·∫†O B·∫¢N ƒê·ªí =========================
let map = L.map('map', {
  center: [10.776, 106.7],
  zoom: 12,
  zoomControl: true
});

// ======================= LAYER GOOGLE + OSM =======================
let gRoad, gSat, gHy;
try {
  gRoad = L.gridLayer.googleMutant({ type: 'roadmap' });
  gSat  = L.gridLayer.googleMutant({ type: 'satellite' });
  gHy   = L.gridLayer.googleMutant({ type: 'hybrid' });
} catch (err) {
  console.warn('‚ö†Ô∏è GoogleMutant ch∆∞a load, d√πng OSM fallback.');
  gRoad = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
  gSat  = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png');
  gHy   = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png');
}

let osmMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '&copy; OpenStreetMap'
});
let esriStreet = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
  attribution: '&copy; Esri Streets'
});
let esriImage = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: '&copy; Esri Imagery'
});
let bing = L.tileLayer('https://ecn.t{s}.tiles.virtualearth.net/tiles/a{q}.jpeg?g=1', {
  subdomains: ['0','1','2','3'], attribution: '&copy; Bing'
});

// Add default layer
osmMap.addTo(map);

// ======================= ƒê·ªäA GI·ªöI H√ÄNH CH√çNH =======================
let hcmLayer;
async function loadHCM() {
  try {
    const res = await fetch('assets/TPHCM.geojson');
    const data = await res.json();
    if (hcmLayer) map.removeLayer(hcmLayer);
    hcmLayer = L.geoJSON(data, {
      style: {color: "#ff0000", weight: 1.5, fillOpacity: 0.1},
      onEachFeature: function (feature, layer) {
        const info = feature.properties;
        layer.bindPopup(
          `<b>${info.ten_xa || ''}</b><br>` +
          `${info.sap_nhap || ''}<br>` +
          `${info.dtich_km2 ? info.dtich_km2 + ' km¬≤' : ''}<br>` +
          `${info.dan_so ? info.dan_so + ' ng∆∞·ªùi' : ''}`
        );
      }
    }).addTo(map);
  } catch (err) {
    alert("Kh√¥ng th·ªÉ t·∫£i file ƒë·ªãa gi·ªõi h√†nh ch√≠nh. Ki·ªÉm tra assets/TPHCM.geojson");
    console.error(err);
  }
}

// ======================= CONTROL SEARCH (Google Places) =======================
let input = L.DomUtil.create('input', 'search-box');
input.type = 'text';
input.placeholder = "üîç Nh·∫≠p ƒë·ªãa ch·ªâ (VD: 961 Ho√†ng Sa, Qu·∫≠n 3)";
input.style = 'position:absolute;top:10px;left:50px;width:360px;z-index:9999;padding:4px;';
document.body.appendChild(input);

let autocomplete;
setTimeout(() => {
  if (window.google && google.maps.places) {
    autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.addListener('place_changed', () => {
      const place = autocomplete.getPlace();
      if (!place.geometry) return;
      const lat = place.geometry.location.lat();
      const lng = place.geometry.location.lng();
      map.setView([lat, lng], 17);
      L.marker([lat, lng]).addTo(map)
        .bindPopup(`<b>${place.formatted_address}</b>`).openPopup();
    });
  } else {
    console.warn("‚ö†Ô∏è Google Places API ch∆∞a s·∫µn s√†ng.");
  }
}, 2000);

// ======================= CONTROL LAYER =======================
const baseMaps = {
  "üó∫Ô∏è Google ƒê∆∞·ªùng ph·ªë": gRoad,
  "üõ∞Ô∏è Google V·ªá tinh": gSat,
  "üåè Google Hybrid": gHy,
  "üåç OpenStreetMap": osmMap,
  "üó∫Ô∏è Esri Streets": esriStreet,
  "üõ∞Ô∏è Esri Image": esriImage,
  "üì∑ Bing Map": bing
};

const overlayMaps = {
  "ƒê·ªãa gi·ªõi HCM": L.layerGroup()
};

L.control.layers(baseMaps, overlayMaps).addTo(map);

// ======================= N√öT B·∫¨T/T·∫ÆT =======================
let panel = L.control({position: 'topright'});
panel.onAdd = function() {
  let div = L.DomUtil.create('div', 'leaflet-bar');
  div.innerHTML = `
    <button onclick="loadHCM()">üó∫Ô∏è N·∫°p ƒë·ªãa gi·ªõi</button><br>
    <button onclick="if(hcmLayer){map.removeLayer(hcmLayer)}">·∫®n ƒë·ªãa gi·ªõi</button>
  `;
  div.style.background = "#fff";
  div.style.padding = "5px";
  return div;
};
panel.addTo(map);

</script>
</body>
</html>

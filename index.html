<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>HCM WebGIS ‚Äì Quy ho·∫°ch & ƒê·ªãa gi·ªõi h√†nh ch√≠nh TP.HCM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet & plugins -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-compass/dist/leaflet-compass.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

<!-- Google Places Autocomplete -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places"></script>

<style>
  html, body, #map {height:100%; margin:0; padding:0;}
  .leaflet-bar button {display:block; width:100%; border:none; background:white; padding:6px 8px; cursor:pointer;}
  .leaflet-bar button:hover {background:#eee;}
  .coords {
    position:absolute; bottom:6px; left:10px;
    background:rgba(255,255,255,0.9); padding:4px 8px;
    border-radius:4px; font-size:12px; font-family:monospace; z-index:1000;
  }
  #search-box {
    position:absolute; top:10px; left:50%; transform:translateX(-50%);
    z-index:1500; width:340px;
  }
  #search-input {
    width:100%; padding:8px 10px; border-radius:6px; border:1px solid #999;
    box-shadow:0 2px 6px rgba(0,0,0,0.2); background:#fff;
  }
</style>
</head>
<body>
<div id="search-box"><input id="search-input" type="text" placeholder="üîç Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c t√™n ph∆∞·ªùng/qu·∫≠n..."></div>
<div id="map"></div>
<div id="coords" class="coords">Lat: --, Lng: --</div>

<!-- JS libs -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.js"></script>
<script src="https://unpkg.com/leaflet-compass/dist/leaflet-compass.min.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
window.onload = function() {
  // ===== Kh·ªüi t·∫°o b·∫£n ƒë·ªì
  const map = L.map('map', { center: [10.776,106.7], zoom: 12 });

  // ===== L·ªõp n·ªÅn
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
  const googleStreet = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA',{attribution:'¬© Google'});
  const googleHybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}&key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA',{attribution:'¬© Google'});
  const bingRoad = L.tileLayer('https://ecn.t{s}.tiles.virtualearth.net/tiles/r{q}.jpeg?g=1', {subdomains:['0','1','2','3'], attribution:'¬© Bing'});
  const bingAerial = L.tileLayer('https://ecn.t{s}.tiles.virtualearth.net/tiles/a{q}.jpeg?g=1', {subdomains:['0','1','2','3'], attribution:'¬© Bing'});
  const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'¬© Esri'});
  const esriBasemap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {attribution:'¬© Esri Basemap'});

  const baseMaps = {
    "üó∫Ô∏è OSM": osm,
    "üåç Google Street": googleStreet,
    "üõ∞Ô∏è Google Hybrid": googleHybrid,
    "üõ£Ô∏è Bing Road": bingRoad,
    "üåÑ Bing Aerial": bingAerial,
    "üå§Ô∏è Esri Imagery": esriImagery,
    "üß≠ Esri Basemap": esriBasemap
  };

  // ===== Nh√≥m l·ªõp
  const hanhChinhGroup = L.layerGroup();
  const quyHoachGroup  = L.layerGroup();
  const taiSanGroup    = L.layerGroup();

  // ===== H√†m t√¥ m√†u theo MaQuyUoc
  function colorByMaQuyUoc(code) {
    if (!code) return "#cccccc";
    const lut = {
      "ODT": "#e41a1c", // ƒê·∫•t ·ªü ƒë√¥ th·ªã
      "ONT": "#fb9a99", // ƒê·∫•t ·ªü n√¥ng th√¥n / h·ªón h·ª£p ·ªü
      "CX":  "#4daf4a", // C√¢y xanh
      "DGT": "#999999", // Giao th√¥ng
      "CC":  "#ffcc00", // C√¥ng c·ªông
      "MN":  "#6baed6", // M·∫∑t n∆∞·ªõc
      "HTKT":"#984ea3", // H·∫° t·∫ßng k·ªπ thu·∫≠t
      "TG":  "#fdb462"  // T√¥n gi√°o
    };
    for (const [k,v] of Object.entries(lut)) { if ((code||"").includes(k)) return v; }
    return "#ccc";
  }

  // ===== B·ªô nh·ªõ c√°c v√πng ƒë∆∞·ª£c t√¥ m√†u (l·ªõp H√†nh ch√≠nh)
  let colored = [];

  function highlightFeature(feature, layer){
    const palette = ["#FFD700","#FFA500","#1E90FF","#32CD32","#FF69B4","#7B68EE"];
    const fill = palette[Math.floor(Math.random()*palette.length)];
    layer.setStyle({ fillColor: fill, fillOpacity: 0.55 });
    colored.push({ feature, layer });
  }
  function clearColors(){
    colored.forEach(obj => obj.layer.setStyle({ fillOpacity: 0.05, fillColor: null }));
    colored = [];
  }
  function exportColoredGeoJSON(){
    if (colored.length === 0){ alert("Ch∆∞a c√≥ v√πng n√†o ƒë∆∞·ª£c t√¥ m√†u!"); return; }
    const geojson = { type:"FeatureCollection", features: colored.map(o => o.feature) };
    const blob = new Blob([JSON.stringify(geojson, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'vung_to_mau_hanh_chinh.geojson'; a.click();
    URL.revokeObjectURL(url);
  }

  // ===== L·ªõp H√ÄNH CH√çNH (TPHCM.geojson)
  fetch('assets/TPHCM.geojson')
    .then(r=>r.json())
    .then(data=>{
      const layer = L.geoJSON(data, {
        style:{ color:"#ff6600", weight:1, fillOpacity:0.05 },
        onEachFeature:(f,l)=>{
          const p=f.properties||{};
          const ten=p.ten_xa||'', quan=p.quan_huyen||'';
          const dt=p.dtich_km2!=null?`${(+p.dtich_km2).toFixed(2)} km¬≤`:"-";
          const ds=p.dan_so!=null?(+p.dan_so).toLocaleString()+" ng∆∞·ªùi":"-";
          const sap=p.sap_nhap?`<br><i>${p.sap_nhap}</i>`:"";
          l.bindPopup(`<b>${ten}</b><br>${quan}<br>${dt}<br>${ds}${sap}`);
          l.on('click', ()=> highlightFeature(f,l));
        }
      });
      hanhChinhGroup.addLayer(layer);
    })
    .catch(err=>console.warn("Kh√¥ng t·∫£i ƒë∆∞·ª£c TPHCM.geojson:", err));

  // ===== L·ªõp QUY HO·∫†CH 1/2000 (QHPKSDD_SHAPE.json)
  fetch('assets/QHPKSDD_SHAPE.json')
    .then(r=>r.json())
    .then(data=>{
      const layer = L.geoJSON(data, {
        style:f=>({
          color:"#555", weight:0.4,
          fillColor: colorByMaQuyUoc((f.properties||{}).MaQuyUoc || ""),
          fillOpacity: 0.6
        }),
        onEachFeature:(f,l)=>{
          const p=f.properties||{};
          const area=p.Shape_Area!=null ? Number(p.Shape_Area).toLocaleString()+" m¬≤" : "-";
          l.bindPopup(
            `<b>M√£ quy ∆∞·ªõc:</b> ${p.MaQuyUoc||''}<br>
             <b>Ch·ª©c nƒÉng:</b> ${p.ChucNang||''}<br>
             <b>M√£ √¥ ph·ªë:</b> ${p.MaOPho||''}<br>
             <b>Di·ªán t√≠ch:</b> ${area}`
          );
        }
      });
      quyHoachGroup.addLayer(layer);
    })
    .catch(err=>console.warn("Kh√¥ng t·∫£i ƒë∆∞·ª£c QHPKSDD_SHAPE.json:", err));

  // ===== L·ªõp T√ÄI S·∫¢N (tu·ª≥ ch·ªçn ‚Äì kh√¥ng c√≥ file c≈©ng kh√¥ng l·ªói)
  fetch('assets/tai_san.geojson')
    .then(r=> r.ok ? r.json() : Promise.reject("no assets"))
    .then(data=>{
      const iconTaiSan = L.icon({ iconUrl: 'assets/icon_home.png', iconSize:[26,26] });
      const layer = L.geoJSON(data, {
        pointToLayer:(f,latlng)=> L.marker(latlng, {icon: iconTaiSan}),
        onEachFeature:(f,l)=>{
          const name=f.properties?.name||'T√†i s·∫£n';
          const desc=f.properties?.description||'';
          l.bindPopup(`<b>${name}</b><br>${desc}`);
        }
      });
      taiSanGroup.addLayer(layer);
    })
    .catch(()=>{/* kh√¥ng c√≥ file t√†i s·∫£n c≈©ng OK */});

  // ===== C√¥ng c·ª•
  L.control.scale().addTo(map);
  L.control.locate({strings:{title:"ƒê·ªãnh v·ªã GPS"}}).addTo(map);
  let measureCtrl=null, compassCtrl=null;
  function toggleTools(){
    if(measureCtrl){ map.removeControl(measureCtrl); map.removeControl(compassCtrl); measureCtrl=null; compassCtrl=null; }
    else{
      measureCtrl=L.control.measure({primaryLengthUnit:'meters',secondaryLengthUnit:'kilometers',primaryAreaUnit:'sqmeters'}).addTo(map);
      compassCtrl=L.control.compass({autoActive:true,showDigit:true,position:'topright'}).addTo(map);
    }
  }

  // ===== T√¨m ki·∫øm ƒë·ªãa ch·ªâ (Google Places)
  const input=document.getElementById('search-input');
  const autocomplete=new google.maps.places.Autocomplete(input,{componentRestrictions:{country:"vn"},fields:["geometry","name","formatted_address"]});
  autocomplete.addListener("place_changed",()=>{
    const place=autocomplete.getPlace(); if(!place.geometry) return;
    const {lat,lng} = {lat: place.geometry.location.lat(), lng: place.geometry.location.lng()};
    map.setView([lat,lng],17);
    L.marker([lat,lng]).addTo(map).bindPopup(`<b>${place.name||''}</b><br>${place.formatted_address||''}`).openPopup();
  });

  // ===== T·ªça ƒë·ªô chu·ªôt
  const coordsDiv=document.getElementById('coords');
  map.on('mousemove',e=>coordsDiv.innerHTML=`Lat:${e.latlng.lat.toFixed(5)}, Lng:${e.latlng.lng.toFixed(5)}`);

  // ===== ƒêi·ªÅu khi·ªÉn l·ªõp
  const overlays = {
    "üóæ ƒê·ªãa gi·ªõi h√†nh ch√≠nh": hanhChinhGroup,
    "üìê Quy ho·∫°ch 1/2000":   quyHoachGroup,
    "üè† T√†i s·∫£n (My Maps)":  taiSanGroup
  };
  L.control.layers(baseMaps, overlays).addTo(map);

  // ===== Panel n√∫t nhanh
  const panel=L.control({position:'topright'});
  panel.onAdd=function(){
    const div=L.DomUtil.create('div','leaflet-bar');
    div.innerHTML=`
      <button onclick="window._toggleTools()">üîß C√¥ng c·ª•</button>
      <button onclick="window._clearColors()">üé® X√≥a t√¥ m√†u</button>
      <button onclick="window._exportColored()">üíæ Xu·∫•t GeoJSON</button>
    `;
    return div;
  };
  panel.addTo(map);
  window._toggleTools = toggleTools;
  window._clearColors = clearColors;
  window._exportColored = exportColoredGeoJSON;

  // ===== CH√ö GI·∫¢I M√ÄU (Legend) g√≥c ph·∫£i d∆∞·ªõi
  const legend=L.control({position:'bottomright'});
  legend.onAdd=function(){
    const div=L.DomUtil.create('div','info legend');
    const types={
      "ƒê·∫•t ·ªü (ODT/ONT)":"#e41a1c",
      "C√¢y xanh (CX)":"#4daf4a",
      "Giao th√¥ng (DGT)":"#999999",
      "C√¥ng c·ªông (CC)":"#ffcc00",
      "M·∫∑t n∆∞·ªõc (MN)":"#6baed6",
      "H·∫° t·∫ßng k·ªπ thu·∫≠t (HTKT)":"#984ea3",
      "T√¥n gi√°o (TG)":"#fdb462"
    };
    div.innerHTML="<b>Ch√∫ gi·∫£i lo·∫°i ƒë·∫•t</b><br>";
    for(const [name,color] of Object.entries(types)){
      div.innerHTML+=`<i style="background:${color};width:14px;height:14px;display:inline-block;margin-right:5px;"></i>${name}<br>`;
    }
    div.style.background="rgba(255,255,255,0.9)";
    div.style.padding="6px 8px";
    div.style.borderRadius="5px";
    div.style.lineHeight="18px";
    div.style.fontSize="12px";
    return div;
  };
  legend.addTo(map);
};
</script>
</body>
</html>

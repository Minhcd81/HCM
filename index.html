<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Vietnam WebGIS v15 — Full 34 Provinces (PropTechViet)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places,geometry"></script>
<style>
html,body,#map{height:100%;margin:0}
body{font-family:Roboto,Arial,Helvetica,sans-serif}
#map{z-index:1}
#sidebar{position:absolute;left:10px;top:10px;width:270px;background:#fff;padding:10px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.25);z-index:1000}
#sidebar select,#sidebar button{width:100%;margin-top:6px;padding:8px;border-radius:6px;border:1px solid #ccc}
#tools{position:absolute;right:10px;top:60px;z-index:1200;display:flex;flex-direction:column;gap:8px}
.toolbtn{background:#fff;border:1px solid #ccc;border-radius:50%;width:48px;height:48px;cursor:pointer;font-size:22px;text-align:center;line-height:48px;box-shadow:0 2px 8px rgba(0,0,0,.2)}
.toolbtn:hover{background:#eaf6ff}
.popup-street{width:320px;height:180px;border:0;border-radius:8px}
.leaflet-popup-content-wrapper{border-radius:10px}
</style>
</head>
<body>
<div id="sidebar">
<h3>PropTechViet WebGIS</h3>
<select id="provinceSelect"></select>
<button id="loadProvince">Tải tỉnh này</button>
<button id="toggleHeat">🔥 Bật/Tắt Heatmap</button>
<button id="locateTSBD">📍 Định vị TSBĐ</button>
</div>
<div id="tools">
<div class="toolbtn" id="btnMeasure" title="Đo khoảng cách">📏</div>
<div class="toolbtn" id="btnArea" title="Đo diện tích">📐</div>
<div class="toolbtn" id="btnStreet" title="StreetView">👁️</div>
<div class="toolbtn" id="btnCompass" title="La bàn">🧭</div>
</div>
<div id="map"></div>

<script>
// === DANH SÁCH 34 TỈNH/THÀNH CHUẨN ===
const PROVINCES=[
{name:'An Giang',slug:'angiang'},
{name:'Bắc Ninh',slug:'bacninh'},
{name:'Lâm Đồng',slug:'lamdong'},
{name:'Cà Mau',slug:'camau'},
{name:'Cần Thơ',slug:'cantho'},
{name:'Cao Bằng',slug:'caobang'},
{name:'Đà Nẵng',slug:'danang'},
{name:'Đắk Lắk',slug:'daklak'},
{name:'Điện Biên',slug:'dienbien'},
{name:'Đồng Nai',slug:'dongnai'},
{name:'Đồng Tháp',slug:'dongthap'},
{name:'Gia Lai',slug:'gialai'},
{name:'TP Hà Nội',slug:'hanoi'},
{name:'Hà Tĩnh',slug:'hatinh'},
{name:'Hải Phòng',slug:'haiphong'},
{name:'Hưng Yên',slug:'hungyen'},
{name:'Khánh Hòa',slug:'khanhhoa'},
{name:'Lai Châu',slug:'laichau'},
{name:'Lạng Sơn',slug:'langson'},
{name:'Lào Cai',slug:'laocai'},
{name:'Nghệ An',slug:'nghean'},
{name:'Ninh Bình',slug:'ninhbinh'},
{name:'Phú Thọ',slug:'phutho'},
{name:'Quảng Ngãi',slug:'quangngai'},
{name:'Quảng Ninh',slug:'quangninh'},
{name:'Quảng Trị',slug:'quangtri'},
{name:'Sơn La',slug:'sonla'},
{name:'Tây Ninh',slug:'tayninh'},
{name:'Thái Nguyên',slug:'thainguyen'},
{name:'Thanh Hóa',slug:'thanhhoa'},
{name:'TP Huế',slug:'hue'},
{name:'TP.HCM',slug:'hcm'},
{name:'Tuyên Quang',slug:'tuyenquang'},
{name:'Vĩnh Long',slug:'vinhlong'}
];

// === KHỞI TẠO MAP ===
let map=L.map('map',{center:[10.78,106.67],zoom:8});
let osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OSM'}).addTo(map);
let gHybrid=L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{attribution:'© Google'});
let gStreet=L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}');
let currentProvinceLayer,heatLayer,tsbdMarker;

// === TẠO DANH SÁCH TỈNH TRONG DROPDOWN ===
let sel=document.getElementById('provinceSelect');
PROVINCES.forEach(p=>{
 let opt=document.createElement('option');opt.value=p.slug;opt.textContent=p.name;sel.appendChild(opt);
});

// === LOAD GEOJSON CỦA 1 TỈNH ===
async function loadProvince(slug){
  if(currentProvinceLayer) map.removeLayer(currentProvinceLayer);
  try{
    const res=await fetch(`assets/${slug}.geojson`);
    const geo=await res.json();
    const color="#"+Math.floor(Math.random()*16777215).toString(16);
    currentProvinceLayer=L.geoJSON(geo,{
      style:{color:'#555',weight:1,fillColor:color,fillOpacity:.25},
      onEachFeature:(f,layer)=>{
        const p=f.properties||{};
        const ten=p.ten_xa||p.NAME_3||'';
        const qh=p.quan_huyen||p.NAME_2||'';
        const tinh=p.tinh||p.NAME_1||'';
        layer.bindPopup(`<b>${ten}</b><br>${qh}, ${tinh}`);
        layer.on('mouseover',()=>layer.setStyle({fillOpacity:.55}));
        layer.on('mouseout',()=>layer.setStyle({fillOpacity:.25}));
      }
    }).addTo(map);
    map.fitBounds(currentProvinceLayer.getBounds());
  }catch(e){alert("Không tải được dữ liệu tỉnh "+slug);}
}

// === NÚT LOAD ===
document.getElementById('loadProvince').onclick=()=>{loadProvince(sel.value);};

// === NÚT HEATMAP DEMO ===
document.getElementById('toggleHeat').onclick=()=>{
 if(heatLayer){map.removeLayer(heatLayer);heatLayer=null;return;}
 const pts=[];
 if(currentProvinceLayer){
  currentProvinceLayer.eachLayer(l=>{
    const c=l.getBounds().getCenter();
    pts.push([c.lat,c.lng,Math.random()*5]);
  });
 }
 heatLayer=L.heatLayer(pts,{radius:25,blur:15,maxZoom:12}).addTo(map);
};

// === ĐỊNH VỊ TSBĐ ===
document.getElementById('locateTSBD').onclick=()=>{
 map.locate({setView:true,maxZoom:16});
 map.on('locationfound',e=>{
  if(tsbdMarker) map.removeLayer(tsbdMarker);
  tsbdMarker=L.marker(e.latlng,{title:'TSBĐ',riseOnHover:true}).addTo(map);
  const lat=e.latlng.lat.toFixed(6),lng=e.latlng.lng.toFixed(6);
  tsbdMarker.bindPopup(`TSBĐ<br>Lat:${lat}<br>Lng:${lng}<br><button onclick="openStreet(${lat},${lng})">👁️ Street View</button>`).openPopup();
 });
};

// === STREET VIEW POPUP ===
function openStreet(lat,lng){
 const svUrl=`https://www.google.com/maps/embed?pb=!4v!6m8!1m7!1sCAoSLEFGMVFpcE9...!2m2!1d${lat}!2d${lng}!3f0!4f0!5f0.7820865974627469`;
 const html=`<iframe class="popup-street" src="https://www.google.com/maps?q=&layer=c&cbll=${lat},${lng}&cbp=11,0,0,0,0&z=18" allowfullscreen></iframe>`;
 L.popup().setLatLng([lat,lng]).setContent(html).openOn(map);
}

// === CÔNG CỤ ĐO KHOẢNG CÁCH & DIỆN TÍCH (đơn giản) ===
let measureLine=null;
document.getElementById('btnMeasure').onclick=()=>{
 map.once('click',e=>{
   if(measureLine){map.removeLayer(measureLine);}
   let start=e.latlng;
   map.on('mousemove',ev=>{
     if(measureLine) map.removeLayer(measureLine);
     measureLine=L.polyline([start,ev.latlng],{color:'#00BFFF'}).addTo(map);
     let dist=map.distance(start,ev.latlng).toFixed(1);
     measureLine.bindTooltip(dist+" m").openTooltip();
   });
   map.once('click',()=>{map.off('mousemove');});
 });
};

// === DIỆN TÍCH ===
document.getElementById('btnArea').onclick=()=>{
 let pts=[];let poly=null;
 map.on('click',e=>{
   pts.push(e.latlng);
   if(poly) map.removeLayer(poly);
   poly=L.polygon(pts,{color:'#00BFFF',fillOpacity:.3}).addTo(map);
   if(pts.length>2){
     const area=L.GeometryUtil.geodesicArea(pts);
     poly.bindTooltip((area/1000000).toFixed(3)+" km²").openTooltip();
   }
 });
};

// === LA BÀN GIẢ LẬP ===
document.getElementById('btnCompass').onclick=()=>{
 alert("🧭 Hướng Bắc: 0°, Nam: 180°, Đông: 90°, Tây: 270°");
};
</script>
</body>
</html>

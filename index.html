<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HCM WebGIS ‚Äî Quy ho·∫°ch & B·∫£n ƒë·ªì h√†nh ch√≠nh</title>

<!-- Leaflet core -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Esri Leaflet (Esri basemaps) -->
<script src="https://unpkg.com/esri-leaflet@3.0.11/dist/esri-leaflet.js"></script>

<!-- GoogleMutant (Google base layers) -->
<script src="https://cdn.jsdelivr.net/npm/leaflet.gridlayer.googlemutant@0.13.5/Leaflet.GoogleMutant.min.js"></script>

<!-- Bing layer -->
<script src="https://unpkg.com/leaflet-bing-layer/leaflet-bing-layer.js"></script>

<!-- Locate control -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.css">
<script src="https://unpkg.com/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.js"></script>

<!-- Measure control -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-measure@3.3.0/dist/leaflet-measure.css">
<script src="https://unpkg.com/leaflet-measure@3.3.0/dist/leaflet-measure.min.js"></script>

<!-- Geoman (draw/edit) -->
<link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.14.1/dist/leaflet-geoman.css">
<script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.14.1/dist/leaflet-geoman.min.js"></script>

<!-- Compass -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-compass@1.5.1/dist/leaflet-compass.css" />
<script src="https://unpkg.com/leaflet-compass@1.5.1/dist/leaflet-compass.min.js"></script>

<!-- FileSaver for export -->
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<!-- Simple CSS -->
<style>
  html, body, #map { height:100%; margin:0; }
  .topbar {
    position: absolute; left: 64px; top: 10px; z-index: 1000;
    display:flex; gap:8px; flex-wrap: wrap;
  }
  .btn {
    background:#1f6feb; color:#fff; border:none; padding:8px 12px; border-radius:8px;
    font-weight:600; box-shadow:0 2px 8px rgba(0,0,0,.15); cursor:pointer;
  }
  .btn.secondary { background:#6e7781; }
  .panel {
    position:absolute; left:10px; top:10px; z-index:1100;
  }
  .slide-toggle{
    background:#0ea5e9; color:#fff; border:none; border-radius:24px; padding:10px 14px; font-weight:700;
    box-shadow:0 2px 8px rgba(0,0,0,.2); cursor:pointer;
  }
  .side-card{
    width:320px; max-width:86vw; background:#083344; color:#ecfeff; border-radius:14px;
    padding:14px; box-shadow:0 10px 24px rgba(0,0,0,.25); display:none;
  }
  .side-card h3{ margin:0 0 10px; font-size:16px; }
  .side-card label{ display:block; font-size:13px; margin:8px 0 2px; opacity:.9 }
  .side-card input, .side-card select{ width:100%; padding:8px 10px; border-radius:10px; border:none; outline:none; }
  #searchBox{
    width:380px; max-width:60vw; background:#fff; border-radius:12px; padding:8px 12px;
    box-shadow:0 2px 10px rgba(0,0,0,.15);
  }
  .layers-card{
    position:absolute; right:10px; top:10px; z-index:1000;
    background:#fff; border-radius:12px; padding:12px; box-shadow:0 10px 24px rgba(0,0,0,.2);
    line-height:1.7; font-size:14px;
  }
  .legend{
    position:absolute; right:10px; bottom:26px; z-index:900;
    background:#fff; border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(0,0,0,.18);
    font-size:14px;
  }
  .legend .row{ display:flex; align-items:center; gap:8px; margin:4px 0; }
  .swatch{ width:16px; height:16px; border-radius:4px; border:1px solid rgba(0,0,0,.2); }
  .coords {
    position:absolute; left:10px; bottom:6px; z-index:900;
    background:#fff; padding:4px 8px; border-radius:8px; font-size:12px; box-shadow:0 2px 8px rgba(0,0,0,.15);
  }
  .leaflet-control-locate { margin-top:48px; }/* ƒë·∫©y n√∫t GPS xu·ªëng d∆∞·ªõi c·ª•m zoom */
  @media (max-width: 680px){
    #searchBox{ width:220px; }
  }
</style>
</head>
<body>
<div id="map"></div>

<!-- Top controls -->
<div class="topbar">
  <input id="searchBox" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c t√™n ph∆∞·ªùng..." />
  <button id="clearPaint" class="btn">üßπ X√≥a t√¥ m√†u</button>
  <button id="exportGeoJSON" class="btn secondary">üì¶ Xu·∫•t GeoJSON</button>
</div>

<!-- Left slide panel: TSBƒê / TSSS -->
<div class="panel">
  <button id="toggleSide" class="slide-toggle">TSBƒê / TSSS</button>
  <div id="sideCard" class="side-card">
    <h3>Nh·∫≠p nhanh t·ªça ƒë·ªô / ghi ch√∫</h3>
    <label>TSBƒê:</label>
    <input id="tsbd" placeholder="Nh·∫•p b·∫£n ƒë·ªì ƒë·ªÉ copy Lat,Lng ho·∫∑c t·ª± nh·∫≠p..." />
    <label>TSSS 1:</label><input id="tsss1" placeholder="Nh·∫•p b·∫£n ƒë·ªì ƒë·ªÉ copy Lat,Lng..." />
    <label>TSSS 2:</label><input id="tsss2" placeholder="Nh·∫•p b·∫£n ƒë·ªì ƒë·ªÉ copy Lat,Lng..." />
    <label>TSSS 3:</label><input id="tsss3" placeholder="Nh·∫•p b·∫£n ƒë·ªì ƒë·ªÉ copy Lat,Lng..." />
    <label>Ki·ªÉu n·ªÅn Google (khi ch·ªçn Google):</label>
    <select id="gKind">
      <option value="roadmap">ƒê∆∞·ªùng ph·ªë</option>
      <option value="hybrid">Hybrid</option>
    </select>
  </div>
</div>

<!-- Right layers -->
<div class="layers-card">
  <b>Basemap</b><br/>
  <label><input type="radio" name="base" value="osm" checked> OpenStreetMap</label><br/>
  <label><input type="radio" name="base" value="esriStreet"> Esri Street</label><br/>
  <label><input type="radio" name="base" value="esriImg"> Esri Imagery</label><br/>
  <label><input type="radio" name="base" value="gStreet"> Google Street</label><br/>
  <label><input type="radio" name="base" value="gHybrid"> Google Hybrid</label><br/>
  <label><input type="radio" name="base" value="bingRoad"> Bing Road</label>
  <hr/>
  <label><input type="checkbox" id="chkAdmin" checked> ƒê·ªãa gi·ªõi h√†nh ch√≠nh</label><br/>
  <label><input type="checkbox" id="chkQH"> Quy ho·∫°ch 1/2000</label>
</div>

<!-- Legend Quy ho·∫°ch -->
<div class="legend" id="legendQH" style="display:none;">
  <b>Ch√∫ gi·∫£i lo·∫°i ƒë·∫•t</b>
  <div class="row"><span class="swatch" style="background:#f59e0b"></span> ƒê·∫•t ·ªü (ODT/ONT)</div>
  <div class="row"><span class="swatch" style="background:#22c55e"></span> C√¢y xanh (CX)</div>
  <div class="row"><span class="swatch" style="background:#9ca3af"></span> Giao th√¥ng (DGT)</div>
  <div class="row"><span class="swatch" style="background:#fde047"></span> C√¥ng c·ªông (CC)</div>
  <div class="row"><span class="swatch" style="background:#60a5fa"></span> M·∫∑t n∆∞·ªõc (MN)</div>
  <div class="row"><span class="swatch" style="background:#a78bfa"></span> H·∫° t·∫ßng k·ªπ thu·∫≠t (HTKT)</div>
  <div class="row"><span class="swatch" style="background:#06b6d4"></span> T√¥n gi√°o (TG)</div>
</div>

<!-- Coords -->
<div class="coords" id="coords">Lat: ‚Äî, Lng: ‚Äî</div>

<script>
/* ====== CONFIG ====== */
const BING_KEY = 'YOUR_BING_API_KEY'; // <- ƒëi·ªÅn key c·ªßa anh
const GOOGLE_MUTANT_OPTIONS = {type: 'roadmap'}; // street
const GOOGLE_MUTANT_OPTIONS_HYBRID = {type: 'hybrid'};

// M√†u t√¥ khi click h√†nh ch√≠nh (xoay v√≤ng)
const PAINT_PALETTE = ['#fbbf24','#f97316','#ef4444','#a855f7','#2563eb','#06b6d4'];
let paintIdx = 0;

/* ====== MAP ====== */
const map = L.map('map', { zoomControl:true }).setView([10.776,106.700], 12);

// Basemaps
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom: 20, attribution: '&copy; OpenStreetMap'
}).addTo(map);

const esriStreet = L.esri.basemapLayer('Streets');
const esriImg = L.esri.basemapLayer('Imagery');

let gStreet = L.gridLayer.googleMutant(GOOGLE_MUTANT_OPTIONS);
let gHybrid = L.gridLayer.googleMutant(GOOGLE_MUTANT_OPTIONS_HYBRID);

const bingRoad = L.tileLayer.bing({
  bingMapsKey: BING_KEY,
  imagerySet: 'Road'
});

// Radio basemap
document.querySelectorAll('input[name="base"]').forEach(r=>{
  r.addEventListener('change', () => {
    [osm,esriStreet,esriImg,gStreet,gHybrid,bingRoad].forEach(l => { if(map.hasLayer(l)) map.removeLayer(l); });
    const v = r.value;
    if(v==='osm') osm.addTo(map);
    else if(v==='esriStreet') esriStreet.addTo(map);
    else if(v==='esriImg') esriImg.addTo(map);
    else if(v==='gStreet') gStreet.addTo(map);
    else if(v==='gHybrid') gHybrid.addTo(map);
    else if(v==='bingRoad') bingRoad.addTo(map);
  });
});

// Change Google kind from panel
document.getElementById('gKind').addEventListener('change', (e)=>{
  const kind = e.target.value==='hybrid' ? GOOGLE_MUTANT_OPTIONS_HYBRID : GOOGLE_MUTANT_OPTIONS;
  // re-create to apply change
  if(map.hasLayer(gStreet)) map.removeLayer(gStreet);
  if(map.hasLayer(gHybrid)) map.removeLayer(gHybrid);
  gStreet = L.gridLayer.googleMutant({type:'roadmap'});
  gHybrid = L.gridLayer.googleMutant({type:'hybrid'});
});

// Locate control (d∆∞·ªõi c·ª•m zoom nh·ªù CSS margin-top)
L.control.locate({
  position:'topleft',
  strings:{ title:'ƒê·ªãnh v·ªã GPS' },
  flyTo:true, keepCurrentZoomLevel:false
}).addTo(map);

// Measure
L.control.measure({
  primaryLengthUnit: 'meters',
  primaryAreaUnit: 'sqmeters',
}).addTo(map);

// Geoman draw/edit
map.pm.addControls({
  position: 'topleft',
  drawCircle: false
});

// Compass
L.control.compass({autoActive: true, position:'topright'}).addTo(map);

// Mouse coords
map.on('mousemove', e=>{
  document.getElementById('coords').textContent = `Lat: ${e.latlng.lat.toFixed(5)}, Lng: ${e.latlng.lng.toFixed(5)}`;
});

/* ====== DATA LAYERS ====== */
let adminLayer;
let qhLayer;
const painted = new Set(); // id set for export
const paintedFeatures = []; // store features painted

// Style by MaQuyUoc (Quy ho·∫°ch)
function styleQH(feat){
  const m = (feat.properties?.MaQuyUoc || '').toUpperCase();
  let c = '#f59e0b'; // default ƒê·∫•t ·ªü
  if(m.includes('CX')) c = '#22c55e';
  else if(m.includes('DGT')) c = '#9ca3af';
  else if(m.includes('CC')) c = '#fde047';
  else if(m.includes('MN')) c = '#60a5fa';
  else if(m.includes('HTKT')) c = '#a78bfa';
  else if(m.includes('TG')) c = '#06b6d4';
  return { color:'#ef4444', weight:1, fillColor:c, fillOpacity:0.35 };
}

// Load ƒë·ªãa gi·ªõi
fetch('assets/TPHCM.geojson')
  .then(r=>r.json())
  .then(geo=>{
    adminLayer = L.geoJSON(geo, {
      style: { color:'#ef4444', weight:2, fillOpacity:0 },
      onEachFeature: (f,layer)=>{
        layer.on('click',()=>{
          const color = PAINT_PALETTE[paintIdx % PAINT_PALETTE.length];
          paintIdx++;
          layer.setStyle({ fillColor: color, fillOpacity: 0.45 });

          const p = f.properties || {};
          const name = p.ten_xa || '‚Äî';
          const sap  = p.sap_nhap || '‚Äî';
          const dt   = p.dtich_km2 !== undefined ? Number(p.dtich_km2).toLocaleString('vi-VN',{maximumFractionDigits:2})+' km¬≤' : '‚Äî';
          const dan  = p.dan_so !== undefined ? Number(p.dan_so).toLocaleString('vi-VN')+' ng∆∞·ªùi' : '‚Äî';

          layer.bindPopup(`<b>${name}</b><br/>${sap}<br/><b>${dt}</b> ‚Äî <b>${dan}</b>`).openPopup();

          // mark for export
          if(!painted.has(L.stamp(layer))){
            painted.add(L.stamp(layer));
            paintedFeatures.push(f);
          }
        });
      }
    }).addTo(map);
  });

// Load QH
function loadQH(){
  if(qhLayer){ map.removeLayer(qhLayer); qhLayer=null; }
  fetch('assets/QHPKSDD_SHAPE.json')
    .then(r=>r.json())
    .then(geo=>{
      qhLayer = L.geoJSON(geo, {
        style: styleQH,
        onEachFeature:(f,l)=>{
          l.bindTooltip(f.properties?.MaQuyUoc || '',{sticky:true});
        }
      }).addTo(map);
      document.getElementById('legendQH').style.display='block';
    })
    .catch(err=>{
      alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c Quy ho·∫°ch 1/2000 (ki·ªÉm tra CORS/ƒë∆∞·ªùng d·∫´n).');
      console.error(err);
    });
}

// Layer toggles
document.getElementById('chkAdmin').addEventListener('change', e=>{
  if(!adminLayer) return;
  if(e.target.checked) map.addLayer(adminLayer); else map.removeLayer(adminLayer);
});
document.getElementById('chkQH').addEventListener('change', e=>{
  if(e.target.checked) loadQH();
  else{
    if(qhLayer) map.removeLayer(qhLayer);
    qhLayer=null;
    document.getElementById('legendQH').style.display='none';
  }
});

/* ====== PAINT & EXPORT ====== */
document.getElementById('clearPaint').addEventListener('click', ()=>{
  if(adminLayer){
    adminLayer.eachLayer(l=>{
      l.setStyle({ fillOpacity:0 });
    });
  }
  painted.clear();
  paintedFeatures.length = 0;
});

document.getElementById('exportGeoJSON').addEventListener('click', ()=>{
  if(paintedFeatures.length===0){
    alert('Ch∆∞a c√≥ v√πng n√†o ƒë∆∞·ª£c t√¥ ƒë·ªÉ xu·∫•t.');
    return;
  }
  const gj = { type:'FeatureCollection', features:[...paintedFeatures] };
  const blob = new Blob([JSON.stringify(gj)], {type:'application/json;charset=utf-8'});
  saveAs(blob, 'vung_to.geojson');
});

/* ====== SIDE PANEL ====== */
const sideCard = document.getElementById('sideCard');
document.getElementById('toggleSide').addEventListener('click', ()=>{
  sideCard.style.display = (sideCard.style.display==='block') ? 'none':'block';
});

function putLatLngToFirstEmpty(ll){
  const ids = ['tsbd','tsss1','tsss2','tsss3'];
  for(const id of ids){
    const inp = document.getElementById(id);
    if(!inp.value.trim()){
      inp.value = `${ll.lat.toFixed(6)}, ${ll.lng.toFixed(6)}`;
      break;
    }
  }
}
map.on('click', e=> putLatLngToFirstEmpty(e.latlng));

/* ====== SEARCH ====== */
/* Google Places Autocomplete */
let gAutocomplete;
function initGoogleAutocomplete(){
  const input = document.getElementById('searchBox');
  if(!window.google || !google.maps || !google.maps.places){
    console.warn('Google Places ch∆∞a s·∫µn s√†ng ‚Äî fallback Nominatim');
    enableNominatimSearch();
    return;
  }
  gAutocomplete = new google.maps.places.Autocomplete(input,{ componentRestrictions:{ country:'vn' }});
  gAutocomplete.addListener('place_changed', ()=>{
    const place = gAutocomplete.getPlace();
    if(place && place.geometry && place.geometry.location){
      const lat = place.geometry.location.lat();
      const lng = place.geometry.location.lng();
      map.setView([lat,lng], 17);
      L.marker([lat,lng]).addTo(map);
    }
  });
}

/* Fallback: Nominatim */
function enableNominatimSearch(){
  const input = document.getElementById('searchBox');
  input.addEventListener('keydown', async (ev)=>{
    if(ev.key === 'Enter'){
      const q = input.value.trim();
      if(!q) return;
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
      try{
        const res = await fetch(url,{headers:{'Accept-Language':'vi'}});
        const data = await res.json();
        if(data && data[0]){
          const lat = parseFloat(data[0].lat), lon = parseFloat(data[0].lon);
          map.setView([lat,lon], 17);
          L.marker([lat,lon]).addTo(map).bindPopup(data[0].display_name).openPopup();
        }else alert('Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£.');
      }catch(e){ console.error(e); }
    }
  });
}

/* ====== GOOGLE MAPS JS (Places) ====== */
window.initMap = initGoogleAutocomplete;
</script>

<!-- Google Maps JS (gi·ªØ nguy√™n key c·ªßa anh) -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places&callback=initMap">
</script>
</body>
</html>
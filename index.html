<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>HCM WebGIS ‚Äì ƒê·ªãa gi·ªõi h√†nh ch√≠nh TP.HCM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-compass/dist/leaflet-compass.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

<!-- Google Places Autocomplete -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places"></script>

<style>
  html, body, #map {height:100%; margin:0; padding:0;}
  .leaflet-bar button {display:block; width:100%; border:none; background:white; padding:5px; cursor:pointer;}
  .leaflet-bar button:hover {background:#eee;}
  .label-text {
    font-size: 11px;
    font-weight: bold;
    color: #000;
    text-shadow: 0 0 2px #fff, 0 0 4px #fff;
  }
  .coords {
    position: absolute;
    bottom: 5px;
    left: 10px;
    background: rgba(255,255,255,0.9);
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-family: monospace;
    z-index: 1000;
  }
  #search-box {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1500;
    width: 300px;
  }
  #search-input {
    width: 100%;
    padding: 6px 10px;
    border-radius: 5px;
    border: 1px solid #999;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
</style>
</head>
<body>
<div id="search-box"><input id="search-input" type="text" placeholder="üîç Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c t√™n ph∆∞·ªùng..."></div>
<div id="map"></div>
<div id="coords" class="coords">Lat: --, Lng: --</div>

<!-- JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.js"></script>
<script src="https://unpkg.com/leaflet-compass/dist/leaflet-compass.min.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
window.onload = function() {
  const map = L.map('map', {center: [10.776,106.7], zoom: 12});

  // --- L·ªõp n·ªÅn ---
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution:'¬© OpenStreetMap'}).addTo(map);
  const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution:'¬© Esri'});
  const googleHybrid = L.tileLayer('https://mts1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}&key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA', {attribution:'¬© Google'});

  const baseMaps = {"üåç OSM": osm, "üõ∞Ô∏è Esri Imagery": esriImagery, "üå§Ô∏è Google Hybrid": googleHybrid};

  const phuongXaGroup = L.layerGroup(), quanHuyenGroup = L.layerGroup(), labelGroup = L.layerGroup();
  let colored = [];
  let measureCtrl, compassCtrl;

  // --- N·∫°p GeoJSON ---
  async function loadHCM() {
    const res = await fetch('assets/TPHCM.geojson');
    const data = await res.json();
    const searchList = [];

    const layer = L.geoJSON(data, {
      style: { color: "#ff6600", weight: 1, fillOpacity: 0.1 },
      onEachFeature: (f, l) => {
        const p = f.properties || {};
        const ten = p.ten_xa || '';
        const quan = p.quan_huyen || '';
        const dt = (p.dtich_km2 ? p.dtich_km2.toFixed(2) : '-') + " km¬≤";
        const ds = p.dan_so ? p.dan_so.toLocaleString() + " ng∆∞·ªùi" : '-';
        const sap = p.sap_nhap ? `<br><i>${p.sap_nhap}</i>` : '';
        l.bindPopup(`<b>${ten}</b><br>${quan}<br>${dt}<br>${ds}${sap}`);
        l.on('click', () => highlight(f, l));
        searchList.push({ name: `${ten} - ${quan}`, layer: l });
      }
    }).addTo(phuongXaGroup);

    addSearchControl(searchList);
    phuongXaGroup.addTo(map);
  }

  // --- T√¥ m√†u v√πng ---
  function highlight(feature, layer){
    const colors = ["#FFD700","#FFA500","#1E90FF","#32CD32","#FF69B4"];
    const c = colors[Math.floor(Math.random()*colors.length)];
    layer.setStyle({ fillColor:c, fillOpacity:0.5 });
    colored.push({ feature: feature, layer: layer });
  }
  function clearColors(){
    colored.forEach(obj => obj.layer.setStyle({ fillOpacity:0.1, fillColor:null }));
    colored = [];
  }
  function exportGeoJSON(){
    if(colored.length === 0){ alert("Ch∆∞a c√≥ v√πng n√†o ƒë∆∞·ª£c t√¥ m√†u!"); return; }
    const geojson = { type: "FeatureCollection", features: colored.map(o => o.feature) };
    const blob = new Blob([JSON.stringify(geojson, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'to_mau.geojson'; a.click();
    URL.revokeObjectURL(url);
  }

  // --- T√¨m ki·∫øm ph∆∞·ªùng/x√£ ---
  function addSearchControl(list){
    const geocoder = L.Control.geocoder({
      defaultMarkGeocode: false,
      placeholder: 'üîç T√¨m ph∆∞·ªùng/x√£ ho·∫∑c qu·∫≠n...',
    }).addTo(map);
    const input = geocoder._input;
    input.addEventListener('input', function(){
      const kw = this.value.toLowerCase();
      const match = list.find(i => i.name.toLowerCase().includes(kw));
      if(match){ const b = match.layer.getBounds(); map.fitBounds(b); match.layer.openPopup(); }
    });
  }

  // --- Autocomplete ƒë·ªãa ch·ªâ ---
  const input = document.getElementById('search-input');
  const autocomplete = new google.maps.places.Autocomplete(input, {
    componentRestrictions: { country: "vn" },
    fields: ["geometry", "name"]
  });
  autocomplete.addListener("place_changed", () => {
    const place = autocomplete.getPlace();
    if (!place.geometry) return;
    const loc = place.geometry.location;
    map.setView([loc.lat(), loc.lng()], 17);
    L.marker([loc.lat(), loc.lng()]).addTo(map)
      .bindPopup(`<b>${place.name}</b>`).openPopup();
  });

  // --- T·ªça ƒë·ªô chu·ªôt ---
  const coordsDiv = document.getElementById('coords');
  map.on('mousemove', e => coordsDiv.innerHTML = `Lat: ${e.latlng.lat.toFixed(5)}, Lng: ${e.latlng.lng.toFixed(5)}`);

  // --- C√¥ng c·ª• c∆° b·∫£n ---
  L.control.scale().addTo(map);
  L.control.locate({strings:{title:"ƒê·ªãnh v·ªã GPS"}}).addTo(map);

  // --- B·∫≠t t·∫Øt c√¥ng c·ª• ---
  function toggleTools(){
    if(measureCtrl){ map.removeControl(measureCtrl); map.removeControl(compassCtrl); measureCtrl = null; compassCtrl = null; }
    else {
      measureCtrl = L.control.measure({ primaryLengthUnit:'meters', secondaryLengthUnit:'kilometers', primaryAreaUnit:'sqmeters' }).addTo(map);
      compassCtrl = L.control.compass({autoActive:true, showDigit:true, position:'topright'}).addTo(map);
    }
  }

  // --- Layer control ---
  L.control.layers(baseMaps, {"üó∫Ô∏è Ph∆∞·ªùng/X√£": phuongXaGroup}).addTo(map);

  // --- Thanh c√¥ng c·ª• ---
  const panel = L.control({position:'topright'});
  panel.onAdd = function(){
    const div = L.DomUtil.create('div','leaflet-bar');
    div.innerHTML = `
      <button onclick="window._clearColors()">üé® X√≥a t√¥ m√†u</button>
      <button onclick="window._exportGeoJSON()">üíæ Xu·∫•t GeoJSON</button>
      <button onclick="window._toggleTools()">üîß C√¥ng c·ª•</button>
    `;
    return div;
  };
  panel.addTo(map);
  window._clearColors = clearColors;
  window._exportGeoJSON = exportGeoJSON;
  window._toggleTools = toggleTools;

  // --- Auto ·∫£nh v·ªá tinh ---
  map.on('zoomend', () => {
    if (map.getZoom() > 14 && !map.hasLayer(esriImagery)) map.addLayer(esriImagery);
    else if (map.getZoom() <= 14 && map.hasLayer(esriImagery)) map.removeLayer(esriImagery);
  });

  loadHCM();
};
</script>
</body>
</html>

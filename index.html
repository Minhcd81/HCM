<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HCM WebGIS ‚Äì Quy ho·∫°ch & B·∫£n ƒë·ªì h√†nh ch√≠nh</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css" />
<style>
  html, body, #map { height: 100%; margin: 0; }
  .legend {
    position: absolute;
    bottom: 20px;
    right: 20px;
    background: white;
    padding: 10px;
    border-radius: 8px;
    font-size: 13px;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
  }
  .legend div { margin-bottom: 4px; }
  .legend i {
    display: inline-block;
    width: 14px;
    height: 14px;
    margin-right: 6px;
  }
  .custom-button {
    position: absolute;
    top: 90px;
    right: 20px;
    background: white;
    padding: 6px 10px;
    border-radius: 6px;
    box-shadow: 0 0 5px rgba(0,0,0,0.4);
    cursor: pointer;
    font-size: 13px;
  }
</style>
</head>
<body>
<div id="map"></div>
<div class="custom-button" id="clearColor">üßπ X√≥a t√¥ m√†u</div>
<div class="legend">
  <b>Ch√∫ gi·∫£i lo·∫°i ƒë·∫•t</b><br>
  <div><i style="background:red"></i> ƒê·∫•t ·ªü (ODT/ONT)</div>
  <div><i style="background:green"></i> C√¢y xanh (CX)</div>
  <div><i style="background:gray"></i> Giao th√¥ng (DGT)</div>
  <div><i style="background:yellow"></i> C√¥ng c·ªông (CC)</div>
  <div><i style="background:blue"></i> M·∫∑t n∆∞·ªõc (MN)</div>
  <div><i style="background:orange"></i> H·∫° t·∫ßng k·ªπ thu·∫≠t (HTKT)</div>
  <div><i style="background:purple"></i> T√¥n gi√°o (TG)</div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.js"></script>
<script>
const map = L.map('map').setView([10.775, 106.7], 12);

// --- Base maps ---
const baseMaps = {
  'OSM': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }),
  'Esri Street Basemap': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles ¬© Esri'
  }),
  'Esri Imagery': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Imagery ¬© Esri'
  }),
  'Google Street': L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { attribution: 'Google Street' }),
  'Google Hybrid': L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { attribution: 'Google Hybrid' }),
  'Bing Road': L.tileLayer(`https://dev.virtualearth.net/REST/V1/Imagery/Metadata/Road?key=34TsHklW0IqAp0Ei1inHFoaRUxqgaVSDH9Dm56DqrisxL0NtnWL5JQQJ99BJACYeBjFmUVijAAAgAZMPXNSk`, { attribution: 'Bing Road' }),
  'Bing Aerial': L.tileLayer(`https://dev.virtualearth.net/REST/V1/Imagery/Metadata/Aerial?key=34TsHklW0IqAp0Ei1inHFoaRUxqgaVSDH9Dm56DqrisxL0NtnWL5JQQJ99BJACYeBjFmUVijAAAgAZMPXNSk`, { attribution: 'Bing Aerial' })
};
baseMaps['OSM'].addTo(map);

let hanhChinh, quyHoach, taiSan;
let coloredLayers = [];

// --- L·ªõp h√†nh ch√≠nh ---
fetch('assets/TPHCM.geojson')
  .then(res => res.json())
  .then(data => {
    hanhChinh = L.geoJSON(data, {
      style: { color: '#ff6600', weight: 1, fillOpacity: 0.2 },
      onEachFeature: (feature, layer) => {
        const info = `<b>${feature.properties.ten_xa}</b><br>${feature.properties.dtich_km2} km¬≤ - ${feature.properties.dan_so} ng∆∞·ªùi`;
        layer.bindPopup(info);
        layer.on('click', () => {
          layer.setStyle({ fillColor: 'pink', fillOpacity: 0.5 });
          coloredLayers.push(layer);
        });
      }
    }).addTo(map);
  });

document.getElementById('clearColor').addEventListener('click', () => {
  coloredLayers.forEach(l => l.setStyle({ fillColor: null, fillOpacity: 0.2 }));
  coloredLayers = [];
});

// --- L·ªõp quy ho·∫°ch ---
fetch('https://drive.google.com/uc?export=download&id=1UTyZRAmJGmkQSfU48jnrjved9Dc0zY3u')
  .then(res => res.json())
  .then(data => {
    const colorMap = {
      'ODT': 'red', 'ONT': 'red', 'CX': 'green', 'DGT': 'gray', 'CC': 'yellow', 'MN': 'blue', 'HTKT': 'orange', 'TG': 'purple'
    };
    quyHoach = L.geoJSON(data, {
      style: f => ({
        color: '#555',
        weight: 0.5,
        fillColor: colorMap[f.properties.MaQuyUoc] || '#cccccc',
        fillOpacity: 0.5
      }),
      onEachFeature: (f, layer) => {
        layer.bindPopup(`<b>${f.properties.MaQuyUoc}</b><br>${f.properties.TenLoaiDat || ''}`);
      }
    });
  });

// --- L·ªõp t√†i s·∫£n ---
fetch('assets/taisan.geojson')
  .then(res => res.json())
  .then(data => {
    taiSan = L.geoJSON(data, {
      pointToLayer: (f, latlng) => L.marker(latlng),
      onEachFeature: (f, layer) => {
        const props = f.properties;
        layer.bindPopup(`<b>${props.name || 'T√†i s·∫£n'}</b><br>${props.description || ''}`);
      }
    });
  });

// --- Controls ---
L.control.layers(baseMaps, {
  'ƒê·ªãa gi·ªõi h√†nh ch√≠nh': hanhChinh,
  'Quy ho·∫°ch 1/2000': quyHoach,
  'T√†i s·∫£n (My Maps)': taiSan
}).addTo(map);

// Measure tool
L.control.measure({ primaryLengthUnit: 'meters', primaryAreaUnit: 'sqmeters' }).addTo(map);

// Geocoder
L.Control.geocoder({ defaultMarkGeocode: true }).addTo(map);
</script>
</body>
</html>

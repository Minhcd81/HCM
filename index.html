<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WebGIS ‚Äì Search t√¥ m√†u ph∆∞·ªùng (34 t·ªânh)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places,geometry"></script>

<style>
html,body,#map{height:100%;margin:0}
body{font-family:system-ui,Segoe UI,Roboto,Arial}
#searchbar{position:absolute;left:50%;top:12px;transform:translateX(-50%);z-index:1200;width:820px;max-width:92vw}
#q{width:100%;padding:12px 14px;border:1px solid #cfd4dc;border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.15)}
#tools{position:absolute;right:12px;top:76px;z-index:1200;display:flex;flex-direction:column;gap:10px}
.tool{width:46px;height:46px;border-radius:50%;background:#fff;border:1px solid #ddd;box-shadow:0 2px 8px rgba(0,0,0,.2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px}
#map .leaflet-popup-content{min-width:260px}
.badge{display:inline-block;padding:2px 6px;border-radius:6px;background:#eef4ff;border:1px solid #d7e3ff;color:#2051d8;font-size:12px;margin-left:6px}
.coords{position:absolute;left:8px;bottom:6px;background:rgba(255,255,255,.9);padding:4px 8px;border-radius:8px;font:12px monospace;z-index:1000}
@media(max-width:640px){#searchbar{top:10px} .tool{width:44px;height:44px}}
</style>
</head>
<body>
<div id="searchbar"><input id="q" placeholder="üîç ƒê·ªãa ch·ªâ / ph∆∞·ªùng/x√£ c≈© / t·ªça ƒë·ªô (vd: 10.79844, 106.65855)" autocomplete="off"></div>
<div id="tools">
  <div class="tool" id="btnClear" title="X√≥a t√¥ m√†u">üßπ</div>
  <div class="tool" id="btnGPS"   title="ƒê·ªãnh v·ªã">üìç</div>
  <div class="tool" id="btnEye"   title="Xem Street View">üëÅÔ∏è</div>
</div>
<div id="map"></div>
<div class="coords" id="coords">Lat: ‚Äî, Lng: ‚Äî</div>

<script>
// =================== MAP ===================
const map=L.map('map',{center:[10.77,106.67],zoom:12});
const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OpenStreetMap'}).addTo(map);
const gHybrid=L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{attribution:'¬© Google'});
let activeFill=null, activeWardLayer=null, activeProvinceSlug=null;
let provinceLayersCache={}, geoCache={}, placeMarker=null;

map.on('mousemove',e=>{document.getElementById('coords').textContent=`Lat:${e.latlng.lat.toFixed(5)}, Lng:${e.latlng.lng.toFixed(5)}`;});

// =========== 34 t·ªânh/th√†nh (slug kh·ªõp t√™n file assets/<slug>.geojson) ===========
const PROVINCE_NAME_TO_SLUG = {
 'TP H√† N·ªôi':'hanoi','H√† N·ªôi':'hanoi','Ha Noi':'hanoi',
 'TP.HCM':'hcm','Th√†nh ph·ªë H·ªì Ch√≠ Minh':'hcm','Ho Chi Minh City':'hcm',
 'ƒê√† N·∫µng':'danang','Da Nang':'danang',
 'Th·ª´a Thi√™n Hu·∫ø':'hue','TP Hu·∫ø':'hue','Hue':'hue',
 'H·∫£i Ph√≤ng':'haiphong','Hai Phong':'haiphong',
 'An Giang':'angiang','B·∫Øc Ninh':'bacninh','L√¢m ƒê·ªìng':'lamdong','C√† Mau':'camau','C·∫ßn Th∆°':'cantho','Cao B·∫±ng':'caobang',
 'ƒê·∫Øk L·∫Øk':'daklak','ƒêi·ªán Bi√™n':'dienbien','ƒê·ªìng Nai':'dongnai','ƒê·ªìng Th√°p':'dongthap','Gia Lai':'gialai',
 'H√† Tƒ©nh':'hatinh','H∆∞ng Y√™n':'hungyen','Kh√°nh H√≤a':'khanhhoa','Lai Ch√¢u':'laichau','L·∫°ng S∆°n':'langson','L√†o Cai':'laocai',
 'Ngh·ªá An':'nghean','Ninh B√¨nh':'ninhbinh','Ph√∫ Th·ªç':'phutho','Qu·∫£ng Ng√£i':'quangngai','Qu·∫£ng Ninh':'quangninh','Qu·∫£ng Tr·ªã':'quangtri',
 'S∆°n La':'sonla','T√¢y Ninh':'tayninh','Th√°i Nguy√™n':'thainguyen','Thanh H√≥a':'thanhhoa','Tuy√™n Quang':'tuyenquang','Vƒ©nh Long':'vinhlong'
};

// =================== GOOGLE PLACES AUTOCOMPLETE ===================
const input=document.getElementById('q');
const ac=new google.maps.places.Autocomplete(input,{
  fields:['geometry','formatted_address','address_components','name'],
  componentRestrictions:{country:'vn'}
});
ac.addListener('place_changed', async ()=>{
  const pl=ac.getPlace();
  if(!pl || !pl.geometry){ // th·ª≠ parse t·ªça ƒë·ªô th√¥
    const ll=parseLatLngFromText(input.value);
    if(ll){ moveTo(ll.lat,ll.lng, true); return; }
    alert('Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c v·ªã tr√≠.'); return;
  }
  const lat=pl.geometry.location.lat(), lng=pl.geometry.location.lng();
  moveTo(lat,lng,true, pl);
});

// G√µ t·ªça ƒë·ªô "lat, lng"
function parseLatLngFromText(txt){
  const m=txt.trim().match(/(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)/);
  if(!m) return null;
  const lat=parseFloat(m[1]), lng=parseFloat(m[2]);
  if(isFinite(lat)&&isFinite(lng)) return {lat,lng};
  return null;
}

// =================== MOVE + COLOR WARD ===================
async function moveTo(lat,lng, openPopup=false, placeObj=null){
  map.setView([lat,lng], 17);
  if(placeMarker) map.removeLayer(placeMarker);
  placeMarker=L.marker([lat,lng]).addTo(map);

  // L·∫•y t√™n t·ªânh t·ª´ address_components
  let provinceName=null;
  if(placeObj && placeObj.address_components){
    for(const c of placeObj.address_components){
      if(c.types.includes('administrative_area_level_1')){ provinceName=c.long_name; break; }
    }
  }
  // N·∫øu kh√¥ng c√≥, th·ª≠ reverse geocode nhanh b·∫±ng Google (ch·ªâ fallback)
  if(!provinceName){
    try{
      const g=new google.maps.Geocoder();
      g.geocode({location:{lat,lng}},(results,status)=>{
        if(status==='OK' && results?.[0]){
          const comps=results[0].address_components||[];
          const found=comps.find(x=>x.types.includes('administrative_area_level_1'));
          colorByProvince(found?.long_name||null);
        }else colorByProvince(null);
      });
    }catch(e){ colorByProvince(null); }
  }else{
    colorByProvince(provinceName);
  }

  // popup marker c∆° b·∫£n + n√∫t üëÅÔ∏è StreetView
  const addr = (placeObj && placeObj.formatted_address) ? placeObj.formatted_address : `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
  placeMarker.bindPopup(`
    <b>${addr}</b>
    <div style="margin-top:6px">
      <button onclick="showStreet(${lat},${lng})">üëÅÔ∏è Xem Street View</button>
    </div>
  `);
  if(openPopup) placeMarker.openPopup();
}

// √Ånh x·∫° t√™n t·ªânh ‚Üí slug, r·ªìi fetch geojson & t√¨m ph∆∞·ªùng ch·ª©a ƒëi·ªÉm
async function colorByProvince(provinceName){
  if(!provinceName){ return; }
  const slug = PROVINCE_NAME_TO_SLUG[provinceName] || PROVINCE_NAME_TO_SLUG[provinceName.replace('Th√†nh ph·ªë ','TP ')] || null;
  if(!slug){ return; }
  activeProvinceSlug=slug;

  try{
    const gj = await getProvinceGeo(slug);
    const latlng = placeMarker.getLatLng();
    const pt = turf.point([latlng.lng, latlng.lat]);

    let foundFeat=null;
    for(const f of gj.features){
      if(!f || !f.geometry) continue;
      if(turf.booleanPointInPolygon(pt, f)){ foundFeat=f; break; }
    }
    if(!foundFeat){ return; }

    // Hightlight ph∆∞·ªùng
    if(activeWardLayer) map.removeLayer(activeWardLayer);
    activeWardLayer = L.geoJSON(foundFeat,{
      style:{color:'#ff6b00',weight:2,fillColor:'#ffd9a6',fillOpacity:.45}
    }).addTo(map);

    // Popup th√¥ng tin (ƒë·ªïi m√†u t·ª± ƒë·ªông theo click)
    const p = foundFeat.properties || {};
    const xa  = p.ten_xa || p.xa || p.NAME_3 || '‚Äî';
    const qh  = p.quan_huyen || p.NAME_2 || '‚Äî';
    const tinh= p.tinh || p.NAME_1 || provinceName || '‚Äî';
    const dt  = p.dtich_km2 ? `${(+p.dtich_km2).toLocaleString('vi-VN')} km¬≤` : (p.area ? p.area+' km¬≤' : '‚Äî');
    const ds  = p.dan_so ? `${(+p.dan_so).toLocaleString('vi-VN')} ng∆∞·ªùi` : '‚Äî';
    const sn  = p.sap_nhap || p.ten_cu || '';

    const latlng = placeMarker.getLatLng();
    const html = `
      <div>
        <div style="font-weight:700">${xa} <span class="badge">${tinh}</span></div>
        <div>${qh}</div>
        <div>Di·ªán t√≠ch: ${dt} ‚Ä¢ D√¢n s·ªë: ${ds}</div>
        ${sn?`<div>Tr∆∞·ªõc s√°p nh·∫≠p: ${sn}</div>`:''}
        <div style="margin-top:6px"><button onclick="showStreet(${latlng.lat},${latlng.lng})">üëÅÔ∏è Xem Street View t·∫°i v·ªã tr√≠ n√†y</button></div>
      </div>`;
    L.popup({offset:[0,-6]}).setLatLng(latlng).setContent(html).openOn(map);

  }catch(e){
    // Kh√¥ng c√≥ file t·ªânh ‚Üí th√¥i kh√¥ng t√¥
  }
}

async function getProvinceGeo(slug){
  if(geoCache[slug]) return geoCache[slug];
  const res = await fetch(`assets/${slug}.geojson`);
  if(!res.ok) throw new Error('Missing geojson for '+slug);
  const gj = await res.json();
  geoCache[slug]=gj;
  return gj;
}

// =================== TOOLS ===================
document.getElementById('btnClear').onclick=()=>{
  if(activeWardLayer){ map.removeLayer(activeWardLayer); activeWardLayer=null; }
};
document.getElementById('btnGPS').onclick=()=>{
  map.locate({setView:true,maxZoom:17});
  map.once('locationfound',e=>moveTo(e.latlng.lat,e.latlng.lng,true));
};
document.getElementById('btnEye').onclick=()=>{
  if(!placeMarker){alert('Ch∆∞a c√≥ v·ªã tr√≠. T√¨m ƒë·ªãa ch·ªâ/to·∫° ƒë·ªô tr∆∞·ªõc.');return;}
  const {lat,lng}=placeMarker.getLatLng();
  showStreet(lat,lng,true);
};

// iframe Street View trong popup (khung nh·ªè ‚Äî ph√π h·ª£p mobile)
window.showStreet = (lat,lng, openSeparate)=>{
  const html = `<iframe style="width:340px;max-width:86vw;height:200px;border:0;border-radius:8px"
    src="https://www.google.com/maps?q=&layer=c&cbll=${lat},${lng}&cbp=11,0,0,0,0&z=18" allowfullscreen></iframe>`;
  const ll = L.latLng(lat,lng);
  L.popup().setLatLng(ll).setContent(html).openOn(map);
};
</script>
</body>
</html>

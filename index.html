<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HCM WebGIS v7 â€” Dynamic Measure + Compass + StreetView</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<style>
html,body,#map{height:100%;margin:0}
.toolbtn{background:#fff;border:1px solid #ddd;border-radius:50%;width:48px;height:48px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.15);font-size:22px;text-align:center;line-height:48px;transition:all .2s}
.toolbtn:hover{transform:scale(1.1);background:#f1f5f9}
#tools{position:absolute;right:10px;top:70px;z-index:1200;display:flex;flex-direction:column;gap:10px}
#measureMenu{position:absolute;right:70px;top:120px;background:#fff;border:1px solid #ddd;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.15);display:none;z-index:1300}
#measureMenu button{display:block;padding:8px 12px;border:none;background:#fff;width:180px;text-align:left;cursor:pointer}
#measureMenu button:hover{background:#f1f5f9}
#compassOverlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:350px;height:350px;border-radius:50%;background:rgba(255,255,255,.9);border:2px solid #bbb;display:none;z-index:1300;box-shadow:0 4px 14px rgba(0,0,0,.3)}
#compassOverlay .label{position:absolute;font-weight:bold;color:#333;font-size:18px}
#compassOverlay .n{top:8px;left:50%;transform:translateX(-50%);color:#d00}
#compassOverlay .s{bottom:8px;left:50%;transform:translateX(-50%)}
#compassOverlay .e{right:8px;top:50%;transform:translateY(-50%)}
#compassOverlay .w{left:8px;top:50%;transform:translateY(-50%)}
#btnClear{position:absolute;right:10px;bottom:70px;z-index:1200;background:#fff;border:1px solid #ddd;border-radius:10px;padding:8px 10px;box-shadow:0 2px 6px rgba(0,0,0,.15);}
</style>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=geometry,places"></script>
</head>
<body>
<div id="map"></div>
<div id="tools">
  <div id="btnCompass" class="toolbtn">ğŸ§­</div>
  <div id="btnMeasure" class="toolbtn">ğŸ“</div>
  <div id="btnGPS" class="toolbtn">ğŸ“</div>
</div>
<div id="measureMenu">
  <button id="mDist">ğŸ“ğŸ“ Äo khoáº£ng cÃ¡ch</button>
  <button id="mArea">â¬› Äo diá»‡n tÃ­ch</button>
  <button id="mQuick">âš¡ Äo nhanh (Ä‘á»™ng)</button>
  <button id="mFinish">ğŸ›‘ HoÃ n táº¥t Ä‘o</button>
</div>
<div id="compassOverlay">
  <div class="label n">B</div>
  <div class="label s">N</div>
  <div class="label e">Ä</div>
  <div class="label w">T</div>
</div>
<button id="btnClear">ğŸ§¹ XÃ³a tÃ´ mÃ u</button>
<script>
const map=L.map('map',{center:[10.776,106.7],zoom:13});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(map);
let coloredLayers=[],drawnItems=new L.FeatureGroup().addTo(map),activeDraw=null;

// Clear
document.getElementById('btnClear').onclick=()=>{coloredLayers.forEach(l=>l.setStyle({fillColor:null,fillOpacity:.1}));coloredLayers=[];};

// Compass
const compass=document.getElementById('compassOverlay');let compassOn=false;
document.getElementById('btnCompass').onclick=()=>{compassOn=!compassOn;compass.style.display=compassOn?'block':'none';};

// Measure menu
document.getElementById('btnMeasure').onclick=()=>{
 const m=document.getElementById('measureMenu');
 m.style.display=m.style.display==='block'?'none':'block';
};
function stopMeasure(){if(activeDraw){activeDraw.disable();activeDraw=null;}}
function startDist(){
 stopMeasure();
 activeDraw=new L.Draw.Polyline(map,{shapeOptions:{color:'#00BFFF',weight:3}});
 activeDraw.enable();
}
function startArea(){
 stopMeasure();
 activeDraw=new L.Draw.Polygon(map,{shapeOptions:{color:'#00BFFF',weight:2,fillOpacity:.2}});
 activeDraw.enable();
}
document.getElementById('mDist').onclick=()=>{document.getElementById('measureMenu').style.display='none';startDist();};
document.getElementById('mArea').onclick=()=>{document.getElementById('measureMenu').style.display='none';startArea();};
document.getElementById('mFinish').onclick=()=>{stopMeasure();document.getElementById('measureMenu').style.display='none';};

// Dynamic measure
let dynamicStart=null,dynLine=null,dynLabel=null;
document.getElementById('mQuick').onclick=()=>{
  document.getElementById('measureMenu').style.display='none';
  alert('Cháº¿ Ä‘á»™ Ä‘o nhanh: click chá»n Ä‘iá»ƒm Ä‘áº§u, di chuá»™t Ä‘á»ƒ xem khoáº£ng cÃ¡ch, double click hoáº·c ESC Ä‘á»ƒ thoÃ¡t.');
  map.on('click',startDynamic);
};
function startDynamic(e){
  if(dynamicStart){return;}
  dynamicStart=e.latlng;
  dynLine=L.polyline([dynamicStart],{color:'#00BFFF',weight:4,opacity:0.9}).addTo(map);
  dynLabel=L.marker(e.latlng,{interactive:false,icon:L.divIcon({className:'dynLabel',html:'',iconSize:[120,30]})}).addTo(map);
  map.on('mousemove',updateDynamic);
  map.on('dblclick',endDynamic);
  document.addEventListener('keydown',escDynamic);
}
function updateDynamic(e){
 if(!dynamicStart)return;
 const latlngs=[dynamicStart,e.latlng];
 dynLine.setLatLngs(latlngs);
 const dist=map.distance(dynamicStart,e.latlng);
 const text=`ğŸ“ ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}<br>ğŸ“ ${(dist).toFixed(1)} m`;
 dynLabel.setLatLng(e.latlng);
 dynLabel._icon.innerHTML=`<div style="background:rgba(255,255,255,0.9);border:1px solid #ccc;border-radius:6px;padding:4px 6px;font-size:13px;box-shadow:0 0 8px #00BFFF">${text}</div>`;
}
function endDynamic(){
 if(dynLine){dynLine.remove();dynLabel.remove();}
 dynamicStart=null;dynLine=null;dynLabel=null;
 map.off('mousemove',updateDynamic);map.off('dblclick',endDynamic);map.off('click',startDynamic);
 document.removeEventListener('keydown',escDynamic);
}
function escDynamic(e){if(e.key==='Escape')endDynamic();}

// Leaflet Draw result
map.on(L.Draw.Event.CREATED, e=>{
 const layer=e.layer;drawnItems.addLayer(layer);
 if(e.layerType==='polyline'){
   const coords=layer.getLatLngs().map(ll=>[ll.lng,ll.lat]);
   let len=0;for(let i=1;i<coords.length;i++){len+=turf.distance(coords[i-1],coords[i],{units:'kilometers'});}
   layer.bindPopup('Chiá»u dÃ i: '+(len*1000).toFixed(1)+' m').openPopup();
 }else if(e.layerType==='polygon'){
   const coords=[layer.getLatLngs()[0].map(ll=>[ll.lng,ll.lat])];
   const poly=turf.polygon([coords[0]]);const area=turf.area(poly);
   layer.bindPopup('Diá»‡n tÃ­ch: '+area.toFixed(0)+' mÂ²').openPopup();
 }
});

// Glow effect for dynamic line
L.Polyline.include({
 _updatePath:function(){
   L.Path.prototype._updatePath.call(this);
   if(this.options.color==='#00BFFF'){
     const ctx=this._ctx;ctx.save();ctx.shadowColor='#00BFFF';ctx.shadowBlur=8;ctx.stroke();ctx.restore();
   }
 }
});
</script>
</body></html>

<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>HCM WebGIS ‚Äì ƒê·ªãa gi·ªõi h√†nh ch√≠nh TP.HCM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-compass/dist/leaflet-compass.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

<style>
  html, body, #map {height:100%; margin:0; padding:0;}
  .leaflet-bar button {display:block; width:100%; border:none; background:white; padding:5px; cursor:pointer;}
  .leaflet-bar button:hover {background:#eee;}
  .label-text {
    font-size: 11px;
    font-weight: bold;
    color: #000;
    text-shadow: 0 0 2px #fff, 0 0 4px #fff;
  }
</style>
</head>
<body>
<div id="map"></div>

<!-- JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.js"></script>
<script src="https://unpkg.com/leaflet-compass/dist/leaflet-compass.min.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
window.onload = function() {
  const map = L.map('map', {center: [10.776,106.7], zoom: 12});

  // --- L·ªõp n·ªÅn an to√†n ---
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution:'¬© OpenStreetMap'}).addTo(map);
  const esriStreet = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {attribution:'¬© Esri'});
  const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution:'¬© Esri'});
  const bing = L.tileLayer('https://ecn.t{s}.tiles.virtualearth.net/tiles/a{q}.jpeg?g=1&key=1&key=e18625f53fd5484c93b09c24ff459087', {
    subdomains:['t0','t1','t2','t3'], attribution:'¬© Bing Maps'
  });
  // Google map (qua tile API h·ª£p l·ªá)
  const googleStreet = L.tileLayer('https://mts1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA', {attribution:'¬© Google'});
  const googleHybrid = L.tileLayer('https://mts1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}&key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA', {attribution:'¬© Google'});
  const googleSat = L.tileLayer('https://mts1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}&key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA', {attribution:'¬© Google'});

  const baseMaps = {
    "üó∫Ô∏è OpenStreetMap": osm,
    "üß≠ Esri Streets": esriStreet,
    "üõ∞Ô∏è Esri Imagery": esriImagery,
    "üå§Ô∏è Google Street": googleStreet,
    "üåç Google Hybrid": googleHybrid,
    "üåå Google Satellite": googleSat,
    "‚òÅÔ∏è Bing Aerial": bing
  };

  const phuongXaGroup = L.layerGroup();
  const quanHuyenGroup = L.layerGroup();
  const labelGroup = L.layerGroup();

  // --- N·∫°p d·ªØ li·ªáu ---
  async function loadHCM() {
    const res = await fetch('assets/TPHCM.geojson');
    const data = await res.json();
    const searchList = [];

    // Ph∆∞·ªùng/X√£
    const phuongXaLayer = L.geoJSON(data, {
      style: { color: "#ff6600", weight: 1, fillOpacity: 0.1 },
      onEachFeature: (f, l) => {
        const p = f.properties || {};
        const ten = p.ten_xa || '';
        const quan = p.quan_huyen || '';
        const dt = (p.dtich_km2 ? p.dtich_km2.toFixed(2) : '-') + " km¬≤";
        const ds = p.dan_so ? p.dan_so.toLocaleString() + " ng∆∞·ªùi" : '-';
        const sap = p.sap_nhap ? `<br><i>${p.sap_nhap}</i>` : '';
        l.bindPopup(`<b>${ten}</b><br>${quan}<br>${dt}<br>${ds}${sap}`);
        l.on('click', () => highlight(l));
        searchList.push({ name: `${ten} - ${quan}`, layer: l });
      }
    }).addTo(phuongXaGroup);

    // Qu·∫≠n/Huy·ªán
    const districts = {};
    data.features.forEach(f => {
      const p = f.properties || {};
      if (!districts[p.quan_huyen]) districts[p.quan_huyen] = [];
      if (f.geometry) districts[p.quan_huyen].push(f.geometry);
    });

    Object.keys(districts).forEach(q => {
      const feature = { type: "FeatureCollection", features: districts[q].map(g => ({type:"Feature", geometry:g})) };
      L.geoJSON(feature, {
        style: { color: "#660099", weight: 3, fillOpacity: 0 },
        onEachFeature: (f,l) => l.bindTooltip(`<b>${q}</b>`, {permanent:false})
      }).addTo(quanHuyenGroup);
    });

    // Nh√£n
    data.features.forEach(f => {
      const p = f.properties || {};
      if (f.geometry && (f.geometry.type === "Polygon" || f.geometry.type === "MultiPolygon")) {
        const center = getCenter(f);
        if (center) {
          const label = L.marker(center, {
            icon: L.divIcon({ className: "label-text", html: p.ten_xa || "" })
          });
          labelGroup.addLayer(label);
        }
      }
    });

    // T√¨m ki·∫øm n·ªôi b·ªô
    addSearchControl(searchList);

    phuongXaGroup.addTo(map);
  }

  function getCenter(feature) {
    try {
      const coords = (feature.geometry.type === "Polygon")
        ? feature.geometry.coordinates[0]
        : feature.geometry.coordinates[0][0];
      let lat = 0, lng = 0;
      coords.forEach(c => { lng += c[0]; lat += c[1]; });
      return [lat/coords.length, lng/coords.length];
    } catch { return null; }
  }

  // --- T√¥ m√†u ---
  const colored = [];
  function highlight(layer){
    const colors = ["#FFD700","#FFA500","#1E90FF","#32CD32","#FF69B4"];
    const c = colors[Math.floor(Math.random()*colors.length)];
    layer.setStyle({ fillColor:c, fillOpacity:0.5 });
    colored.push(layer);
  }
  function clearColors(){
    colored.forEach(l => l.setStyle({ fillOpacity:0.1, fillColor:null }));
    colored.length = 0;
  }

  // --- C√¥ng c·ª• b·∫£n ƒë·ªì ---
  L.control.scale().addTo(map);
  L.control.locate({strings:{title:"ƒê·ªãnh v·ªã GPS"}}).addTo(map);
  L.control.measure({ primaryLengthUnit:'meters', secondaryLengthUnit:'kilometers', primaryAreaUnit:'sqmeters' }).addTo(map);
  L.control.compass({autoActive:true, showDigit:true, position:'topright'}).addTo(map);

  // --- Layer control ---
  const overlayMaps = {
    "üó∫Ô∏è ƒê·ªãa gi·ªõi ph∆∞·ªùng/x√£": phuongXaGroup,
    "üèôÔ∏è Ranh gi·ªõi qu·∫≠n/huy·ªán": quanHuyenGroup,
    "üî§ T√™n ƒë·ªãa danh": labelGroup
  };
  L.control.layers(baseMaps, overlayMaps).addTo(map);

  // --- N√∫t x√≥a t√¥ m√†u ---
  const panel = L.control({position:'topright'});
  panel.onAdd = function(){
    const div = L.DomUtil.create('div','leaflet-bar');
    div.innerHTML = `<button onclick="window._clearColors()">üé® X√≥a t√¥ m√†u</button>`;
    return div;
  };
  panel.addTo(map);
  window._clearColors = clearColors;

  // --- T·ª± ƒë·ªông ƒë·ªïi n·ªÅn ---
  map.on('zoomend', function() {
    if (map.getZoom() > 14) {
      if (!map.hasLayer(esriImagery)) map.addLayer(esriImagery);
    } else {
      if (map.hasLayer(esriImagery)) map.removeLayer(esriImagery);
    }
  });

  // --- T√¨m ki·∫øm ƒë·ªãa danh ---
  function addSearchControl(list){
    const geocoder = L.Control.geocoder({
      defaultMarkGeocode: false,
      placeholder: 'üîç T√¨m ph∆∞·ªùng/x√£ ho·∫∑c qu·∫≠n...',
      errorMessage: 'Kh√¥ng t√¨m th·∫•y',
    }).addTo(map);

    const input = geocoder._input;
    input.addEventListener('input', function(){
      const keyword = this.value.toLowerCase();
      const match = list.find(i => i.name.toLowerCase().includes(keyword));
      if(match) {
        const bounds = match.layer.getBounds();
        map.fitBounds(bounds);
        match.layer.openPopup();
      }
    });
  }

  // --- Load ---
  loadHCM();
};
</script>
</body>
</html>

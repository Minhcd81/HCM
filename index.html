<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>HCM WebGIS v12 ‚Äî Unified Search + Compass Overlay + TSBƒê/TSSS + Export</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
<link rel="preconnect" href="https://unpkg.com">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script src="https://unpkg.com/leaflet-easyprint@2.1.9/dist/bundle.js"></script>
<!-- SheetJS: xu·∫•t Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.0/dist/xlsx.full.min.js"></script>
<!-- Google: b·∫≠t Places + Geometry cho key c·ªßa anh -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places,geometry"></script>

<style>
:root{--pri:#00BFFF}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Roboto',Arial,sans-serif}
#map{position:absolute;inset:0}

/* Unified search */
#searchWrap{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:1400;width:860px;max-width:92vw}
#search{width:100%;padding:12px 14px;border:1px solid #cfd4dc;border-radius:14px;background:#fff;
        box-shadow:0 2px 8px rgba(0,0,0,.15)}
#search::placeholder{color:#8a8f98}
#localSuggest{position:absolute;left:0;right:0;margin-top:8px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;
              box-shadow:0 12px 28px rgba(0,0,0,.18);display:none;max-height:300px;overflow:auto}
.sug-header{padding:6px 10px;font-size:12px;color:#6b7280;border-bottom:1px solid #f1f5f9}
.sug-item{padding:10px 12px;cursor:pointer}
.sug-item:hover{background:#f6faff}

/* Tools (right) */
#tools{position:absolute;right:10px;top:72px;z-index:1200;display:flex;flex-direction:column;gap:10px}
.toolbtn{background:#fff;border:1px solid #ddd;border-radius:50%;width:48px;height:48px;cursor:pointer;
display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.toolbtn:hover{background:#f5f8ff}

/* Measure menu */
#measureMenu{position:absolute;right:70px;top:122px;background:#fff;border:1px solid #ddd;border-radius:12px;
box-shadow:0 8px 24px rgba(0,0,0,.18);display:none;z-index:1300}
#measureMenu button{display:block;width:240px;padding:10px 14px;border:none;background:#fff;text-align:left;cursor:pointer;font-size:14px}
#measureMenu button:hover{background:#f1f5f9}

/* Clear */
#btnClear{position:absolute;right:10px;top:230px;z-index:1200;background:#fff;border:1px solid #ddd;border-radius:12px;
padding:8px 12px;box-shadow:0 2px 6px rgba(0,0,0,.15);cursor:pointer}

/* Sidebar */
#sidebarToggle{position:absolute;left:10px;top:120px;z-index:1200;background:#fff;border:1px solid #ddd;border-radius:12px;
padding:8px 12px;box-shadow:0 2px 6px rgba(0,0,0,.15);cursor:pointer}
#sidebar{position:fixed;left:0;top:0;height:100%;width:380px;background:#fff;box-shadow:4px 0 20px rgba(0,0,0,.2);
transform:translateX(-400px);transition:transform .28s ease;z-index:1600;display:flex;flex-direction:column}
#sidebar.open{transform:translateX(0)}
#sbHead{background:var(--pri);color:#fff;padding:14px 16px;font-weight:700;display:flex;align-items:center;justify-content:space-between}
#sidebarClose{border:none;background:transparent;color:#fff;font-size:22px;cursor:pointer}
#sbBody{padding:12px 12px 90px;overflow:auto}
.section{border:1px solid #e5e7eb;border-radius:12px;padding:10px 10px 6px;margin-bottom:10px}
.section h4{margin:0 0 8px;font-size:14px}
.form-row{display:flex;gap:8px;margin-bottom:8px}
.form-row input,.form-row select,.form-row textarea{flex:1;padding:9px;border:1px solid #cfd4dc;border-radius:10px}
.small{font-size:12px;color:#6b7280}

/* Compass overlay (transparent 100%) */
#compassOverlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:260px;height:260px;
pointer-events:none;display:none;z-index:1300}
#compassCanvas{width:100%;height:100%}

/* Coords footer */
.coords{position:absolute;left:10px;bottom:6px;background:rgba(255,255,255,.9);padding:4px 8px;border-radius:8px;font:12px monospace;z-index:1000}

/* Responsive */
@media(max-width:768px){
  #searchWrap{width:92vw}
  #tools{flex-direction:row;bottom:10px;top:auto;right:50%;transform:translateX(50%)}
  #btnClear,#sidebarToggle{bottom:70px;top:auto}
  #sidebar{width:92vw;transform:translateX(-100vw)}
  #compassOverlay{width:220px;height:220px}
}
</style>
</head>
<body>
<!-- Unified search -->
<div id="searchWrap">
  <input id="search" placeholder="üîç ƒê·ªãa ch·ªâ / Ph∆∞·ªùng-X√£ / T√™n c≈© tr∆∞·ªõc s√°p nh·∫≠p / T·ªça ƒë·ªô (vd: 10.79844, 106.65855)">
  <div id="localSuggest"></div>
</div>

<div id="map"></div>

<!-- Tools -->
<div id="tools">
  <button id="btnCompass" class="toolbtn" title="ƒêo h∆∞·ªõng nh√† (b·∫≠t/·∫©n la b√†n)">üß≠</button>
  <button id="btnMeasure" class="toolbtn" title="ƒêo (kho·∫£ng c√°ch/di·ªán t√≠ch)">üìè</button>
  <button id="btnGPS" class="toolbtn" title="ƒê·ªãnh v·ªã">üìç</button>
</div>
<div id="measureMenu">
  <button id="mDist">üìçüìç ƒêo kho·∫£ng c√°ch</button>
  <button id="mArea">‚¨õ ƒêo di·ªán t√≠ch</button>
  <button id="mFinish">üõë Ho√†n t·∫•t ƒëo</button>
</div>
<button id="btnClear">üßπ X√≥a t√¥ m√†u</button>

<!-- Sidebar TSBƒê/TSSS (g·ªôp) -->
<button id="sidebarToggle">üìã TSBƒê / TSSS</button>
<div id="sidebar">
  <div id="sbHead">
    <span>üìã TSBƒê / TSSS</span>
    <button id="sidebarClose">√ó</button>
  </div>
  <div id="sbBody">
    <!-- TSBƒê -->
    <div class="section">
      <h4>TSBƒê</h4>
      <div class="form-row">
        <select id="tsbdLoai"><option>Nh√† ·ªü</option><option>ƒê·∫•t tr·ªëng</option><option>CƒÉn h·ªô</option></select>
        <input id="tsbdDientich" placeholder="Di·ªán t√≠ch (m¬≤)" type="number">
      </div>
      <div class="form-row">
        <input id="tsbdGia" placeholder="Gi√° tr·ªã (t·ª∑)" type="number">
        <input id="tsbdTen" placeholder="T√™n/ƒê·ªãa ch·ªâ t√†i s·∫£n">
      </div>
      <div class="form-row">
        <input id="tsbdLat" placeholder="Lat">
        <input id="tsbdLng" placeholder="Lng">
      </div>
      <div class="form-row">
        <textarea id="tsbdGhiChu" rows="2" placeholder="Ghi ch√∫"></textarea>
      </div>
      <div class="form-row">
        <button id="tsbdPin">üìç ƒê·∫∑t ƒëi·ªÉm</button>
        <button id="tsbdStreet">üëÅÔ∏è Street View</button>
        <button id="btnShot">üì∑ Ch·ª•p ·∫£nh PNG</button>
      </div>
      <div class="small">M·∫πo: nh·∫≠p Lat/Lng r·ªìi ‚Äúƒê·∫∑t ƒëi·ªÉm‚Äù ƒë·ªÉ ghim TSBƒê.</div>
    </div>

    <!-- TSSS -->
    <div class="section">
      <h4>T√†i s·∫£n so s√°nh (TSSS)</h4>
      <div class="form-row">
        <input id="tsssTen" placeholder="T√™n/ƒê·ªãa ch·ªâ so s√°nh">
        <input id="tsssGia" placeholder="Gi√° (t·ª∑)" type="number">
      </div>
      <div class="form-row">
        <input id="tsssLat" placeholder="Lat">
        <input id="tsssLng" placeholder="Lng">
      </div>
      <div class="form-row">
        <button id="tsssAdd">‚ûï Th√™m TSSS (auto n·ªëi)</button>
        <button id="tsssClear">üóëÔ∏è X√≥a t·∫•t c·∫£ TSSS</button>
      </div>
      <div id="tsssList" class="small">Ch∆∞a c√≥ m·ª•c so s√°nh n√†o.</div>

      <div class="form-row" style="margin-top:10px">
        <button id="btnExportCSV">üìÑ Xu·∫•t CSV</button>
        <button id="btnExportXLSX">üìò Xu·∫•t Excel (.xlsx)</button>
      </div>
      <div class="small">File xu·∫•t g·ªìm: STT, T√™n, Lat, Lng, Gi√° (t·ª∑), Kho·∫£ng c√°ch (m), Ghi ch√∫.</div>
    </div>
  </div>
</div>

<!-- Compass overlay -->
<div id="compassOverlay"><canvas id="compassCanvas" width="260" height="260"></canvas></div>

<div class="coords" id="coords">Lat: --, Lng: --</div>

<script>
/* ================== MAP BASE ================== */
const map=L.map('map',{center:[10.776,106.7],zoom:12});
const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
const gStreet=L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}');
const gHybrid=L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}');
L.control.layers({"üó∫Ô∏è OSM":osm,"üåç Google Street":gStreet,"üõ∞Ô∏è Google Hybrid":gHybrid}).addTo(map);

let coloredLayers=[], lastMarker=null;

/* ================== SIDEBAR ================== */
const sidebar=document.getElementById('sidebar');
document.getElementById('sidebarToggle').onclick=()=>sidebar.classList.add('open');
document.getElementById('sidebarClose').onclick=()=>sidebar.classList.remove('open');

/* ================== GEOJSON (popup + indexes) ================== */
let gjLayer=null, allFeatures=[], wardIndex=new Map(), oldNameIndex=new Map();
fetch('assets/TPHCM.geojson').then(r=>r.json()).then(geo=>{
  gjLayer=L.geoJSON(geo,{style:baseStyle,onEachFeature:(f,l)=>{
    const p=f.properties||{};
    const ten=(p.ten_xa??'').toString().trim();
    const qh=(p.quan_huyen??'').toString().trim();
    const snRaw=(p.sap_nhap??'').toString().trim();
    const sn=(snRaw && snRaw!=='0')?snRaw:'‚Äî';
    const dt=(p.dtich_km2!=null)?`${p.dtich_km2} km¬≤`:'‚Äî';
    const ds=(p.dan_so!=null)?`${Number(p.dan_so).toLocaleString('vi-VN')} ng∆∞·ªùi`:'‚Äî';

    l.bindPopup(`<b>${ten}</b><br>${qh}<br>Tr∆∞·ªõc s√°p nh·∫≠p: ${sn}<br>Di·ªán t√≠ch: ${dt}<br>D√¢n s·ªë: ${ds}`);
    l.on('click',()=>{const c=randColor(); l.setStyle({fillColor:c,fillOpacity:.5}); if(!coloredLayers.includes(l)) coloredLayers.push(l);});

    allFeatures.push({layer:l,props:p});
    const kWard=normalize(ten);
    if(!wardIndex.has(kWard)) wardIndex.set(kWard,[]);
    wardIndex.get(kWard).push(l);
    if(snRaw && snRaw!=='0'){
      snRaw.split(',').map(s=>s.trim()).filter(Boolean).forEach(old=>{
        const kOld=normalize(old);
        if(!oldNameIndex.has(kOld)) oldNameIndex.set(kOld,[]);
        oldNameIndex.get(kOld).push(l);
      });
    }
  }}).addTo(map);

  setupUnifiedSearch();
}).catch(()=>alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c assets/TPHCM.geojson, ki·ªÉm tra ƒë∆∞·ªùng d·∫´n.'));

function baseStyle(){ return {color:'#555',weight:1,fillOpacity:.15}; }
function deemphStyle(){ return {color:'#888',weight:1,fillOpacity:.08,fillColor:null}; }
function emphStyle(){ return {color:'#1a4d7a',weight:2.5,fillOpacity:.45,fillColor:varPri()}; }
function varPri(){ return getComputedStyle(document.documentElement).getPropertyValue('--pri') || '#00BFFF'; }
function randColor(){ const a=['#FFD700','#FFA500','#FF4500','#8A2BE2','#1E90FF','#00CED1']; return a[(Math.random()*a.length)|0]; }
function normalize(s){ return (s||'').toString().trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }

/* ================== UNIFIED SEARCH (Places + ward + old + latlng) ================== */
function setupUnifiedSearch(){
  const input=document.getElementById('search');
  const sug=document.getElementById('localSuggest');

  // Google Places Autocomplete
  let ac=null;
  try{
    ac=new google.maps.places.Autocomplete(input,{types:['geocode'],componentRestrictions:{country:'vn'}});
    ac.addListener('place_changed',()=>{
      const place=ac.getPlace();
      if(place && place.geometry && place.geometry.location){
        const lat=place.geometry.location.lat(), lng=place.geometry.location.lng();
        placeMarker(lat,lng,place.formatted_address||'V·ªã tr√≠ ƒë√£ ch·ªçn');
        hideSuggest();
      }
    });
  }catch(e){ console.warn('Places Autocomplete kh√¥ng kh·∫£ d·ª•ng.', e); }

  // Enter: lat,lng or local search
  input.addEventListener('keydown',e=>{
    if(e.key!=='Enter') return;
    const val=input.value.trim();
    const m=val.match(/^(-?\d+(?:\.\d+)?),\s*(-?\d+(?:\.\d+)?)/);
    if(m){ placeMarker(+m[1],+m[2],'T·ªça ƒë·ªô nh·∫≠p tay'); hideSuggest(); return; }
    if(handleLocalSearch(val)){ hideSuggest(); return; }
    geocodeFallback(val);
  });

  // g·ª£i √Ω n·ªôi b·ªô (ward/old) khi g√µ ‚â•3 k√Ω t·ª±
  input.addEventListener('input',()=>{
    const val=input.value.trim();
    if(val.length<3){ hideSuggest(); return; }
    const q=normalize(val);
    const wardHits=[...wardIndex.keys()].filter(k=>k.includes(q)).slice(0,5);
    const oldHits=[...oldNameIndex.keys()].filter(k=>k.includes(q)).slice(0,5);

    if(wardHits.length===0 && oldHits.length===0){ hideSuggest(); return; }
    sug.innerHTML=`${wardHits.length?`<div class="sug-header">Ph∆∞·ªùng/X√£</div>`:''}${
      wardHits.map(w=>`<div class="sug-item" data-type="ward" data-key="${w}">${restoreCase(w)}</div>`).join('')
    }${oldHits.length?`<div class="sug-header">T√™n c≈© tr∆∞·ªõc s√°p nh·∫≠p</div>`:''}${
      oldHits.map(w=>`<div class="sug-item" data-type="old" data-key="${w}">${restoreCase(w)}</div>`).join('')
    }`;
    sug.style.display='block';
  });

  sug.addEventListener('click',e=>{
    const item=e.target.closest('.sug-item'); if(!item) return;
    const type=item.dataset.type, key=item.dataset.key;
    if(type==='ward') zoomToFromIndex(wardIndex,key);
    else if(type==='old') zoomToFromIndex(oldNameIndex,key);
    hideSuggest();
  });

  function hideSuggest(){ sug.style.display='none'; }
  function restoreCase(slug){ return slug.split(' ').map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(' '); }

  async function geocodeFallback(val){
    try{
      const url=`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(val)}&key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA`;
      const r=await fetch(url); const d=await r.json();
      if(d.status==='OK'){
        const loc=d.results[0].geometry.location;
        placeMarker(loc.lat,loc.lng,d.results[0].formatted_address);
      }else alert('Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ. Th·ª≠ g√µ r√µ h∆°n ho·∫∑c nh·∫≠p t·ªça ƒë·ªô.');
    }catch{ alert('M·∫°ng ch·∫≠m ho·∫∑c Geocoding l·ªói. Th·ª≠ l·∫°i nh√©.'); }
  }
}

function zoomToFromIndex(index,key){
  const layers=index.get(key); if(!layers||!layers.length){ alert('Kh√¥ng t√¨m th·∫•y.'); return; }
  const l=layers[0];
  allFeatures.forEach(({layer})=>layer.setStyle(deemphStyle()));
  l.setStyle(emphStyle()); l.bringToFront();
  map.fitBounds(l.getBounds().pad(0.2));
  l.openPopup();
}
function handleLocalSearch(val){
  const q=normalize(val);
  let layers=wardIndex.get(q);
  if(!layers){
    const hit=[...wardIndex.keys()].find(k=>k.startsWith(q))||[...wardIndex.keys()].find(k=>k.includes(q));
    if(hit) layers=wardIndex.get(hit);
  }
  if(!layers){
    layers=oldNameIndex.get(q);
    if(!layers){
      const hit=[...oldNameIndex.keys()].find(k=>k.startsWith(q))||[...oldNameIndex.keys()].find(k=>k.includes(q));
      if(hit) layers=oldNameIndex.get(hit);
    }
  }
  if(!layers) return false;
  const l=layers[0];
  allFeatures.forEach(({layer})=>layer.setStyle(deemphStyle()));
  l.setStyle(emphStyle()); l.bringToFront();
  map.fitBounds(l.getBounds().pad(0.2));
  l.openPopup();
  return true;
}

/* ================== Marker & StreetView ================== */
function placeMarker(lat,lng,label){
  map.setView([lat,lng],17);
  if(lastMarker) map.removeLayer(lastMarker);
  lastMarker=L.marker([lat,lng]).addTo(map)
    .bindPopup(`<b>${label||''}</b><br><button id='svbtn'>üëÅÔ∏è Xem Street View t·∫°i v·ªã tr√≠ n√†y</button>`).openPopup();
  setTimeout(()=>{const b=document.getElementById('svbtn'); if(b) b.onclick=()=>openStreetView(lat,lng);},120);
}
function openStreetView(lat,lng){
  const html=`<iframe width='350' height='250' style='border:0' loading='lazy'
    referrerpolicy='no-referrer-when-downgrade'
    src='https://www.google.com/maps/embed?pb=!4v1665600758447!6m8!1m7!1sCAoSLEFGMVFpcE1Xd2VoQllvT2F2TkFwSGlDaTZYVFF6b1pHOUdwa3JtX3lPaUo3!2m2!1d${lat}!2d${lng}!3f0!4f0!5f0!0'></iframe>`;
  L.popup().setLatLng([lat,lng]).setContent(html).openOn(map);
}

/* ================== Measure (distance/area) ================== */
const drawnItems=new L.FeatureGroup().addTo(map);
let activeDraw=null;
function stopMeasure(){if(activeDraw){activeDraw.disable();activeDraw=null;}}
document.getElementById('btnMeasure').onclick=()=>{const m=document.getElementById('measureMenu');m.style.display=m.style.display==='block'?'none':'block';};
document.getElementById('mDist').onclick=()=>{stopMeasure();activeDraw=new L.Draw.Polyline(map,{shapeOptions:{color:varPri()}});activeDraw.enable();document.getElementById('measureMenu').style.display='none';};
document.getElementById('mArea').onclick=()=>{stopMeasure();activeDraw=new L.Draw.Polygon(map,{shapeOptions:{color:varPri(),fillOpacity:.2}});activeDraw.enable();document.getElementById('measureMenu').style.display='none';};
document.getElementById('mFinish').onclick=()=>{stopMeasure();document.getElementById('measureMenu').style.display='none';};
map.on(L.Draw.Event.CREATED,e=>{
  const layer=e.layer;drawnItems.addLayer(layer);
  if(e.layerType==='polyline'){
    const coords=layer.getLatLngs().map(ll=>[ll.lng,ll.lat]);let len=0;for(let i=1;i<coords.length;i++){len+=turf.distance(coords[i-1],coords[i],{units:'kilometers'});}
    layer.bindPopup('Chi·ªÅu d√†i: '+(len*1000).toFixed(1)+' m').openPopup();
  }else if(e.layerType==='polygon'){
    const coords=[layer.getLatLngs()[0].map(ll=>[ll.lng,ll.lat])];const poly=turf.polygon([coords[0]]);const area=turf.area(poly);
    layer.bindPopup('Di·ªán t√≠ch: '+area.toFixed(0)+' m¬≤').openPopup();
  }
});

/* ================== Compass overlay (Meeymap style) ================== */
const compassEl=document.getElementById('compassOverlay');
const cv=document.getElementById('compassCanvas'), ctx=cv.getContext('2d');
let compassOn=false, deviceHeading=0, liveBearing=null, bearingMode=false;
const R=cv.width/2, C=R;

function drawCompass(){
  ctx.clearRect(0,0,cv.width,cv.height);
  ctx.strokeStyle='rgba(0,0,0,.35)'; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.arc(C,C,R-6,0,Math.PI*2); ctx.stroke();
  for(let d=0; d<360; d+=10){
    const len=(d%30===0)?10:5, a=(d-deviceHeading)*Math.PI/180;
    const r1=R-14, r2=r1-len;
    ctx.beginPath();
    ctx.moveTo(C+Math.cos(a)*r1, C+Math.sin(a)*r1);
    ctx.lineTo(C+Math.cos(a)*r2, C+Math.sin(a)*r2);
    ctx.stroke();
  }
  labelAt('B',0); labelAt('ƒê',90); labelAt('N',180); labelAt('T',270);
  function labelAt(text,deg){
    const a=(deg-deviceHeading)*Math.PI/180, r=R-34;
    ctx.fillStyle='#111'; ctx.font='700 14px Roboto'; ctx.textAlign='center';
    const x=C+Math.cos(a)*r, y=C+Math.sin(a)*r+5; ctx.fillText(text,x,y);
  }
  ctx.save(); ctx.translate(C,C); ctx.rotate((-deviceHeading)*Math.PI/180);
  ctx.fillStyle='#d00'; ctx.beginPath(); ctx.moveTo(0,-(R-34)); ctx.lineTo(7,0); ctx.lineTo(-7,0); ctx.closePath(); ctx.fill(); ctx.restore();
  if(liveBearing!=null){ ctx.fillStyle='#111'; ctx.font='700 16px Roboto'; ctx.textAlign='center'; ctx.fillText(`${liveBearing.toFixed(0)}¬∞`, C, C+R-50); }
}
function setCompass(on){
  compassOn=on; bearingMode=on; compassEl.style.display = on ? 'block' : 'none'; liveBearing=null; if(on) drawCompass();
}
document.getElementById('btnCompass').onclick=()=> setCompass(!compassOn);
window.addEventListener('deviceorientation',e=>{
  if(typeof e.alpha==='number'){ deviceHeading = 360 - e.alpha; if(compassOn) drawCompass(); }
});
let bearingStart=null, tempLine=null;
map.on('click',e=>{
  if(!bearingMode) return;
  if(!bearingStart){ bearingStart=e.latlng; if(tempLine){ map.removeLayer(tempLine); tempLine=null; } }
  else{
    const brg = bearingBetween(bearingStart,e.latlng);
    liveBearing = normalizeDeg(brg - deviceHeading);
    if(tempLine){ tempLine.bindPopup(`H∆∞·ªõng: ${liveBearing.toFixed(0)}¬∞`).openPopup(); }
    bearingStart=null;
  }
});
map.on('mousemove',e=>{
  if(!bearingMode||!bearingStart) return;
  const pts=[bearingStart,e.latlng];
  if(!tempLine) tempLine=L.polyline(pts,{color:'#00BFFF',weight:3,dashArray:'6,6'}).addTo(map);
  else tempLine.setLatLngs(pts);
  const brg = bearingBetween(bearingStart,e.latlng);
  liveBearing = normalizeDeg(brg - deviceHeading); drawCompass();
});
function bearingBetween(a,b){
  const brg = turf.bearing([a.lng,a.lat],[b.lng,b.lat]); return (brg+360)%360;
}
function normalizeDeg(d){ d%=360; if(d<0)d+=360; return d; }

/* ================== GPS ================== */
const locateCtrl=L.control.locate({strings:{title:"V·ªã tr√≠ c·ªßa t√¥i"},showCompass:true,setView:'untilPanOrZoom'});
document.getElementById('btnGPS').onclick=()=>{ if(!locateCtrl._map) locateCtrl.addTo(map); locateCtrl.start(); };

/* ================== CLEAR COLORS ================== */
document.getElementById('btnClear').onclick=()=>{ coloredLayers.forEach(l=>l.setStyle({fillColor:null,fillOpacity:.15})); coloredLayers=[]; };

/* ================== FOOTER COORDS ================== */
map.on('mousemove',e=>document.getElementById('coords').textContent=`Lat:${e.latlng.lat.toFixed(5)}, Lng:${e.latlng.lng.toFixed(5)}`);

/* ================== TSBƒê / TSSS ================== */
let tsbdMarker=null, tsssMarkers=[], tsssLines=[];
const fmtM = m => `${m.toFixed(1)} m`;

function readLatLng(latId,lngId){
  const lat=parseFloat(document.getElementById(latId).value);
  const lng=parseFloat(document.getElementById(lngId).value);
  return (isFinite(lat)&&isFinite(lng))?{lat,lng}:null;
}
function updateTSSSList(){
  const box=document.getElementById('tsssList');
  if(tsssMarkers.length===0){ box.textContent='Ch∆∞a c√≥ m·ª•c so s√°nh n√†o.'; return; }
  box.innerHTML=tsssMarkers.map((m,i)=>`‚Ä¢ ${m.meta?.name||'TSSS'} ‚Äî ${m.getLatLng().lat.toFixed(5)}, ${m.getLatLng().lng.toFixed(5)} ‚Äî Gi√°: ${m.meta?.price??''} t·ª∑`).join('<br>');
}

document.getElementById('tsbdPin').onclick=()=>{
  const pt=readLatLng('tsbdLat','tsbdLng'); if(!pt){ alert('Nh·∫≠p Lat/Lng h·ª£p l·ªá cho TSBƒê'); return; }
  if(tsbdMarker) map.removeLayer(tsbdMarker);
  tsbdMarker=L.marker([pt.lat,pt.lng],{title:'TSBƒê'}).addTo(map)
    .bindPopup(`<b>TSBƒê</b><br>${document.getElementById('tsbdTen').value||''}`).openPopup();
  map.setView([pt.lat,pt.lng],17);
  redrawTSSSLines();
};
document.getElementById('tsbdStreet').onclick=()=>{
  const pt=readLatLng('tsbdLat','tsbdLng'); if(!pt){ alert('Nh·∫≠p Lat/Lng h·ª£p l·ªá cho TSBƒê'); return; }
  openStreetView(pt.lat,pt.lng);
};

/* Ch·ª•p ·∫£nh PNG */
let printer=L.easyPrint({ tileLayer: osm, sizeModes: ['Current'], filename: 'HCM_Map', exportOnly: true, hideControlContainer: true }).addTo(map);
document.getElementById('btnShot').onclick=()=>{
  try{ printer.printMap('CurrentSize','HCM_Map'); }
  catch(e){ alert('Ch·ª•p ·∫£nh kh√¥ng th√†nh c√¥ng. Vui l√≤ng th·ª≠ l·∫°i!'); console.error(e); }
};

/* Th√™m TSSS (auto-connect) */
document.getElementById('tsssAdd').onclick=()=>{
  const pt=readLatLng('tsssLat','tsssLng'); if(!pt){ alert('Nh·∫≠p Lat/Lng h·ª£p l·ªá cho TSSS'); return; }
  const name=document.getElementById('tsssTen').value||'TSSS';
  const price=parseFloat(document.getElementById('tsssGia').value);
  const m=L.marker([pt.lat,pt.lng],{title:name}).addTo(map); m.meta={name,price:isFinite(price)?price:null};
  tsssMarkers.push(m);

  if(tsbdMarker){
    const a=tsbdMarker.getLatLng(), b=m.getLatLng();
    const line=L.polyline([a,b],{color:'#00BFFF',weight:3,opacity:.8}).addTo(map);
    const dist=turf.distance([a.lng,a.lat],[b.lng,b.lat],{units:'kilometers'})*1000;
    line.bindPopup(`Kho·∫£ng c√°ch TSBƒê ‚Üî ${name}: <b>${fmtM(dist)}</b>`);
    tsssLines.push(line);
  }

  m.bindPopup(`<b>${name}</b><br>${pt.lat.toFixed(5)}, ${pt.lng.toFixed(5)}${isFinite(price)?`<br>Gi√°: ${price} t·ª∑`:''}`);
  updateTSSSList(); map.setView([pt.lat,pt.lng],17);
};
document.getElementById('tsssClear').onclick=()=>{
  tsssMarkers.forEach(m=>map.removeLayer(m));
  tsssLines.forEach(l=>map.removeLayer(l));
  tsssMarkers=[]; tsssLines=[];
  updateTSSSList();
};
function redrawTSSSLines(){
  tsssLines.forEach(l=>map.removeLayer(l));
  tsssLines=[];
  if(!tsbdMarker) return;
  const a=tsbdMarker.getLatLng();
  tsssMarkers.forEach(m=>{
    const b=m.getLatLng();
    const line=L.polyline([a,b],{color:'#00BFFF',weight:3,opacity:.8}).addTo(map);
    const dist=turf.distance([a.lng,a.lat],[b.lng,b.lat],{units:'kilometers'})*1000;
    line.bindPopup(`Kho·∫£ng c√°ch TSBƒê ‚Üî ${m.meta?.name||'TSSS'}: <b>${fmtM(dist)}</b>`);
    tsssLines.push(line);
  });
}

/* ================== EXPORT CSV / EXCEL ================== */
function collectExportRows(){
  const rows=[];
  if(!tsbdMarker){ alert('Vui l√≤ng ƒë·∫∑t ƒëi·ªÉm TSBƒê tr∆∞·ªõc khi xu·∫•t.'); return null; }
  const a=tsbdMarker.getLatLng();
  tsssMarkers.forEach((m,idx)=>{
    const b=m.getLatLng();
    const distM=turf.distance([a.lng,a.lat],[b.lng,b.lat],{units:'kilometers'})*1000;
    rows.push({
      STT: idx+1,
      Ten: m.meta?.name||'TSSS',
      Lat: +b.lat.toFixed(6),
      Lng: +b.lng.toFixed(6),
      Gia_ty: (m.meta?.price!=null)? m.meta.price : '',
      Khoang_cach: `${distM.toFixed(1)} m`,
      Ghi_chu: ''
    });
  });
  if(rows.length===0){ alert('Ch∆∞a c√≥ TSSS ƒë·ªÉ xu·∫•t.'); return null; }
  return rows;
}
function timestamp(){ const d=new Date(); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}`; }

document.getElementById('btnExportCSV').onclick=()=>{
  const rows=collectExportRows(); if(!rows) return;
  const headers=['STT','Ten','Lat','Lng','Gia_ty','Khoang_cach','Ghi_chu'];
  const csv=[headers.join(','), ...rows.map(r=>headers.map(h=>{
    const v=r[h]==null?'':String(r[h]).replace(/"/g,'""');
    return /[",\n]/.test(v)?`"${v}"`:v;
  }).join(','))].join('\n');
  const blob=new Blob([`\uFEFF${csv}`],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`TSSS_Export_HCM_${timestamp()}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
};

document.getElementById('btnExportXLSX').onclick=()=>{
  const rows=collectExportRows(); if(!rows) return;
  const ws=XLSX.utils.json_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'TSSS');
  XLSX.writeFile(wb,`TSSS_Export_HCM_${timestamp()}.xlsx`);
};
</script>
</body>
</html>

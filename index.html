<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>HCM WebGIS ‚Äì Quy ho·∫°ch & ƒê·ªãa gi·ªõi h√†nh ch√≠nh TP.HCM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet & plugin -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-compass/dist/leaflet-compass.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>

<style>
  html, body, #map {height:100%; margin:0; padding:0;}
  .leaflet-bar button {display:block; width:100%; border:none; background:white; padding:5px; cursor:pointer;}
  .leaflet-bar button:hover {background:#eee;}
  .coords {
    position:absolute; bottom:5px; left:10px;
    background:rgba(255,255,255,0.9); padding:3px 8px;
    border-radius:4px; font-size:12px; font-family:monospace; z-index:1000;
  }
  #search-box {
    position:absolute; top:10px; left:50%; transform:translateX(-50%);
    z-index:1500; width:300px;
  }
  #search-input {
    width:100%; padding:6px 10px; border-radius:5px; border:1px solid #999;
    box-shadow:0 2px 5px rgba(0,0,0,0.2);
  }
</style>
</head>
<body>
<div id="search-box"><input id="search-input" type="text" placeholder="üîç Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c t√™n ph∆∞·ªùng..."></div>
<div id="map"></div>
<div id="coords" class="coords">Lat: --, Lng: --</div>

<!-- JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.js"></script>
<script src="https://unpkg.com/leaflet-compass/dist/leaflet-compass.min.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
window.onload = function() {
  const map = L.map('map', {center:[10.776,106.7], zoom:12});

  // --- L·ªõp n·ªÅn ---
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
  const googleStreet = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA',{attribution:'¬© Google'});
  const googleHybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}&key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA',{attribution:'¬© Google'});
  const bingRoad = L.tileLayer('https://ecn.t{s}.tiles.virtualearth.net/tiles/r{q}.jpeg?g=1',{subdomains:['0','1','2','3'], attribution:'¬© Bing Maps'});
  const bingAerial = L.tileLayer('https://ecn.t{s}.tiles.virtualearth.net/tiles/a{q}.jpeg?g=1',{subdomains:['0','1','2','3'], attribution:'¬© Bing Maps'});
  const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'¬© Esri'});

  const baseMaps = {
    "üó∫Ô∏è OSM": osm,
    "üåç Google Street": googleStreet,
    "üõ∞Ô∏è Google Hybrid": googleHybrid,
    "üóæ Bing Road": bingRoad,
    "üåÑ Bing Aerial": bingAerial,
    "üå§Ô∏è Esri Imagery": esriImagery
  };

  const hanhChinhGroup = L.layerGroup(), quyHoachGroup = L.layerGroup();
  let colored = [], measureCtrl, compassCtrl;

  // --- H√†m t√¥ m√†u theo m√£ quy ho·∫°ch ---
  function getColor(ma) {
    if(!ma) return "#cccccc";
    const colors = {
      "ODT":"#e41a1c","ONT":"#fb9a99","CX":"#4daf4a","CXCL":"#a1d99b",
      "DGT":"#999999","CC":"#ffcc00","MN":"#6baed6","HTKT":"#984ea3","TG":"#fdb462"
    };
    for(const [k,v] of Object.entries(colors)){ if(ma.includes(k)) return v; }
    return "#ccc";
  }

  // --- L·ªõp h√†nh ch√≠nh ---
  fetch('assets/TPHCM.geojson')
    .then(res=>res.json())
    .then(data=>{
      const layer=L.geoJSON(data,{
        style:{color:"#ff6600",weight:1,fillOpacity:0.1},
        onEachFeature:(f,l)=>{
          const p=f.properties||{};
          const ten=p.ten_xa||'',quan=p.quan_huyen||'',dt=p.dtich_km2?`${p.dtich_km2.toFixed(2)} km¬≤`:"-",ds=p.dan_so?p.dan_so.toLocaleString()+" ng∆∞·ªùi":"-";
          const sap=p.sap_nhap?`<br><i>${p.sap_nhap}</i>`:"";
          l.bindPopup(`<b>${ten}</b><br>${quan}<br>${dt}<br>${ds}${sap}`);
        }
      }).addTo(hanhChinhGroup);
    });

  // --- L·ªõp quy ho·∫°ch ---
  fetch('assets/QHPKSDD_SHAPE.json')
    .then(res=>res.json())
    .then(data=>{
      const qh=L.geoJSON(data,{
        style:f=>({
          color:"#555",weight:0.3,fillColor:getColor(f.properties.MaQuyUoc),
          fillOpacity:0.6
        }),
        onEachFeature:(f,l)=>{
          const p=f.properties||{};
          l.bindPopup(`<b>M√£:</b> ${p.MaQuyUoc||''}<br><b>Ch·ª©c nƒÉng:</b> ${p.ChucNang||''}`);
        }
      }).addTo(quyHoachGroup);
    });

  // --- C√¥ng c·ª• ---
  L.control.scale().addTo(map);
  L.control.locate({strings:{title:"ƒê·ªãnh v·ªã GPS"}}).addTo(map);

  function toggleTools(){
    if(measureCtrl){map.removeControl(measureCtrl);map.removeControl(compassCtrl);measureCtrl=null;compassCtrl=null;}
    else{
      measureCtrl=L.control.measure({primaryLengthUnit:'meters',secondaryLengthUnit:'kilometers',primaryAreaUnit:'sqmeters'}).addTo(map);
      compassCtrl=L.control.compass({autoActive:true,showDigit:true,position:'topright'}).addTo(map);
    }
  }

  // --- T√¨m ki·∫øm ƒë·ªãa ch·ªâ ---
  const input=document.getElementById('search-input');
  const autocomplete=new google.maps.places.Autocomplete(input,{componentRestrictions:{country:"vn"},fields:["geometry","name"]});
  autocomplete.addListener("place_changed",()=>{
    const place=autocomplete.getPlace();
    if(!place.geometry) return;
    const loc=place.geometry.location;
    map.setView([loc.lat(),loc.lng()],17);
    L.marker([loc.lat(),loc.lng()]).addTo(map).bindPopup(`<b>${place.name}</b>`).openPopup();
  });

  // --- Hi·ªÉn th·ªã t·ªça ƒë·ªô chu·ªôt ---
  const coordsDiv=document.getElementById('coords');
  map.on('mousemove',e=>coordsDiv.innerHTML=`Lat:${e.latlng.lat.toFixed(5)}, Lng:${e.latlng.lng.toFixed(5)}`);

  // --- ƒêi·ªÅu khi·ªÉn l·ªõp ---
  const overlayMaps={"üóæ ƒê·ªãa gi·ªõi h√†nh ch√≠nh":hanhChinhGroup,"üìê Quy ho·∫°ch 1/2000":quyHoachGroup};
  L.control.layers(baseMaps,overlayMaps).addTo(map);

  // --- Thanh c√¥ng c·ª• ---
  const panel=L.control({position:'topright'});
  panel.onAdd=function(){
    const div=L.DomUtil.create('div','leaflet-bar');
    div.innerHTML=`
      <button onclick="window._toggleTools()">üîß C√¥ng c·ª•</button>
    `;
    return div;
  };
  panel.addTo(map);
  window._toggleTools=toggleTools;
};
</script>
</body>
</html>

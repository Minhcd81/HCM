<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>HCM WebGIS v17 Full ‚Äî 34 T·ªânh T·ª± ƒê·ªông + Fade-in Highlight</title>

<!-- üß≠ CSS & LIBRARIES -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://unpkg.com/leaflet.browser.print/dist/leaflet.browser.print.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places,geometry"></script>

<style>
html,body,#map{height:100%;margin:0;font-family:'Roboto',sans-serif;}
:root{--pri:#00BFFF;--b:#333;--bg:#fff}
#map{z-index:1}

/* Search bar */
#searchbar{position:absolute;top:10px;left:50%;transform:translateX(-50%);
  z-index:1200;width:90%;max-width:560px;background:#fff;border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,.15);padding:6px 10px;display:flex;gap:8px;align-items:center}
#searchInput{flex:1;padding:10px;border:none;outline:none;font-size:14px}
#searchBtn{background:var(--pri);border:none;color:#fff;border-radius:8px;padding:8px 14px;cursor:pointer}
.autocomplete{position:absolute;top:60px;left:50%;transform:translateX(-50%);
  background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.15);z-index:1500;
  width:90%;max-width:560px;display:none;max-height:220px;overflow:auto}
.autocomplete div{padding:10px 14px;cursor:pointer}
.autocomplete div:hover{background:#f0f6ff}

/* Tools */
.tools{position:absolute;top:80px;right:10px;z-index:1200;display:flex;flex-direction:column;gap:10px}
.toolbtn{width:46px;height:46px;border-radius:50%;background:#fff;border:1px solid #ddd;
  display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;
  box-shadow:0 2px 6px rgba(0,0,0,.2)}
.toolbtn:hover{background:#f2f9ff}

/* Sidebar */
#sidebar{position:fixed;left:0;top:0;width:360px;height:100%;background:#fff;
  box-shadow:4px 0 20px rgba(0,0,0,.2);z-index:1600;transform:translateX(-370px);
  transition:transform .25s ease;padding:16px;overflow:auto}
#sidebar.open{transform:translateX(0)}
#sidebarClose{position:absolute;top:6px;right:10px;font-size:22px;background:none;border:none;cursor:pointer}
#sidebar h3{margin-top:0}
.form-row{display:flex;gap:6px;margin-bottom:8px}
.form-row input,.form-row select,.form-row textarea{flex:1;padding:8px;border:1px solid #ccc;border-radius:6px}
button.primary{background:var(--pri);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
button.primary:hover{opacity:.9}
.coords{position:absolute;left:10px;bottom:8px;background:rgba(255,255,255,.9);
  padding:4px 8px;border-radius:8px;font:12px monospace;z-index:1500}

/* Fade highlight */
.highlighted{animation:fadeIn 1s ease forwards}
@keyframes fadeIn{0%{opacity:0.2}100%{opacity:1}}

/* StreetView Popup iframe */
.streetview-frame{width:350px;height:250px;border:none;border-radius:8px;}

/* Mobile */
@media(max-width:600px){
 #sidebar{width:90%}
 #searchbar{width:94%;top:6px}
 .tools{top:70px}
}
</style>
</head>
<body>
<div id="map"></div>

<!-- üîç Search -->
<div id="searchbar">
  <input id="searchInput" placeholder="üîç Nh·∫≠p ƒë·ªãa ch·ªâ, ph∆∞·ªùng/x√£ ho·∫∑c t·ªça ƒë·ªô...">
  <button id="searchBtn">T√¨m</button>
</div>
<div id="autocomplete" class="autocomplete"></div>

<!-- ‚öôÔ∏è Tools -->
<div class="tools">
  <div class="toolbtn" id="btnSidebar" title="M·ªü panel">üìã</div>
  <div class="toolbtn" id="btnMeasure" title="ƒêo">üìè</div>
  <div class="toolbtn" id="btnCompass" title="La b√†n">üß≠</div>
  <div class="toolbtn" id="btnClear" title="X√≥a t√¥ m√†u">üßπ</div>
</div>

<!-- üßæ Sidebar -->
<div id="sidebar">
  <button id="sidebarClose">√ó</button>
  <h3>Th√¥ng tin ƒë·ªãnh gi√°</h3>
  <div class="form-row"><input id="tsbdTen" placeholder="T√™n TSBƒê"><input id="tsbdGia" placeholder="Gi√° tr·ªã (t·ª∑)"></div>
  <div class="form-row"><input id="tsbdLat" placeholder="Lat"><input id="tsbdLng" placeholder="Lng"></div>
  <div class="form-row"><textarea id="tsbdNote" rows="2" placeholder="Ghi ch√∫"></textarea></div>
  <button class="primary" id="btnAddTSBD">üìç ƒê·∫∑t TSBƒê</button>
  <hr>
  <h4>T√†i s·∫£n so s√°nh (TSSS)</h4>
  <div class="form-row"><input id="tsssTen" placeholder="T√™n TSSS"><input id="tsssGia" placeholder="Gi√° (t·ª∑)"></div>
  <div class="form-row"><input id="tsssLat" placeholder="Lat"><input id="tsssLng" placeholder="Lng"></div>
  <button class="primary" id="btnAddTSSS">‚ûï Th√™m TSSS</button>
  <button class="primary" id="btnExport">üìä Xu·∫•t Excel / CSV</button>
</div>
<div class="coords" id="coords">Lat: --, Lng: --</div>

<script>
// =================== CONFIG ===================
const PROVINCES = [
{name:'An Giang',slug:'angiang'},{name:'B·∫Øc Ninh',slug:'bacninh'},{name:'L√¢m ƒê·ªìng',slug:'lamdong'},
{name:'C√† Mau',slug:'camau'},{name:'C·∫ßn Th∆°',slug:'cantho'},{name:'Cao B·∫±ng',slug:'caobang'},
{name:'ƒê√† N·∫µng',slug:'danang'},{name:'ƒê·∫Øk L·∫Øk',slug:'daklak'},{name:'ƒêi·ªán Bi√™n',slug:'dienbien'},
{name:'ƒê·ªìng Nai',slug:'dongnai'},{name:'ƒê·ªìng Th√°p',slug:'dongthap'},{name:'Gia Lai',slug:'gialai'},
{name:'TP H√† N·ªôi',slug:'hanoi'},{name:'H√† Tƒ©nh',slug:'hatinh'},{name:'H·∫£i Ph√≤ng',slug:'haiphong'},
{name:'H∆∞ng Y√™n',slug:'hungyen'},{name:'Kh√°nh H√≤a',slug:'khanhhoa'},{name:'Lai Ch√¢u',slug:'laichau'},
{name:'L·∫°ng S∆°n',slug:'langson'},{name:'L√†o Cai',slug:'laocai'},{name:'Ngh·ªá An',slug:'nghean'},
{name:'Ninh B√¨nh',slug:'ninhbinh'},{name:'Ph√∫ Th·ªç',slug:'phutho'},{name:'Qu·∫£ng Ng√£i',slug:'quangngai'},
{name:'Qu·∫£ng Ninh',slug:'quangninh'},{name:'Qu·∫£ng Tr·ªã',slug:'quangtri'},{name:'S∆°n La',slug:'sonla'},
{name:'T√¢y Ninh',slug:'tayninh'},{name:'Th√°i Nguy√™n',slug:'thainguyen'},{name:'Thanh H√≥a',slug:'thanhhoa'},
{name:'TP Hu·∫ø',slug:'hue'},{name:'TP.HCM',slug:'hcm'},{name:'Tuy√™n Quang',slug:'tuyenquang'},
{name:'Vƒ©nh Long',slug:'vinhlong'}
];

const COLORS = ['#FFD700','#FF8C00','#FF6347','#87CEFA','#00FA9A','#DA70D6'];
let currentLayer=null, tsbdMarker=null, tsssMarkers=[];

// =================== MAP INIT ===================
const map = L.map('map').setView([10.7769,106.7009],11);
const baseLayers = {
  "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}),
  "Google Street": L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{maxZoom:20,subdomains:['mt0','mt1','mt2','mt3']}),
  "Google Hybrid": L.tileLayer('http://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{maxZoom:20,subdomains:['mt0','mt1','mt2','mt3']}),
  "Esri Satellite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
};
baseLayers["OpenStreetMap"].addTo(map);
L.control.layers(baseLayers).addTo(map);

// Load default HCM map
fetch('assets/hcm.geojson').then(r=>r.json()).then(data=>drawGeojson(data));

function drawGeojson(data){
  if(currentLayer) map.removeLayer(currentLayer);
  currentLayer=L.geoJSON(data,{
    onEachFeature:(f,l)=>{
      l.on('click',()=>{
        const c=COLORS[Math.floor(Math.random()*COLORS.length)];
        l.setStyle({fillColor:c,fillOpacity:0.6,color:'#333'});
        l.bindPopup(`<b>${f.properties.ten_xa}</b><br>${f.properties.sap_nhap||''}<br>${f.properties.dtich_km2||''} km¬≤<br>${f.properties.dan_so||''} ng∆∞·ªùi`).openPopup();
        l.getElement()?.classList.add('highlighted');
      });
    },
    style:{color:'#555',weight:1,fillOpacity:.3}
  }).addTo(map);
}

// =================== SEARCH ===================
document.getElementById('searchBtn').onclick=()=>{
  let q=document.getElementById('searchInput').value.trim();
  if(!q)return;
  if(q.includes(',')){ // coordinate
    const [lat,lng]=q.split(',').map(Number);
    map.setView([lat,lng],15);
    const m=L.marker([lat,lng],{title:'TS',icon:L.divIcon({html:'<div style="background:#00BFFF;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:11px;">TS</div>'})}).addTo(map);
    m.bindPopup(`<b>T·ªça ƒë·ªô:</b> ${lat.toFixed(5)}, ${lng.toFixed(5)}<br><button onclick="openStreetView(${lat},${lng})">üëÅÔ∏è Street View</button>`).openPopup();
  }else{
    new google.maps.Geocoder().geocode({address:q},(res,st)=>{
      if(st==='OK'){
        const loc=res[0].geometry.location;
        map.setView([loc.lat(),loc.lng()],15);
        L.marker([loc.lat(),loc.lng()]).addTo(map).bindPopup(`<b>${res[0].formatted_address}</b><br><button onclick="openStreetView(${loc.lat()},${loc.lng()})">üëÅÔ∏è Street View</button>`).openPopup();
      }
    });
  }
};

// =================== STREET VIEW ===================
window.openStreetView=function(lat,lng){
  const url=`https://www.google.com/maps/embed/v1/streetview?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&location=${lat},${lng}&heading=0&pitch=0&fov=90`;
  L.popup({maxWidth:370})
   .setLatLng([lat,lng])
   .setContent(`<iframe class='streetview-frame' src='${url}'></iframe>`)
   .openOn(map);
};

// =================== SIDEBAR ===================
const sb=document.getElementById('sidebar');
document.getElementById('btnSidebar').onclick=()=>sb.classList.add('open');
document.getElementById('sidebarClose').onclick=()=>sb.classList.remove('open');

// =================== MEASURE TOOL ===================
let measureOn=false, poly=null;
document.getElementById('btnMeasure').onclick=()=>{
  measureOn=!measureOn;
  if(measureOn){
    map.on('click',measureClick);
  }else{
    map.off('click',measureClick);
    if(poly){map.removeLayer(poly);poly=null;}
  }
};
let points=[];
function measureClick(e){
  points.push(e.latlng);
  if(points.length>1){
    if(poly)map.removeLayer(poly);
    poly=L.polyline(points,{color:'#f00'}).addTo(map);
    const d=turf.length(turf.lineString(points.map(p=>[p.lng,p.lat])),{units:'kilometers'})*1000;
    L.popup().setLatLng(e.latlng).setContent(`üìè ${d.toFixed(1)} m`).openOn(map);
  }
}

// =================== CLEAR ===================
document.getElementById('btnClear').onclick=()=>{
  if(currentLayer) currentLayer.resetStyle();
};

// =================== COORD UPDATE ===================
map.on('mousemove',e=>{
 document.getElementById('coords').innerText=`Lat: ${e.latlng.lat.toFixed(5)}, Lng: ${e.latlng.lng.toFixed(5)}`;
});
</script>
</body>
</html>

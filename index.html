<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HCM WebGIS â€“ Google & Äá»‹a giá»›i hÃ nh chÃ­nh</title>

<!-- Leaflet core -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- GoogleMutant stable -->
<script src="https://cdn.jsdelivr.net/npm/leaflet.gridlayer.googlemutant@0.10.2/Leaflet.GoogleMutant.min.js"></script>

<!-- Plugins -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.css" />
<script src="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.css" />
<script src="https://unpkg.com/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.js"></script>

<script src="https://unpkg.com/leaflet.browser.print/dist/leaflet.browser.print.min.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<style>
html,body,#map{height:100%;margin:0;font-family:Segoe UI,Arial}
#search{position:absolute;top:10px;left:10px;z-index:1000;width:320px;padding:6px 10px;border:1px solid #ccc;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,.2);}
.panel{position:absolute;top:10px;right:10px;background:rgba(255,255,255,.95);padding:10px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.2);font-size:13px;width:230px;}
.panel button,.panel select{width:100%;margin-top:4px;padding:6px;}
</style>
</head>
<body>
<input id="search" type="text" placeholder="ğŸ” Nháº­p Ä‘á»‹a chá»‰ (VD: 961 HoÃ ng Sa, Quáº­n 3)" />
<div id="map"></div>

<div class="panel">
<b>Äá»‹a giá»›i HCM â€“ simplify</b><br>
Nguá»“n: <i>assets/hcm_admin_shp.zip</i><br>
Äá»™ Ä‘Æ¡n giáº£n hÃ³a:
<select id="tol">
  <option value="10">10 m (nháº¹)</option>
  <option value="20">20 m (khuyáº¿n nghá»‹)</option>
  <option value="30">30 m (cao)</option>
</select>
<button id="load">ğŸ“ Náº¡p Ä‘á»‹a giá»›i</button>
<button id="toggle">ğŸ‘ï¸ áº¨n/Hiá»‡n Ä‘á»‹a giá»›i</button>
<button id="tools">âš™ï¸ áº¨n/Hiá»‡n cÃ´ng cá»¥</button>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places&loading=async"></script>

<script>
window.onload = function(){
  // ==== Táº O MAP ====
  const map = L.map('map',{center:[10.77,106.7],zoom:12});

  // ==== BASE LAYERS ====
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(map);
  const gRoad = L.gridLayer.googleMutant({type:'roadmap'});
  const gSat = L.gridLayer.googleMutant({type:'satellite'});
  const gHy = L.gridLayer.googleMutant({type:'hybrid'});
  const esriSt = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}');
  const esriImg = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
  const bing = L.tileLayer('https://ecn.t{s}.tiles.virtualearth.net/tiles/a{q}.jpeg?g=1',{subdomains:['0','1','2','3']});

  L.control.layers({
    "Google ÄÆ°á»ng phá»‘": gRoad,
    "Google Vá»‡ tinh": gSat,
    "Google Hybrid": gHy,
    "OpenStreetMap": osm,
    "Esri Streets": esriSt,
    "Esri Satellite": esriImg,
    "Bing Maps": bing
  }, null, {position:'bottomleft'}).addTo(map);

  // ==== CÃ”NG Cá»¤ ====
  const lc = L.control.locate({position:'topleft'}).addTo(map);
  const measure = L.control.measure({position:'topleft',primaryLengthUnit:'kilometers'}).addTo(map);
  const drawnItems = new L.FeatureGroup(); map.addLayer(drawnItems);
  const drawControl = new L.Control.Draw({edit:{featureGroup:drawnItems}}); map.addControl(drawControl);
  map.on(L.Draw.Event.CREATED,e=>drawnItems.addLayer(e.layer));
  L.control.browserPrint({position:'topleft'}).addTo(map);

  // ==== SEARCH GOOGLE PLACES ====
  const input=document.getElementById('search');
  const autocomplete=new google.maps.places.Autocomplete(input,{componentRestrictions:{country:'vn'}});
  autocomplete.addListener('place_changed',()=>{
    const place=autocomplete.getPlace();
    if(!place.geometry)return;
    const loc=[place.geometry.location.lat(),place.geometry.location.lng()];
    map.setView(loc,16);
    L.marker(loc).addTo(map).bindPopup(`<b>${place.formatted_address}</b>`).openPopup();
  });

  // ==== Äá»ŠA GIá»šI ====
  let layer=null, visible=true;
  const stDef={color:'#1565C0',weight:1.2,fillOpacity:0.05};
  const stHigh={color:'#F57C00',weight:3,fillColor:'#FFF176',fillOpacity:0.5};
  const popup=p=>`<b>${p.ten_xa||'KhÃ´ng rÃµ'}</b><br>Quáº­n/Huyá»‡n: ${p.quan_huyen||'-'}<br>Diá»‡n tÃ­ch: ${p.dtich_km2||'-'} kmÂ²<br>DÃ¢n sá»‘: ${p.dan_so?Number(p.dan_so).toLocaleString('vi-VN'):'-'} ngÆ°á»i`;

  async function loadBoundary(){
    try{
      console.log("â³ Äang táº£i shapefile...");
      const tol=parseFloat(document.getElementById("tol").value);
      const res=await fetch("assets/hcm_admin_shp.zip",{cache:"no-store"});
      if(!res.ok) throw new Error("KhÃ´ng thá»ƒ táº£i shapefile!");
      const blob=await res.blob();
      const data=await shp(blob);
      console.log("âœ… Táº£i thÃ nh cÃ´ng shapefile");

      if(layer) map.removeLayer(layer);
      const simp=turf.simplify(data,{tolerance:tol,highQuality:false});
      layer=L.geoJSON(simp,{
        style:()=>stDef,
        onEachFeature:(f,l)=>{
          const p=f.properties;
          l.bindTooltip(p.ten_xa||"");
          l.on("click",()=>{
            layer.resetStyle();
            l.setStyle(stHigh);
            L.popup({maxWidth:300})
             .setLatLng(l.getBounds().getCenter())
             .setContent(popup(p))
             .openOn(map);
          });
        }
      }).addTo(map);
      map.fitBounds(layer.getBounds());
    }catch(err){
      console.error("âŒ Lá»—i:",err);
      alert("âš ï¸ KhÃ´ng thá»ƒ táº£i file Ä‘á»‹a giá»›i hÃ nh chÃ­nh. Vui lÃ²ng kiá»ƒm tra file ZIP hoáº·c thá»­ reload trang.");
    }
  }

  document.getElementById("load").onclick=loadBoundary;
  document.getElementById("toggle").onclick=()=>{
    if(!layer) return;
    visible=!visible;
    visible?map.addLayer(layer):map.removeLayer(layer);
  };
  document.getElementById("tools").onclick=()=>{
    const tl=document.querySelectorAll(".leaflet-control");
    tl.forEach(e=>e.style.display=(e.style.display==="none")?"block":"none");
  };
};
</script>
</body>
</html>

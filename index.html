<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HCM WebGIS ‚Äì Google + ƒê·ªãa gi·ªõi HCM (+ƒëo, v·∫Ω, la b√†n)</title>

<!-- Leaflet core -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Google Maps API (Places for Autocomplete) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places"></script>

<!-- GoogleMutant (Google base layers cho Leaflet) -->
<script src="https://cdn.jsdelivr.net/npm/leaflet.gridlayer.googlemutant@0.11.2/dist/Leaflet.GoogleMutant.min.js"></script>

<!-- Plugins: Locate, Geocoder, Draw, Measure, EasyButton, Compass, EasyPrint -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.css"/>
<script src="https://unpkg.com/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.css"/>
<script src="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-easybutton@2.4.0/src/easy-button.css"/>
<script src="https://unpkg.com/leaflet-easybutton@2.4.0/src/easy-button.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-compass/dist/leaflet-compass.css"/>
<script src="https://unpkg.com/leaflet-compass/dist/leaflet-compass.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/leaflet-easyprint@2.1.9/dist/leaflet.easyPrint.js"></script>

<!-- Shapefile + Turf -->
<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<style>
  html, body, #map { height: 100%; margin: 0; font-family: "Segoe UI", Arial, sans-serif; }
  #search-box{
    position:absolute; top:10px; left:50px; z-index:1000; width:320px;
    padding:6px 10px; border-radius:6px; border:1px solid #ccc;
    box-shadow:0 1px 3px rgba(0,0,0,.2);
  }
  .panel{
    position:absolute; top:10px; right:10px; z-index:1000;
    background:rgba(255,255,255,.95); padding:10px; width:230px;
    border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.2); font-size:13px;
  }
  .panel button, .panel select{ width:100%; margin-top:6px; padding:6px; }
  .legend{
    position:absolute; bottom:10px; left:10px; z-index:500;
    background:rgba(255,255,255,.9); padding:8px 12px; border-radius:8px;
    box-shadow:0 2px 6px rgba(0,0,0,.2); font-size:13px;
  }
</style>
</head>
<body>
<input id="search-box" type="text" placeholder="üîé Nh·∫≠p ƒë·ªãa ch·ªâ (v√≠ d·ª•: 961 Ho√†ng Sa)..." />
<div id="map"></div>

<!-- B·∫£ng c√¥ng c·ª• ƒë·ªãa gi·ªõi -->
<div class="panel">
  <b>ƒê·ªãa gi·ªõi HCM ‚Äì simplify</b><br>
  <small>Ngu·ªìn: <i>assets/hcm_admin_shp.zip</i></small>
  <label style="margin-top:6px">ƒê·ªô ƒë∆°n gi·∫£n h√≥a:</label>
  <select id="tolerance">
    <option value="0.00005">~5 m (chi ti·∫øt)</option>
    <option value="0.0001" selected>~10 m (khuy·∫øn ngh·ªã)</option>
    <option value="0.0002">~20 m (nh·∫π nh·∫•t)</option>
  </select>
  <button id="btnLoad">üìÇ N·∫°p ƒë·ªãa gi·ªõi</button>
  <button id="btnToggle">üëÅÔ∏è ·∫®n/Hi·ªán ƒë·ªãa gi·ªõi</button>
  <button id="btnClear">üßπ X√≥a ƒë·ªãa gi·ªõi</button>
</div>

<script>
// ========== 1) B·∫¢N ƒê·ªí & L·ªöP N·ªÄN ==========
const map = L.map('map', { center: [10.779, 106.69], zoom: 12 });

const gRoad = L.gridLayer.googleMutant({ type: 'roadmap' });
const gSat  = L.gridLayer.googleMutant({ type: 'satellite' });
const gHy   = L.gridLayer.googleMutant({ type: 'hybrid' });
const osm   = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 });
const esriSt= L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}');
const esriIm= L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

gRoad.addTo(map);

L.control.layers({
  'Google ƒê∆∞·ªùng ph·ªë': gRoad,
  'Google V·ªá tinh'  : gSat,
  'Google Hybrid'   : gHy,
  'OpenStreetMap'   : osm,
  'Esri Streets'    : esriSt,
  'Esri Satellite'  : esriIm
}, null, { position:'topright' }).addTo(map);

// ========== 2) TI·ªÜN √çCH (GPS, Geocoder, Measure, Draw, Print, Compass) ==========
L.control.locate({ position:'topleft', strings:{ title:'ƒê·ªãnh v·ªã GPS' } }).addTo(map);
L.Control.geocoder({ position:'topleft', placeholder:'T√¨m nhanh...' }).addTo(map);
L.control.measure({ position:'topleft', primaryLengthUnit:'meters', primaryAreaUnit:'sqmeters' }).addTo(map);

const drawnItems = new L.FeatureGroup().addTo(map);
new L.Control.Draw({
  edit:{ featureGroup: drawnItems },
  draw:{ polygon:true, rectangle:true, polyline:true, circle:true, marker:true }
}).addTo(map);
map.on(L.Draw.Event.CREATED, e => drawnItems.addLayer(e.layer));

L.easyPrint({ title:'In b·∫£n ƒë·ªì', position:'topleft', filename:'ban_do_HCM' }).addTo(map);
L.control.compass({ position:'topright', autoActive:true, showDigit:true }).addTo(map);
L.control.scale({ metric:true }).addTo(map);

// ========== 3) SEARCH Google Autocomplete ==========
const searchInput = document.getElementById('search-box');
const ac = new google.maps.places.Autocomplete(searchInput, { types:['geocode'] });
ac.addListener('place_changed', () => {
  const place = ac.getPlace();
  if (!place.geometry) return;
  const lat = place.geometry.location.lat(), lng = place.geometry.location.lng();
  map.setView([lat, lng], 16);
  L.marker([lat, lng]).addTo(map).bindPopup(`<b>${place.formatted_address}</b>`).openPopup();
});

// ========== 4) ƒê·ªäA GI·ªöI HCM (n·∫°p t·ª´ shapefile) ==========
let boundaryLayer = null;
let boundaryVisible = true;
let currentHit = null;

const styleDefault  = () => ({ color:'#1976D2', weight:1.4, fillOpacity:0.06 });
const styleHighlight= () => ({ color:'#0B5ED7', weight:3, fillColor:'#FFD43B', fillOpacity:0.55 });

function popupHTML(p){
  const danso = p.dan_so ? Number(p.dan_so).toLocaleString('vi-VN') : '‚Äì';
  const dtich = p.dtich_km2 ?? '‚Äì';
  const snhap = p.sap_nhap || '‚Äì';
  const qh    = p.quan_huyen || '‚Äì';
  return `
    <b>${p.ten_xa || 'Kh√¥ng r√µ'}</b><br/>
    Qu·∫≠n/Huy·ªán: ${qh}<br/>
    Di·ªán t√≠ch: ${dtich} km¬≤<br/>
    D√¢n s·ªë: ${danso} ng∆∞·ªùi<br/>
    S√°p nh·∫≠p: ${snhap}
  `;
}

async function loadBoundary(){
  // Clear c≈©
  if (boundaryLayer) { map.removeLayer(boundaryLayer); boundaryLayer = null; }

  const tol = parseFloat(document.getElementById('tolerance').value);
  const raw = await shp('assets/hcm_admin_shp.zip');
  const simplified = turf.simplify(raw, { tolerance: tol, highQuality:false });

  boundaryLayer = L.geoJSON(simplified, {
    style: styleDefault,
    onEachFeature: (f, lyr) => {
      const p = f.properties || {};
      lyr.bindTooltip(p.ten_xa || '', { sticky:true });
      lyr.on('click', () => {
        if (currentHit) boundaryLayer.resetStyle(currentHit);
        currentHit = lyr;
        lyr.setStyle(styleHighlight());
        const center = lyr.getBounds().getCenter();
        L.popup({ maxWidth:320 })
          .setLatLng(center)
          .setContent(popupHTML(p))
          .openOn(map);
      });
    }
  }).addTo(map);

  boundaryVisible = true;
  map.fitBounds(boundaryLayer.getBounds());
}

// N√∫t panel
document.getElementById('btnLoad').onclick   = loadBoundary;
document.getElementById('btnToggle').onclick = () => {
  if (!boundaryLayer) return;
  boundaryVisible ? map.removeLayer(boundaryLayer) : map.addLayer(boundaryLayer);
  boundaryVisible = !boundaryVisible;
};
document.getElementById('btnClear').onclick  = () => {
  if (boundaryLayer) { map.removeLayer(boundaryLayer); boundaryLayer = null; }
  boundaryVisible = false;
  currentHit = null;
};

// T·ª± ƒë·ªông n·∫°p khi m·ªü trang (c√≥ th·ªÉ t·∫Øt n·∫øu mu·ªën)
loadBoundary();

// ========== 5) Legend ==========
L.control({ position:'bottomleft' }).onAdd = function(){
  const div = L.DomUtil.create('div','legend');
  div.innerHTML = `
    <b>Ch√∫ gi·∫£i</b><br/>
    <span style="display:inline-block;width:14px;height:14px;background:#1976D2;border:1px solid #1976D2;margin-right:6px"></span> Ranh ƒë·ªãa gi·ªõi<br/>
    <span style="display:inline-block;width:14px;height:14px;background:#FFD43B;border:1px solid #0B5ED7;margin-right:6px"></span> Khu ƒë∆∞·ª£c ch·ªçn
  `;
  return div;
}.addTo(map);
</script>
</body>
</html>

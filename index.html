<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HCM WebGIS ‚Äì ƒê·ªãa gi·ªõi h√†nh ch√≠nh</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Plugins -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.css" />
<script src="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.css" />
<script src="https://unpkg.com/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.js"></script>

<script src="https://unpkg.com/leaflet.browser.print/dist/leaflet.browser.print.min.js"></script>

<!-- GoogleMutant -->
<script src="https://cdn.jsdelivr.net/npm/leaflet.gridlayer.googlemutant@0.10.2/Leaflet.GoogleMutant.min.js"></script>

<style>
html,body,#map{height:100%;margin:0;font-family:Segoe UI,Arial}
#search{position:absolute;top:10px;left:10px;z-index:1000;width:320px;padding:6px 10px;border:1px solid #ccc;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,.2);}
.panel{position:absolute;top:10px;right:10px;background:rgba(255,255,255,.95);padding:10px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.2);font-size:13px;width:230px;}
.panel button{width:100%;margin-top:5px;padding:6px;}
</style>
</head>
<body>
<input id="search" type="text" placeholder="üîé Nh·∫≠p ƒë·ªãa ch·ªâ (VD: 961 Ho√†ng Sa, Qu·∫≠n 3)" />
<div id="map"></div>

<div class="panel">
<b>ƒê·ªãa gi·ªõi HCM ‚Äì GeoJSON</b><br>
Ngu·ªìn: <i>assets/TPHCM.geojson</i><br>
<button id="toggle">üëÅÔ∏è ·∫®n/Hi·ªán ƒë·ªãa gi·ªõi</button>
<button id="tools">‚öôÔ∏è ·∫®n/Hi·ªán c√¥ng c·ª•</button>
</div>

<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places&loading=async"></script>

<script>
window.onload = async function(){

  // ==== Kh·ªüi t·∫°o b·∫£n ƒë·ªì ====
  const map = L.map('map',{center:[10.77,106.7],zoom:12});

  // ==== Base layers ====
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
  const gRoad = L.gridLayer.googleMutant({type:'roadmap'});
  const gSat = L.gridLayer.googleMutant({type:'satellite'});
  const gHy = L.gridLayer.googleMutant({type:'hybrid'});
  const esriSt = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}');
  const esriImg = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
  const bing = L.tileLayer('https://ecn.t{s}.tiles.virtualearth.net/tiles/a{q}.jpeg?g=1',{subdomains:['0','1','2','3']});

  L.control.layers({
    "Google ƒê∆∞·ªùng ph·ªë": gRoad,
    "Google V·ªá tinh": gSat,
    "Google Hybrid": gHy,
    "OpenStreetMap": osm,
    "Esri Streets": esriSt,
    "Esri Satellite": esriImg,
    "Bing Maps": bing
  }, null, {position:'bottomleft'}).addTo(map);

  // ==== C√¥ng c·ª• ====
  L.control.locate({position:'topleft'}).addTo(map);
  L.control.measure({position:'topleft',primaryLengthUnit:'kilometers'}).addTo(map);
  const drawnItems = new L.FeatureGroup(); map.addLayer(drawnItems);
  const drawControl = new L.Control.Draw({edit:{featureGroup:drawnItems}}); map.addControl(drawControl);
  map.on(L.Draw.Event.CREATED,e=>drawnItems.addLayer(e.layer));
  L.control.browserPrint({position:'topleft'}).addTo(map);

  // ==== Search Google Places ====
  const input=document.getElementById('search');
  const autocomplete=new google.maps.places.Autocomplete(input,{componentRestrictions:{country:'vn'}});
  autocomplete.addListener('place_changed',()=>{
    const place=autocomplete.getPlace();
    if(!place.geometry)return;
    const loc=[place.geometry.location.lat(),place.geometry.location.lng()];
    map.setView(loc,16);
    L.marker(loc).addTo(map).bindPopup(`<b>${place.formatted_address}</b>`).openPopup();
  });

  // ==== ƒê·ªãa gi·ªõi GeoJSON ====
  let layer=null,visible=true;
  const stDef={color:'#1565C0',weight:1.2,fillOpacity:0.05};
  const stHigh={color:'#F57C00',weight:3,fillColor:'#FFF176',fillOpacity:0.5};
  const popup=p=>`<b>${p.ten_xa||'Kh√¥ng r√µ'}</b><br>
  Qu·∫≠n/Huy·ªán: ${p.quan_huyen||'-'}<br>
  Di·ªán t√≠ch: ${p.dtich_km2||'-'} km¬≤<br>
  D√¢n s·ªë: ${p.dan_so?Number(p.dan_so).toLocaleString('vi-VN'):'-'} ng∆∞·ªùi`;

  try{
    const res=await fetch("assets/TPHCM.geojson",{cache:"no-store"});
    if(!res.ok) throw new Error("Kh√¥ng t·∫£i ƒë∆∞·ª£c GeoJSON!");
    const data=await res.json();
    layer=L.geoJSON(data,{
      style:()=>stDef,
      onEachFeature:(f,l)=>{
        const p=f.properties;
        l.bindTooltip(p.ten_xa||"");
        l.on("mouseover",()=>l.setStyle({weight:3,color:"#FFD54F"}));
        l.on("mouseout",()=>l.setStyle(stDef));
        l.on("click",()=>{
          layer.resetStyle();
          l.setStyle(stHigh);
          L.popup({maxWidth:300})
           .setLatLng(l.getBounds().getCenter())
           .setContent(popup(p))
           .openOn(map);
        });
      }
    }).addTo(map);
    map.fitBounds(layer.getBounds());
    console.log("‚úÖ ƒê√£ t·∫£i ƒë·ªãa gi·ªõi h√†nh ch√≠nh HCM (GeoJSON)");
  }catch(err){
    console.error("‚ùå L·ªói t·∫£i GeoJSON:",err);
    alert("‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i file ƒë·ªãa gi·ªõi h√†nh ch√≠nh. Vui l√≤ng ki·ªÉm tra assets/TPHCM.geojson.");
  }

  // ==== N√∫t ƒëi·ªÅu khi·ªÉn ====
  document.getElementById("toggle").onclick=()=>{
    if(!layer)return;
    visible=!visible;
    visible?map.addLayer(layer):map.removeLayer(layer);
  };
  document.getElementById("tools").onclick=()=>{
    const tl=document.querySelectorAll(".leaflet-control");
    tl.forEach(e=>e.style.display=(e.style.display==="none")?"block":"none");
  };
};
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>HCM WebGIS v7 — Dynamic Measure + Compass + StreetView (Roboto)</title>

<!-- Roboto (UI giống Google) -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<!-- Leaflet core -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Draw + Turf (đo thủ công) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<!-- Locate (GPS) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

<!-- Google Maps JS (Places + Geometry) cho Search & Street View) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places,geometry"></script>

<style>
  :root{--pri:#00BFFF;--text:#202124;--bg:#fff}
  html,body,#map{height:100%;margin:0;font-family:Roboto,system-ui,-apple-system,Segoe UI,Arial}
  /* Search top */
  #searchbar{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:1400;width:560px;max-width:90vw}
  #q{width:100%;padding:10px 12px;border:1px solid #cfd4dc;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.12)}
  /* Tools panel (right) */
  #tools{position:absolute;right:10px;top:70px;z-index:1200;display:flex;flex-direction:column;gap:10px}
  .toolbtn{background:#fff;border:1px solid #ddd;border-radius:50%;width:48px;height:48px;cursor:pointer;
           box-shadow:0 2px 8px rgba(0,0,0,.15);font-size:22px;text-align:center;line-height:48px;transition:.18s}
  .toolbtn:hover{transform:scale(1.08);background:#f5f8ff}
  /* Measure menu */
  #measureMenu{position:absolute;right:70px;top:120px;background:#fff;border:1px solid #ddd;border-radius:12px;
               box-shadow:0 8px 24px rgba(0,0,0,.18);display:none;z-index:1300;overflow:hidden}
  #measureMenu button{display:block;padding:10px 14px;border:none;background:#fff;width:220px;text-align:left;
                      cursor:pointer;font-size:14px}
  #measureMenu button:hover{background:#f1f5f9}
  /* Compass overlay (giữa bản đồ) */
  #compassOverlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:350px;height:350px;
                  border-radius:50%;background:rgba(255,255,255,.92);border:2px solid #bbb;display:none;z-index:1300;
                  box-shadow:0 8px 20px rgba(0,0,0,.25)}
  #compassOverlay .label{position:absolute;font-weight:700;color:#333;font-size:18px}
  #compassOverlay .n{top:8px;left:50%;transform:translateX(-50%);color:#d00}
  #compassOverlay .s{bottom:8px;left:50%;transform:translateX(-50%)}
  #compassOverlay .e{right:8px;top:50%;transform:translateY(-50%)}
  #compassOverlay .w{left:8px;top:50%;transform:translateY(-50%)}
  #compassCanvas{position:absolute;left:0;top:0}
  /* Clear color button (dưới layer control) */
  #btnClear{position:absolute;right:10px;top:220px;z-index:1200;background:#fff;border:1px solid #ddd;border-radius:12px;
            padding:8px 12px;box-shadow:0 2px 6px rgba(0,0,0,.15);cursor:pointer}
  /* Sidebar toggle dưới cụm zoom +/- (bên trái) */
  #sidebarToggle{position:absolute;left:10px;top:120px;z-index:1200;background:#fff;border:1px solid #ddd;border-radius:12px;
                 padding:8px 12px;box-shadow:0 2px 6px rgba(0,0,0,.15);cursor:pointer}
  /* Sidebar TSBĐ/TSSS */
  #sidebar{position:fixed;left:0;top:0;height:100%;width:360px;background:#fff;box-shadow:4px 0 20px rgba(0,0,0,.2);
           transform:translateX(-380px);transition:transform .28s ease;z-index:1600;padding:16px 16px 80px 16px;overflow:auto}
  #sidebar.open{transform:translateX(0)}
  #sidebar h3{margin:6px 0 12px}
  #tabs{display:flex;gap:8px;margin-bottom:10px}
  #tabs button{flex:1;border:1px solid #cfd4dc;background:#f6f8fa;border-radius:10px;padding:8px;cursor:pointer}
  #tabs button.active{background:#1f6feb;color:#fff;border-color:#1f6feb}
  .form-row{display:flex;gap:8px;margin-bottom:8px}
  .form-row input,.form-row select,.form-row textarea{flex:1;padding:9px;border:1px solid #cfd4dc;border-radius:10px}
  .muted{color:#5f6368;font-size:12px}
  #sidebarClose{position:absolute;right:10px;top:8px;border:none;background:transparent;font-size:22px;cursor:pointer}
  /* Bottom coords */
  .coords{position:absolute;left:10px;bottom:6px;background:rgba(255,255,255,.9);padding:4px 8px;border-radius:8px;font:12px monospace;z-index:1000}
  /* Dyn label glow */
  .dynbox{background:rgba(255,255,255,.95);border:1px solid #ccd6e0;border-radius:10px;padding:6px 8px;font-size:13px;
          box-shadow:0 0 10px var(--pri)}
</style>
</head>
<body>
<div id="searchbar"><input id="q" placeholder="🔍 Địa chỉ / phường/xã hoặc tọa độ: 10.79844, 106.65855"></div>
<div id="map"></div>

<!-- Tools (right) -->
<div id="tools">
  <div id="btnCompass" class="toolbtn" title="La bàn">🧭</div>
  <div id="btnMeasure" class="toolbtn" title="Đo">📏</div>
  <div id="btnGPS" class="toolbtn" title="Định vị">📍</div>
</div>
<!-- Measure menu -->
<div id="measureMenu">
  <button id="mDist">📍📍 Đo khoảng cách</button>
  <button id="mArea">⬛ Đo diện tích</button>
  <button id="mQuick">⚡ Đo nhanh (động)</button>
  <button id="mFinish">🛑 Hoàn tất đo</button>
</div>
<!-- Clear colors -->
<button id="btnClear">🧹 Xóa tô màu</button>

<!-- Sidebar toggle (left, dưới zoom) -->
<button id="sidebarToggle">📋 TSBĐ / TSSS</button>

<!-- Sidebar -->
<div id="sidebar">
  <button id="sidebarClose">×</button>
  <h3>Thông tin tài sản</h3>
  <div id="tabs">
    <button id="tab-tsbd" class="active">TSBĐ</button>
    <button id="tab-tsss">TSSS</button>
  </div>
  <div id="pane-tsbd">
    <div class="form-row"><select id="tsbdLoai"><option>Nhà ở</option><option>Đất trống</option><option>Căn hộ</option></select></div>
    <div class="form-row"><input id="tsbdDientich" type="number" placeholder="Diện tích (m²)"><input id="tsbdGia" type="number" placeholder="Giá trị (tỷ)"></div>
    <div class="form-row"><input id="tsbdLat" placeholder="Lat"><input id="tsbdLng" placeholder="Lng"></div>
    <div class="form-row"><textarea id="tsbdGhiChu" rows="3" placeholder="Ghi chú"></textarea></div>
    <div class="form-row"><button id="tsbdPin">📍 Đặt điểm</button><button id="tsbdStreet">👁️ Street View</button></div>
    <div class="muted">Mẹo: nhập Lat/Lng rồi bấm “Đặt điểm” để nhảy tới vị trí TSBĐ.</div>
  </div>
  <div id="pane-tsss" style="display:none">
    <div class="form-row"><input id="tsssTen" placeholder="Tên/Địa chỉ so sánh"><input id="tsssGia" type="number" placeholder="Giá (tỷ)"></div>
    <div class="form-row"><input id="tsssLat" placeholder="Lat"><input id="tsssLng" placeholder="Lng"></div>
    <div class="form-row"><button id="tsssAdd">➕ Thêm so sánh</button></div>
    <div id="tsssList" class="muted">Chưa có mục so sánh nào.</div>
  </div>
</div>

<!-- Compass overlay -->
<div id="compassOverlay">
  <span class="label n">B</span>
  <span class="label s">N</span>
  <span class="label e">Đ</span>
  <span class="label w">T</span>
  <canvas id="compassCanvas" width="350" height="350"></canvas>
</div>

<div class="coords" id="coords">Lat: --, Lng: --</div>

<script>
// ========== MAP ==========
const map=L.map('map',{center:[10.776,106.7],zoom:12});

// Basemaps
const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
const esriStreet=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',{attribution:'© Esri'});
const esriImagery=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'© Esri Imagery'});
const esriTopo=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',{attribution:'© Esri Topo'});
const gStreet=L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{attribution:'© Google'});
const gHybrid=L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{attribution:'© Google'});

L.control.layers({
  "🗺️ OSM": osm,
  "🗺️ Esri Street": esriStreet,
  "🛰️ Esri Imagery": esriImagery,
  "🗺️ Esri Topo": esriTopo,
  "🌍 Google Street": gStreet,
  "🛰️ Google Hybrid": gHybrid
},{},{collapsed:true}).addTo(map);

// Overlays (hành chính) – cố gắng load nếu có; nếu không thì thôi
const hanhChinh=L.layerGroup().addTo(map);
let coloredLayers=[];

function colorBy(code){
  const lut={"ODT":"#e41a1c","ONT":"#e41a1c","CX":"#4daf4a","DGT":"#999","CC":"#ffcc00","MN":"#6baed6","HTKT":"#984ea3","TG":"#fdb462"};
  for(const k in lut){ if(code && code.includes(k)) return lut[k]; }
  return "#ccc";
}

// Load hành chính nếu có assets; nếu 404 thì bỏ qua
fetch('assets/TPHCM.geojson').then(r=>{if(!r.ok) throw 0; return r.json();})
.then(geo=>{
  const layer=L.geoJSON(geo,{
    style:{color:"#ff6600",weight:1,fillOpacity:.1},
    onEachFeature:(f,l)=>{
      const p=f.properties||{};
      l.bindPopup(`<b>${p.ten_xa||''}</b><br>${p.quan_huyen||''}${p.dtich_km2?('<br>'+p.dtich_km2+' km²'):''}`);
      l.on('click',()=>{ l.setStyle({fillColor:"#ffd3e6",fillOpacity:.45}); if(!coloredLayers.includes(l)) coloredLayers.push(l); });
    }
  });
  hanhChinh.addLayer(layer);
}).catch(()=>{ /* no assets, vẫn chạy bình thường */ });

// Clear colors
document.getElementById('btnClear').onclick=()=>{ coloredLayers.forEach(l=>l.setStyle({fillColor:null,fillOpacity:.1})); coloredLayers=[]; };

// ========== GPS ==========
const locateCtrl=L.control.locate({strings:{title:"Vị trí của tôi"},showCompass:true,keepCurrentZoomLevel:true});

// ========== SEARCH (địa chỉ / tọa độ) ==========
const qInp=document.getElementById('q');
const ac=new google.maps.places.Autocomplete(qInp,{componentRestrictions:{country:"vn"}});
let lastMarker=null;

function placeMarker(lat,lng,label){
  map.setView([lat,lng],17);
  if(lastMarker) map.removeLayer(lastMarker);
  lastMarker=L.marker([lat,lng]).addTo(map)
    .bindPopup(`<b>${label||''}</b><br><button id="svbtn">👁️ Xem Street View tại vị trí này</button>`).openPopup();
  setTimeout(()=>{ const b=document.getElementById('svbtn'); if(b){ b.onclick=()=>openStreetView(lat,lng); }},50);
}
ac.addListener("place_changed",()=>{const p=ac.getPlace(); if(!p.geometry) return; placeMarker(p.geometry.location.lat(),p.geometry.location.lng(),p.formatted_address||p.name);});
qInp.addEventListener('keydown',ev=>{
  if(ev.key!=="Enter") return;
  const m=qInp.value.trim().match(/^(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)/);
  if(m){ const lat=parseFloat(m[1]),lng=parseFloat(m[2]); placeMarker(lat,lng,`Tọa độ: ${lat.toFixed(6)}, ${lng.toFixed(6)}`); }
});

// ========== STREET VIEW (API, popup 350×250) ==========
const svService=new google.maps.StreetViewService();
function openStreetView(lat,lng){
  const html='<div id="sv" style="width:350px;height:250px"></div>';
  L.popup({maxWidth:380}).setLatLng([lat,lng]).setContent(html).openOn(map);
  setTimeout(()=>{
    svService.getPanorama({location:{lat:lat,lng:lng}, radius:60},(data,status)=>{
      if(status!=='OK'||!data||!data.location){ document.getElementById('sv').innerHTML='<div style="padding:8px">Không có Street View tại đây.</div>'; return; }
      let heading=0;
      if(data.links && data.links.length){ heading=data.links[0].heading; }
      else if(google.maps.geometry && data.location && data.location.latLng){
        heading=google.maps.geometry.spherical.computeHeading(data.location.latLng,new google.maps.LatLng(lat,lng));
      }
      new google.maps.StreetViewPanorama(document.getElementById('sv'),{
        position:data.location.latLng,pov:{heading:heading,pitch:0,zoom:0},
        linksControl:true,zoomControl:true,panControl:true,addressControl:false
      });
    });
  },40);
}
// Chuột phải mở Street View
map.on('contextmenu', e=> openStreetView(e.latlng.lat, e.latlng.lng));

// ========== TOOLS (right) ==========
document.getElementById('btnGPS').onclick=()=>{ if(!locateCtrl._map) locateCtrl.addTo(map); locateCtrl.start(); };
document.getElementById('btnMeasure').onclick=()=>{ const m=document.getElementById('measureMenu'); m.style.display=(m.style.display==='block')?'none':'block'; };

// Đo thủ công
let activeDraw=null, drawnItems=new L.FeatureGroup().addTo(map);
function stopMeasure(){ if(activeDraw){ activeDraw.disable(); activeDraw=null; } }
function startDist(){ stopMeasure(); activeDraw=new L.Draw.Polyline(map,{shapeOptions:{color:varPri(),weight:3}}); activeDraw.enable(); }
function startArea(){ stopMeasure(); activeDraw=new L.Draw.Polygon(map,{shapeOptions:{color:varPri(),weight:2,fillOpacity:.2}}); activeDraw.enable(); }
document.getElementById('mDist').onclick=()=>{document.getElementById('measureMenu').style.display='none'; startDist();};
document.getElementById('mArea').onclick=()=>{document.getElementById('measureMenu').style.display='none'; startArea();};
document.getElementById('mFinish').onclick=()=>{ stopMeasure(); document.getElementById('measureMenu').style.display='none'; };

map.on(L.Draw.Event.CREATED, e=>{
  const layer=e.layer; drawnItems.addLayer(layer);
  if(e.layerType==='polyline'){
    const coords=layer.getLatLngs().map(ll=>[ll.lng,ll.lat]);
    let len=0; for(let i=1;i<coords.length;i++){ len+=turf.distance(coords[i-1],coords[i],{units:'kilometers'}); }
    layer.bindPopup('Chiều dài: '+(len*1000).toFixed(1)+' m').openPopup();
  }else if(e.layerType==='polygon'){
    const coords=[layer.getLatLngs()[0].map(ll=>[ll.lng,ll.lat])];
    const poly=turf.polygon([coords[0]]); const area=turf.area(poly);
    layer.bindPopup('Diện tích: '+area.toFixed(0)+' m²').openPopup();
  }
});

// Đo nhanh (động) — click 1 lần chọn điểm đầu, di chuột để xem khoảng cách, ESC / double click để thoát
let dynamicStart=null,dynLine=null,dynLabel=null;
document.getElementById('mQuick').onclick=()=>{
  document.getElementById('measureMenu').style.display='none';
  alert('Đo nhanh: click chọn điểm đầu, di chuột để xem khoảng cách (m), double click hoặc ESC để thoát.');
  map.on('click',startDynamic);
};
function varPri(){return getComputedStyle(document.documentElement).getPropertyValue('--pri')||'#00BFFF';}
function startDynamic(e){
  if(dynamicStart){return;}
  dynamicStart=e.latlng;
  dynLine=L.polyline([dynamicStart],{color:'#00BFFF',weight:4,opacity:0.95}).addTo(map);
  dynLabel=L.marker(e.latlng,{interactive:false,icon:L.divIcon({className:'dynLabel',html:'',iconSize:[160,40]})}).addTo(map);
  map.on('mousemove',updateDynamic);
  map.on('dblclick',endDynamic);
  document.addEventListener('keydown',escDynamic);
}
function updateDynamic(e){
 if(!dynamicStart)return;
 const latlngs=[dynamicStart,e.latlng];
 dynLine.setLatLngs(latlngs);
 const dist=map.distance(dynamicStart,e.latlng);
 const text=`📍 ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}<br>📏 ${(dist).toFixed(1)} m`;
 dynLabel.setLatLng(e.latlng);
 const el=dynLabel._icon; if(el) el.innerHTML=`<div class="dynbox">${text}</div>`;
}
function endDynamic(){
 if(dynLine){dynLine.remove();} if(dynLabel){dynLabel.remove();}
 dynamicStart=null; dynLine=null; dynLabel=null;
 map.off('mousemove',updateDynamic); map.off('dblclick',endDynamic); map.off('click',startDynamic);
 document.removeEventListener('keydown',escDynamic);
}
function escDynamic(e){ if(e.key==='Escape') endDynamic(); }

// Glow effect cho dynamic line (#00BFFF)
L.Polyline.include({
  _updatePath:function(){
    L.Path.prototype._updatePath.call(this);
    if(this.options && this.options.color==='#00BFFF' && this._ctx){
      const ctx=this._ctx; ctx.save(); ctx.shadowColor='#00BFFF'; ctx.shadowBlur=10; ctx.stroke(); ctx.restore();
    }
  }
});

// ========== SIDEBAR TSBĐ/TSSS ==========
const sidebar=document.getElementById('sidebar');
document.getElementById('sidebarToggle').onclick=()=> sidebar.classList.add('open');
document.getElementById('sidebarClose').onclick=()=> sidebar.classList.remove('open');

const tabTSBD=document.getElementById('tab-tsbd'), tabTSSS=document.getElementById('tab-tsss');
const paneTSBD=document.getElementById('pane-tsbd'), paneTSSS=document.getElementById('pane-tsss');
function setTab(which){
  if(which==='tsbd'){ tabTSBD.classList.add('active'); tabTSSS.classList.remove('active'); paneTSBD.style.display='block'; paneTSSS.style.display='none'; }
  else{ tabTSBD.classList.remove('active'); tabTSSS.classList.add('active'); paneTSBD.style.display='none'; paneTSSS.style.display='block'; }
}
tabTSBD.onclick=()=>setTab('tsbd'); tabTSSS.onclick=()=>setTab('tsss');

// TSBD actions
document.getElementById('tsbdPin').onclick=()=>{
  const lat=parseFloat(document.getElementById('tsbdLat').value);
  const lng=parseFloat(document.getElementById('tsbdLng').value);
  if(!isFinite(lat)||!isFinite(lng)){ alert('Nhập Lat/Lng hợp lệ'); return; }
  placeMarker(lat,lng,'TSBĐ');
};
document.getElementById('tsbdStreet').onclick=()=>{
  const lat=parseFloat(document.getElementById('tsbdLat').value);
  const lng=parseFloat(document.getElementById('tsbdLng').value);
  if(!isFinite(lat)||!isFinite(lng)){ alert('Nhập Lat/Lng hợp lệ'); return; }
  openStreetView(lat,lng);
};

// TSSS list
const tsssList=document.getElementById('tsssList'); const items=[];
document.getElementById('tsssAdd').onclick=()=>{
  const name=document.getElementById('tsssTen').value.trim(); const price=parseFloat(document.getElementById('tsssGia').value);
  const lat=parseFloat(document.getElementById('tsssLat').value); const lng=parseFloat(document.getElementById('tsssLng').value);
  if(!name || !isFinite(lat)||!isFinite(lng)){ alert('Nhập tên và tọa độ hợp lệ'); return; }
  items.push({name,price,lat,lng}); renderTSSS();
};
function renderTSSS(){
  if(!items.length){ tsssList.innerHTML='Chưa có mục so sánh nào.'; return; }
  tsssList.innerHTML=items.map((it,i)=>`<div style="margin:8px 0;padding:8px;border:1px solid #eef1f4;border-radius:10px">
    <b>${i+1}. ${it.name}</b> ${isFinite(it.price)?'— '+it.price+' tỷ':''}<br>
    ${it.lat.toFixed(6)}, ${it.lng.toFixed(6)}
    <div style="margin-top:6px;display:flex;gap:6px">
      <button onclick="window._goTSSS(${i})">Tới vị trí</button>
      <button onclick="window._svTSSS(${i})">Street View</button>
      <button onclick="window._rmTSSS(${i})">Xóa</button>
    </div>
  </div>`).join('');
}
window._goTSSS=i=>{ const it=items[i]; placeMarker(it.lat,it.lng,it.name); };
window._svTSSS=i=>{ const it=items[i]; openStreetView(it.lat,it.lng); };
window._rmTSSS=i=>{ items.splice(i,1); renderTSSS(); };

// Coords footer
map.on('mousemove', e=> document.getElementById('coords').textContent=`Lat:${e.latlng.lat.toFixed(5)}, Lng:${e.latlng.lng.toFixed(5)}`);
</script>
</body>
</html>

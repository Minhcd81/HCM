<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>HCM WebGIS v14 â€” Admin Map + Measure + Compass + TSBÄ/TSSS + Export</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Äo Ä‘áº¡c + GPS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

<!-- Turf, XLSX, Screenshot JPG -->
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.0/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/leaflet-simple-map-screenshoter"></script>

<!-- Google Places (giá»¯ key cá»§a anh) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places,geometry"></script>

<style>
:root{--pri:#00BFFF;--gold:#FFD700}
*{box-sizing:border-box}
html,body,#map{height:100%;margin:0;font-family:Roboto,Arial}
#map{position:absolute;inset:0}

/* Search */
#searchWrap{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:1400;width:860px;max-width:92vw}
#search{width:100%;padding:12px 14px;border:1px solid #cfd4dc;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.15)}

/* Right tools */
#tools{position:absolute;right:10px;top:72px;z-index:1200;display:flex;flex-direction:column;gap:10px}
.toolbtn{background:#fff;border:1px solid #ddd;border-radius:50%;width:48px;height:48px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.15);font-size:22px}
#btnClear{position:absolute;right:10px;top:240px;z-index:1200;background:#fff;border:1px solid #ddd;border-radius:12px;padding:8px 12px;box-shadow:0 2px 6px rgba(0,0,0,.15);cursor:pointer}

/* Measure menu */
#measureMenu{position:absolute;right:70px;top:122px;background:#fff;border:1px solid #ddd;border-radius:12px;
box-shadow:0 8px 24px rgba(0,0,0,.18);display:none;z-index:1300}
#measureMenu button{display:block;width:240px;padding:10px 14px;border:none;background:#fff;text-align:left;cursor:pointer;font-size:14px}
#measureMenu button:hover{background:#f1f5f9}

/* Sidebar */
#sidebarToggle{position:absolute;left:10px;top:120px;z-index:1200;background:#fff;border:1px solid #ddd;border-radius:12px;padding:8px 12px;box-shadow:0 2px 6px rgba(0,0,0,.15);cursor:pointer}
#sidebar{position:fixed;left:0;top:0;height:100%;width:380px;background:#fff;box-shadow:4px 0 20px rgba(0,0,0,.2);
         transform:translateX(-400px);transition:transform .28s ease;z-index:1600;display:flex;flex-direction:column}
#sidebar.open{transform:translateX(0)}
#sbHead{background:var(--pri);color:#fff;padding:14px 16px;font-weight:700;display:flex;align-items:center;justify-content:space-between}
#sidebarClose{border:none;background:transparent;color:#fff;font-size:22px;cursor:pointer}
#sbBody{padding:12px 12px 90px;overflow:auto}
.section{border:1px solid #e5e7eb;border-radius:12px;padding:10px 10px 6px;margin-bottom:10px}
.section h4{margin:0 0 8px;font-size:14px}
.form-row{display:flex;gap:8px;margin-bottom:8px}
.form-row input,.form-row select,.form-row textarea{flex:1;padding:9px;border:1px solid #cfd4dc;border-radius:10px}
.sm{font-size:12px;color:#6b7280}

/* Marker style (DivIcon) */
.pin{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#003;font-weight:700;border:3px solid #004;}
.pin.tsbd{background:var(--gold);border-color:#a06f00}
.pin.tsss{background:var(--pri);border-color:#0a4f7a;color:#fff}

/* Compass overlay (chá»‰ váº¡ch + chá»¯, ná»n 100% trong suá»‘t) */
#compassOverlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:260px;height:260px;pointer-events:none;display:none;z-index:1300}
#compassCanvas{width:100%;height:100%}

/* coords footer */
.coords{position:absolute;left:10px;bottom:6px;background:rgba(255,255,255,.9);padding:4px 8px;border-radius:8px;font:12px monospace;z-index:1000}

@media(max-width:768px){
  #searchWrap{width:92vw}
  #sidebar{width:92vw;transform:translateX(-100vw)}
  #compassOverlay{width:220px;height:220px}
}
</style>
</head>
<body>
<!-- Search -->
<div id="searchWrap"><input id="search" placeholder="ğŸ” Äá»‹a chá»‰ / PhÆ°á»ng-XÃ£ / TÃªn cÅ© / Tá»a Ä‘á»™ (10.79, 106.66)"></div>

<div id="map"></div>

<!-- Tools -->
<div id="tools">
  <button id="btnCompass" class="toolbtn" title="Báº­t/Táº¯t la bÃ n">ğŸ§­</button>
  <button id="btnMeasure" class="toolbtn" title="Äo (khoáº£ng cÃ¡ch/diá»‡n tÃ­ch)">ğŸ“</button>
  <button id="btnGPS" class="toolbtn" title="Äá»‹nh vá»‹">ğŸ“</button>
  <button id="btnShot" class="toolbtn" title="Chá»¥p báº£n Ä‘á»“ JPG">ğŸ“¸</button>
</div>
<div id="measureMenu">
  <button id="mDist">ğŸ“ğŸ“ Äo khoáº£ng cÃ¡ch</button>
  <button id="mArea">â¬› Äo diá»‡n tÃ­ch</button>
  <button id="mFinish">ğŸ›‘ HoÃ n táº¥t Ä‘o</button>
</div>
<button id="btnClear">ğŸ§¹ XÃ³a tÃ´ mÃ u</button>

<!-- Sidebar -->
<button id="sidebarToggle">ğŸ“‹ TSBÄ / TSSS</button>
<div id="sidebar">
  <div id="sbHead"><span>ğŸ“‹ TSBÄ / TSSS</span><button id="sidebarClose">Ã—</button></div>
  <div id="sbBody">
    <div class="section">
      <h4>TSBÄ</h4>
      <div class="form-row"><input id="tsbdTen" placeholder="TÃªn/Äá»‹a chá»‰ TSBÄ"><input id="tsbdGia" placeholder="GiÃ¡ (tá»·)" type="number"></div>
      <div class="form-row"><input id="tsbdLat" placeholder="Lat"><input id="tsbdLng" placeholder="Lng"></div>
      <div class="form-row"><button id="tsbdPin">ğŸ“ Äáº·t Ä‘iá»ƒm</button><button id="tsbdStreet">ğŸ‘ï¸ Street View</button></div>
      <div class="sm">TSBÄ hiá»ƒn thá»‹ vÃ²ng trÃ²n <b>vÃ ng</b>.</div>
    </div>

    <div class="section">
      <h4>TSSS</h4>
      <div class="form-row"><input id="tsssTen" placeholder="TÃªn/Äá»‹a chá»‰ so sÃ¡nh"><input id="tsssGia" placeholder="GiÃ¡ (tá»·)" type="number"></div>
      <div class="form-row"><input id="tsssLat" placeholder="Lat"><input id="tsssLng" placeholder="Lng"></div>
      <div class="form-row"><button id="tsssAdd">â• ThÃªm TSSS</button><button id="tsssClear">ğŸ—‘ï¸ XÃ³a TSSS</button></div>
      <div id="tsssList" class="sm">ChÆ°a cÃ³ TSSS.</div>
    </div>

    <div class="section">
      <h4>LÆ°u / Táº£i dá»¯ liá»‡u</h4>
      <div class="form-row"><button id="btnExportCSV">ğŸ“„ Xuáº¥t CSV</button><button id="btnExportXLSX">ğŸ“˜ Xuáº¥t Excel (.xlsx)</button></div>
      <div class="form-row"><button id="btnExportKML">ğŸ—ºï¸ Táº¡o My Map (KML)</button><button id="btnOpenMyMaps">ğŸ“‚ Má»Ÿ My Maps</button></div>
      <div class="sm">Excel/CSV cÃ³ cá»™t <b>Quáº­n/Huyá»‡n</b>. KML dÃ¹ng Ä‘á»ƒ import vÃ o Google My Maps.</div>
    </div>
  </div>
</div>

<!-- Compass overlay -->
<div id="compassOverlay"><canvas id="compassCanvas" width="260" height="260"></canvas></div>

<div class="coords" id="coords">Lat: --, Lng: --</div>

<script>
/* ========== MAP BASE ========== */
const map=L.map('map',{center:[10.775,106.7],zoom:12});
const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(map);
const gSt=L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}');
const gHy=L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}');
L.control.layers({"ğŸ—ºï¸ OSM":osm,"ğŸŒ Google Street":gSt,"ğŸ›°ï¸ Google Hybrid":gHy}).addTo(map);
map.on('mousemove',e=>document.getElementById('coords').textContent=`Lat:${e.latlng.lat.toFixed(5)}, Lng:${e.latlng.lng.toFixed(5)}`);

/* ========== Sidebar toggle ========== */
const sidebar=document.getElementById('sidebar');
document.getElementById('sidebarToggle').onclick=()=>sidebar.classList.add('open');
document.getElementById('sidebarClose').onclick=()=>sidebar.classList.remove('open');

/* ========== GeoJSON hÃ nh chÃ­nh ========== */
let wardLayer=null, wardFeatures=[], coloredLayers=[];
fetch('assets/TPHCM.geojson').then(r=>r.json()).then(g=>{
  wardLayer=L.geoJSON(g,{style:{color:'#555',weight:1,fillOpacity:.1}, onEachFeature:(f,l)=>{
    const p=f.properties||{}, ten=(p.ten_xa||'').toString().trim(), qh=(p.quan_huyen||'').toString().trim();
    const sn=(p.sap_nhap && p.sap_nhap!=='0')?p.sap_nhap:'â€”';
    const dt=(p.dtich_km2!=null)?`${p.dtich_km2} kmÂ²`:'â€”';
    const ds=(p.dan_so!=null)?`${Number(p.dan_so).toLocaleString('vi-VN')} ngÆ°á»i`:'â€”';
    l.bindPopup(`<b>${ten}</b><br>${qh}<br>TrÆ°á»›c sÃ¡p nháº­p: ${sn}<br>Diá»‡n tÃ­ch: ${dt}<br>DÃ¢n sá»‘: ${ds}`);
    l.on('click',()=>{const c=randColor(); l.setStyle({fillColor:c,fillOpacity:.45}); if(!coloredLayers.includes(l)) coloredLayers.push(l); l.openPopup();});
    wardFeatures.push(f);
  }}).addTo(map);
}).catch(()=>alert('KhÃ´ng táº£i Ä‘Æ°á»£c assets/TPHCM.geojson'));

document.getElementById('btnClear').onclick=()=>{ coloredLayers.forEach(l=>l.setStyle({fillColor:null,fillOpacity:.1})); coloredLayers=[]; };
function randColor(){const a=['#FFD700','#FFA500','#FF4500','#8A2BE2','#1E90FF','#00CED1'];return a[(Math.random()*a.length)|0];}

/* Tra Quáº­n/Huyá»‡n theo Ä‘iá»ƒm */
function findQuanHuyen(lat,lng){
  if(!wardFeatures.length) return '';
  const pt=turf.point([lng,lat]);
  for(const f of wardFeatures){ if(turf.booleanPointInPolygon(pt,f)) return (f.properties?.quan_huyen||'').toString().trim(); }
  return '';
}

/* ========== Search há»£p nháº¥t ========== */
const search=document.getElementById('search');
try{
  const ac=new google.maps.places.Autocomplete(search,{types:['geocode'],componentRestrictions:{country:'vn'}});
  ac.addListener('place_changed',()=>{
    const pl=ac.getPlace();
    if(pl && pl.geometry){ const lat=pl.geometry.location.lat(), lng=pl.geometry.location.lng();
      map.setView([lat,lng],17); placeTemp(lat,lng,pl.formatted_address);
    }
  });
}catch(e){console.warn('Places khÃ´ng sáºµn:',e);}
search.addEventListener('keydown',e=>{
  if(e.key!=='Enter') return;
  const v=search.value.trim();
  const m=v.match(/^(-?\d+(?:\.\d+)?),\s*(-?\d+(?:\.\d+)?)/);
  if(m){ map.setView([+m[1],+m[2]],17); placeTemp(+m[1],+m[2],"Tá»a Ä‘á»™ nháº­p tay"); }
});
let lastTemp=null;
function placeTemp(lat,lng,label){
  if(lastTemp) map.removeLayer(lastTemp);
  lastTemp=L.marker([lat,lng]).addTo(map).bindPopup(`<b>${label}</b>`).openPopup();
}

/* ========== Measure (Leaflet.Draw) ========== */
const drawnItems=new L.FeatureGroup().addTo(map);
let activeDraw=null;
function stopMeasure(){if(activeDraw){activeDraw.disable();activeDraw=null;}}
document.getElementById('btnMeasure').onclick=()=>{const m=document.getElementById('measureMenu');m.style.display=m.style.display==='block'?'none':'block';};
document.getElementById('mDist').onclick=()=>{stopMeasure();activeDraw=new L.Draw.Polyline(map,{shapeOptions:{color:varPri()}});activeDraw.enable();document.getElementById('measureMenu').style.display='none';};
document.getElementById('mArea').onclick=()=>{stopMeasure();activeDraw=new L.Draw.Polygon(map,{shapeOptions:{color:varPri(),fillOpacity:.2}});activeDraw.enable();document.getElementById('measureMenu').style.display='none';};
document.getElementById('mFinish').onclick=()=>{stopMeasure();document.getElementById('measureMenu').style.display='none';};
map.on(L.Draw.Event.CREATED,e=>{
  const layer=e.layer;drawnItems.addLayer(layer);
  if(e.layerType==='polyline'){
    const coords=layer.getLatLngs().map(ll=>[ll.lng,ll.lat]);let len=0;for(let i=1;i<coords.length;i++){len+=turf.distance(coords[i-1],coords[i],{units:'kilometers'});}
    layer.bindPopup('Chiá»u dÃ i: '+(len*1000).toFixed(1)+' m').openPopup();
  }else if(e.layerType==='polygon'){
    const coords=[layer.getLatLngs()[0].map(ll=>[ll.lng,ll.lat])];const poly=turf.polygon([coords[0]]);const area=turf.area(poly);
    layer.bindPopup('Diá»‡n tÃ­ch: '+area.toFixed(0)+' mÂ²').openPopup();
  }
});
function varPri(){return getComputedStyle(document.documentElement).getPropertyValue('--pri')||'#00BFFF';}

/* ========== Compass overlay ========== */
const compassEl=document.getElementById('compassOverlay');
const cv=document.getElementById('compassCanvas'), ctx=cv.getContext('2d');
let compassOn=false, deviceHeading=0;
function drawCompass(){
  const R=cv.width/2, C=R; ctx.clearRect(0,0,cv.width,cv.height);
  ctx.strokeStyle='rgba(0,0,0,.35)'; ctx.lineWidth=1.4;
  ctx.beginPath(); ctx.arc(C,C,R-6,0,Math.PI*2); ctx.stroke();
  for(let d=0; d<360; d+=10){
    const len=(d%30===0)?10:5, a=(d-deviceHeading)*Math.PI/180;
    const r1=R-14, r2=r1-len;
    ctx.beginPath();
    ctx.moveTo(C+Math.cos(a)*r1, C+Math.sin(a)*r1);
    ctx.lineTo(C+Math.cos(a)*r2, C+Math.sin(a)*r2);
    ctx.stroke();
  }
  labelAt('B',0); labelAt('Ä',90); labelAt('N',180); labelAt('T',270);
  function labelAt(t,deg){const a=(deg-deviceHeading)*Math.PI/180, r=R-34; ctx.fillStyle='#111'; ctx.font='700 14px Roboto'; ctx.textAlign='center'; ctx.fillText(t, C+Math.cos(a)*r, C+Math.sin(a)*r+5);}
  ctx.save(); ctx.translate(C,C); ctx.rotate((-deviceHeading)*Math.PI/180);
  ctx.fillStyle='#d00'; ctx.beginPath(); ctx.moveTo(0,-(R-34)); ctx.lineTo(7,0); ctx.lineTo(-7,0); ctx.closePath(); ctx.fill(); ctx.restore();
}
document.getElementById('btnCompass').onclick=()=>{compassOn=!compassOn; compassEl.style.display=compassOn?'block':'none'; if(compassOn) drawCompass();};
window.addEventListener('deviceorientation',e=>{ if(typeof e.alpha==='number'){deviceHeading=360-e.alpha; if(compassOn) drawCompass();} });

/* ========== GPS ========== */
const locateCtrl=L.control.locate({strings:{title:"Vá»‹ trÃ­ cá»§a tÃ´i"},showCompass:true,setView:'untilPanOrZoom'});
document.getElementById('btnGPS').onclick=()=>{ if(!locateCtrl._map) locateCtrl.addTo(map); locateCtrl.start(); };

/* ========== Screenshot JPG ========== */
const screenshoter = new L.simpleMapScreenshoter({ hidden:true, mimeType:'image/jpeg', quality:0.92, domtoimageOptions:{bgcolor:'#ffffff'} }).addTo(map);
document.getElementById('btnShot').onclick=()=>{ screenshoter.takeScreen('blob').then(blob=>{const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`HCM_Map_${ts()}.jpg`; a.click();}).catch(()=>alert('KhÃ´ng chá»¥p Ä‘Æ°á»£c áº£nh.')); };

/* ========== TSBÄ / TSSS ========== */
function iconTSBD(){ return L.divIcon({className:'', html:`<div class="pin tsbd">TSBÄ</div>`, iconSize:[34,34], iconAnchor:[17,17]}); }
function iconTSSS(){ return L.divIcon({className:'', html:`<div class="pin tsss">TSSS</div>`, iconSize:[34,34], iconAnchor:[17,17]}); }

let tsbdMarker=null; const tsssMarkers=[];
const tsbdTen=document.getElementById('tsbdTen'), tsbdGia=document.getElementById('tsbdGia'), tsbdLat=document.getElementById('tsbdLat'), tsbdLng=document.getElementById('tsbdLng');
const tsssTen=document.getElementById('tsssTen'), tsssGia=document.getElementById('tsssGia'), tsssLat=document.getElementById('tsssLat'), tsssLng=document.getElementById('tsssLng');

document.getElementById('tsbdPin').onclick=()=>{
  const lat=parseFloat(tsbdLat.value), lng=parseFloat(tsbdLng.value);
  if(!isFinite(lat)||!isFinite(lng)){alert('Nháº­p Lat/Lng há»£p lá»‡ cho TSBÄ');return;}
  if(tsbdMarker) map.removeLayer(tsbdMarker);
  tsbdMarker=L.marker([lat,lng],{icon:iconTSBD()}).addTo(map);
  const qh=findQuanHuyen(lat,lng);
  tsbdMarker.bindPopup(`<b>${tsbdTen.value||'TSBÄ'}</b><br><small>${qh||'â€”'}</small>${tsbdGia.value?`<br>GiÃ¡: ${tsbdGia.value} tá»·`:''}`).openPopup();
  map.setView([lat,lng],17);
};
document.getElementById('tsbdStreet').onclick=()=>{
  const lat=parseFloat(tsbdLat.value), lng=parseFloat(tsbdLng.value);
  if(!isFinite(lat)||!isFinite(lng)){alert('Nháº­p Lat/Lng há»£p lá»‡ cho TSBÄ');return;}
  const html=`<iframe width='350' height='250' style='border:0' loading='lazy'
    referrerpolicy='no-referrer-when-downgrade'
    src='https://www.google.com/maps/embed?pb=!4v1665600758447!6m8!1m7!1sCAoSLEFGMVFpcE1Xd2VoQllvT2F2TkFwSGlDaTZYVFF6b1pHOUdwa3JtX3lPaUo3!2m2!1d${lat}!2d${lng}!3f0!4f0!5f0!0'></iframe>`;
  L.popup().setLatLng([lat,lng]).setContent(html).openOn(map);
};

document.getElementById('tsssAdd').onclick=()=>{
  const lat=parseFloat(tsssLat.value), lng=parseFloat(tsssLng.value);
  if(!isFinite(lat)||!isFinite(lng)){alert('Nháº­p Lat/Lng há»£p lá»‡ cho TSSS');return;}
  const m=L.marker([lat,lng],{icon:iconTSSS()}).addTo(map);
  m.meta={name:tsssTen.value||'TSSS', price:isFinite(+tsssGia.value)?+tsssGia.value:null};
  const qh=findQuanHuyen(lat,lng);
  m.bindPopup(`<b>${m.meta.name}</b><br><small>${qh||'â€”'}</small>${m.meta.price!=null?`<br>GiÃ¡: ${m.meta.price} tá»·`:''}`);
  tsssMarkers.push(m); map.setView([lat,lng],17); renderList();
};
document.getElementById('tsssClear').onclick=()=>{ tsssMarkers.forEach(m=>map.removeLayer(m)); tsssMarkers.length=0; renderList(); };
function renderList(){
  const box=document.getElementById('tsssList');
  if(tsssMarkers.length===0){ box.textContent='ChÆ°a cÃ³ TSSS.'; return; }
  box.innerHTML=tsssMarkers.map(m=>`â€¢ ${m.meta?.name||'TSSS'} â€” ${m.getLatLng().lat.toFixed(5)}, ${m.getLatLng().lng.toFixed(5)} ${m.meta?.price!=null?`â€” ${m.meta.price} tá»·`:''}`).join('<br>');
}

/* ========== Export CSV/XLSX ========== */
function ts(){const d=new Date();const p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}`;}
function rowsForExport(){
  if(!tsbdMarker){alert('Äáº·t Ä‘iá»ƒm TSBÄ trÆ°á»›c khi xuáº¥t');return null;}
  const a=tsbdMarker.getLatLng(), qhA=findQuanHuyen(a.lat,a.lng);
  const rows=[{Loai:'TSBD',Ten:tsbdTen.value||'TSBÄ',Lat:+a.lat.toFixed(6),Lng:+a.lng.toFixed(6),Quan_Huyen:qhA||'',Gia_ty:isFinite(+tsbdGia.value)?+tsbdGia.value:'',Khoang_cach:'',Ghi_chu:''}];
  tsssMarkers.forEach(m=>{
    const b=m.getLatLng(), qhB=findQuanHuyen(b.lat,b.lng);
    let dist=''; if(tsbdMarker){ const dkm=turf.distance([a.lng,a.lat],[b.lng,b.lat],{units:'kilometers'}); dist=`${(dkm*1000).toFixed(1)} m`; }
    rows.push({Loai:'TSSS',Ten:m.meta?.name||'TSSS',Lat:+b.lat.toFixed(6),Lng:+b.lng.toFixed(6),Quan_Huyen:qhB||'',Gia_ty:(m.meta?.price!=null)?m.meta.price:'',Khoang_cach:dist,Ghi_chu:''});
  });
  return rows;
}
document.getElementById('btnExportCSV').onclick=()=>{
  const rows=rowsForExport(); if(!rows) return;
  const headers=['Loai','Ten','Lat','Lng','Quan_Huyen','Gia_ty','Khoang_cach','Ghi_chu'];
  const csv=[headers.join(','),...rows.map(r=>headers.map(h=>String(r[h]??'').replace(/"/g,'""')).map(v=>/[",\n]/.test(v)?`"${v}"`:v).join(','))].join('\n');
  const blob=new Blob([`\uFEFF${csv}`],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download=`TS_Export_${ts()}.csv`; a.click();
};
document.getElementById('btnExportXLSX').onclick=()=>{
  const rows=rowsForExport(); if(!rows) return;
  const ws=XLSX.utils.json_to_sheet(rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'DATA'); XLSX.writeFile(wb,`TS_Export_${ts()}.xlsx`);
};

/* ========== KML (My Maps) ========== */
document.getElementById('btnExportKML').onclick=()=>{
  if(!tsbdMarker){alert('Äáº·t Ä‘iá»ƒm TSBÄ trÆ°á»›c khi xuáº¥t KML');return;}
  const a=tsbdMarker.getLatLng(), qhA=findQuanHuyen(a.lat,a.lng);
  const esc=s=>String(s??'').replace(/[<&>]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));
  const placemark=(name,desc,lat,lng,style)=>`
  <Placemark><name>${esc(name)}</name><description>${esc(desc)}</description><styleUrl>#${style}</styleUrl><Point><coordinates>${lng},${lat},0</coordinates></Point></Placemark>`;
  let kml=`<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document>
  <name>HCM_TSBD_TSSS_${ts()}</name>
  <Style id="tsbd"><IconStyle><scale>1.2</scale><Icon><href>http://maps.google.com/mapfiles/kml/paddle/ylw-circle.png</href></Icon></IconStyle></Style>
  <Style id="tsss"><IconStyle><scale>1.2</scale><Icon><href>http://maps.google.com/mapfiles/kml/paddle/blu-circle.png</href></Icon></IconStyle></Style>`;
  kml+=placemark(tsbdTen.value||'TSBÄ',`Quáº­n/Huyá»‡n: ${qhA||'â€”'}${tsbdGia.value?` | GiÃ¡: ${tsbdGia.value} tá»·`:''}`,a.lat,a.lng,'tsbd');
  tsssMarkers.forEach(m=>{const b=m.getLatLng(), qh=findQuanHuyen(b.lat,b.lng); kml+=placemark(m.meta?.name||'TSSS',`Quáº­n/Huyá»‡n: ${qh||'â€”'}${m.meta?.price!=null?` | GiÃ¡: ${m.meta.price} tá»·`:''}`,b.lat,b.lng,'tsss');});
  kml+='</Document></kml>';
  const blob=new Blob([kml],{type:'application/vnd.google-earth.kml+xml'}); const aTag=document.createElement('a'); aTag.href=URL.createObjectURL(blob); aTag.download=`HCM_TSBD_TSSS_${ts()}.kml`; aTag.click();
};
document.getElementById('btnOpenMyMaps').onclick=()=>window.open('https://www.google.com/mymaps','_blank');
</script>
</body>
</html>

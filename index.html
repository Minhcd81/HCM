<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>HCM WebGIS v8.4 â€” Fixed GeoJSON + Responsive Panel</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places,geometry"></script>

<style>
:root{--pri:#00BFFF;--text:#202124}
html,body{height:100%;margin:0;font-family:'Roboto',Arial,sans-serif}
#map{position:absolute;inset:0}
#searchbar{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:1200;width:560px;max-width:92vw}
#q{width:100%;padding:10px 12px;border:1px solid #ccc;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.15)}
#tools{position:absolute;right:10px;top:70px;z-index:1200;display:flex;flex-direction:column;gap:10px}
.toolbtn{background:#fff;border:1px solid #ddd;border-radius:50%;width:48px;height:48px;cursor:pointer;
display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.toolbtn:hover{background:#f5f8ff}
#measureMenu{position:absolute;right:70px;top:120px;background:#fff;border:1px solid #ddd;border-radius:12px;
box-shadow:0 8px 24px rgba(0,0,0,.18);display:none;z-index:1300}
#measureMenu button{display:block;width:220px;padding:10px 14px;border:none;background:#fff;text-align:left;cursor:pointer;font-size:14px}
#measureMenu button:hover{background:#f1f5f9}
#btnClear{position:absolute;right:10px;top:220px;z-index:1200;background:#fff;border:1px solid #ddd;border-radius:12px;padding:8px 12px;
box-shadow:0 2px 6px rgba(0,0,0,.15);cursor:pointer}
#sidebarToggle{position:absolute;left:10px;top:120px;z-index:1200;background:#fff;border:1px solid #ddd;border-radius:12px;
padding:8px 12px;box-shadow:0 2px 6px rgba(0,0,0,.15);cursor:pointer}
#sidebar{position:fixed;left:0;top:0;height:100%;width:360px;background:#fff;box-shadow:4px 0 20px rgba(0,0,0,.2);
transform:translateX(-380px);transition:transform .3s ease;z-index:1600;padding:16px;overflow:auto}
#sidebar.open{transform:translateX(0)}
#tabs{display:flex;gap:8px;margin-bottom:10px}
#tabs button{flex:1;border:1px solid #cfd4dc;background:#f6f8fa;border-radius:10px;padding:8px;cursor:pointer}
#tabs button.active{background:#00BFFF;color:#fff}
.form-row{display:flex;gap:8px;margin-bottom:8px}
.form-row input,.form-row select,.form-row textarea{flex:1;padding:9px;border:1px solid #cfd4dc;border-radius:10px}
#sidebarClose{position:absolute;right:10px;top:8px;border:none;background:none;font-size:22px;cursor:pointer}
.coords{position:absolute;left:10px;bottom:6px;background:rgba(255,255,255,.9);padding:4px 8px;border-radius:8px;font:12px monospace;z-index:1000}
@media(max-width:768px){
#searchbar{width:90vw}
#tools{flex-direction:row;bottom:10px;top:auto;right:50%;transform:translateX(50%)}
#btnClear,#sidebarToggle{bottom:70px;top:auto}
}
</style>
</head>
<body>
<div id="searchbar"><input id="q" placeholder="ğŸ” Äá»‹a chá»‰ / phÆ°á»ng/xÃ£ hoáº·c tá»a Ä‘á»™: 10.79844, 106.65855"></div>
<div id="map"></div>
<div id="tools">
<button id="btnCompass" class="toolbtn" title="La bÃ n">ğŸ§­</button>
<button id="btnMeasure" class="toolbtn" title="Äo">ğŸ“</button>
<button id="btnGPS" class="toolbtn" title="Äá»‹nh vá»‹">ğŸ“</button>
</div>
<div id="measureMenu">
<button id="mDist">ğŸ“ğŸ“ Äo khoáº£ng cÃ¡ch</button>
<button id="mArea">â¬› Äo diá»‡n tÃ­ch</button>
<button id="mFinish">ğŸ›‘ HoÃ n táº¥t Ä‘o</button>
</div>
<button id="btnClear">ğŸ§¹ XÃ³a tÃ´ mÃ u</button>
<button id="sidebarToggle">ğŸ“‹ TSBÄ / TSSS</button>

<div id="sidebar">
<button id="sidebarClose">Ã—</button>
<h3>ThÃ´ng tin tÃ i sáº£n</h3>
<div id="tabs">
<button id="tab-tsbd" class="active">TSBÄ</button>
<button id="tab-tsss">TSSS</button>
</div>
<div id="pane-tsbd">
<div class="form-row"><select id="tsbdLoai"><option>NhÃ  á»Ÿ</option><option>Äáº¥t trá»‘ng</option><option>CÄƒn há»™</option></select></div>
<div class="form-row"><input id="tsbdDientich" placeholder="Diá»‡n tÃ­ch (mÂ²)" type="number"><input id="tsbdGia" placeholder="GiÃ¡ trá»‹ (tá»·)" type="number"></div>
<div class="form-row"><input id="tsbdLat" placeholder="Lat"><input id="tsbdLng" placeholder="Lng"></div>
<div class="form-row"><textarea id="tsbdGhiChu" rows="3" placeholder="Ghi chÃº"></textarea></div>
<div class="form-row"><button id="tsbdPin">ğŸ“ Äáº·t Ä‘iá»ƒm</button><button id="tsbdStreet">ğŸ‘ï¸ Street View</button></div>
</div>
<div id="pane-tsss" style="display:none">
<div class="form-row"><input id="tsssTen" placeholder="TÃªn so sÃ¡nh"><input id="tsssGia" placeholder="GiÃ¡ (tá»·)" type="number"></div>
<div class="form-row"><input id="tsssLat" placeholder="Lat"><input id="tsssLng" placeholder="Lng"></div>
<div class="form-row"><button id="tsssAdd">â• ThÃªm</button></div>
<div id="tsssList" class="muted">ChÆ°a cÃ³ má»¥c so sÃ¡nh nÃ o.</div>
</div>
</div>

<div class="coords" id="coords">Lat: --, Lng: --</div>

<script>
// ============ MAP BASE ============
const map=L.map('map',{center:[10.776,106.7],zoom:12});
const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(map);
const gStreet=L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}');
const gHybrid=L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}');
L.control.layers({"ğŸ—ºï¸ OSM":osm,"ğŸŒ Google Street":gStreet,"ğŸ›°ï¸ Google Hybrid":gHybrid}).addTo(map);

let coloredLayers=[];
document.getElementById('btnClear').onclick=()=>{coloredLayers.forEach(l=>l.setStyle({fillColor:null,fillOpacity:.15}));coloredLayers=[];};

// ============ SEARCH ============
const q=document.getElementById('q');
q.addEventListener('keydown',e=>{
if(e.key!=='Enter')return;
const m=q.value.match(/^(-?\d+(?:\.\d+)?),\s*(-?\d+(?:\.\d+)?)/);
if(m){placeMarker(parseFloat(m[1]),parseFloat(m[2]),'Tá»a Ä‘á»™ nháº­p tay');}
});
function placeMarker(lat,lng,label){map.setView([lat,lng],17);L.marker([lat,lng]).addTo(map)
.bindPopup(`<b>${label}</b><br><button id='svbtn'>ğŸ‘ï¸ Xem Street View táº¡i vá»‹ trÃ­ nÃ y</button>`).openPopup();
setTimeout(()=>{const b=document.getElementById('svbtn');if(b)b.onclick=()=>openStreetView(lat,lng);},300);}
function openStreetView(lat,lng){
const html=`<iframe width='350' height='250' style='border:0' loading='lazy'
referrerpolicy='no-referrer-when-downgrade'
src='https://www.google.com/maps/embed?pb=!4v1665600758447!6m8!1m7!1sCAoSLEFGMVFpcE1Xd2VoQllvT2F2TkFwSGlDaTZYVFF6b1pHOUdwa3JtX3lPaUo3!2m2!1d${lat}!2d${lng}!3f0!4f0!5f0.7820865974627469'></iframe>`;
L.popup().setLatLng([lat,lng]).setContent(html).openOn(map);
}

// ============ GEOJSON ============
fetch('assets/TPHCM.geojson')
.then(r=>r.json())
.then(geo=>{
L.geoJSON(geo,{style:{color:'#555',weight:1,fillOpacity:.15},
onEachFeature:(f,l)=>{
const p=f.properties;
const ten=p.ten_xa||'KhÃ´ng rÃµ', qh=p.quan_huyen||'', sn=p.sap_nhap||'â€”', dt=p.dtich_km2||'â€”', ds=p.dan_so?`${p.dan_so.toLocaleString('vi-VN')} ngÆ°á»i`:'â€”';
l.bindPopup(`<b>${ten}</b><br>${qh}<br>TrÆ°á»›c sÃ¡p nháº­p: ${sn}<br>Diá»‡n tÃ­ch: ${dt} kmÂ²<br>DÃ¢n sá»‘: ${ds}`);
l.on('click',()=>{const c=['#FFD700','#FFA500','#FF4500','#8A2BE2','#1E90FF','#00CED1'][Math.floor(Math.random()*6)];
l.setStyle({fillColor:c,fillOpacity:.5});coloredLayers.push(l);});
}}).addTo(map);
})
.catch(()=>alert('KhÃ´ng táº£i Ä‘Æ°á»£c assets/TPHCM.geojson, kiá»ƒm tra Ä‘Æ°á»ng dáº«n.'));

map.on('mousemove',e=>document.getElementById('coords').textContent=`Lat:${e.latlng.lat.toFixed(5)}, Lng:${e.latlng.lng.toFixed(5)}`);
</script>
</body>
</html>
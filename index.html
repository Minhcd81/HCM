<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>HCM WebGIS ‚Äì Full Version (Google + Bing + Esri + GeoJSON)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>

<style>
  html, body, #map {height:100%; margin:0; padding:0;}
  .leaflet-bar button {display:block; width:100%; border:none; background:white; padding:5px; cursor:pointer;}
  .leaflet-bar button:hover {background:#eee;}
  .search-box {position:absolute; top:10px; left:50px; width:350px; z-index:9999; padding:5px;}
</style>
</head>
<body>
<div id="map"></div>

<!-- JS LIBRARIES -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.min.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places"></script>
<script src="https://unpkg.com/leaflet.gridlayer.googlemutant@0.13.6/dist/Leaflet.GoogleMutant.min.js"></script>

<script>
let map = L.map('map', {center:[10.776,106.7], zoom:12});

// ====== GOOGLE MAP LAYERS ======
let gRoad = L.gridLayer.googleMutant({type:'roadmap'});
let gSat  = L.gridLayer.googleMutant({type:'satellite'});
let gHy   = L.gridLayer.googleMutant({type:'hybrid'});

// ====== OTHER MAPS ======
let osm  = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution:'¬© OpenStreetMap'});
let esriStreet = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {attribution:'Esri'});
let esriImg    = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution:'Esri'});

// ====== BING MAP (THAY KEY) ======
let bingKey = "YOUR_BING_API_KEY";
let bingAerial = L.tileLayer(`https://ecn.t{s}.tiles.virtualearth.net/tiles/a{q}.jpeg?g=1&key=${bingKey}`, {
  subdomains:['t0','t1','t2','t3'],
  attribution:'¬© Microsoft Bing'
});

osm.addTo(map);

// ====== BASEMAP CONTROL ======
let baseMaps = {
  "üó∫Ô∏è Google Street": gRoad,
  "üåè Google Hybrid": gHy,
  "üõ∞Ô∏è Google Satellite": gSat,
  "üó∫Ô∏è OpenStreetMap": osm,
  "üó∫Ô∏è Esri Streets": esriStreet,
  "üõ∞Ô∏è Esri Imagery": esriImg,
  "üõ∞Ô∏è Bing Aerial": bingAerial
};
L.control.layers(baseMaps, {}).addTo(map);

// ====== TOOLBAR ======
L.control.scale().addTo(map);
L.control.locate({strings:{title:"ƒê·ªãnh v·ªã GPS"}, position:"topleft"}).addTo(map);
L.control.measure({position:'topleft', primaryLengthUnit:'meters', primaryAreaUnit:'sqmeters'}).addTo(map);

// ====== GEOJSON LAYER ======
let hcmLayer, colored = [];

async function loadHCM(){
  const res = await fetch('assets/TPHCM.geojson');
  const data = await res.json();
  if(hcmLayer) map.removeLayer(hcmLayer);

  hcmLayer = L.geoJSON(data,{
    style:{color:"#ff0000",weight:1,fillOpacity:0.1},
    onEachFeature:(f,l)=>{
      const p=f.properties;
      l.bindPopup(`<b>${p.ten_xa}</b><br>${p.quan_huyen||''}<br>${p.dtich_km2||''} km¬≤<br>${p.dan_so||''} ng∆∞·ªùi`);
      l.on('click',()=>highlight(l));
    }
  }).addTo(map);
}

function highlight(layer){
  const colors=["#FFD700","#FFA500","#1E90FF"];
  const c=colors[Math.floor(Math.random()*colors.length)];
  layer.setStyle({fillColor:c,fillOpacity:0.5});
  colored.push(layer);
}

function clearColors(){
  colored.forEach(l=>l.setStyle({fillOpacity:0.1,fillColor:null}));
  colored=[];
}

// ====== CONTROL PANEL ======
let panel = L.control({position:'topright'});
panel.onAdd=function(){
  let div=L.DomUtil.create('div','leaflet-bar');
  div.innerHTML=`
    <button onclick="loadHCM()">üó∫Ô∏è N·∫°p ƒë·ªãa gi·ªõi</button>
    <button onclick="if(hcmLayer){map.removeLayer(hcmLayer)}">·∫®n ƒë·ªãa gi·ªõi</button>
    <button onclick="clearColors()">üé® X√≥a t√¥ m√†u</button>
  `;
  return div;
};
panel.addTo(map);

// ====== SEARCH BOX ======
let input=L.DomUtil.create('input','search-box');
input.placeholder="üîç Nh·∫≠p ƒë·ªãa ch·ªâ (VD: 961 Ho√†ng Sa, Qu·∫≠n 3)";
document.body.appendChild(input);

setTimeout(()=>{
  if(window.google&&google.maps.places){
    const ac=new google.maps.places.Autocomplete(input);
    ac.addListener('place_changed',()=>{
      const pl=ac.getPlace();
      if(!pl.geometry) return;
      const lat=pl.geometry.location.lat(), lng=pl.geometry.location.lng();
      map.setView([lat,lng],17);
      L.marker([lat,lng]).addTo(map).bindPopup(pl.formatted_address).openPopup();
    });
  }
},2000);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>B·∫£n ƒë·ªì ƒë·ªãa gi·ªõi h√†nh ch√≠nh TP.HCM - N√¢ng c·∫•p Google Maps</title>

<!-- üó∫Ô∏è Leaflet core -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places"></script>

<!-- Leaflet plugins -->
<script src="https://unpkg.com/leaflet.gridlayer.googlemutant@0.13.6/dist/Leaflet.GoogleMutant.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.css"/>
<script src="https://unpkg.com/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/leaflet-compass/dist/leaflet-compass.min.js"></script>
<script src="https://unpkg.com/leaflet-easybutton@2.4.0/src/easy-button.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-easybutton@2.4.0/src/easy-button.css"/>

<!-- Turf.js (ƒë·ªÉ simplify ho·∫∑c x·ª≠ l√Ω centroid) -->
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<style>
  html, body, #map {
    height: 100%;
    margin: 0;
    font-family: "Segoe UI", Arial, sans-serif;
  }
  .leaflet-popup-content {
    font-size: 14px;
    line-height: 1.4;
  }
  .legend {
    position:absolute; bottom:10px; left:10px;
    background:rgba(255,255,255,0.9);
    padding:8px 12px;
    border-radius:8px;
    box-shadow:0 2px 6px rgba(0,0,0,0.2);
    font-size:13px;
  }
</style>
</head>
<body>
<div id="map"></div>

<script>
// ===== 1. Kh·ªüi t·∫°o b·∫£n ƒë·ªì =====
const map = L.map('map', { center: [10.77, 106.7], zoom: 11 });

// ---- Google Maps layers ----
const roadmap = L.gridLayer.googleMutant({ type: 'roadmap' });
const hybrid = L.gridLayer.googleMutant({ type: 'hybrid' });
const satellite = L.gridLayer.googleMutant({ type: 'satellite' });
roadmap.addTo(map);

// ---- Base maps control ----
const baseMaps = {
  "Google Roadmap": roadmap,
  "Google Satellite": satellite,
  "Google Hybrid": hybrid
};
L.control.layers(baseMaps, null, { position: "topright", collapsed: true }).addTo(map);

// ===== 2. Th√™m c√°c control ti·ªán √≠ch =====
L.control.locate({ position: "topleft", strings: { title: "ƒê·ªãnh v·ªã GPS" }}).addTo(map);
L.Control.geocoder({ position: "topleft", placeholder: "T√¨m ki·∫øm ƒë·ªãa ch·ªâ..." }).addTo(map);
L.control.compass({ position: "topright", autoActive: true, showDigit: true }).addTo(map);
L.control.scale({ metric: true, imperial: false, position: "bottomleft" }).addTo(map);

// ===== 3. H√†m x·ª≠ l√Ω popup v√† highlight =====
let currentLayer = null;
function styleDefault() {
  return { color: "#2262CC", weight: 1.2, fillOpacity: 0.05 };
}
function styleHighlight() {
  return { color: "#0B5ED7", weight: 3, fillColor: "#FFD43B", fillOpacity: 0.5 };
}

// Popup n·ªôi dung
function popupContent(p) {
  const dan_so = p.dan_so ? p.dan_so.toLocaleString("vi-VN") : "‚Äì";
  const matdo = p.matdo_km2 ? p.matdo_km2.toLocaleString("vi-VN") : "‚Äì";
  const dtich = p.dtich_km2 || "‚Äì";
  const name = p.ten_xa || "Kh√¥ng r√µ";
  const loai = p.loai || "";
  return `
    <b>${loai} ${name}</b><br>
    T·ªânh/TP: ${p.ten_tinh || "TP. H·ªì Ch√≠ Minh"}<br>
    D√¢n s·ªë: ${dan_so} ng∆∞·ªùi<br>
    Di·ªán t√≠ch: ${dtich} km¬≤<br>
    M·∫≠t ƒë·ªô: ${matdo} ng∆∞·ªùi/km¬≤<br>
    Tr·ª• s·ªü: ${p.tru_so || "‚Äì"}<br>
    M√£ h√†nh ch√≠nh: ${p.ma_xa || "‚Äì"}
  `;
}

// ===== 4. ƒê·ªçc shapefile (GeoJSON ho·∫∑c t·ª´ zip assets) =====
(async function() {
  const url = "assets/hcm_admin_shp.zip";
  const geojson = await window.shp(url);

  const layer = L.geoJSON(geojson, {
    style: styleDefault,
    onEachFeature: function(feat, layer) {
      const props = feat.properties;
      const centroid = turf.centroid(feat);
      layer.bindTooltip(`${props.loai || ""} ${props.ten_xa || ""}`, { permanent: false });
      layer.on("click", function() {
        if (currentLayer) geoLayer.resetStyle(currentLayer);
        currentLayer = layer;
        layer.setStyle(styleHighlight());
        const center = [centroid.geometry.coordinates[1], centroid.geometry.coordinates[0]];
        const popup = L.popup({ maxWidth: 300, autoPan: true })
          .setLatLng(center)
          .setContent(popupContent(props))
          .openOn(map);
      });
    }
  });

  const geoLayer = L.featureGroup([layer]).addTo(map);
  map.fitBounds(geoLayer.getBounds());
})();

// ===== 5. Legend =====
const legend = L.control({ position: "bottomleft" });
legend.onAdd = function () {
  const div = L.DomUtil.create("div", "legend");
  div.innerHTML = `
    <b>Ch√∫ gi·∫£i</b><br>
    <span style="display:inline-block;width:14px;height:14px;background:#2262CC;border:1px solid #2262CC;margin-right:4px"></span> Ranh ƒë·ªãa gi·ªõi<br>
    <span style="display:inline-block;width:14px;height:14px;background:#FFD43B;border:1px solid #0B5ED7;margin-right:4px"></span> Khi ch·ªçn
  `;
  return div;
};
legend.addTo(map);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>HCM WebGIS ‚Äì Quy ho·∫°ch & H√†nh ch√≠nh</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-compass/dist/leaflet-compass.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
<style>
  html, body, #map { height: 100%; margin: 0; }
  .leaflet-popup-content { font-size: 13px; line-height: 1.4; }
  .legend {
    background: white;
    padding: 8px;
    border-radius: 8px;
    line-height: 1.4;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
    font-size: 13px;
  }
  .legend i { width: 18px; height: 18px; float: left; margin-right: 6px; opacity: 0.7; }
  #coords {
    position: absolute;
    bottom: 4px;
    left: 5px;
    font-size: 12px;
    background: rgba(255,255,255,0.8);
    padding: 2px 6px;
    border-radius: 4px;
    z-index: 9999;
  }
  .toolbox {
    position:absolute; top:10px; right:10px; z-index:1000;
    background:white; padding:6px 8px; border-radius:8px; box-shadow:0 0 5px rgba(0,0,0,.3);
  }
  .toolbox button { margin:2px; padding:4px 8px; font-size:13px; border:none; border-radius:4px; background:#0078ff; color:white; cursor:pointer; }
  .toolbox button:hover { background:#005bbb; }
  #searchBox {
    position:absolute;top:10px;left:50px;z-index:9999;width:300px;
    padding:6px;border:1px solid #ccc;border-radius:6px;
  }
</style>
</head>
<body>
<input id="searchBox" type="text" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c t√™n ph∆∞·ªùng..."/>
<div id="map"></div>
<div id="coords"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.min.js"></script>
<script src="https://unpkg.com/leaflet-compass/dist/leaflet-compass.min.js"></script>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places"></script>

<script>
const map = L.map('map',{center:[10.77,106.68],zoom:12});

// ====== BASEMAPS ======
const baseLayers={
 "OpenStreetMap":L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}),
 "Esri Street":L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',{attribution:'Esri'}),
 "Esri Imagery":L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'Esri'}),
 "Google Streets":L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{attribution:'Google'}),
 "Google Hybrid":L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{attribution:'Google'}),
 "Bing Road":L.tileLayer('https://ecn.t{subdomain}.tiles.virtualearth.net/tiles/r{q}.jpeg?g=1&key=YOUR_BING_API_KEY',{subdomains:['0','1','2','3'],attribution:'Bing Maps'})
};
baseLayers["OpenStreetMap"].addTo(map);

// ====== Overlay layers ======
const overlayLayers={};
const highlightColors=['#FFD700','#FF8C00','#FF6347','#8A2BE2','#1E90FF','#00CED1'];
let selectedLayers=[];

// === H√ÄNH CH√çNH ===
fetch('assets/TPHCM.geojson')
.then(r=>r.json())
.then(data=>{
 overlayLayers["ƒê·ªãa gi·ªõi h√†nh ch√≠nh"]=L.geoJSON(data,{
  style:{color:'#ff6600',weight:1,fillOpacity:0.05},
  onEachFeature:(f,l)=>{
    const p=f.properties;
    const name=p.ten_xa||'';
    const merged=p.sap_nhap||'';
    const area=p.dtich_km2?`${p.dtich_km2} km¬≤`:'';
    const pop=p.dan_so?`${p.dan_so.toLocaleString('vi-VN')} ng∆∞·ªùi`:'';
    const info=`<b>${name}</b><br>${merged}<br>${area} ‚Äì ${pop}`;
    l.bindPopup(info);
    l.on('click',()=>{
      const color=highlightColors[Math.floor(Math.random()*highlightColors.length)];
      l.setStyle({fillColor:color,fillOpacity:0.5,color:'#000',weight:1.5});
      selectedLayers.push(l);
    });
  }
 });
});

// === QUY HO·∫†CH 1/2000 ===
fetch('assets/QHPKSDD_SHAPE.json')
.then(r=>r.json())
.then(data=>{
 overlayLayers["Quy ho·∫°ch 1/2000"]=L.geoJSON(data,{
  style:f=>({color:'#555',weight:0.4,fillColor:'#999',fillOpacity:0.4}),
  onEachFeature:(f,l)=>{
    const p=f.properties;
    const info=`<b>Lo·∫°i ƒë·∫•t:</b> ${p.MaQuyUoc||'Ch∆∞a x√°c ƒë·ªãnh'}<br>${p.TenLoaiDat||''}`;
    l.bindPopup(info);
  }
 });
});

// ====== CONTROL LAYERS ======
setTimeout(()=>{ L.control.layers(baseLayers,overlayLayers,{collapsed:false}).addTo(map); },2000);

// ====== TOOLS ======
new L.Control.Measure({primaryLengthUnit:'meters',secondaryLengthUnit:'kilometers'}).addTo(map);
new L.Control.Compass({autoActive:true,showDigit:true}).addTo(map);
L.control.locate({position:'topleft',flyTo:true,strings:{title:'V·ªã tr√≠ c·ªßa t√¥i'}}).addTo(map);

// ====== SEARCH BOX ======
const input=document.getElementById("searchBox");
const autocomplete=new google.maps.places.Autocomplete(input);
autocomplete.addListener('place_changed',()=>{
  const place=autocomplete.getPlace();
  if(place.geometry){
    const loc=place.geometry.location;
    map.setView([loc.lat(),loc.lng()],17);
    L.marker([loc.lat(),loc.lng()]).addTo(map).bindPopup(place.formatted_address).openPopup();
  }
});

// ====== TOGGLE TOOLBOX ======
const toolbox=L.control({position:'topright'});
toolbox.onAdd=function(){
  const div=L.DomUtil.create('div','toolbox');
  div.innerHTML=`
    <button onclick="clearColors()">üé® X√≥a t√¥ m√†u</button>
    <button onclick="exportGeoJSON()">üíæ Xu·∫•t GeoJSON</button>
  `;
  return div;
};
toolbox.addTo(map);

// ====== CLEAR & EXPORT ======
function clearColors(){
  selectedLayers.forEach(l=>l.setStyle({fillOpacity:0.05,fillColor:''}));
  selectedLayers=[];
}
function exportGeoJSON(){
  const fc={type:"FeatureCollection",features:selectedLayers.map(l=>l.toGeoJSON())};
  const blob=new Blob([JSON.stringify(fc,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='selected.geojson';
  a.click();
}

// ====== MOUSE COORDS ======
map.on('mousemove',e=>{
 document.getElementById('coords').innerText=`Lat:${e.latlng.lat.toFixed(5)}, Lng:${e.latlng.lng.toFixed(5)}`;
});

// ====== LEGEND ======
const legend=L.control({position:'bottomright'});
legend.onAdd=function(){
 const div=L.DomUtil.create('div','legend');
 div.innerHTML='<b>Ch√∫ gi·∫£i lo·∫°i ƒë·∫•t</b><br>'+
 '<i style="background:#ff6666"></i> ƒê·∫•t ·ªü (ODT/ONT)<br>'+
 '<i style="background:#33cc33"></i> C√¢y xanh (CX)<br>'+
 '<i style="background:#999999"></i> Giao th√¥ng (DGT)<br>'+
 '<i style="background:#ffcc66"></i> C√¥ng c·ªông (CC)<br>'+
 '<i style="background:#0099cc"></i> M·∫∑t n∆∞·ªõc (MN)<br>'+
 '<i style="background:#9966cc"></i> H·∫° t·∫ßng k·ªπ thu·∫≠t (HTKT)<br>'+
 '<i style="background:#cccccc"></i> T√¥n gi√°o (TG)<br>';
 return div;
};
legend.addTo(map);
</script>
</body>
</html>

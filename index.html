<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>WebGIS HCM - H√†nh ch√≠nh & Quy ho·∫°ch 1/2000</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css"/>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_API_KEY&libraries=places"></script>

<style>
  html, body, #map { height:100%; margin:0; padding:0; }
  #legend { position:absolute; bottom:10px; right:10px; background:white; padding:8px; border-radius:8px; font-size:12px; box-shadow:0 0 6px rgba(0,0,0,0.3); }
  #legend i { display:inline-block; width:14px; height:14px; margin-right:5px; }
  #searchbox { position:absolute; top:10px; left:50%; transform:translateX(-50%); z-index:1500; background:white; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.3); padding:6px 8px; width:340px; }
</style>
</head>
<body>
<div id="searchbox"><input id="search" type="text" placeholder="üîç Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c khu v·ª±c..." style="width:100%;border:none;outline:none;"></div>
<div id="map"></div>
<div id="legend">
  <b>Ch√∫ gi·∫£i lo·∫°i ƒë·∫•t</b><br>
  <i style="background:#e41a1c"></i> ƒê·∫•t ·ªü<br>
  <i style="background:#4daf4a"></i> C√¢y xanh<br>
  <i style="background:#999"></i> Giao th√¥ng<br>
  <i style="background:#ffcc00"></i> C√¥ng c·ªông<br>
  <i style="background:#6baed6"></i> M·∫∑t n∆∞·ªõc<br>
  <i style="background:#984ea3"></i> H·∫° t·∫ßng k·ªπ thu·∫≠t<br>
  <i style="background:#fdb462"></i> T√¥n gi√°o
</div>

<script>
const map = L.map('map').setView([10.775,106.7],12);

// === BASEMAPS ===
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
const googleStreets = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA',{attribution:'¬© Google'});
const googleHybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}&key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA',{attribution:'¬© Google'});
const esriBasemap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',{attribution:'¬© Esri'});
const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'¬© Esri Imagery'});

const baseMaps = {
  "üó∫Ô∏è OSM": osm,
  "üåç Google Street": googleStreets,
  "üõ∞Ô∏è Google Hybrid": googleHybrid,
  "üó∫Ô∏è Esri Basemap": esriBasemap,
  "üõ∞Ô∏è Esri Imagery": esriImagery
};

// === H√ÄNH CH√çNH ===
const hanhChinh = L.layerGroup();
fetch("assets/TPHCM.geojson").then(r=>r.json()).then(data=>{
  L.geoJSON(data,{
    style:{color:"#0066ff",weight:1,fillOpacity:0.05},
    onEachFeature:(f,l)=>{
      const p=f.properties;
      l.bindPopup(`<b>${p.ten_xa||''}</b><br>${p.quan_huyen||''}`);
      l.on('click',()=>l.setStyle({fillColor:'#FFD700',fillOpacity:0.4}));
    }
  }).addTo(hanhChinh);
});

// === QUY HO·∫†CH 1/2000 ===
const quyhoach = L.layerGroup();
function colorByMaQuyUoc(m){
  const lut={
    'ODT':'#e41a1c','ONT':'#e41a1c','CX':'#4daf4a','DGT':'#999','CC':'#ffcc00','MN':'#6baed6','HTKT':'#984ea3','TG':'#fdb462'
  };
  for (const k in lut){ if(m && m.includes(k)) return lut[k]; }
  return '#cccccc';
}
fetch("assets/QHPKSDD_SHAPE.json")
.then(r=>r.json())
.then(data=>{
  L.geoJSON(data,{
    style:f=>({color:'#666',weight:0.3,fillColor:colorByMaQuyUoc(f.properties.MaQuyUoc),fillOpacity:0.5}),
    onEachFeature:(f,l)=>{
      const p=f.properties;
      l.bindPopup(`<b>${p.MaQuyUoc||''}</b><br>${p.TenLoaiDat||''}`);
    }
  }).addTo(quyhoach);
});

// === CONTROL LAYERS ===
L.control.layers(baseMaps,{
  "üìç H√†nh ch√≠nh":hanhChinh,
  "üìê Quy ho·∫°ch 1/2000":quyhoach
}).addTo(map);

// === TOOLS ===
L.control.locate().addTo(map);
L.control.measure({primaryLengthUnit:'meters'}).addTo(map);

// === SEARCH ===
const input=document.getElementById("search");
const autocomplete=new google.maps.places.Autocomplete(input,{componentRestrictions:{country:"vn"}});
autocomplete.addListener("place_changed",()=>{
  const pl=autocomplete.getPlace();
  if(pl.geometry){
    const lat=pl.geometry.location.lat(),lng=pl.geometry.location.lng();
    map.setView([lat,lng],17);
    L.marker([lat,lng]).addTo(map).bindPopup(pl.formatted_address).openPopup();
  }
});
</script>
</body>
</html>

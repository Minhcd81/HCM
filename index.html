<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HCM WebGIS ‚Äì Quy ho·∫°ch & B·∫£n ƒë·ªì h√†nh ch√≠nh</title>

<!-- Leaflet & plugins -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-compass/dist/leaflet-compass.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

<!-- Google Places (autocomplete) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places"></script>

<!-- Leaflet JS + plugins -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.js"></script>
<script src="https://unpkg.com/leaflet-compass/dist/leaflet-compass.min.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<!-- Bing plugin ch√≠nh th·ª©c -->
<script src="https://unpkg.com/leaflet-bing-layer/dist/leaflet-bing-layer.min.js"></script>

<style>
  html, body, #map {height:100%; margin:0;}
  .topbar {
    position:absolute; z-index:1500; left:50%; transform:translateX(-50%);
    top:10px; width:360px;
  }
  #search-input {
    width:100%; padding:8px 10px; border:1px solid #999; border-radius:6px; background:#fff;
    box-shadow:0 2px 6px rgba(0,0,0,0.2);
  }
  .coords {
    position:absolute; bottom:6px; left:10px; z-index:1100;
    background:rgba(255,255,255,0.9); padding:4px 8px; border-radius:4px; font:12px/1.2 monospace;
  }
  .legend {
    position:absolute; right:12px; bottom:12px; z-index:1100;
    background:rgba(255,255,255,0.95); border-radius:8px; padding:8px 10px; font-size:12px;
    box-shadow:0 2px 8px rgba(0,0,0,0.25);
  }
  .legend i {display:inline-block; width:14px; height:14px; margin-right:6px; vertical-align:middle;}
  .leaflet-bar .btn {display:block; background:#fff; border:none; padding:6px 8px; cursor:pointer; width:100%;}
  .leaflet-bar .btn:hover {background:#eee;}
</style>
</head>
<body>
<div class="topbar"><input id="search-input" type="text" placeholder="üîç Nh·∫≠p ƒë·ªãa ch·ªâ / t√™n ph∆∞·ªùng, qu·∫≠n..."></div>
<div id="map"></div>
<div id="coords" class="coords">Lat: --, Lng: --</div>
<div class="legend" id="legend">
  <b>Ch√∫ gi·∫£i lo·∫°i ƒë·∫•t</b><br>
  <div><i style="background:#e41a1c"></i> ƒê·∫•t ·ªü (ODT/ONT)</div>
  <div><i style="background:#4daf4a"></i> C√¢y xanh (CX)</div>
  <div><i style="background:#999999"></i> Giao th√¥ng (DGT)</div>
  <div><i style="background:#ffcc00"></i> C√¥ng c·ªông (CC)</div>
  <div><i style="background:#6baed6"></i> M·∫∑t n∆∞·ªõc (MN)</div>
  <div><i style="background:#984ea3"></i> H·∫° t·∫ßng k·ªπ thu·∫≠t (HTKT)</div>
  <div><i style="background:#fdb462"></i> T√¥n gi√°o (TG)</div>
</div>

<script>
(function(){
  // ==== MAP INIT
  const map = L.map('map', {center:[10.776,106.7], zoom:12});

  // ==== BASE MAPS
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
  const esriStreet = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',{attribution:'¬© Esri Street'});
  const esriImg = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'¬© Esri Imagery'});
  const googleStreet = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA',{attribution:'¬© Google'});
  const googleHybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}&key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA',{attribution:'¬© Google'});

  // Bing official plugin (·∫©n m·∫∑c ƒë·ªãnh; b·∫≠t th·ªß c√¥ng qua Layers)
  const bingKey = '34TsHklW0IqAp0Ei1inHFoaRUxqgaVSDH9Dm56DqrisxL0NtnWL5JQQJ99BJACYeBjFmUVijAAAgAZMPXNSk';
  const bingRoad = L.tileLayer.bing({ bingMapsKey: bingKey, imagerySet: 'Road' });
  const bingAerial = L.tileLayer.bing({ bingMapsKey: bingKey, imagerySet: 'Aerial' });

  const baseMaps = {
    "üó∫Ô∏è OSM": osm,
    "üõ£Ô∏è Esri Street": esriStreet,
    "üõ∞Ô∏è Esri Imagery": esriImg,
    "üåç Google Street": googleStreet,
    "üõ∞Ô∏è Google Hybrid": googleHybrid,
    "üó∫Ô∏è Bing Road": bingRoad,
    "üåÑ Bing Aerial": bingAerial
  };

  // ==== OVERLAYS
  const hanhChinhGroup = L.layerGroup();   // TPHCM.geojson
  const quyHoachGroup  = L.layerGroup();   // QHPKSDD from Drive (via CORS proxy)
  const taiSanGroup    = L.layerGroup();   // taisan.geojson (optional)

  // ==== COLOR LUT for MaQuyUoc
  function colorByMaQuyUoc(code){
    if(!code) return "#cccccc";
    const lut = {
      "ODT":"#e41a1c", "ONT":"#e41a1c",
      "CX":"#4daf4a", "DGT":"#999999",
      "CC":"#ffcc00", "MN":"#6baed6",
      "HTKT":"#984ea3", "TG":"#fdb462"
    };
    for (const k in lut){ if(code.includes(k)) return lut[k]; }
    return "#cccccc";
  }

  // ==== ADMIN LAYER (click to color, popup, export)
  let coloredLayers = [];
  function highlightFeature(layer){
    const palette = ["#FFD700","#FFA500","#32CD32","#1E90FF","#FF69B4","#7B68EE","#00CED1","#F08080"];
    const fill = palette[Math.floor(Math.random()*palette.length)];
    layer.setStyle({ fillColor: fill, fillOpacity: 0.55 });
    coloredLayers.push(layer);
  }
  function clearColors(){
    coloredLayers.forEach(l => l.setStyle({ fillColor: null, fillOpacity: 0.1 }));
    coloredLayers = [];
  }
  function exportColoredGeoJSON(){
    const feats = [];
    hanhChinhGroup.eachLayer(g=>{
      g.eachLayer(l=>{
        // l ch·ªâ ƒë∆∞·ª£c push n·∫øu ƒë√£ t·ª´ng t√¥ (c√≥ trong coloredLayers)
        if (coloredLayers.includes(l)){
          feats.push(l.toGeoJSON());
        }
      });
    });
    if(!feats.length){ alert("Ch∆∞a c√≥ v√πng n√†o ƒë∆∞·ª£c t√¥ m√†u!"); return; }
    const fc = {type:"FeatureCollection", features:feats};
    const blob = new Blob([JSON.stringify(fc,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download="vung_to_mau_hanh_chinh.geojson"; a.click();
    URL.revokeObjectURL(url);
  }

  fetch('assets/TPHCM.geojson')
    .then(r=>r.json())
    .then(data=>{
      const layer = L.geoJSON(data,{
        style:{ color:"#ff6600", weight:1, fillOpacity:0.1 },
        onEachFeature:(f,l)=>{
          const p=f.properties||{};
          const ten=p.ten_xa||'', quan=p.quan_huyen||'';
          const dt= p.dtich_km2!=null? `${(+p.dtich_km2).toFixed(2)} km¬≤` : "-";
          const ds= p.dan_so!=null? (+p.dan_so).toLocaleString()+" ng∆∞·ªùi" : "-";
          const sap = p.sap_nhap? `<br><i>${p.sap_nhap}</i>` : "";
          l.bindPopup(`<b>${ten}</b><br>${quan}<br>${dt}<br>${ds}${sap}`);
          l.on('click', ()=> highlightFeature(l));
        }
      });
      hanhChinhGroup.addLayer(layer);
    })
    .catch(err=>console.error("TPHCM.geojson error:", err));

  // ==== QH 1/2000 t·ª´ Google Drive qua CORS proxy
  const QH_URL = "https://corsproxy.io/?https://drive.google.com/uc?export=download&id=1UTyZRAmJGmkQSfU48jnrjved9Dc0zY3u";
  fetch(QH_URL)
    .then(r=>{
      if(!r.ok) throw new Error("Fetch QH 1/2000 th·∫•t b·∫°i: "+r.status);
      return r.json();
    })
    .then(data=>{
      const qh = L.geoJSON(data,{
        style:f=>({
          color:"#555", weight:0.4,
          fillColor: colorByMaQuyUoc((f.properties||{}).MaQuyUoc || ""),
          fillOpacity: 0.6
        }),
        onEachFeature:(f,l)=>{
          const p=f.properties||{};
          const area = p.Shape_Area!=null ? Number(p.Shape_Area).toLocaleString()+" m¬≤" : "-";
          l.bindPopup(
            `<b>M√£ quy ∆∞·ªõc:</b> ${p.MaQuyUoc||''}<br>
             <b>Ch·ª©c nƒÉng:</b> ${p.ChucNang||p.TenLoaiDat||''}<br>
             <b>Di·ªán t√≠ch:</b> ${area}`
          );
        }
      });
      quyHoachGroup.addLayer(qh);
    })
    .catch(err=>{
      console.error("QHPKSDD fetch error:", err);
      alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c l·ªõp Quy ho·∫°ch 1/2000 t·ª´ Google Drive (CORS/URL). Vui l√≤ng t·∫£i file v·ªÅ v√† ƒë·∫∑t v√†o assets/QHPKSDD_SHAPE.json r·ªìi s·ª≠a ƒë∆∞·ªùng d·∫´n trong HTML.");
    });

  // ==== L·ªõp T√ÄI S·∫¢N (t√πy ch·ªçn, b·∫≠t th·ªß c√¥ng)
  fetch('assets/taisan.geojson')
    .then(r=> r.ok ? r.json() : Promise.reject("no assets"))
    .then(data=>{
      const icon = L.icon({iconUrl:'assets/icon_home.png', iconSize:[26,26]});
      const ts = L.geoJSON(data, {
        pointToLayer:(f,latlng)=> L.marker(latlng,{icon}),
        onEachFeature:(f,l)=>{
          const p=f.properties||{};
          l.bindPopup(`<b>${p.name||'T√†i s·∫£n'}</b><br>${p.description||p.DiaChi||''}`);
        }
      });
      taiSanGroup.addLayer(ts);
    })
    .catch(()=>{/* kh√¥ng c√≥ file th√¨ th√¥i */});

  // ==== LAYERS CONTROL
  const overlays = {
    "üóæ ƒê·ªãa gi·ªõi h√†nh ch√≠nh": hanhChinhGroup,
    "üìê Quy ho·∫°ch 1/2000":   quyHoachGroup,
    "üè† T√†i s·∫£n (My Maps)":  taiSanGroup
  };
  L.control.layers(baseMaps, overlays).addTo(map);

  // ==== TOOLS
  L.control.scale().addTo(map);
  L.control.locate({strings:{title:"ƒê·ªãnh v·ªã GPS"}}).addTo(map);
  let measureCtrl=null, compassCtrl=null;
  function toggleTools(){
    if(measureCtrl){ map.removeControl(measureCtrl); map.removeControl(compassCtrl); measureCtrl=null; compassCtrl=null; }
    else{
      measureCtrl=L.control.measure({primaryLengthUnit:'meters',secondaryLengthUnit:'kilometers',primaryAreaUnit:'sqmeters'}).addTo(map);
      compassCtrl=L.control.compass({autoActive:true,showDigit:true,position:'topright'}).addTo(map);
    }
  }

  // Quick panel (X√≥a t√¥ m√†u / Xu·∫•t GeoJSON / B·∫≠t c√¥ng c·ª•)
  const panel=L.control({position:'topright'});
  panel.onAdd=function(){
    const div=L.DomUtil.create('div','leaflet-bar');
    div.innerHTML=`
      <button class="btn" onclick="window._toggleTools()">üîß C√¥ng c·ª•</button>
      <button class="btn" onclick="window._clearColors()">üßπ X√≥a t√¥ m√†u</button>
      <button class="btn" onclick="window._exportColored()">üíæ Xu·∫•t GeoJSON</button>
    `;
    return div;
  };
  panel.addTo(map);
  window._toggleTools=toggleTools;
  window._clearColors=clearColors;
  window._exportColored=exportColoredGeoJSON;

  // ==== GOOGLE PLACES AUTOCOMPLETE
  const input = document.getElementById('search-input');
  const autocomplete = new google.maps.places.Autocomplete(input, {
    componentRestrictions:{country:"vn"},
    fields:["geometry","name","formatted_address"]
  });
  autocomplete.addListener("place_changed", ()=>{
    const place = autocomplete.getPlace();
    if(!place.geometry) return;
    const loc = place.geometry.location;
    const lat = loc.lat(), lng = loc.lng();
    map.setView([lat,lng], 17);
    L.marker([lat,lng]).addTo(map).bindPopup(`<b>${place.name||''}</b><br>${place.formatted_address||''}`).openPopup();
  });

  // ==== Mouse coords
  const coordsDiv=document.getElementById('coords');
  map.on('mousemove',e=> coordsDiv.textContent = `Lat: ${e.latlng.lat.toFixed(5)}, Lng: ${e.latlng.lng.toFixed(5)}`);
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>WebGIS v17.3_fix ‚Äî H√†nh ch√≠nh + TSBƒê/TSSS + StreetView + La b√†n</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet.Draw (ƒëo kho·∫£ng c√°ch/di·ªán t√≠ch) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<!-- TurfJS (t√≠nh di·ªán t√≠ch/kho·∫£ng c√°ch) -->
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<!-- Google Maps JS API (Places + Geometry + Street View) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places,geometry"></script>

<style>
:root { --pri:#00BFFF; --ink:#202124; }
html,body,#map{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
#map{background:#f6f8fb}

/* Search bar */
.topbar{position:absolute;left:50%;top:14px;transform:translateX(-50%);z-index:1200;width:840px;max-width:92vw}
#searchInput{width:100%;padding:12px 14px;border:1px solid #cfd4dc;border-radius:14px;box-shadow:0 4px 18px rgba(0,0,0,.12);outline:none}
#suggest{position:absolute;left:0;top:52px;width:100%;background:#fff;border:1px solid #e2e6eb;border-radius:12px;
         box-shadow:0 10px 24px rgba(0,0,0,.18);overflow:hidden;display:none;max-height:320px;overflow-y:auto}
.sug{padding:10px 12px;cursor:pointer;border-bottom:1px solid #f1f3f7}
.sug:hover{background:#f6fbff}
.sug small{color:#6b7280}

/* Right tool buttons */
.tools{position:absolute;right:12px;top:86px;z-index:1200;display:flex;flex-direction:column;gap:12px}
.tool{width:46px;height:46px;border-radius:50%;background:#fff;border:1px solid #e5e7eb;box-shadow:0 6px 16px rgba(0,0,0,.15);
      display:grid;place-items:center;font-size:20px;cursor:pointer}
.tool:hover{transform:scale(1.05);background:#f9fbff}

/* Clear colors button */
#btnClear{position:absolute;right:16px;top:332px;z-index:1200;background:#fff;border:1px solid #e5e7eb;border-radius:12px;
          padding:9px 12px;box-shadow:0 8px 20px rgba(0,0,0,.18);cursor:pointer}

/* Sidebar (TSBƒê/TSSS) */
#panel{position:absolute;left:12px;top:64px;z-index:1200;width:360px;max-width:92vw;background:#fff;border:1px solid #e5e7eb;border-radius:14px;
       box-shadow:0 16px 40px rgba(0,0,0,.2);padding:12px 12px 10px 12px}
#panel.hidden{display:none}
#panel h3{margin:4px 0 10px;font-size:16px}
.row{display:flex;gap:8px;margin-bottom:8px}
.row input,.row textarea{flex:1;padding:9px;border:1px solid #d6dbe3;border-radius:10px}
.row textarea{resize:vertical}
.btn{border:none;border-radius:10px;padding:9px 12px;background:#f3f6fb;border:1px solid #dbe2ec;cursor:pointer}
.btn:hover{background:#eef6ff}
.btn.pri{background:var(--pri);color:#fff;border-color:#0bb3ff}
.line{height:1px;background:#eef1f6;margin:10px 0}
.pill{display:inline-flex;align-items:center;gap:6px;border-radius:20px;padding:6px 10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}

/* Compass overlay (in-map) */
#compassWrap{position:absolute;right:18px;top:144px;z-index:1250;display:none}
#compass{width:120px;height:120px;border-radius:50%;border:2px solid rgba(0,0,0,.35);background:rgba(255,255,255,0);
         position:relative;display:flex;align-items:center;justify-content:center}
#needle{position:absolute;top:6px;left:50%;width:2px;height:56px;background:#e11;transform-origin:bottom center;}

/* Popup fade when color change */
.fade-poly{animation:fade .45s ease}
@keyframes fade{from{opacity:.2}to{opacity:1}}

/* responsive */
@media(max-width:768px){
  .topbar{top:10px}
  #panel{top:60px;left:10px;width:94vw}
}
.leaflet-popup-content{margin:10px 12px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#ecf5ff;border:1px solid #cfe7ff;color:#1677ff;font-size:12px}
.small{font-size:12px;color:#6b7280}
</style>
</head>
<body>

<div id="map"></div>

<!-- Search -->
<div class="topbar">
  <input id="searchInput" placeholder="üîç ƒê·ªãa ch·ªâ / ph∆∞·ªùng x√£ c≈© / t·ªça ƒë·ªô (vd: 10.79844, 106.65855)"/>
  <div id="suggest"></div>
</div>

<!-- Tools -->
<div class="tools">
  <div class="tool" id="btnMeasure" title="ƒêo (kho·∫£ng c√°ch/di·ªán t√≠ch)">üìè</div>
  <div class="tool" id="btnCompass" title="La b√†n">üß≠</div>
  <div class="tool" id="btnStreet" title="Street View (b·∫≠t khi c√≥ marker)">üëÅÔ∏è</div>
</div>
<button id="btnClear">üßπ X√≥a t√¥ m√†u</button>

<!-- TSBƒê / TSSS -->
<div id="panel">
  <div class="row" style="justify-content:space-between;align-items:center">
    <h3>Th√¥ng tin ƒë·ªãnh gi√°</h3>
    <button class="pill" id="btnClose">‚úï</button>
  </div>
  <div class="row"><input id="tsbdTen" placeholder="T√™n TSBƒê"><input id="tsbdGia" type="number" placeholder="Gi√° tr·ªã (t·ª∑)"></div>
  <div class="row"><input id="tsbdLat" placeholder="Lat"><input id="tsbdLng" placeholder="Lng"></div>
  <div class="row"><textarea id="tsbdNote" rows="2" placeholder="Ghi  ch√∫"></textarea></div>
  <div class="row">
    <button class="btn pri" id="btnSetTSBD">üìç ƒê·∫∑t TSBƒê</button>
    <button class="btn" id="btnSnapJPG">üñºÔ∏è JPG</button>
  </div>
  <div class="line"></div>
  <h3>T√†i s·∫£n so s√°nh (TSSS)</h3>
  <div class="row"><input id="tsssTen" placeholder="T√™n TSSS"><input id="tsssGia" type="number" placeholder="Gi√° (t·ª∑)"></div>
  <div class="row"><input id="tsssLat" placeholder="Lat"><input id="tsssLng" placeholder="Lng"></div>
  <div class="row">
    <button class="btn pri" id="btnAddTSSS">‚ûï Th√™m TSSS</button>
    <button class="btn" id="btnExport">üìä Xu·∫•t Excel / CSV</button>
  </div>
  <div id="log" class="small">File xu·∫•t g·ªìm: STT, T√™n, Lat, Lng, Gi√° (t·ª∑), Kho·∫£ng c√°ch (m), Qu·∫≠n/Huy·ªán.</div>
</div>

<!-- Compass overlay -->
<div id="compassWrap">
  <div id="compass">
    <div id="needle"></div>
    <span style="position:absolute;top:4px;left:50%;transform:translateX(-50%);font-weight:700">B</span>
    <span style="position:absolute;bottom:4px;left:50%;transform:translateX(-50%);">N</span>
    <span style="position:absolute;left:4px;top:50%;transform:translateY(-50%);">T</span>
    <span style="position:absolute;right:4px;top:50%;transform:translateY(-50%);">ƒê</span>
  </div>
</div>

<script>
/* ====================== MAP & BASE LAYERS ====================== */
const map = L.map('map',{center:[10.775,106.7],zoom:13,zoomControl:true});

const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:20, attribution:'¬© OpenStreetMap'
}).addTo(map);

// (Tu·ª≥ ch·ªçn gmap tiles proxy-free (styling OSM) ‚Äì ƒë·ªÉ an to√†n b·∫£n quy·ªÅn ta kh√¥ng g·ªçi tile Google tr·ª±c ti·∫øp)
const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
  maxZoom:20, attribution:'Esri'
});
const esriTopo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{maxZoom:17,attribution:'OpenTopo'});

const baseControl = L.control.layers(
  {"OSM":osm,"Esri Satellite":esriSat,"Esri Topo":esriTopo},
  {},{position:'topright'}
).addTo(map);

/* ====================== GLOBALS ====================== */
const provinceSlugs = [
  "angiang","baclieu","bacgiang","backan","bentre","binhdinh","binhduong","binhphuoc","binhthuan",
  "camau","cantho","danang","daklak","daknong","dienbien","dongnai","dongthap","gialai","hagiang",
  "haiphong","hanoi","hatinh","haugiang","hcm","khanhhoa","kiengiang","kontum","laocai","lamdong",
  "longan","namdinh","nghean","ninhthuan","phutho","phuyen","quangbinh","quangnam","quangngai",
  "quangninh","quangtri","soctrang","tayninh","thaibinh","thainguyen","thanhhoa","thuathienhue",
  "tiengiang","travinh","vinhlong","vinhphuc","yenbai"
]; // c√≥ th·ªÉ r√∫t g·ªçn/ƒë·ªïi theo 34 t·ªânh sau s√°p nh·∫≠p anh ƒëang d√πng

const layerAdmin = L.geoJSON(null,{onEachFeature:attachPolygonHandlers,style:styler}).addTo(map);
let loadedSlug = null; // t·ªânh hi·ªán t·∫°i
let drawnItems = new L.FeatureGroup().addTo(map);
let drawControl = null;

const coloredIds = new Set();
const randomColors = ['#ffb703','#fb7185','#60a5fa','#22c55e','#a78bfa','#f97316','#14b8a6'];

/* ====================== LOAD DEFAULT HCM ====================== */
async function loadProvince(slug){
  if(slug===loadedSlug) return;
  try{
    const res = await fetch(`assets/${slug}.geojson`,{cache:'no-store'});
    if(!res.ok) throw new Error('Kh√¥ng t·∫£i ƒë∆∞·ª£c '+slug);
    const gj = await res.json();
    layerAdmin.clearLayers();
    layerAdmin.addData(gj);
    loadedSlug = slug;
    coloredIds.clear();
  }catch(e){
    console.warn(e.message);
  }
}
// m·∫∑c ƒë·ªãnh HCM
loadProvince('hcm');

/* ====================== POLYGON INTERACTION ====================== */
function styler(){
  return {color:'#444',weight:1,fillColor:'#f0f0f0',fillOpacity:.25}
}
function attachPolygonHandlers(feat,layer){
  layer.on('click',e=>{
    colorPolygon(layer,feat);
    openAdminPopup(layer,feat);
  });
}
function colorPolygon(layer,feat){
  const id = feat.properties?.id || JSON.stringify(feat.geometry).slice(0,80);
  if(coloredIds.has(id)){
    layer.setStyle(styler());
    coloredIds.delete(id);
  }else{
    const c = randomColors[Math.floor(Math.random()*randomColors.length)];
    layer.setStyle({fillColor:c,fillOpacity:.45,color:'#ff7f50',weight:1.2,className:'fade-poly'});
    coloredIds.add(id);
  }
}
function openAdminPopup(layer,feat){
  const p = feat.properties||{};
  const ten = p.ten_xa || p.TenXa || p.name || '(Kh√¥ng r√µ)';
  const qh  = p.quan_huyen || p.QuanHuyen || p.district || '';
  const dt  = p.dtich_km2 || p.area_km2 || p.area || '';
  const ds  = p.dan_so || p.population || '';
  const sap = p.sap_nhap || p.merge || '';

  const html = `
    <div style="min-width:240px">
      <div class="badge">${ten}</div><br>
      <div class="small">Qu·∫≠n/Huy·ªán: <b>${qh||'-'}</b></div>
      ${sap?`<div class="small">T√™n c≈©: <b>${sap}</b></div>`:''}
      ${dt?`<div class="small">Di·ªán t√≠ch: <b>${dt}</b></div>`:''}
      ${ds?`<div class="small">D√¢n s·ªë: <b>${ds}</b></div>`:''}
      <div style="margin-top:8px"><button class="btn" onclick="centerAndSV(${layer.getBounds().getCenter().lat},${layer.getBounds().getCenter().lng})">üëÅÔ∏è Xem Street View t·∫°i ƒë√¢y</button></div>
    </div>`;
  layer.bindPopup(html).openPopup();
}
window.centerAndSV=(lat,lng)=>{ map.setView([lat,lng],18); showStreetPreview(lat,lng); }

/* ====================== AUTOCOMPLETE (GOOGLE PLACES) ====================== */
const input = document.getElementById('searchInput');
const sugBox = document.getElementById('suggest');
const placesService = new google.maps.places.AutocompleteService();
const geocoder = new google.maps.Geocoder();

let sugTimer=null;
input.addEventListener('input',()=>{
  const q=input.value.trim();
  if(sugTimer) clearTimeout(sugTimer);
  if(!q){sugBox.style.display='none';return;}
  // n·∫øu l√† t·ªça ƒë·ªô
  const m=q.match(/(-?\d+(\.\d+)?)[,\s]+(-?\d+(\.\d+)?)/);
  if(m){sugBox.innerHTML=`<div class="sug">ƒêi t·ªõi t·ªça ƒë·ªô: <b>${m[1]}, ${m[3]}</b></div>`;sugBox.style.display='block';return;}
  sugTimer=setTimeout(()=>{
    placesService.getPlacePredictions({input:q,componentRestrictions:{country:'vn'}},(res)=>{
      if(!res||!res.length){sugBox.style.display='none';return;}
      sugBox.innerHTML = res.slice(0,8).map(p=>`<div class="sug" data-id="${p.place_id}"><b>${p.structured_formatting.main_text}</b> <small>${p.structured_formatting.secondary_text||''}</small></div>`).join('');
      sugBox.style.display='block';
    });
  },150);
});
document.addEventListener('click',e=>{
  if(!sugBox.contains(e.target) && e.target!==input) sugBox.style.display='none';
});
sugBox.addEventListener('click',e=>{
  const item=e.target.closest('.sug'); if(!item) return;
  sugBox.style.display='none';
  const text=item.textContent.trim();
  // t·ªça ƒë·ªô
  const m=text.match(/(-?\d+(\.\d+)?)[,\s]+(-?\d+(\.\d+)?)/);
  if(m){ const lat=+m[1], lng=+m[3]; addTSMarker(lat,lng,'TS'); map.setView([lat,lng],18); return;}
  // place id
  const placeId=item.dataset.id;
  geocoder.geocode({placeId},(res,stat)=>{
    if(stat==='OK' && res[0]){
      const g=res[0].geometry.location; const lat=g.lat(), lng=g.lng();
      map.setView([lat,lng],18);
      // suy lu·∫≠n slug t·ªânh t·ª´ address components
      const comps=res[0].address_components||[];
      const province = (comps.find(c=>c.types.includes('administrative_area_level_1'))?.long_name||'').toLowerCase();
      const picked = pickSlugFromProvince(province) || 'hcm';
      loadProvince(picked).then(()=>{
        // t√¨m polygon ch·ª©a ƒëi·ªÉm
        const lyr = findPolygonContains([lng,lat]);
        if(lyr){ colorPolygon(lyr.layer,lyr.feature); openAdminPopup(lyr.layer,lyr.feature); }
      });
    }
  });
});
function pickSlugFromProvince(text){
  const norm = (text||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s/g,'');
  return provinceSlugs.find(s=> norm.includes(s) || s.includes(norm) );
}

/* T√¨m polygon ch·ª©a ƒëi·ªÉm */
function findPolygonContains(lnglat){
  let found=null;
  layerAdmin.eachLayer(l=>{
    if(found) return;
    const gj = l.toGeoJSON();
    if(turf.booleanPointInPolygon(turf.point(lnglat), gj)) found={layer:l,feature:gj};
  });
  return found;
}

/* ====================== DRAW / MEASURE ====================== */
function ensureDraw(){
  if(drawControl) return;
  drawControl = new L.Control.Draw({
    edit: { featureGroup: drawnItems },
    draw: {
      marker:false, circle:false, rectangle:false,
      polyline:{ shapeOptions:{color:'#0ea5e9'} },
      polygon:{ allowIntersection:false, shapeOptions:{color:'#22c55e'} }
    }
  });
  map.addControl(drawControl);
}
document.getElementById('btnMeasure').onclick=()=>{ ensureDraw(); };

map.on(L.Draw.Event.CREATED, function (e) {
  const layer = e.layer;
  drawnItems.addLayer(layer);
  let html='';
  if(e.layerType==='polyline'){
    const coords = layer.getLatLngs().map(p=>[p.lng,p.lat]);
    const len = turf.length(turf.lineString(coords),{units:'kilometers'})*1000;
    html=`üìè Chi·ªÅu d√†i: <b>${len.toFixed(1)} m</b>`;
  } else if(e.layerType==='polygon'){
    const coords = [layer.getLatLngs()[0].map(p=>[p.lng,p.lat])];
    const area = turf.area(turf.polygon(coords));
    html=`üü© Di·ªán t√≠ch: <b>${area.toFixed(1)} m¬≤</b>`;
  }
  if(html) layer.bindPopup(html).openPopup();
});

/* ====================== CLEAR COLORS ====================== */
document.getElementById('btnClear').onclick=()=>{
  layerAdmin.eachLayer(l=>l.setStyle(styler()));
  coloredIds.clear();
};

/* ====================== STREET VIEW PREVIEW ====================== */
let lastTSMarker=null;
document.getElementById('btnStreet').onclick=()=>{
  if(!lastTSMarker){alert('ƒê·∫∑t TSBƒê/TS ho·∫∑c ch·ªçn v·ªã tr√≠ tr∆∞·ªõc.');return;}
  const {lat,lng}=lastTSMarker.getLatLng();
  showStreetPreview(lat,lng);
};
function showStreetPreview(lat,lng){
  const id='sv_'+Date.now();
  const html=`
    <div style="width:350px;height:250px">
      <div id="${id}" style="width:100%;height:100%"></div>
    </div>`;
  L.popup({maxWidth:360,closeButton:true})
    .setLatLng([lat,lng])
    .setContent(html)
    .openOn(map);
  // init Google SV panorama
  setTimeout(()=>{
    const pano = new google.maps.StreetViewPanorama(document.getElementById(id),{
      position:{lat,lng}, pov:{heading:0,pitch:0}, addressControl:false, fullscreenControl:false, linksControl:true
    });
  },80);
}

/* ====================== TSBƒê / TSSS ====================== */
const tsbdIcon = L.divIcon({className:'',html:`<div style="width:28px;height:28px;border-radius:50%;background:#facc15;border:2px solid #7c6f00;display:grid;place-items:center;font:12px/1.2 monospace">TSBƒê</div>`});
const tsssIcon = L.divIcon({className:'',html:`<div style="width:28px;height:28px;border-radius:50%;background:#38bdf8;border:2px solid #0369a1;display:grid;place-items:center;font:12px/1.2 monospace">TS</div>`});
let tsbdMarker=null;
const tsssList=[]; // {name,lat,lng,gia,marker}

document.getElementById('btnClose').onclick=()=>document.getElementById('panel').classList.add('hidden');

function addTSMarker(lat,lng,label='TS'){
  const m = L.marker([lat,lng],{icon: tsssIcon, draggable:true}).addTo(map);
  lastTSMarker=m;
  m.bindPopup(`<b>${label}</b><br><button class="btn" onclick="showStreetPreview(${lat},${lng})">üëÅÔ∏è Street View</button>`);
  return m;
}

document.getElementById('btnSetTSBD').onclick=()=>{
  const lat=parseFloat(document.getElementById('tsbdLat').value);
  const lng=parseFloat(document.getElementById('tsbdLng').value);
  if(Number.isNaN(lat)||Number.isNaN(lng)){ alert('Nh·∫≠p Lat/Lng h·ª£p l·ªá'); return; }
  if(tsbdMarker) map.removeLayer(tsbdMarker);
  tsbdMarker = L.marker([lat,lng],{icon:tsbdIcon,draggable:true}).addTo(map).bindPopup(`<b>TSBƒê</b><br>${lat.toFixed(5)}, ${lng.toFixed(5)}<br><button class="btn" onclick="showStreetPreview(${lat},${lng})">üëÅÔ∏è Street View</button>`);
  map.setView([lat,lng],18);
  lastTSMarker = tsbdMarker;
};

document.getElementById('btnAddTSSS').onclick=()=>{
  const name=document.getElementById('tsssTen').value||'TSSS';
  const gia=parseFloat(document.getElementById('tsssGia').value||0);
  const lat=parseFloat(document.getElementById('tsssLat').value);
  const lng=parseFloat(document.getElementById('tsssLng').value);
  if(Number.isNaN(lat)||Number.isNaN(lng)){ alert('Nh·∫≠p Lat/Lng h·ª£p l·ªá'); return; }
  const mk = L.marker([lat,lng],{icon:tsssIcon,draggable:true}).addTo(map)
      .bindPopup(`<b>${name}</b><br>${lat.toFixed(5)}, ${lng.toFixed(5)}<br><button class="btn" onclick="showStreetPreview(${lat},${lng})">üëÅÔ∏è Street View</button>`);
  tsssList.push({name,gia,lat,lng,marker:mk});
  map.setView([lat,lng],18);
  lastTSMarker = mk;
  document.getElementById('log').textContent = `ƒê√£ th√™m: ${name}. T·ªïng TSSS: ${tsssList.length}`;
};

document.getElementById('btnExport').onclick=()=>{
  const rows=[];
  // TSBƒê
  if(tsbdMarker){
    const c=tsbdMarker.getLatLng();
    rows.push({STT:0, Ten: document.getElementById('tsbdTen').value||'TSBƒê', Lat:c.lat, Lng:c.lng, Gia: document.getElementById('tsbdGia').value||'', KhoangCach_m:0, QuanHuyen:getDistrictOfPoint([c.lng,c.lat])||''});
  }
  // TSSS
  tsssList.forEach((it,i)=>{
    const dist = tsbdMarker ? map.distance(tsbdMarker.getLatLng(), [it.lat,it.lng]) : '';
    rows.push({STT:i+1, Ten:it.name, Lat:it.lat, Lng:it.lng, Gia:it.gia, KhoangCach_m: dist?dist.toFixed(1):'', QuanHuyen:getDistrictOfPoint([it.lng,it.lat])||''});
  });
  const csv = "STT,Ten,Lat,Lng,Gia(KTY),KhoangCach(m),Quan/Huyen\n" + rows.map(r=>[r.STT,r.Ten,r.Lat,r.Lng,r.Gia,r.KhoangCach_m,r.QuanHuyen].join(',')).join('\n');
  download('tsbd_tsss.csv', csv);
};

/* District from point (current province layer) */
function getDistrictOfPoint(lnglat){
  let name='';
  layerAdmin.eachLayer(l=>{
    if(name) return;
    const gj=l.toGeoJSON();
    if(turf.booleanPointInPolygon(turf.point(lnglat),gj)){
      const p=gj.properties||{};
      name = p.quan_huyen||p.QuanHuyen||p.district||'';
    }
  });
  return name;
}

function download(filename, content){
  const blob = new Blob([content], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),500);
}

/* ====================== SCREENSHOT JPG (map only) ====================== */
document.getElementById('btnSnapJPG').onclick=async()=>{
  // d√πng leaflet export canvas ƒë∆°n gi·∫£n th√¥ng qua html2canvas (nh·∫π). CDN:
  const s=document.createElement('script'); s.src='https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js';
  s.onload=()=>{
    html2canvas(document.getElementById('map'),{useCORS:true}).then(c=>{
      const a=document.createElement('a'); a.href=c.toDataURL('image/jpeg',0.92); a.download='map.jpg'; a.click();
    });
  }; document.body.appendChild(s);
};

/* ====================== COMPASS SENSOR ====================== */
const compassWrap=document.getElementById('compassWrap');
const needle=document.getElementById('needle');
let compassOn=false;

async function ensureOrientationPermission(){
  if(typeof DeviceOrientationEvent === 'undefined') return true;
  // iOS
  if(typeof DeviceOrientationEvent.requestPermission === 'function'){
    try{
      const st = await DeviceOrientationEvent.requestPermission();
      return st==='granted';
    }catch(e){ return false; }
  }
  return true; // Android/desktop
}
document.getElementById('btnCompass').onclick=async()=>{
  if(!compassOn){
    const ok=await ensureOrientationPermission();
    compassWrap.style.display='block';
    compassOn=true;
    if(!ok) console.warn('Kh√¥ng c√≥ quy·ªÅn c·∫£m bi·∫øn.');
  }else{
    compassWrap.style.display='none';
    compassOn=false;
  }
};

if(window.DeviceOrientationEvent){
  window.addEventListener('deviceorientation',e=>{
    if(!compassOn) return;
    let heading = e.webkitCompassHeading;
    if(typeof heading === 'undefined'){
      if(typeof e.alpha === 'number') heading = 360 - e.alpha;
    }
    if(Number.isFinite(heading)){
      needle.style.transform=`rotate(${heading}deg)`;
    }
  },true);
}

/* ====================== PANEL TOGGLE BY KEY (optional) ====================== */
document.addEventListener('keydown',e=>{
  if(e.key==='`'){ document.getElementById('panel').classList.toggle('hidden'); }
});

/* ====================== HELP: CLICK MAP TO FILL LAT/LNG QUICKLY ====================== */
map.on('click',e=>{
  const {lat,lng}=e.latlng;
  // quick fill to TSSS inputs (for convenience)
  document.getElementById('tsssLat').value=lat.toFixed(6);
  document.getElementById('tsssLng').value=lng.toFixed(6);
});
</script>
</body>
</html>

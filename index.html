<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HCM WebGIS v5 ‚Äî Street View API + Sidebar TSBƒê/TSSS</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-compass/dist/leaflet-compass.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.js"></script>
<script src="https://unpkg.com/leaflet-compass/dist/leaflet-compass.min.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<style>
  html,body,#map{height:100%;margin:0}
  #searchbar{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:1400;width:520px}
  #q{width:100%;padding:10px 12px;border:1px solid #bbb;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.15)}
  .coords{position:absolute;left:10px;bottom:6px;background:rgba(255,255,255,.9);padding:4px 8px;border-radius:6px;font:12px monospace;z-index:1000}
  .leaflet-bar button{display:block;width:100%;border:none;background:#fff;padding:8px;cursor:pointer}
  .leaflet-bar button:hover{background:#eee}
  #tools{position:absolute;right:10px;top:70px;z-index:1000}
  #tools .btn{display:block;margin-bottom:6px;padding:8px 10px;border-radius:10px;border:1px solid #ddd;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.15);cursor:pointer}
  #legend{position:absolute;right:10px;bottom:10px;background:#fff;padding:8px 10px;border-radius:8px;font-size:12px;box-shadow:0 2px 6px rgba(0,0,0,.2)}
  #legend i{display:inline-block;width:14px;height:14px;margin-right:6px;vertical-align:middle}
  #sidebarToggle{position:absolute;left:10px;top:10px;z-index:1500;background:#fff;border:1px solid #ddd;border-radius:10px;padding:8px 10px;box-shadow:0 2px 6px rgba(0,0,0,.15);cursor:pointer}
  #sidebar{position:fixed;left:0;top:0;height:100%;width:340px;background:#ffffff;box-shadow:4px 0 16px rgba(0,0,0,.2);transform:translateX(-360px);transition:transform .25s ease;z-index:1600;padding:14px 14px 70px 14px;overflow:auto}
  #sidebar.open{transform:translateX(0)}
  #sidebar h3{margin:6px 0 10px}
  #tabs{display:flex;gap:8px;margin-bottom:10px}
  #tabs button{flex:1;border:1px solid #ccc;background:#f6f8fa;border-radius:8px;padding:8px;cursor:pointer}
  #tabs button.active{background:#1f6feb;color:#fff;border-color:#1f6feb}
  .form-row{display:flex;gap:8px;margin-bottom:8px}
  .form-row input,.form-row select,.form-row textarea{flex:1;padding:8px;border:1px solid #ccc;border-radius:8px}
  .muted{color:#586069;font-size:12px}
</style>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places,geometry"></script>
</head>
<body>
<button id="sidebarToggle">üìã TSBƒê / TSSS</button>
<div id="sidebar">
  <h3>Th√¥ng tin t√†i s·∫£n</h3>
  <div id="tabs">
    <button id="tab-tsbd" class="active">TSBƒê</button>
    <button id="tab-tsss">TSSS</button>
  </div>
  <div id="pane-tsbd">
    <div class="form-row"><select id="tsbdLoai"><option>Nh√† ·ªü</option><option>ƒê·∫•t tr·ªëng</option><option>CƒÉn h·ªô</option></select></div>
    <div class="form-row"><input id="tsbdDientich" type="number" placeholder="Di·ªán t√≠ch (m¬≤)"><input id="tsbdGia" type="number" placeholder="Gi√° tr·ªã (t·ª∑)"></div>
    <div class="form-row"><input id="tsbdLat" placeholder="Lat"><input id="tsbdLng" placeholder="Lng"></div>
    <div class="form-row"><textarea id="tsbdGhiChu" rows="3" placeholder="Ghi ch√∫"></textarea></div>
    <div class="form-row"><button id="tsbdPin">üìç ƒê·∫∑t ƒëi·ªÉm tr√™n b·∫£n ƒë·ªì</button><button id="tsbdStreet">üëÅÔ∏è Xem Street View</button></div>
    <div class="muted">M·∫πo: Nh·∫≠p t·ªça ƒë·ªô r·ªìi b·∫•m ‚Äúƒê·∫∑t ƒëi·ªÉm‚Äù ƒë·ªÉ nh·∫£y t·ªõi v·ªã tr√≠ TSBƒê.</div>
  </div>
  <div id="pane-tsss" style="display:none">
    <div class="form-row"><input id="tsssTen" placeholder="T√™n/ƒê·ªãa ch·ªâ so s√°nh"><input id="tsssGia" type="number" placeholder="Gi√° (t·ª∑)"></div>
    <div class="form-row"><input id="tsssLat" placeholder="Lat"><input id="tsssLng" placeholder="Lng"></div>
    <div class="form-row"><button id="tsssAdd">‚ûï Th√™m so s√°nh</button></div>
    <div id="tsssList" class="muted">Ch∆∞a c√≥ m·ª•c so s√°nh n√†o.</div>
  </div>
</div>

<div id="searchbar"><input id="q" placeholder="üîç ƒê·ªãa ch·ªâ, ph∆∞·ªùng/x√£, ho·∫∑c nh·∫≠p t·ªça ƒë·ªô: 10.79844, 106.65855"></div>
<div id="map"></div>

<div id="tools">
  <button id="btnClear" class="btn">üßπ X√≥a t√¥ m√†u</button>
  <label class="btn"><input type="checkbox" id="chkQH" checked> Hi·ªán Quy ho·∫°ch 1/2000</label>
</div>

<div id="legend">
  <b>Ch√∫ gi·∫£i lo·∫°i ƒë·∫•t</b><br>
  <i style="background:#e41a1c"></i> ƒê·∫•t ·ªü (ODT/ONT) &nbsp;
  <i style="background:#4daf4a"></i> C√¢y xanh (CX) &nbsp;
  <i style="background:#999"></i> Giao th√¥ng (DGT) &nbsp;
  <i style="background:#ffcc00"></i> C√¥ng c·ªông (CC) &nbsp;
  <i style="background:#6baed6"></i> M·∫∑t n∆∞·ªõc (MN)
</div>
<div class="coords" id="coords">Lat: --, Lng: --</div>

<script>
const map=L.map('map',{center:[10.776,106.7],zoom:12});

const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
const esriStreet=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',{attribution:'¬© Esri'});
const esriImagery=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'¬© Esri Imagery'});
const esriTopo=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',{attribution:'¬© Esri Topo'});
const gStreet=L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA',{attribution:'¬© Google'});
const gHybrid=L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}&key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA',{attribution:'¬© Google'});

L.control.layers({"üó∫Ô∏è OSM":osm,"üó∫Ô∏è Esri Street":esriStreet,"üõ∞Ô∏è Esri Imagery":esriImagery,"üó∫Ô∏è Esri Topo":esriTopo,"üåç Google Street":gStreet,"üõ∞Ô∏è Google Hybrid":gHybrid},{},{collapsed:true}).addTo(map);

function colorBy(code){const lut={"ODT":"#e41a1c","ONT":"#e41a1c","CX":"#4daf4a","DGT":"#999","CC":"#ffcc00","MN":"#6baed6","HTKT":"#984ea3","TG":"#fdb462"};for(const k in lut){if(code && code.includes(k)) return lut[k];}return "#ccc";}
const hanhChinh=L.layerGroup().addTo(map),quyHoach=L.layerGroup().addTo(map);
let coloredLayers=[];

fetch('assets/TPHCM.geojson').then(r=>r.json()).then(geo=>{
  const layer=L.geoJSON(geo,{style:{color:"#ff6600",weight:1,fillOpacity:.1},onEachFeature:(f,l)=>{
    const p=f.properties||{};l.bindPopup(`<b>${p.ten_xa||''}</b><br>${p.quan_huyen||''}<br>${(p.dtich_km2||'-')} km¬≤<br>${p.dan_so? p.dan_so.toLocaleString()+' ng∆∞·ªùi':'-'}`);
    l.on('click',()=>{l.setStyle({fillColor:"#ff79c6",fillOpacity:.45});if(!coloredLayers.includes(l))coloredLayers.push(l);});
  }});hanhChinh.addLayer(layer);
});

fetch('assets/QHPKSDD_SHAPE.json').then(r=>r.json()).then(geo=>{
  const layer=L.geoJSON(geo,{style:f=>({color:"#666",weight:.4,fillColor:colorBy(f.properties?.MaQuyUoc),fillOpacity:.5}),onEachFeature:(f,l)=>l.bindPopup(`<b>${f.properties?.MaQuyUoc||''}</b> - ${f.properties?.TenLoaiDat||''}`)});quyHoach.addLayer(layer);
});

document.getElementById('chkQH').addEventListener('change',e=>{ if(e.target.checked) map.addLayer(quyHoach); else map.removeLayer(quyHoach); });

L.control.locate({strings:{title:"ƒê·ªãnh v·ªã GPS"}}).addTo(map);
L.control.measure({primaryLengthUnit:'meters',primaryAreaUnit:'sqmeters'}).addTo(map);
L.control.compass({autoActive:true,position:'topright'}).addTo(map);

document.getElementById('btnClear').onclick=()=>{ coloredLayers.forEach(l=>l.setStyle({fillColor:null,fillOpacity:.1})); coloredLayers=[]; };

const qInp=document.getElementById('q');const ac=new google.maps.places.Autocomplete(qInp,{componentRestrictions:{country:"vn"}});
let lastMarker=null;
function placeMarker(lat,lng,label){
  map.setView([lat,lng],17);
  if(lastMarker) map.removeLayer(lastMarker);
  lastMarker=L.marker([lat,lng]).addTo(map).bindPopup(`<b>${label||''}</b><br><button id="svbtn">üëÅÔ∏è Xem Street View t·∫°i v·ªã tr√≠ n√†y</button>`).openPopup();
  setTimeout(()=>{const btn=document.getElementById('svbtn'); if(btn){ btn.onclick=()=>openStreetView(lat,lng); }},60);
}
ac.addListener("place_changed",()=>{ const p=ac.getPlace(); if(!p.geometry) return; placeMarker(p.geometry.location.lat(),p.geometry.location.lng(),p.formatted_address||p.name); });
qInp.addEventListener('keydown',ev=>{ if(ev.key!=="Enter") return; const m=qInp.value.trim().match(/^(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)/); if(m){ const lat=parseFloat(m[1]),lng=parseFloat(m[2]); placeMarker(lat,lng,`T·ªça ƒë·ªô: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);} });

const svService=new google.maps.StreetViewService();
function openStreetView(lat,lng){
  const html=`<div id="sv" style="width:350px;height:250px"></div>`;
  L.popup({maxWidth:380}).setLatLng([lat,lng]).setContent(html).openOn(map);
  setTimeout(()=>{
    svService.getPanorama({location:{lat:lat,lng:lng}, radius:60},(data,status)=>{
      if(status!=='OK'||!data||!data.location){ document.getElementById('sv').innerHTML='<div style="padding:8px">Kh√¥ng c√≥ Street View t·∫°i ƒë√¢y.</div>'; return; }
      let heading=0;
      if(data.links && data.links.length){ heading=data.links[0].heading; }
      else if(google.maps.geometry && data.location && data.location.latLng){
        heading=google.maps.geometry.spherical.computeHeading(data.location.latLng,new google.maps.LatLng(lat,lng));
      }
      new google.maps.StreetViewPanorama(document.getElementById('sv'),{
        position:data.location.latLng,
        pov:{heading:heading,pitch:0,zoom:0},
        linksControl:true, zoomControl:true, panControl:true, addressControl:false
      });
    });
  },50);
}
map.on('contextmenu', e=> openStreetView(e.latlng.lat, e.latlng.lng));

// Sidebar
const sidebar=document.getElementById('sidebar');
document.getElementById('sidebarToggle').onclick=()=> sidebar.classList.toggle('open');
const tabTSBD=document.getElementById('tab-tsbd'); const tabTSSS=document.getElementById('tab-tsss');
const paneTSBD=document.getElementById('pane-tsbd'); const paneTSSS=document.getElementById('pane-tsss');
function setTab(which){ if(which==='tsbd'){ tabTSBD.classList.add('active'); tabTSSS.classList.remove('active'); paneTSBD.style.display='block'; paneTSSS.style.display='none'; } else { tabTSBD.classList.remove('active'); tabTSSS.classList.add('active'); paneTSBD.style.display='none'; paneTSSS.style.display='block'; } }
tabTSBD.onclick=()=>setTab('tsbd'); tabTSSS.onclick=()=>setTab('tsss');
document.getElementById('tsbdPin').onclick=()=>{ const lat=parseFloat(document.getElementById('tsbdLat').value); const lng=parseFloat(document.getElementById('tsbdLng').value); if(!isFinite(lat)||!isFinite(lng)){ alert('Nh·∫≠p Lat/Lng h·ª£p l·ªá'); return; } placeMarker(lat,lng,'TSBƒê'); };
document.getElementById('tsbdStreet').onclick=()=>{ const lat=parseFloat(document.getElementById('tsbdLat').value); const lng=parseFloat(document.getElementById('tsbdLng').value); if(!isFinite(lat)||!isFinite(lng)){ alert('Nh·∫≠p Lat/Lng h·ª£p l·ªá'); return; } openStreetView(lat,lng); };

const tsssList=document.getElementById('tsssList'); const items=[];
document.getElementById('tsssAdd').onclick=()=>{
  const name=document.getElementById('tsssTen').value.trim(); const price=parseFloat(document.getElementById('tsssGia').value);
  const lat=parseFloat(document.getElementById('tsssLat').value); const lng=parseFloat(document.getElementById('tsssLng').value);
  if(!name || !isFinite(lat)||!isFinite(lng)){ alert('Nh·∫≠p t√™n v√† t·ªça ƒë·ªô h·ª£p l·ªá'); return; }
  items.push({name,price,lat,lng}); renderTSSS();
};
function renderTSSS(){
  if(!items.length){ tsssList.innerHTML='Ch∆∞a c√≥ m·ª•c so s√°nh n√†o.'; return; }
  tsssList.innerHTML=items.map((it,i)=>`<div style="margin:6px 0;padding:6px;border:1px solid #eee;border-radius:8px">
    <b>${i+1}. ${it.name}</b> ‚Äî ${it.price? it.price+' t·ª∑':''}<br>
    ${it.lat.toFixed(6)}, ${it.lng.toFixed(6)}
    <div style="margin-top:4px">
      <button onclick="window._goTSSS(${i})">T·ªõi v·ªã tr√≠</button>
      <button onclick="window._svTSSS(${i})">Street View</button>
      <button onclick="window._rmTSSS(${i})">X√≥a</button>
    </div>
  </div>`).join('');
}
window._goTSSS=(i)=>{ const it=items[i]; placeMarker(it.lat,it.lng,it.name); };
window._svTSSS=(i)=>{ const it=items[i]; openStreetView(it.lat,it.lng); };
window._rmTSSS=(i)=>{ items.splice(i,1); renderTSSS(); };

map.on('mousemove', e=> document.getElementById('coords').textContent=`Lat:${e.latlng.lat.toFixed(5)}, Lng:${e.latlng.lng.toFixed(5)}`);
</script>
</body>
</html>

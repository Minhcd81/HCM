<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>HCM WebGIS ‚Äì ƒê·ªãa ch√≠nh & Quy ho·∫°ch 1/2000</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet CSS & Plugins -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-compass/dist/leaflet-compass.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

<!-- Google Places -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places"></script>

<style>
html,body,#map{height:100%;margin:0;padding:0;}
#search-box{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:1500;width:320px;}
#search-input{width:100%;padding:6px 10px;border-radius:6px;border:1px solid #aaa;box-shadow:0 2px 5px rgba(0,0,0,0.3);}
.coords{position:absolute;bottom:5px;left:10px;background:rgba(255,255,255,0.9);padding:3px 8px;border-radius:4px;font-size:12px;font-family:monospace;z-index:1000;}
.leaflet-bar button{display:block;width:100%;border:none;background:white;padding:6px;cursor:pointer;}
.leaflet-bar button:hover{background:#eee;}
#legend{position:absolute;right:10px;bottom:10px;background:white;padding:8px 10px;border-radius:8px;font-size:12px;box-shadow:0 2px 5px rgba(0,0,0,0.3);}
#legend i{display:inline-block;width:14px;height:14px;margin-right:5px;vertical-align:middle;}
</style>
</head>
<body>
<div id="search-box"><input id="search-input" type="text" placeholder="üîç T√¨m ƒë·ªãa ch·ªâ ho·∫∑c ph∆∞·ªùng/x√£..."></div>
<div id="map"></div>
<div id="coords" class="coords">Lat: --, Lng: --</div>
<div id="legend">
  <b>Ch√∫ gi·∫£i lo·∫°i ƒë·∫•t</b><br>
  <i style="background:#e41a1c"></i> ƒê·∫•t ·ªü (ODT/ONT)<br>
  <i style="background:#4daf4a"></i> C√¢y xanh (CX)<br>
  <i style="background:#999"></i> Giao th√¥ng (DGT)<br>
  <i style="background:#ffcc00"></i> C√¥ng c·ªông (CC)<br>
  <i style="background:#6baed6"></i> M·∫∑t n∆∞·ªõc (MN)<br>
  <i style="background:#984ea3"></i> H·∫° t·∫ßng k·ªπ thu·∫≠t (HTKT)<br>
  <i style="background:#fdb462"></i> T√¥n gi√°o (TG)
</div>

<!-- JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.js"></script>
<script src="https://unpkg.com/leaflet-compass/dist/leaflet-compass.min.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
window.onload = function(){
  const map = L.map('map',{center:[10.776,106.7],zoom:12});

  // --- L·ªõp n·ªÅn ---
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
  const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'¬© Esri'});
  const googleHybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}&key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA',{attribution:'¬© Google'});

  const baseMaps = {"üåç OSM":osm,"üõ∞Ô∏è Esri Imagery":esriImagery,"üå§Ô∏è Google Hybrid":googleHybrid};

  const phuongXaGroup=L.layerGroup(),quyHoachGroup=L.layerGroup();
  let colored=[],measureCtrl,compassCtrl;

  // --- N·∫°p ƒë·ªãa gi·ªõi h√†nh ch√≠nh ---
  fetch('assets/TPHCM.geojson').then(r=>r.json()).then(data=>{
    const layer=L.geoJSON(data,{
      style:{color:"#ff6600",weight:1,fillOpacity:0.1},
      onEachFeature:(f,l)=>{
        const p=f.properties||{};
        const name=p.ten_xa||'';
        const q=p.quan_huyen||'';
        const dt=(p.dtich_km2?p.dtich_km2.toFixed(2):'-')+" km¬≤";
        const ds=p.dan_so?p.dan_so.toLocaleString()+" ng∆∞·ªùi":'-';
        const sap=p.sap_nhap?`<i>${p.sap_nhap}</i>`:'';
        l.bindPopup(`<b>${name}</b><br>${q}<br>${dt}<br>${ds}<br>${sap}`);
        l.on('click',()=>highlight(f,l));
      }
    });
    phuongXaGroup.addLayer(layer).addTo(map);
    addSearchControl(data.features);
  });

  // --- Quy ho·∫°ch 1/2000 ---
  fetch('assets/QHPKSDD_SHAPE.json').then(r=>r.json()).then(data=>{
    const layer=L.geoJSON(data,{
      style:f=>({color:'#555',weight:0.3,fillColor:colorByCode(f.properties.MaQuyUoc||''),fillOpacity:0.5}),
      onEachFeature:(f,l)=>{
        const p=f.properties||{};
        l.bindPopup(`<b>${p.MaQuyUoc||''}</b><br>${p.TenLoaiDat||''}`);
      }
    });
    quyHoachGroup.addLayer(layer);
  });

  function colorByCode(code){
    const lut={'ODT':'#e41a1c','ONT':'#e41a1c','CX':'#4daf4a','DGT':'#999','CC':'#ffcc00','MN':'#6baed6','HTKT':'#984ea3','TG':'#fdb462'};
    for(const k in lut)if(code.includes(k))return lut[k];
    return '#ccc';
  }

  // --- T√¥ m√†u v√πng ---
  function highlight(f,l){
    const c=['#FFD700','#32CD32','#1E90FF','#FF69B4','#FFA500'][Math.floor(Math.random()*5)];
    l.setStyle({fillColor:c,fillOpacity:0.5});
    colored.push(f);
  }
  function clearColors(){
    phuongXaGroup.eachLayer(l=>l.setStyle&&l.setStyle({fillOpacity:0.1,fillColor:null}));
    colored=[];
  }
  function exportGeoJSON(){
    if(!colored.length)return alert("Ch∆∞a c√≥ v√πng n√†o ƒë∆∞·ª£c t√¥!");
    const blob=new Blob([JSON.stringify({type:"FeatureCollection",features:colored},null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");a.href=url;a.download="to_mau.geojson";a.click();
    URL.revokeObjectURL(url);
  }

  // --- Search b·∫±ng Leaflet geocoder ---
  function addSearchControl(features){
    const list=features.map(f=>({name:`${f.properties.ten_xa} - ${f.properties.quan_huyen}`,layer:f}));
    const g=L.Control.geocoder({defaultMarkGeocode:false,placeholder:'üîç T√¨m ph∆∞·ªùng/x√£ ho·∫∑c qu·∫≠n...'}).addTo(map);
    const input=g._input;
    input.addEventListener('input',function(){
      const kw=this.value.toLowerCase();
      const m=list.find(i=>i.name.toLowerCase().includes(kw));
      if(m){const b=L.geoJSON(m.layer).getBounds();map.fitBounds(b);}
    });
  }

  // --- Google Autocomplete ---
  const input=document.getElementById("search-input");
  const ac=new google.maps.places.Autocomplete(input,{componentRestrictions:{country:"vn"}});
  ac.addListener("place_changed",()=>{
    const p=ac.getPlace();
    if(!p.geometry)return;
    const lat=p.geometry.location.lat(),lng=p.geometry.location.lng();
    map.setView([lat,lng],17);
    L.marker([lat,lng]).addTo(map).bindPopup(p.formatted_address||p.name).openPopup();
  });

  // --- C√¥ng c·ª• c∆° b·∫£n ---
  L.control.layers(baseMaps,{"üó∫Ô∏è H√†nh ch√≠nh":phuongXaGroup,"üìê Quy ho·∫°ch 1/2000":quyHoachGroup}).addTo(map);
  L.control.locate({strings:{title:"ƒê·ªãnh v·ªã GPS"}}).addTo(map);
  L.control.scale().addTo(map);

  const coordsDiv=document.getElementById("coords");
  map.on("mousemove",e=>coordsDiv.textContent=`Lat:${e.latlng.lat.toFixed(5)}, Lng:${e.latlng.lng.toFixed(5)}`);

  // --- N√∫t c√¥ng c·ª• b√™n ph·∫£i ---
  const panel=L.control({position:'topright'});
  panel.onAdd=function(){
    const d=L.DomUtil.create('div','leaflet-bar');
    d.innerHTML=`
      <button onclick="window._clear()">üé® X√≥a t√¥</button>
      <button onclick="window._export()">üíæ Xu·∫•t GeoJSON</button>
      <button onclick="window._toggle()">üß≠ C√¥ng c·ª•</button>`;
    return d;
  };
  panel.addTo(map);

  window._clear=clearColors;
  window._export=exportGeoJSON;
  window._toggle=function(){
    if(measureCtrl){map.removeControl(measureCtrl);map.removeControl(compassCtrl);measureCtrl=null;compassCtrl=null;}
    else{
      measureCtrl=L.control.measure({primaryLengthUnit:'meters',primaryAreaUnit:'sqmeters'}).addTo(map);
      compassCtrl=L.control.compass({autoActive:true,position:'topright'}).addTo(map);
    }
  };

  map.on('zoomend',()=>{
    if(map.getZoom()>14&&!map.hasLayer(esriImagery))map.addLayer(esriImagery);
    else if(map.getZoom()<=14&&map.hasLayer(esriImagery))map.removeLayer(esriImagery);
  });
};
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HCM WebGIS ‚Äì Quy ho·∫°ch & B·∫£n ƒë·ªì h√†nh ch√≠nh</title>

<!-- Leaflet core -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Plugins -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.min.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<!-- Google Places -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places"></script>

<style>
  html, body, #map {height:100%; margin:0; padding:0;}
  #searchbox {
    position:absolute; top:10px; left:50%; transform:translateX(-50%);
    z-index:1500; background:white; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.3);
    padding:6px 8px; width:340px;
  }
  #legend {
    position:absolute; right:10px; bottom:10px; background:rgba(255,255,255,0.95);
    padding:8px 10px; border-radius:8px; font-size:12px; z-index:1100;
  }
  #legend i {display:inline-block; width:14px; height:14px; margin-right:6px; vertical-align:middle;}
  .coords {
    position:absolute; left:10px; bottom:6px; background:rgba(255,255,255,0.9);
    font:12px monospace; padding:4px 6px; border-radius:4px;
  }
  .leaflet-bar button {background:white; border:none; width:100%; padding:6px;}
</style>
</head>
<body>
<div id="searchbox"><input id="search" type="text" placeholder="üîç T√¨m ƒë·ªãa ch·ªâ ho·∫∑c khu v·ª±c..." style="width:100%;border:none;outline:none;"></div>
<div id="map"></div>
<div class="coords" id="coords">Lat: --, Lng: --</div>
<div id="legend">
  <b>Ch√∫ gi·∫£i lo·∫°i ƒë·∫•t</b><br>
  <i style="background:#e41a1c"></i> ƒê·∫•t ·ªü (ODT/ONT)<br>
  <i style="background:#4daf4a"></i> C√¢y xanh (CX)<br>
  <i style="background:#999"></i> Giao th√¥ng (DGT)<br>
  <i style="background:#ffcc00"></i> C√¥ng c·ªông (CC)<br>
  <i style="background:#6baed6"></i> M·∫∑t n∆∞·ªõc (MN)<br>
  <i style="background:#984ea3"></i> H·∫° t·∫ßng k·ªπ thu·∫≠t (HTKT)<br>
  <i style="background:#fdb462"></i> T√¥n gi√°o (TG)
</div>

<script>
const map = L.map('map').setView([10.776,106.7], 12);

// ==== Base maps ====
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
const esriStreet = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',{attribution:'¬© Esri'});
const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'¬© Esri Imagery'});
const googleStreet = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA',{attribution:'¬© Google'});
const googleHybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}&key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA',{attribution:'¬© Google'});
// ‚úÖ S·ª≠a l·ªói Bing plugin: d√πng tile URL tr·ª±c ti·∫øp
const bingRoad = L.tileLayer(
  "https://ecn.t{s}.tiles.virtualearth.net/tiles/r{q}.jpeg?g=0&mkt=en-US&shading=hill&key=34TsHklW0IqAp0Ei1inHFoaRUxqgaVSDH9Dm56DqrisxL0NtnWL5JQQJ99BJACYeBjFmUVijAAAgAZMPXNSk",
  { subdomains: ['t0','t1','t2','t3'], attribution:'¬© Bing Maps' }
);
const bingAerial = L.tileLayer(
  "https://ecn.t{s}.tiles.virtualearth.net/tiles/a{q}.jpeg?g=0&mkt=en-US&key=34TsHklW0IqAp0Ei1inHFoaRUxqgaVSDH9Dm56DqrisxL0NtnWL5JQQJ99BJACYeBjFmUVijAAAgAZMPXNSk",
  { subdomains: ['t0','t1','t2','t3'], attribution:'¬© Bing Aerial' }
);

const baseMaps = {
  "üó∫Ô∏è OSM": osm,
  "üåç Google Street": googleStreet,
  "üõ∞Ô∏è Google Hybrid": googleHybrid,
  "üó∫Ô∏è Esri Street": esriStreet,
  "üõ∞Ô∏è Esri Imagery": esriImagery,
  "üó∫Ô∏è Bing Road": bingRoad,
  "üåÑ Bing Aerial": bingAerial
};

// ==== Overlays ====
const hanhChinh = L.layerGroup();
const quyHoach = L.layerGroup();
const taiSan = L.layerGroup();

function colorByMaQuyUoc(code){
  const lut = {
    "ODT":"#e41a1c","ONT":"#e41a1c","CX":"#4daf4a",
    "DGT":"#999999","CC":"#ffcc00","MN":"#6baed6",
    "HTKT":"#984ea3","TG":"#fdb462"
  };
  for (const k in lut){ if(code && code.includes(k)) return lut[k]; }
  return "#cccccc";
}

// ƒê·ªãa gi·ªõi h√†nh ch√≠nh
fetch("assets/TPHCM.geojson")
.then(r=>r.json())
.then(data=>{
  const layer=L.geoJSON(data,{
    style:{color:"#ff6600",weight:1,fillOpacity:0.1},
    onEachFeature:(f,l)=>{
      const p=f.properties||{};
      const ten=p.ten_xa||'', q=p.quan_huyen||'';
      l.bindPopup(`<b>${ten}</b><br>${q}`);
      l.on("click",()=>l.setStyle({fillColor:"#FFD700",fillOpacity:0.5}));
    }
  });
  hanhChinh.addLayer(layer);
});

// Quy ho·∫°ch 1/2000 (Google Drive qua proxy)
fetch("https://corsproxy.io/?https://drive.google.com/uc?export=download&id=1UTyZRAmJGmkQSfU48jnrjved9Dc0zY3u")
.then(r=>r.json())
.then(data=>{
  const layer=L.geoJSON(data,{
    style:f=>({color:"#555",weight:0.3,fillColor:colorByMaQuyUoc(f.properties.MaQuyUoc||""),fillOpacity:0.6}),
    onEachFeature:(f,l)=>{
      const p=f.properties||{};
      l.bindPopup(`<b>M√£ quy ∆∞·ªõc:</b> ${p.MaQuyUoc||''}<br>${p.TenLoaiDat||''}`);
    }
  });
  quyHoach.addLayer(layer);
})
.catch(()=>alert("‚ö†Ô∏è Kh√¥ng t·∫£i ƒë∆∞·ª£c Quy ho·∫°ch 1/2000 (CORS ho·∫∑c ID sai)."));

// T√†i s·∫£n (n·∫øu c√≥)
fetch("assets/taisan.geojson").then(r=>r.ok?r.json():null).then(data=>{
  if(!data)return;
  const icon=L.icon({iconUrl:"assets/icon_home.png",iconSize:[24,24]});
  taiSan.addLayer(L.geoJSON(data,{pointToLayer:(f,latlng)=>L.marker(latlng,{icon})}));
});

// Layer control
L.control.layers(baseMaps, {
  "üóæ H√†nh ch√≠nh": hanhChinh,
  "üìê Quy ho·∫°ch 1/2000": quyHoach,
  "üè† T√†i s·∫£n (My Maps)": taiSan
}).addTo(map);

// Tools
L.control.scale().addTo(map);
L.control.locate().addTo(map);
L.control.measure({primaryLengthUnit:'meters'}).addTo(map);

// Google Autocomplete
const input=document.getElementById("search");
const autocomplete=new google.maps.places.Autocomplete(input,{componentRestrictions:{country:"vn"}});
autocomplete.addListener("place_changed",()=>{
  const pl=autocomplete.getPlace();
  if(pl.geometry){
    const lat=pl.geometry.location.lat(),lng=pl.geometry.location.lng();
    map.setView([lat,lng],17);
    L.marker([lat,lng]).addTo(map).bindPopup(pl.formatted_address).openPopup();
  }
});

// Hi·ªÉn th·ªã to·∫° ƒë·ªô chu·ªôt
const coordBox=document.getElementById("coords");
map.on("mousemove",e=>{
  coordBox.innerText=`Lat:${e.latlng.lat.toFixed(5)}, Lng:${e.latlng.lng.toFixed(5)}`;
});
</script>
</body>
</html>

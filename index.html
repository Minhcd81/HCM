<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HCM WebGIS v14.2 FULL CLEAN</title>

  <!-- Leaflet CSS + JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- Leaflet Locate -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
  <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

  <!-- Turf, XLSX, Screenshot -->
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.0/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/leaflet-simple-map-screenshoter"></script>

  <!-- Google Maps API (Places & geometry) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places,geometry"></script>

  <style>
    :root { --pri: #00BFFF; --gold: #FFD700; }
    * { box-sizing: border-box; }
    html, body, #map { height: 100%; margin: 0; font-family: system-ui,Segoe UI,Roboto,Arial; }
    #map { position: absolute; inset: 0; }
    #searchWrap {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1400;
      width: 860px;
      max-width: 94vw;
    }
    #search {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #cfd4dc;
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    #tools {
      position: absolute;
      right: 10px;
      top: 72px;
      z-index: 1200;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .toolbtn {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-size: 22px;
    }
    #btnClear {
      position: absolute;
      right: 10px;
      top: 240px;
      z-index: 1200;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 8px 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      cursor: pointer;
    }
    #measureMenu {
      position: absolute;
      right: 70px;
      top: 122px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.18);
      display: none;
      z-index: 1300;
    }
    #measureMenu button {
      display: block;
      width: 240px;
      padding: 10px 14px;
      border: none;
      background: #fff;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
    }
    #measureMenu button:hover {
      background: #f1f5f9;
    }
    #sidebarToggle {
      position: absolute;
      left: 10px;
      top: 120px;
      z-index: 1200;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 8px 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      cursor: pointer;
    }
    #sidebar {
      position: fixed;
      left: 0;
      top: 0;
      height: 100%;
      width: 380px;
      background: #fff;
      box-shadow: 4px 0 20px rgba(0,0,0,0.2);
      transform: translateX(-400px);
      transition: transform 0.28s ease;
      z-index: 1600;
      display: flex;
      flex-direction: column;
    }
    #sidebar.open {
      transform: translateX(0);
    }
    #sbHead {
      background: var(--pri);
      color: #fff;
      padding: 14px 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #sidebarClose {
      border: none;
      background: transparent;
      color: #fff;
      font-size: 22px;
      cursor: pointer;
    }
    #sbBody {
      padding: 12px 12px 90px;
      overflow: auto;
    }
    .section {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 10px 10px 6px;
      margin-bottom: 10px;
    }
    .section h4 {
      margin: 0 0 8px;
      font-size: 14px;
    }
    .form-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .form-row input, .form-row select, .form-row textarea {
      flex: 1;
      padding: 9px;
      border: 1px solid #cfd4dc;
      border-radius: 10px;
    }
    .sm {
      font-size: 12px;
      color: #6b7280;
    }
    .pin {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #003;
      font-weight: 700;
      border: 3px solid #004;
    }
    .pin.tsbd {
      background: var(--gold);
      border-color: #a06f00;
    }
    .pin.tsss {
      background: var(--pri);
      border-color: #0a4f7a;
      color: #fff;
    }
    #compassOverlay {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 240px;
      height: 240px;
      pointer-events: none;
      display: none;
      z-index: 1300;
    }
    #compassCanvas {
      width: 100%;
      height: 100%;
    }
    .coords {
      position: absolute;
      left: 10px;
      bottom: 6px;
      background: rgba(255,255,255,0.9);
      padding: 4px 8px;
      border-radius: 8px;
      font: 12px monospace;
      z-index: 1000;
    }
    @media (max-width: 768px) {
      #searchWrap { width: 94vw; }
      #sidebar { width: 92vw; transform: translateX(-100vw); }
      #compassOverlay { width: 210px; height: 210px; }
    }
  </style>
</head>
<body>

  <div id="searchWrap">
    <input id="search" placeholder="üîç ƒê·ªãa ch·ªâ / Ph∆∞·ªùng-X√£ / T√™n c≈© / T·ªça ƒë·ªô (10.79,106.66)"/>
  </div>
  <div id="map"></div>

  <div id="tools">
    <button id="btnCompass" class="toolbtn" title="B·∫≠t/T·∫Øt la b√†n">üß≠</button>
    <button id="btnMeasure" class="toolbtn" title="ƒêo (kho·∫£ng c√°ch/di·ªán t√≠ch)">üìè</button>
    <button id="btnGPS" class="toolbtn" title="ƒê·ªãnh v·ªã">üìç</button>
    <button id="btnShot" class="toolbtn" title="Ch·ª•p JPG">üì∏</button>
  </div>

  <div id="measureMenu">
    <button id="mDist">üìçüìç ƒêo kho·∫£ng c√°ch</button>
    <button id="mArea">‚¨õ ƒêo di·ªán t√≠ch</button>
    <button id="mFinish">üõë Ho√†n t·∫•t ƒëo</button>
  </div>

  <button id="btnClear">üßπ X√≥a t√¥ m√†u</button>

  <button id="sidebarToggle">üìã TSBƒê / TSSS</button>
  <div id="sidebar">
    <div id="sbHead">
      <span>üìã TSBƒê / TSSS</span>
      <button id="sidebarClose">√ó</button>
    </div>
    <div id="sbBody">
      <div class="section">
        <h4>TSBƒê</h4>
        <div class="form-row">
          <input id="tsbdTen" placeholder="T√™n/ƒê·ªãa ch·ªâ TSBƒê"/>
          <input id="tsbdGia" placeholder="Gi√° (t·ª∑)" type="number"/>
        </div>
        <div class="form-row">
          <input id="tsbdLat" placeholder="Lat"/>
          <input id="tsbdLng" placeholder="Lng"/>
        </div>
        <div class="form-row">
          <button id="tsbdPin">üìç ƒê·∫∑t ƒëi·ªÉm</button>
          <button id="tsbdStreet">üëÅÔ∏è Street View</button>
        </div>
        <div class="sm">TSBƒê hi·ªÉn th·ªã v√≤ng tr√≤n <b>v√†ng</b>.</div>
      </div>

      <div class="section">
        <h4>TSSS</h4>
        <div class="form-row">
          <input id="tsssTen" placeholder="T√™n/ƒê·ªãa ch·ªâ so s√°nh"/>
          <input id="tsssGia" placeholder="Gi√° (t·ª∑)" type="number"/>
        </div>
        <div class="form-row">
          <input id="tsssLat" placeholder="Lat"/>
          <input id="tsssLng" placeholder="Lng"/>
        </div>
        <div class="form-row">
          <button id="tsssAdd">‚ûï Th√™m TSSS</button>
          <button id="tsssClear">üóëÔ∏è X√≥a TSSS</button>
        </div>
        <div id="tsssList" class="sm">Ch∆∞a c√≥ TSSS.</div>
      </div>

      <div class="section">
        <h4>L∆∞u / T·∫£i d·ªØ li·ªáu</h4>
        <div class="form-row">
          <button id="btnExportCSV">üìÑ Xu·∫•t CSV</button>
          <button id="btnExportXLSX">üìò Xu·∫•t Excel (.xlsx)</button>
        </div>
        <div class="form-row">
          <button id="btnExportKML">üó∫Ô∏è T·∫°o My Map (KML)</button>
          <button id="btnOpenMyMaps">üìÇ M·ªü My Maps</button>
        </div>
        <div class="sm">File xu·∫•t c√≥ c·ªôt <b>Qu·∫≠n/Huy·ªán</b>. KML ƒë·ªÉ import v√†o Google My Maps.</div>
      </div>
    </div>
  </div>

  <div id="compassOverlay">
    <canvas id="compassCanvas" width="240" height="240"></canvas>
  </div>
  <div id="coords" class="coords">Lat: --, Lng: --</div>

  <script>
    // MAP base
    const map = L.map('map', { center: [10.775, 106.7], zoom: 12 });
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);
    const gSt = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}');
    const gHy = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}');
    L.control.layers({ "üó∫Ô∏è OSM": osm, "üåç Google Street": gSt, "üõ∞Ô∏è Google Hybrid": gHy }).addTo(map);
    const coordsEl = document.getElementById('coords');
    map.on('mousemove', e => {
      coordsEl.textContent = `Lat: ${e.latlng.lat.toFixed(5)}, Lng: ${e.latlng.lng.toFixed(5)}`;
    });

    // Sidebar toggle
    const sidebar = document.getElementById('sidebar');
    document.getElementById('sidebarToggle').onclick = () => sidebar.classList.add('open');
    document.getElementById('sidebarClose').onclick = () => sidebar.classList.remove('open');

    // GeoJSON h√†nh ch√≠nh t·ª´ raw GitHub
    let wardLayer = null;
    let wardFeatures = [];
    let coloredLayers = [];
    fetch('https://raw.githubusercontent.com/Minhcd81/HCM/main/assets/TPHCM.geojson')
      .then(r => r.json())
      .then(geo => {
        wardLayer = L.geoJSON(geo, {
          style: { color: '#555', weight: 1, fillOpacity: 0.1 },
          onEachFeature: (f, layer) => {
            const p = f.properties || {};
            const ten = p.ten_xa || '';
            const qh = p.quan_huyen || '';
            const sn = (p.sap_nhap && p.sap_nhap !== '0') ? p.sap_nhap : '‚Äî';
            const dt = (p.dtich_km2 != null) ? `${p.dtich_km2} km¬≤` : '‚Äî';
            const ds = (p.dan_so != null) ? `${Number(p.dan_so).toLocaleString('vi-VN')} ng∆∞·ªùi` : '‚Äî';
            const popup = `<b>${ten}</b><br>${qh}<br>Tr∆∞·ªõc s√°p nh·∫≠p: ${sn}<br>Di·ªán t√≠ch: ${dt}<br>D√¢n s·ªë: ${ds}`;
            layer.bindPopup(popup);
            layer.on('click', () => {
              const c = randColor();
              layer.setStyle({ fillColor: c, fillOpacity: 0.45 });
              if (!coloredLayers.includes(layer)) coloredLayers.push(layer);
              layer.openPopup();
            });
            wardFeatures.push(f);
          }
        }).addTo(map);
      })
      .catch(err => {
        console.error('Load GeoJSON l·ªói:', err);
        alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c GeoJSON. Ki·ªÉm tra ƒë∆∞·ªùng d·∫´n.');
      });

    document.getElementById('btnClear').onclick = () => {
      coloredLayers.forEach(l => l.setStyle({ fillColor: null, fillOpacity: 0.1 }));
      coloredLayers = [];
    };
    function randColor() {
      const arr = ['#FFD700', '#FFA500', '#FF4500', '#8A2BE2', '#1E90FF', '#00CED1'];
      return arr[(Math.random() * arr.length) | 0];
    }

    function findQuanHuyen(lat, lng) {
      if (!wardFeatures.length) return '';
      const pt = turf.point([lng, lat]);
      for (const f of wardFeatures) {
        if (turf.booleanPointInPolygon(pt, f)) {
          return (f.properties?.quan_huyen || '').toString().trim();
        }
      }
      return '';
    }

    // Search + Google Places autocomplete
    const search = document.getElementById('search');
    let lastTemp = null;
    try {
      const ac = new google.maps.places.Autocomplete(search, {
        types: ['geocode'],
        componentRestrictions: { country: 'vn' }
      });
      ac.addListener('place_changed', () => {
        const pl = ac.getPlace();
        if (pl && pl.geometry) {
          const lat = pl.geometry.location.lat();
          const lng = pl.geometry.location.lng();
          map.setView([lat, lng], 17);
          if (lastTemp) map.removeLayer(lastTemp);
          lastTemp = L.marker([lat, lng]).addTo(map);
          const html = `<b>${pl.formatted_address}</b><br>
            <button id="svBtn" style="margin-top:6px">üëÅÔ∏è Xem Street View t·∫°i v·ªã tr√≠ n√†y</button>`;
          lastTemp.bindPopup(html).openPopup();
          lastTemp.on('popupopen', () => {
            const b = document.getElementById('svBtn');
            if (b) {
              b.onclick = () => {
                window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`, '_blank');
              };
            }
          });
        }
      });
    } catch (e) {
      console.warn('Google Places unavailable:', e);
    }

    // Measure (draw)
    const drawnItems = new L.FeatureGroup().addTo(map);
    let activeDraw = null;
    function stopMeasure() {
      if (activeDraw) {
        activeDraw.disable();
        activeDraw = null;
      }
    }
    document.getElementById('btnMeasure').onclick = () => {
      const m = document.getElementById('measureMenu');
      m.style.display = (m.style.display === 'block') ? 'none' : 'block';
    };
    document.getElementById('mDist').onclick = () => {
      stopMeasure();
      activeDraw = new L.Draw.Polyline(map, { shapeOptions: { color: getPrimaryColor() } });
      activeDraw.enable();
      document.getElementById('measureMenu').style.display = 'none';
    };
    document.getElementById('mArea').onclick = () => {
      stopMeasure();
      activeDraw = new L.Draw.Polygon(map, { shapeOptions: { color: getPrimaryColor(), fillOpacity: 0.2 } });
      activeDraw.enable();
      document.getElementById('measureMenu').style.display = 'none';
    };
    document.getElementById('mFinish').onclick = () => {
      stopMeasure();
      document.getElementById('measureMenu').style.display = 'none';
    };
    map.on(L.Draw.Event.CREATED, e => {
      const layer = e.layer;
      drawnItems.addLayer(layer);
      if (e.layerType === 'polyline') {
        const coords = layer.getLatLngs().map(ll => [ll.lng, ll.lat]);
        let len = 0;
        for (let i = 1; i < coords.length; i++) {
          len += turf.distance(coords[i - 1], coords[i], { units: 'kilometers' });
        }
        layer.bindPopup('Chi·ªÅu d√†i: ' + (len * 1000).toFixed(1) + ' m').openPopup();
      } else if (e.layerType === 'polygon') {
        const ring = [layer.getLatLngs()[0].map(ll => [ll.lng, ll.lat])];
        const poly = turf.polygon([ring[0]]);
        const area = turf.area(poly);
        layer.bindPopup('Di·ªán t√≠ch: ' + area.toFixed(0) + ' m¬≤').openPopup();
      }
    });
    function getPrimaryColor() {
      return getComputedStyle(document.documentElement).getPropertyValue('--pri') || '#00BFFF';
    }

    // Compass overlay
    const compassEl = document.getElementById('compassOverlay');
    const cv = document.getElementById('compassCanvas');
    const ctx = cv.getContext('2d');
    let compassOn = false;
    let deviceHeading = 0;
    function drawCompass() {
      const R = cv.width / 2;
      const C = R;
      ctx.clearRect(0, 0, cv.width, cv.height);
      ctx.strokeStyle = 'rgba(0,0,0,0.35)';
      ctx.lineWidth = 1.3;
      ctx.beginPath();
      ctx.arc(C, C, R - 6, 0, Math.PI * 2);
      ctx.stroke();
      for (let d = 0; d < 360; d += 10) {
        const len = (d % 30 === 0) ? 10 : 5;
        const a = (d - deviceHeading) * Math.PI / 180;
        const r1 = R - 14;
        const r2 = r1 - len;
        ctx.beginPath();
        ctx.moveTo(C + Math.cos(a) * r1, C + Math.sin(a) * r1);
        ctx.lineTo(C + Math.cos(a) * r2, C + Math.sin(a) * r2);
        ctx.stroke();
      }
      labelAt('B', 0);
      labelAt('ƒê', 90);
      labelAt('N', 180);
      labelAt('T', 270);
      function labelAt(t, deg) {
        const a = (deg - deviceHeading) * Math.PI / 180;
        const r = R - 34;
        ctx.fillStyle = '#111';
        ctx.font = '700 14px Segoe UI';
        ctx.textAlign = 'center';
        ctx.fillText(t, C + Math.cos(a) * r, C + Math.sin(a) * r + 5);
      }
      ctx.save();
      ctx.translate(C, C);
      ctx.rotate((-deviceHeading) * Math.PI / 180);
      ctx.fillStyle = '#d00';
      ctx.beginPath();
      ctx.moveTo(0, -(R - 34));
      ctx.lineTo(7, 0);
      ctx.lineTo(-7, 0);
      ctx.closePath();
      ctx.fill();
      ctx.restore();
    }
    document.getElementById('btnCompass').onclick = () => {
      compassOn = !compassOn;
      compassEl.style.display = compassOn ? 'block' : 'none';
      if (compassOn) drawCompass();
    };
    window.addEventListener('deviceorientation', e => {
      if (typeof e.alpha === 'number') {
        deviceHeading = 360 - e.alpha;
        if (compassOn) drawCompass();
      }
    });

    // GPS locate
    const locateCtrl = L.control.locate({ strings: { title: "V·ªã tr√≠ c·ªßa t√¥i" }, showCompass: true, setView: 'untilPanOrZoom' });
    document.getElementById('btnGPS').onclick = () => {
      if (!locateCtrl._map) locateCtrl.addTo(map);
      locateCtrl.start();
    };

    // Screenshot JPG
    const screenshoter = new L.simpleMapScreenshoter({
      hidden: true,
      mimeType: 'image/jpeg',
      quality: 0.92,
      domtoimageOptions: { bgcolor: '#ffffff' }
    }).addTo(map);
    document.getElementById('btnShot').onclick = () => {
      screenshoter.takeScreen('blob').then(b => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = `HCM_Map_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g, '')}.jpg`;
        a.click();
      });
    };

    // TSBƒê / TSSS logic
    function iconTSBD() {
      return L.divIcon({
        className: '',
        html: `<div class="pin tsbd">TSBƒê</div>`,
        iconSize: [34, 34],
        iconAnchor: [17, 17]
      });
    }
    function iconTSSS() {
      return L.divIcon({
        className: '',
        html: `<div class="pin tsss">TSSS</div>`,
        iconSize: [34, 34],
        iconAnchor: [17, 17]
      });
    }

    let tsbdMarker = null;
    const tsssMarkers = [];
    const tsbdTenEl_ = document.getElementById('tsbdTen');
    const tsbdGiaEl_ = document.getElementById('tsbdGia');
    const tsbdLatEl_ = document.getElementById('tsbdLat');
    const tsbdLngEl_ = document.getElementById('tsbdLng');
    const tsssTenEl = document.getElementById('tsssTen');
    const tsssGiaEl = document.getElementById('tsssGia');
    const tsssLatEl = document.getElementById('tsssLat');
    const tsssLngEl = document.getElementById('tsssLng');

    document.getElementById('tsbdPin').onclick = () => {
      const lat = parseFloat(tsbdLatEl_.value);
      const lng = parseFloat(tsbdLngEl_.value);
      if (!isFinite(lat) || !isFinite(lng)) {
        alert('Nh·∫≠p Lat/Lng h·ª£p l·ªá cho TSBƒê');
        return;
      }
      if (tsbdMarker) map.removeLayer(tsbdMarker);
      tsbdMarker = L.marker([lat, lng], { icon: iconTSBD() }).addTo(map);
      const qh = findQuanHuyen(lat, lng);
      const html = `<b>${tsbdTenEl_.value || 'TSBƒê'}</b><br>
        <small>${qh || '‚Äî'}</small>${tsbdGiaEl_.value ? `<br>Gi√°: ${tsbdGiaEl_.value} t·ª∑` : ''}<br>
        <button id="svTSBD">üëÅÔ∏è Street View</button>`;
      tsbdMarker.bindPopup(html).openPopup();
      tsbdMarker.on('popupopen', () => {
        const b = document.getElementById('svTSBD');
        if (b) {
          b.onclick = () => window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`, '_blank');
        }
      });
      map.setView([lat, lng], 17);
    };

    document.getElementById('tsbdStreet').onclick = () => {
      const lat = parseFloat(tsbdLatEl_.value);
      const lng = parseFloat(tsbdLngEl_.value);
      if (!isFinite(lat) || !isFinite(lng)) {
        alert('Nh·∫≠p Lat/Lng h·ª£p l·ªá cho TSBƒê');
        return;
      }
      window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`, '_blank');
    };

    document.getElementById('tsssAdd').onclick = () => {
      const lat = parseFloat(tsssLatEl.value);
      const lng = parseFloat(tsssLngEl.value);
      if (!isFinite(lat) || !isFinite(lng)) {
        alert('Nh·∫≠p Lat/Lng h·ª£p l·ªá cho TSSS');
        return;
      }
      const m = L.marker([lat, lng], { icon: iconTSSS() }).addTo(map);
      m.meta = {
        name: tsssTenEl.value || 'TSSS',
        price: isFinite(+tsssGiaEl.value) ? +tsssGiaEl.value : null
      };
      const qh = findQuanHuyen(lat, lng);
      const html = `<b>${m.meta.name}</b><br>
        <small>${qh || '‚Äî'}</small>${m.meta.price != null ? `<br>Gi√°: ${m.meta.price} t·ª∑` : ''}<br>
        <button class="svTSSS">üëÅÔ∏è Street View</button>`;
      m.bindPopup(html);
      m.on('popupopen', () => {
        const b = document.querySelector('.svTSSS');
        if (b) {
          b.onclick = () => window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`, '_blank');
        }
      });
      tsssMarkers.push(m);
      map.setView([lat, lng], 17);
      renderList();
    };

    document.getElementById('tsssClear').onclick = () => {
      tsssMarkers.forEach(m => map.removeLayer(m));
      tsssMarkers.length = 0;
      renderList();
    };

    function renderList() {
      const box = document.getElementById('tsssList');
      if (tsssMarkers.length === 0) {
        box.textContent = 'Ch∆∞a c√≥ TSSS.';
        return;
      }
      box.innerHTML = tsssMarkers.map(m => {
        const p = m.getLatLng();
        const nm = m.meta?.name || 'TSSS';
        const pr = m.meta?.price != null ? ` ‚Äî ${m.meta.price} t·ª∑` : '';
        return `‚Ä¢ ${nm} ‚Äî ${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}${pr}`;
      }).join('<br>');
    }

    function rowsForExport() {
      if (!tsbdMarker) {
        alert('ƒê·∫∑t ƒëi·ªÉm TSBƒê tr∆∞·ªõc khi xu·∫•t');
        return null;
      }
      const a = tsbdMarker.getLatLng();
      const qhA = findQuanHuyen(a.lat, a.lng);
      const rows = [{
        Loai: 'TSBD',
        Ten: tsbdTenEl_.value || 'TSBƒê',
        Lat: +a.lat.toFixed(6),
        Lng: +a.lng.toFixed(6),
        Quan_Huyen: qhA || '',
        Gia_ty: isFinite(+tsbdGiaEl_.value) ? +tsbdGiaEl_.value : '',
        Khoang_cach: '',
        Ghi_chu: ''
      }];
      tsssMarkers.forEach(m => {
        const b = m.getLatLng();
        const qhB = findQuanHuyen(b.lat, b.lng);
        const dkm = turf.distance([a.lng, a.lat], [b.lng, b.lat], { units: 'kilometers' });
        const dist = `${(dkm * 1000).toFixed(1)} m`;
        rows.push({
          Loai: 'TSSS',
          Ten: m.meta?.name || 'TSSS',
          Lat: +b.lat.toFixed(6),
          Lng: +b.lng.toFixed(6),
          Quan_Huyen: qhB || '',
          Gia_ty: (m.meta?.price != null) ? m.meta.price : '',
          Khoang_cach: dist,
          Ghi_chu: ''
        });
      });
      return rows;
    }

    document.getElementById('btnExportCSV').onclick = () => {
      const rows = rowsForExport();
      if (!rows) return;
      const headers = ['Loai', 'Ten', 'Lat', 'Lng', 'Quan_Huyen', 'Gia_ty', 'Khoang_cach', 'Ghi_chu'];
      const csv = [headers.join(','), ...rows.map(r =>
        headers.map(h => {
          const v = String(r[h] ?? '');
          return /[",\n]/.test(v) ? `"${v.replace(/"/g, '""')}"` : v;
        }).join(',')
      )].join('\n');
      const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `TS_Export_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g, '')}.csv`;
      a.click();
    };

    document.getElementById('btnExportXLSX').onclick = () => {
      const rows = rowsForExport();
      if (!rows) return;
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'DATA');
      XLSX.writeFile(wb, `TS_Export_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g, '')}.xlsx`);
    };

    document.getElementById('btnExportKML').onclick = () => {
      if (!tsbdMarker) {
        alert('ƒê·∫∑t ƒëi·ªÉm TSBƒê tr∆∞·ªõc khi xu·∫•t KML');
        return;
      }
      const a = tsbdMarker.getLatLng();
      const qhA = findQuanHuyen(a.lat, a.lng);
      function esc(s) {
        return String(s ?? '').replace(/[<&>]/g, c => ({ '<': '&lt;', '>': '&gt;', '&': '&amp;' }[c]));
      }
      function placemark(name, desc, lat, lng, style) {
        return `<Placemark><name>${esc(name)}</name><description>${esc(desc)}</description><styleUrl>#${style}</styleUrl><Point><coordinates>${lng},${lat},0</coordinates></Point></Placemark>`;
      }
      let kml = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document>
        <name>HCM_TSBD_TSSS_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'')}</name>
        <Style id="tsbd"><IconStyle><scale>1.2</scale><Icon><href>http://maps.google.com/mapfiles/kml/paddle/ylw-circle.png</href></Icon></IconStyle></Style>
        <Style id="tsss"><IconStyle><scale>1.2</scale><Icon><href>http://maps.google.com/mapfiles/kml/paddle/blu-circle.png</href></Icon></IconStyle></Style>`;
      kml += placemark(
        tsbdTenEl_.value || 'TSBƒê',
        `Qu·∫≠n/Huy·ªán: ${qhA || '‚Äî'}${tsbdGiaEl_.value ? ` | Gi√°: ${tsbdGiaEl_.value} t·ª∑` : ''}`,
        a.lat, a.lng, 'tsbd'
      );
      tsssMarkers.forEach(m => {
        const b = m.getLatLng();
        const qh = findQuanHuyen(b.lat, b.lng);
        kml += placemark(
          m.meta?.name || 'TSSS',
          `Qu·∫≠n/Huy·ªán: ${qh || '‚Äî'}${m.meta?.price != null ? ` | Gi√°: ${m.meta.price} t·ª∑` : ''}`,
          b.lat, b.lng, 'tsss'
        );
      });
      kml += '</Document></kml>';
      const blob = new Blob([kml], { type: 'application/vnd.google-earth.kml+xml' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `HCM_TSBD_TSSS_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g, '')}.kml`;
      a.click();
    };

    document.getElementById('btnOpenMyMaps').onclick = () => {
      window.open('https://www.google.com/mymaps', '_blank');
    };

  </script>
</body>
</html>

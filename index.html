<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>HCM WebGIS v8.6 ‚Äî L·ªçc Qu·∫≠n/Huy·ªán + Emphasis</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=geometry"></script>

<style>
:root{--pri:#00BFFF}
html,body{height:100%;margin:0;font-family:'Roboto',Arial,sans-serif}
#map{position:absolute;inset:0}
#searchbar{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:1200;width:560px;max-width:92vw}
#q{width:100%;padding:10px 12px;border:1px solid #ccc;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.15)}

/* Tools */
#tools{position:absolute;right:10px;top:70px;z-index:1200;display:flex;flex-direction:column;gap:10px}
.toolbtn{background:#fff;border:1px solid #ddd;border-radius:50%;width:48px;height:48px;cursor:pointer;
display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.toolbtn:hover{background:#f5f8ff}

/* Measure menu */
#measureMenu{position:absolute;right:70px;top:120px;background:#fff;border:1px solid #ddd;border-radius:12px;
box-shadow:0 8px 24px rgba(0,0,0,.18);display:none;z-index:1300}
#measureMenu button{display:block;width:220px;padding:10px 14px;border:none;background:#fff;text-align:left;cursor:pointer;font-size:14px}
#measureMenu button:hover{background:#f1f5f9}

/* Clear colors */
#btnClear{position:absolute;right:10px;top:220px;z-index:1200;background:#fff;border:1px solid #ddd;border-radius:12px;padding:8px 12px;
box-shadow:0 2px 6px rgba(0,0,0,.15);cursor:pointer}

/* Sidebar toggle */
#sidebarToggle{position:absolute;left:10px;top:120px;z-index:1200;background:#fff;border:1px solid #ddd;border-radius:12px;
padding:8px 12px;box-shadow:0 2px 6px rgba(0,0,0,.15);cursor:pointer}

/* Sidebar */
#sidebar{position:fixed;left:0;top:0;height:100%;width:360px;background:#fff;box-shadow:4px 0 20px rgba(0,0,0,.2);
transform:translateX(-380px);transition:transform .3s ease;z-index:1600;padding:16px;overflow:auto}
#sidebar.open{transform:translateX(0)}
#tabs{display:flex;gap:8px;margin-bottom:10px}
#tabs button{flex:1;border:1px solid #cfd4dc;background:#f6f8fa;border-radius:10px;padding:8px;cursor:pointer}
#tabs button.active{background:#00BFFF;color:#fff}
.form-row{display:flex;gap:8px;margin-bottom:8px}
.form-row input,.form-row select,.form-row textarea{flex:1;padding:9px;border:1px solid #cfd4dc;border-radius:10px}
#sidebarClose{position:absolute;right:10px;top:8px;border:none;background:none;font-size:22px;cursor:pointer}

/* Compass overlay */
#compassOverlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:300px;height:300px;border-radius:50%;
background:rgba(255,255,255,.9);border:2px solid #bbb;display:none;z-index:1300;box-shadow:0 8px 20px rgba(0,0,0,.25)}
#compassOverlay canvas{width:100%;height:100%}

/* District filter control */
.leaflet-top.leaflet-left .filter-control{
  margin-top:60px; /* d∆∞·ªõi g√≥c tr√°i, kh√¥ng che +/- */
}
.filter-control{
  background:#fff;border:1px solid #ddd;border-radius:10px;padding:8px 10px;
  box-shadow:0 2px 8px rgba(0,0,0,.15);min-width:210px;font-size:14px
}
.filter-control select,.filter-control button{
  width:100%;margin-top:6px;padding:8px;border:1px solid #cfd4dc;border-radius:8px;background:#fff;cursor:pointer
}
.filter-title{font-weight:700}

/* Footer coords */
.coords{position:absolute;left:10px;bottom:6px;background:rgba(255,255,255,.9);padding:4px 8px;border-radius:8px;font:12px monospace;z-index:1000}

/* Responsive */
@media(max-width:768px){
 #searchbar{width:90vw}
 #tools{flex-direction:row;bottom:10px;top:auto;right:50%;transform:translateX(50%)}
 #btnClear,#sidebarToggle{bottom:70px;top:auto}
 #compassOverlay{width:240px;height:240px}
}
</style>
</head>
<body>
<div id="searchbar"><input id="q" placeholder="üîç ƒê·ªãa ch·ªâ / ph∆∞·ªùng/x√£ ho·∫∑c t·ªça ƒë·ªô: 10.79844, 106.65855"></div>
<div id="map"></div>

<!-- Tools -->
<div id="tools">
  <button id="btnCompass" class="toolbtn" title="La b√†n">üß≠</button>
  <button id="btnMeasure" class="toolbtn" title="ƒêo">üìè</button>
  <button id="btnGPS" class="toolbtn" title="ƒê·ªãnh v·ªã">üìç</button>
</div>
<div id="measureMenu">
  <button id="mDist">üìçüìç ƒêo kho·∫£ng c√°ch</button>
  <button id="mArea">‚¨õ ƒêo di·ªán t√≠ch</button>
  <button id="mFinish">üõë Ho√†n t·∫•t ƒëo</button>
</div>
<button id="btnClear">üßπ X√≥a t√¥ m√†u</button>

<!-- Sidebar -->
<button id="sidebarToggle">üìã TSBƒê / TSSS</button>
<div id="sidebar">
  <button id="sidebarClose">√ó</button>
  <h3>Th√¥ng tin t√†i s·∫£n</h3>
  <div id="tabs">
    <button id="tab-tsbd" class="active">TSBƒê</button>
    <button id="tab-tsss">TSSS</button>
  </div>
  <div id="pane-tsbd">
    <div class="form-row"><select id="tsbdLoai"><option>Nh√† ·ªü</option><option>ƒê·∫•t tr·ªëng</option><option>CƒÉn h·ªô</option></select></div>
    <div class="form-row"><input id="tsbdDientich" placeholder="Di·ªán t√≠ch (m¬≤)" type="number"><input id="tsbdGia" placeholder="Gi√° tr·ªã (t·ª∑)" type="number"></div>
    <div class="form-row"><input id="tsbdLat" placeholder="Lat"><input id="tsbdLng" placeholder="Lng"></div>
    <div class="form-row"><textarea id="tsbdGhiChu" rows="3" placeholder="Ghi ch√∫"></textarea></div>
    <div class="form-row"><button id="tsbdPin">üìç ƒê·∫∑t ƒëi·ªÉm</button><button id="tsbdStreet">üëÅÔ∏è Street View</button></div>
  </div>
  <div id="pane-tsss" style="display:none">
    <div class="form-row"><input id="tsssTen" placeholder="T√™n so s√°nh"><input id="tsssGia" placeholder="Gi√° (t·ª∑)" type="number"></div>
    <div class="form-row"><input id="tsssLat" placeholder="Lat"><input id="tsssLng" placeholder="Lng"></div>
    <div class="form-row"><button id="tsssAdd">‚ûï Th√™m</button></div>
    <div id="tsssList" class="muted">Ch∆∞a c√≥ m·ª•c so s√°nh n√†o.</div>
  </div>
</div>

<!-- Compass -->
<div id="compassOverlay"><canvas id="compassCanvas" width="300" height="300"></canvas></div>

<div class="coords" id="coords">Lat: --, Lng: --</div>

<script>
// ===== Map base =====
const map=L.map('map',{center:[10.776,106.7],zoom:12});
const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
const gStreet=L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}');
const gHybrid=L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}');
L.control.layers({"üó∫Ô∏è OSM":osm,"üåç Google Street":gStreet,"üõ∞Ô∏è Google Hybrid":gHybrid}).addTo(map);

let coloredLayers=[];

// ===== Search (Enter to Lat,Lng) =====
const q=document.getElementById('q');
q.addEventListener('keydown',e=>{
  if(e.key!=='Enter')return;
  const m=q.value.match(/^(-?\d+(?:\.\d+)?),\s*(-?\d+(?:\.\d+)?)/);
  if(m){placeMarker(parseFloat(m[1]),parseFloat(m[2]),'T·ªça ƒë·ªô nh·∫≠p tay');}
});
function placeMarker(lat,lng,label){
  map.setView([lat,lng],17);
  L.marker([lat,lng]).addTo(map)
    .bindPopup(`<b>${label}</b><br><button id='svbtn'>üëÅÔ∏è Xem Street View t·∫°i v·ªã tr√≠ n√†y</button>`).openPopup();
  setTimeout(()=>{const b=document.getElementById('svbtn');if(b)b.onclick=()=>openStreetView(lat,lng);},200);
}
function openStreetView(lat,lng){
  const html=`<iframe width='350' height='250' style='border:0' loading='lazy'
  referrerpolicy='no-referrer-when-downgrade'
  src='https://www.google.com/maps/embed?pb=!4v1665600758447!6m8!1m7!1sCAoSLEFGMVFpcE1Xd2VoQllvT2F2TkFwSGlDaTZYVFF6b1pHOUdwa3JtX3lPaUo3!2m2!1d${lat}!2d${lng}!3f0!4f0!5f0.7820865974627469'></iframe>`;
  L.popup().setLatLng([lat,lng]).setContent(html).openOn(map);
}

// ===== GeoJSON + District filter =====
let gjLayer=null, allFeatures=[], districtIndex=new Map(), selectedDistrict=null;

fetch('assets/TPHCM.geojson').then(r=>r.json()).then(geo=>{
  gjLayer=L.geoJSON(geo,{
    style:baseStyle,
    onEachFeature:(f,l)=>{
      const p=f.properties||{};
      const ten=p.ten_xa||'Kh√¥ng r√µ', qh=p.quan_huyen||'', sn=(p.sap_nhap&&String(p.sap_nhap).trim()!=='0')?p.sap_nhap:'‚Äî';
      const dt=(p.dtich_km2!=null)?`${p.dtich_km2} km¬≤`:'‚Äî';
      const ds=(p.dan_so!=null)?`${Number(p.dan_so).toLocaleString('vi-VN')} ng∆∞·ªùi`:'‚Äî';
      l.bindPopup(`<b>${ten}</b><br>${qh}<br>Tr∆∞·ªõc s√°p nh·∫≠p: ${sn}<br>Di·ªán t√≠ch: ${dt}<br>D√¢n s·ªë: ${ds}`);
      l.on('click',()=>{const c=['#FFD700','#FFA500','#FF4500','#8A2BE2','#1E90FF','#00CED1'][Math.floor(Math.random()*6)];
        l.setStyle({fillColor:c,fillOpacity:.5}); if(!coloredLayers.includes(l))coloredLayers.push(l);
      });
      allFeatures.push({layer:l,props:p});
      const key=p.quan_huyen||'Kh√°c';
      if(!districtIndex.has(key)) districtIndex.set(key,[]);
      districtIndex.get(key).push(l);
    }
  }).addTo(map);

  buildDistrictControl(); // after index ready
}).catch(()=>alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c assets/TPHCM.geojson, ki·ªÉm tra ƒë∆∞·ªùng d·∫´n.'));

function baseStyle(){ return {color:'#555',weight:1,fillOpacity:.15}; }
function deemphStyle(){ return {color:'#888',weight:1,fillOpacity:.08,fillColor:null}; }
function emphStyle(){ return {color:'#1a4d7a',weight:2.5,fillOpacity:.45,fillColor:varPri()}; }
function varPri(){ return getComputedStyle(document.documentElement).getPropertyValue('--pri') || '#00BFFF'; }

// Build district filter control (top-left)
function buildDistrictControl(){
  const Control=L.Control.extend({
    onAdd:function(){
      const div=L.DomUtil.create('div','filter-control');
      div.innerHTML=`
        <div class="filter-title">L·ªçc Qu·∫≠n/Huy·ªán</div>
        <select id="districtSel"><option value="">‚Äî Hi·ªán t·∫•t c·∫£ ‚Äî</option>
          ${[...districtIndex.keys()].sort().map(q=>`<option>${q}</option>`).join('')}
        </select>
        <button id="btnShowAll">Hi·ªán t·∫•t c·∫£</button>
      `;
      L.DomEvent.disableClickPropagation(div);
      return div;
    }
  });
  const ctl=new Control({position:'topleft'}); ctl.addTo(map);

  const sel=document.getElementById('districtSel');
  const btn=document.getElementById('btnShowAll');

  sel.addEventListener('change',()=>{
    selectedDistrict = sel.value || null;
    applyFilter();
    if(selectedDistrict){
      const group = L.featureGroup(districtIndex.get(selectedDistrict));
      map.fitBounds(group.getBounds().pad(0.15));
    }
  });
  btn.addEventListener('click',()=>{
    sel.value='';
    selectedDistrict=null;
    applyFilter();
  });
}

function applyFilter(){
  if(!selectedDistrict){
    allFeatures.forEach(({layer})=>layer.setStyle(baseStyle()));
    return;
  }
  allFeatures.forEach(({layer,props})=>{
    if(props.quan_huyen===selectedDistrict){ layer.setStyle(emphStyle()); layer.bringToFront(); }
    else{ layer.setStyle(deemphStyle()); }
  });
}

// ===== Sidebar =====
const sidebar=document.getElementById('sidebar');
document.getElementById('sidebarToggle').onclick=()=>sidebar.classList.add('open');
document.getElementById('sidebarClose').onclick=()=>sidebar.classList.remove('open');
document.getElementById('tab-tsbd').onclick=()=>{swapTab(true);};
document.getElementById('tab-tsss').onclick=()=>{swapTab(false);};
function swapTab(isTSBD){
  document.getElementById('tab-tsbd').classList.toggle('active',isTSBD);
  document.getElementById('tab-tsss').classList.toggle('active',!isTSBD);
  document.getElementById('pane-tsbd').style.display=isTSBD?'block':'none';
  document.getElementById('pane-tsss').style.display=!isTSBD?'block':'none';
}

// ===== Measure =====
const drawnItems=new L.FeatureGroup().addTo(map);
let activeDraw=null;
function stopMeasure(){if(activeDraw){activeDraw.disable();activeDraw=null;}}
document.getElementById('btnMeasure').onclick=()=>{const m=document.getElementById('measureMenu');m.style.display=m.style.display==='block'?'none':'block';};
document.getElementById('mDist').onclick=()=>{stopMeasure();activeDraw=new L.Draw.Polyline(map,{shapeOptions:{color:varPri()}});activeDraw.enable();document.getElementById('measureMenu').style.display='none';};
document.getElementById('mArea').onclick=()=>{stopMeasure();activeDraw=new L.Draw.Polygon(map,{shapeOptions:{color:varPri(),fillOpacity:.2}});activeDraw.enable();document.getElementById('measureMenu').style.display='none';};
document.getElementById('mFinish').onclick=()=>{stopMeasure();document.getElementById('measureMenu').style.display='none';};
map.on(L.Draw.Event.CREATED,e=>{
  const layer=e.layer;drawnItems.addLayer(layer);
  if(e.layerType==='polyline'){
    const coords=layer.getLatLngs().map(ll=>[ll.lng,ll.lat]);let len=0;for(let i=1;i<coords.length;i++){len+=turf.distance(coords[i-1],coords[i],{units:'kilometers'});}
    layer.bindPopup('Chi·ªÅu d√†i: '+(len*1000).toFixed(1)+' m').openPopup();
  }else if(e.layerType==='polygon'){
    const coords=[layer.getLatLngs()[0].map(ll=>[ll.lng,ll.lat])];const poly=turf.polygon([coords[0]]);const area=turf.area(poly);
    layer.bindPopup('Di·ªán t√≠ch: '+area.toFixed(0)+' m¬≤').openPopup();
  }
});

// ===== Compass & GPS =====
const compass=document.getElementById('compassOverlay');
const ctx=document.getElementById('compassCanvas').getContext('2d');
function drawCompass(deg){ctx.clearRect(0,0,300,300);ctx.save();ctx.translate(150,150);ctx.rotate(deg*Math.PI/180);
ctx.beginPath();ctx.moveTo(0,-120);ctx.lineTo(8,0);ctx.lineTo(-8,0);ctx.closePath();ctx.fillStyle='#d00';ctx.fill();ctx.restore();}
document.getElementById('btnCompass').onclick=()=>{const show=compass.style.display!=='block';compass.style.display=show?'block':'none';if(show)drawCompass(0);};
window.addEventListener('deviceorientation',e=>{if(typeof e.alpha==='number'&&compass.style.display==='block'){drawCompass(360-e.alpha);}});

const locateCtrl=L.control.locate({strings:{title:"V·ªã tr√≠ c·ªßa t√¥i"},showCompass:true,setView:'untilPanOrZoom'});
document.getElementById('btnGPS').onclick=()=>{if(!locateCtrl._map)locateCtrl.addTo(map);locateCtrl.start();};

// ===== Clear colors =====
document.getElementById('btnClear').onclick=()=>{coloredLayers.forEach(l=>l.setStyle({fillColor:null,fillOpacity:.15}));coloredLayers=[];};

// ===== Coords footer =====
map.on('mousemove',e=>document.getElementById('coords').textContent=`Lat:${e.latlng.lat.toFixed(5)}, Lng:${e.latlng.lng.toFixed(5)}`);
</script>
</body>
</html>

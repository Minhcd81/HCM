<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HCM WebGIS ‚Äî Quy ho·∫°ch & B·∫£n ƒë·ªì h√†nh ch√≠nh</title>

<!-- Leaflet core -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Draw -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<!-- Measure control -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-measure@3.3.0/dist/leaflet-measure.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet-measure@3.3.0/dist/leaflet-measure.min.js"></script>

<!-- Compass -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-compass@1.5.0/dist/leaflet-compass.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet-compass@1.5.0/dist/leaflet-compass.min.js"></script>

<!-- Esri Leaflet -->
<script src="https://unpkg.com/esri-leaflet@3/dist/esri-leaflet.js"></script>

<!-- Google Mutant (Google Maps as Leaflet layer) -->
<script src="https://cdn.jsdelivr.net/npm/leaflet.gridlayer.googlemutant@0.14.0/Leaflet.GoogleMutant.min.js"></script>

<!-- Bing layer (placeholder key) -->
<script src="https://cdn.jsdelivr.net/npm/leaflet-bing-layer@1.8.0/leaflet-bing-layer.min.js"></script>

<!-- Fuse for fuzzy search ward names -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<!-- FileSaver for export -->
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<!-- Google Places (gi·ªØ nguy√™n key nh∆∞ anh y√™u c·∫ßu) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsyARhMzsyARhMzsyARhMzsy&libraries=places"></script>

<style>
  html,body,#map{height:100%;margin:0}
  .topbar{
    position:absolute;left:70px;top:14px;z-index:900;
    display:flex;gap:10px;align-items:center;
  }
  .search{
    width:420px;background:#fff;border-radius:10px;border:1px solid #ddd;
    box-shadow:0 2px 10px rgba(0,0,0,.08);padding:8px 12px;font-size:14px;
  }
  .btn{padding:8px 14px;border-radius:8px;border:0;font-weight:600;cursor:pointer}
  .btn-secondary{background:#f0f3ff;color:#1e40af;border:1px solid #c7d2fe}
  .btn-danger{background:#ffe8e8;color:#b91c1c;border:1px solid #fecaca}

  .layers{
    position:absolute;right:14px;top:14px;z-index:900;background:#fff;border:1px solid #eee;
    border-radius:12px;padding:10px 12px;min-width:210px;box-shadow:0 4px 18px rgba(0,0,0,.12)
  }
  .legend{
    position:absolute;right:14px;bottom:14px;z-index:900;background:#fff;border:1px solid #eee;
    border-radius:10px;padding:10px 12px;box-shadow:0 4px 18px rgba(0,0,0,.1);font-size:13px
  }
  .legend .row{display:flex;gap:8px;align-items:center;margin:4px 0}
  .sw{width:14px;height:14px;border-radius:3px;border:1px solid #555}

  /* panel TSBƒê/TSSS b√™n tr√°i */
  .panel {
    position:absolute;left:12px;top:70px;z-index:950;width:320px;max-width:90vw;
    background:#0b7f72;padding:12px;border-radius:12px;color:#ecfeff;box-shadow:0 6px 22px rgba(0,0,0,.18)
  }
  .panel h3{margin:6px 0 10px 0;font-size:16px}
  .panel label{font-size:12px;opacity:.9}
  .panel input,.panel select{
    width:100%;margin:6px 0 10px 0;padding:8px;border-radius:8px;border:0
  }
  .panel .row{display:flex;gap:10px}
  .toggle{
    position:absolute;left:12px;top:14px;z-index:950;background:#0b7f72;color:#fff;border:0;border-radius:20px;
    padding:8px 12px;cursor:pointer;box-shadow:0 3px 12px rgba(0,0,0,.18)
  }

  /* GPS button d∆∞·ªõi n√∫t zoom */
  .leaflet-control-gps {
    background:#fff;border-radius:4px;box-shadow:0 1px 5px rgba(0,0,0,.4);
    width:26px;height:26px;line-height:26px;text-align:center;cursor:pointer;font-weight:700
  }
  .latlng {
    position:absolute;left:8px;bottom:8px;z-index:900;background:#fff;border:1px solid #eee;border-radius:6px;
    padding:4px 8px;font-size:12px;box-shadow:0 2px 10px rgba(0,0,0,.06)
  }
</style>
</head>
<body>
<div id="map"></div>

<!-- Top bar: search + action -->
<div class="topbar">
  <input id="searchBox" class="search" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c t√™n ph∆∞·ªùng...">
  <button id="btnClear" class="btn btn-danger">üßπ X√≥a t√¥ m√†u</button>
  <button id="btnExport" class="btn btn-secondary">üíæ Xu·∫•t GeoJSON</button>
</div>

<!-- Layers -->
<div class="layers">
  <div><b>Basemap</b></div>
  <label><input type="radio" name="bm" value="osm" checked> OpenStreetMap</label><br>
  <label><input type="radio" name="bm" value="esri"> Esri Street</label><br>
  <label><input type="radio" name="bm" value="esriimg"> Esri Imagery</label><br>
  <label><input type="radio" name="bm" value="gstreet"> Google Street</label><br>
  <label><input type="radio" name="bm" value="ghybrid"> Google Hybrid</label><br>
  <label><input type="radio" name="bm" value="bing"> Bing Road</label><br>
  <hr>
  <label><input type="checkbox" id="chkAdmin" checked> ƒê·ªãa gi·ªõi h√†nh ch√≠nh</label><br>
  <label><input type="checkbox" id="chkPlan"> Quy ho·∫°ch 1/2000</label>
</div>

<!-- Legend MaQuyUoc -->
<div class="legend" id="legend">
  <b>Ch√∫ gi·∫£i lo·∫°i ƒë·∫•t</b>
  <div class="row"><span class="sw" style="background:#f59e0b"></span> ƒê·∫•t ·ªü (ODT/ONT)</div>
  <div class="row"><span class="sw" style="background:#22c55e"></span> C√¢y xanh (CX)</div>
  <div class="row"><span class="sw" style="background:#9ca3af"></span> Giao th√¥ng (DGT)</div>
  <div class="row"><span class="sw" style="background:#facc15"></span> C√¥ng c·ªông (CC)</div>
  <div class="row"><span class="sw" style="background:#60a5fa"></span> M·∫∑t n∆∞·ªõc (MN)</div>
  <div class="row"><span class="sw" style="background:#a78bfa"></span> H·∫° t·∫ßng k·ªπ thu·∫≠t (HTKT)</div>
  <div class="row"><span class="sw" style="background:#06b6d4"></span> T√¥n gi√°o (TG)</div>
</div>

<!-- Toggle + Panel TSBƒê/TSSS -->
<button class="toggle" id="togglePanel">‚ò∞ TSBƒê / TSSS</button>
<div class="panel" id="panel" style="display:none">
  <h3>Google Maps ‚Äî H∆∞·ªõng d·∫´n setup</h3>
  <label>TSBƒê:</label>
  <input id="tsbd" placeholder="Nh·∫•p b·∫£n ƒë·ªì ho·∫∑c nh·∫≠p Lat, Lng">
  <label>TSSS1:</label>
  <input id="tsss1" placeholder="Nh·∫•p b·∫£n ƒë·ªì ho·∫∑c nh·∫≠p Lat, Lng">
  <label>TSSS2:</label>
  <input id="tsss2" placeholder="Nh·∫•p b·∫£n ƒë·ªì ho·∫∑c nh·∫≠p Lat, Lng">
  <label>TSSS3:</label>
  <input id="tsss3" placeholder="Nh·∫•p b·∫£n ƒë·ªì ho·∫∑c nh·∫≠p Lat, Lng">
  <div class="row">
    <div style="flex:1">
      <label>Ki·ªÉu b·∫£n ƒë·ªì Google Maps:</label>
      <select id="gmKind">
        <option value="roadmap">ƒê∆∞·ªùng ph·ªë</option>
        <option value="hybrid">Hybrid</option>
        <option value="satellite">V·ªá tinh</option>
      </select>
    </div>
  </div>
  <div class="row">
    <button class="btn btn-secondary" id="btnToggleWard">B·∫≠t/T·∫Øt ph∆∞·ªùng</button>
    <button class="btn btn-secondary" id="btnCenterHCM">CƒÉn gi·ªØa HCM</button>
  </div>
  <small>Nh·∫•p b·∫•t k·ª≥ v·ªã tr√≠ tr√™n b·∫£n ƒë·ªì ƒë·ªÉ ƒë·ªï Lat,Lng v√†o √¥ ƒëang focus.</small>
</div>

<!-- GPS button & latlng -->
<div id="latlng" class="latlng">Lat: ‚Äî, Lng: ‚Äî</div>

<script>
(async function(){
  // ----- Map init
  const map = L.map('map',{zoomControl:true}).setView([10.78,106.68], 12);

  // Basemaps
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; OpenStreetMap'
  }).addTo(map);

  const esri = L.esri.basemapLayer('Streets');
  const esriImg = L.esri.basemapLayer('Imagery');

  // Google Mutant
  const gStreet = L.gridLayer.googleMutant({type:'roadmap'});
  const gHybrid = L.gridLayer.googleMutant({type:'hybrid'});

  // Bing
  const bing = L.tileLayer.bing('YOUR_BING_API_KEY');

  const basemaps = { osm, esri, esriImg, gStreet, gHybrid, bing };
  function setBase(name){
    Object.values(basemaps).forEach(l=>map.removeLayer(l));
    basemaps[name].addTo(map);
  }
  document.querySelectorAll('[name=bm]').forEach(r=>{
    r.addEventListener('change', e=> setBase(e.target.value));
  });

  // Lat/Lng live
  map.on('mousemove', e=>{
    document.getElementById('latlng').textContent =
      `Lat:${e.latlng.lat.toFixed(6)}, Lng:${e.latlng.lng.toFixed(6)}`;
  });

  // GPS control (under zoom)
  const gps = L.control({position:'topleft'});
  gps.onAdd = function(){
    const el = L.DomUtil.create('div','leaflet-control-gps'); el.title='ƒê·ªãnh v·ªã';
    el.innerHTML='üìç'; el.style.marginTop='46px';
    L.DomEvent.on(el,'click',()=>{
      map.locate({setView:true,maxZoom:17});
    });
    return el;
  };
  gps.addTo(map);

  // Compass
  const compass = new L.Control.Compass({autoActive:true,showDigit:true,position:'topright'});
  compass.addTo(map);

  // Measure
  new L.Control.Measure({
    primaryLengthUnit:'meters',
    secondaryLengthUnit:'kilometers',
    primaryAreaUnit:'sqmeters',
    position:'topright'
  }).addTo(map);

  // Draw
  const drawn = new L.FeatureGroup().addTo(map);
  const drawCtrl = new L.Control.Draw({
    position:'topright',
    edit:{featureGroup: drawn},
    draw:{polyline:true,polygon:true,rectangle:true,circle:false,marker:true,circlemarker:false}
  });
  map.addControl(drawCtrl);
  map.on(L.Draw.Event.CREATED, e=> drawn.addLayer(e.layer));

  // Export GeoJSON
  document.getElementById('btnExport').onclick = ()=>{
    const fc = drawn.toGeoJSON();
    const blob = new Blob([JSON.stringify(fc)],{type:'application/json;charset=utf-8'});
    saveAs(blob,'drawn_features.geojson');
  };

  // TSBƒê/TSSS panel toggle
  const panel = document.getElementById('panel');
  document.getElementById('togglePanel').onclick = ()=>{
    panel.style.display = panel.style.display==='none'?'block':'none';
  };
  // Click map to fill focused input
  map.on('click', e=>{
    const el = document.activeElement;
    if(el && (el.id==='tsbd'||el.id==='tsss1'||el.id==='tsss2'||el.id==='tsss3')){
      el.value = `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
    }
  });
  document.getElementById('btnCenterHCM').onclick = ()=> map.setView([10.775,106.7],12);

  // ----- Overlays
  const adminLayer = L.geoJSON(null,{
    style: f=>({color:'#ef4444',weight:2,fillOpacity:0}),
    onEachFeature:(f,layer)=>{
      layer.on('click',()=>{
        // 6 m√†u: v√†ng/cam/ƒë·ªè/t√≠m/xanh d∆∞∆°ng/xanh bi·ªÉn
        const colors = ['#fde047','#fb923c','#f43f5e','#a78bfa','#60a5fa','#06b6d4'];
        layer.setStyle({fillColor: colors[Math.floor(Math.random()*colors.length)], fillOpacity:0.5});
        const p=f.properties||{};
        const name = p.ten_xa||'‚Äî';
        const sn = p.sap_nhap||'';
        const dt = p.dtich_km2 ? Number(p.dtich_km2).toLocaleString('vi-VN',{maximumFractionDigits:2}) : '‚Äî';
        const ds = p.dan_so ? Number(p.dan_so).toLocaleString('vi-VN') : '‚Äî';
        layer.bindPopup(
          `<b>${name}</b><br>${sn}<br>${dt} km¬≤ ‚Äì ${ds} ng∆∞·ªùi`
        ).openPopup();
      });
    }
  });

  const planColorByCode = (m)=>{
    if(!m) return '#9ca3af';
    const s=m.toString().toUpperCase();
    if(s.includes('ODT')||s.includes('ONT')) return '#f59e0b';
    if(s.includes('CX')) return '#22c55e';
    if(s.includes('DGT')) return '#9ca3af';
    if(s.includes('CC')) return '#facc15';
    if(s.includes('MN')) return '#60a5fa';
    if(s.includes('HTKT')) return '#a78bfa';
    if(s.includes('TG')) return '#06b6d4';
    return '#9ca3af';
  };

  const planLayer = L.geoJSON(null,{
    style:f=>({color:'#7c3aed',weight:1,fillColor: planColorByCode(f.properties?.MaQuyUoc), fillOpacity:.35})
  });

  // Load data
  async function safeLoad(url, target, name){
    try{
      const res = await fetch(url,{cache:'no-store'});
      if(!res.ok) throw new Error(res.status+' '+res.statusText);
      const gj = await res.json();
      target.addData(gj);
      // build search index for wards
      if(target===adminLayer){
        window._wardIdx = new Fuse((gj.features||[]).map(f=>({
          name: f.properties?.ten_xa || '',
          center: L.geoJSON(f).getBounds().getCenter()
        })), {keys:['name'],threshold:.35});
      }
    }catch(err){
      alert(`Kh√¥ng t·∫£i ƒë∆∞·ª£c ${name}. Vui l√≤ng ki·ªÉm tra ƒë∆∞·ªùng d·∫´n trong /assets/.`);
      console.error(err);
    }
  }
  await safeLoad('assets/TPHCM.geojson', adminLayer, 'ƒê·ªãa gi·ªõi h√†nh ch√≠nh');
  await safeLoad('assets/QHPKSDD_SHAPE.json', planLayer, 'Quy ho·∫°ch 1/2000');

  // Add admin by default
  adminLayer.addTo(map);

  // Overlay toggles
  document.getElementById('chkAdmin').onchange = e=>{
    if(e.target.checked) adminLayer.addTo(map); else map.removeLayer(adminLayer);
  };
  document.getElementById('chkPlan').onchange = e=>{
    if(e.target.checked) planLayer.addTo(map); else map.removeLayer(planLayer);
  };

  // Clear fills
  document.getElementById('btnClear').onclick = ()=>{
    adminLayer.setStyle({fillOpacity:0});
    adminLayer.eachLayer(l=> l.closePopup());
  };

  // ----- Search: Google Places + fuzzy ward
  const input = document.getElementById('searchBox');
  const ac = new google.maps.places.Autocomplete(input,{componentRestrictions:{country:'vn'}});
  ac.addListener('place_changed', ()=>{
    const plc = ac.getPlace();
    if(plc && plc.geometry && plc.geometry.location){
      const lat = plc.geometry.location.lat(), lng = plc.geometry.location.lng();
      map.setView([lat,lng], 17);
      L.marker([lat,lng]).addTo(map).bindPopup(plc.formatted_address||'').openPopup();
    }
  });
  // Enter => fuzzy search ward names
  input.addEventListener('keydown', e=>{
    if(e.key==='Enter' && window._wardIdx){
      const q = input.value.trim(); if(!q) return;
      const r = window._wardIdx.search(q);
      if(r && r.length){
        const c = r[0].item.center;
        map.setView([c.lat,c.lng], 14);
      }
    }
  });

})();
</script>
</body>
</html>
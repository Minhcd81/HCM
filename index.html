<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>HCM WebGIS v8.3 — Responsive + Compass + Popup “Trước sáp nhập”</title>

<!-- Fonts & CSS libs -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>

<!-- JS libs -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places,geometry"></script>

<style>
:root{--pri:#1f6feb;--text:#202124}
*{box-sizing:border-box}
html,body{height:100%;margin:0;padding:0;font-family:'Roboto',system-ui,-apple-system,Segoe UI,Arial}
#map{position:absolute;inset:0}

/* Search bar (responsive) */
#searchbar{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:1400;width:560px;max-width:92vw}
#q{width:100%;padding:10px 12px;border:1px solid #cfd4dc;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.12)}

/* Tools (right) */
#tools{position:absolute;right:10px;top:70px;z-index:1200;display:flex;flex-direction:column;gap:10px}
.toolbtn{background:#fff;border:1px solid #ddd;border-radius:50%;width:48px;height:48px;cursor:pointer;
         display:flex;align-items:center;justify-content:center;font-size:22px;
         box-shadow:0 2px 8px rgba(0,0,0,.15);transition:.18s}
.toolbtn:hover{transform:scale(1.08);background:#f5f8ff}

/* Measure menu */
#measureMenu{position:absolute;right:70px;top:120px;background:#fff;border:1px solid #ddd;border-radius:12px;
             box-shadow:0 8px 24px rgba(0,0,0,.18);display:none;z-index:1300;overflow:hidden}
#measureMenu button{display:block;padding:10px 14px;border:none;background:#fff;width:240px;text-align:left;cursor:pointer;font-size:14px}
#measureMenu button:hover{background:#f1f5f9}

/* Compass overlay (center) */
#compassOverlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:350px;height:350px;border-radius:50%;
                background:rgba(255,255,255,.92);border:2px solid #bbb;display:none;z-index:1300;box-shadow:0 8px 20px rgba(0,0,0,.25)}
#compassOverlay .label{position:absolute;font-weight:700;color:#333;font-size:18px}
#compassOverlay .n{top:8px;left:50%;transform:translateX(-50%);color:#d00}
#compassOverlay .s{bottom:8px;left:50%;transform:translateX(-50%)}
#compassOverlay .e{right:8px;top:50%;transform:translateY(-50%)}
#compassOverlay .w{left:8px;top:50%;transform:translateY(-50%)}
#compassCanvas{position:absolute;left:0;top:0}

/* Clear colors button */
#btnClear{position:absolute;right:10px;top:220px;z-index:1200;background:#fff;border:1px solid #ddd;border-radius:12px;
          padding:8px 12px;box-shadow:0 2px 6px rgba(0,0,0,.15);cursor:pointer}

/* Sidebar toggle (left, dưới +/-) */
#sidebarToggle{position:absolute;left:10px;top:120px;z-index:1200;background:#fff;border:1px solid #ddd;border-radius:12px;
               padding:8px 12px;box-shadow:0 2px 6px rgba(0,0,0,.15);cursor:pointer}

/* Sidebar TSBĐ/TSSS */
#sidebar{position:fixed;left:0;top:0;height:100%;width:360px;background:#fff;box-shadow:4px 0 20px rgba(0,0,0,.2);
         transform:translateX(-380px);transition:transform .28s ease;z-index:1600;padding:16px 16px 80px 16px;overflow:auto}
#sidebar.open{transform:translateX(0)}
#sidebar h3{margin:6px 0 12px}
#tabs{display:flex;gap:8px;margin-bottom:10px}
#tabs button{flex:1;border:1px solid #cfd4dc;background:#f6f8fa;border-radius:10px;padding:8px;cursor:pointer}
#tabs button.active{background:#1f6feb;color:#fff;border-color:#1f6feb}
.form-row{display:flex;gap:8px;margin-bottom:8px}
.form-row input,.form-row select,.form-row textarea{flex:1;padding:9px;border:1px solid #cfd4dc;border-radius:10px}
.muted{color:#5f6368;font-size:12px}
#sidebarClose{position:absolute;right:10px;top:8px;border:none;background:transparent;font-size:22px;cursor:pointer}

/* Footer coords */
.coords{position:absolute;left:10px;bottom:6px;background:rgba(255,255,255,.9);padding:4px 8px;border-radius:8px;font:12px monospace;z-index:1000}

/* ======= Responsive ======= */
@media (max-width: 768px){
  #searchbar{width:90vw;left:50%;transform:translateX(-50%);top:8px}
  #tools{right:50%;transform:translateX(50%);bottom:8px;top:auto;flex-direction:row;gap:8px}
  .toolbtn{width:44px;height:44px;font-size:20px}
  #measureMenu{right:8px;top:auto;bottom:60px}
  #btnClear{top:auto;bottom:60px}
  #sidebarToggle{top:auto;bottom:60px}
  #compassOverlay{width:300px;height:300px}
}
</style>
</head>
<body>
<!-- Search bar -->
<div id="searchbar"><input id="q" placeholder="🔍 Địa chỉ / phường/xã hoặc tọa độ: 10.79844, 106.65855"></div>

<!-- Map -->
<div id="map"></div>

<!-- Tools -->
<div id="tools">
  <button id="btnCompass" class="toolbtn" title="La bàn">🧭</button>
  <button id="btnMeasure" class="toolbtn" title="Đo">📏</button>
  <button id="btnGPS" class="toolbtn" title="Định vị">📍</button>
</div>

<!-- Measure menu -->
<div id="measureMenu">
  <button id="mDist">📍📍 Đo khoảng cách</button>
  <button id="mArea">⬛ Đo diện tích</button>
  <button id="mFinish">🛑 Hoàn tất đo</button>
</div>

<!-- Clear colors -->
<button id="btnClear">🧹 Xóa tô màu</button>

<!-- Sidebar toggle -->
<button id="sidebarToggle">📋 TSBĐ / TSSS</button>

<!-- Sidebar -->
<div id="sidebar">
  <button id="sidebarClose">×</button>
  <h3>Thông tin tài sản</h3>
  <div id="tabs">
    <button id="tab-tsbd" class="active">TSBĐ</button>
    <button id="tab-tsss">TSSS</button>
  </div>
  <div id="pane-tsbd">
    <div class="form-row"><select id="tsbdLoai"><option>Nhà ở</option><option>Đất trống</option><option>Căn hộ</option></select></div>
    <div class="form-row"><input id="tsbdDientich" type="number" placeholder="Diện tích (m²)"><input id="tsbdGia" type="number" placeholder="Giá trị (tỷ)"></div>
    <div class="form-row"><input id="tsbdLat" placeholder="Lat"><input id="tsbdLng" placeholder="Lng"></div>
    <div class="form-row"><textarea id="tsbdGhiChu" rows="3" placeholder="Ghi chú"></textarea></div>
    <div class="form-row"><button id="tsbdPin">📍 Đặt điểm</button><button id="tsbdStreet">👁️ Street View</button></div>
    <div class="muted">Mẹo: nhập Lat/Lng rồi bấm “Đặt điểm”.</div>
  </div>
  <div id="pane-tsss" style="display:none">
    <div class="form-row"><input id="tsssTen" placeholder="Tên/Địa chỉ so sánh"><input id="tsssGia" type="number" placeholder="Giá (tỷ)"></div>
    <div class="form-row"><input id="tsssLat" placeholder="Lat"><input id="tsssLng" placeholder="Lng"></div>
    <div class="form-row"><button id="tsssAdd">➕ Thêm so sánh</button></div>
    <div id="tsssList" class="muted">Chưa có mục so sánh nào.</div>
  </div>
</div>

<!-- Compass overlay -->
<div id="compassOverlay">
  <span class="label n">B</span><span class="label s">N</span><span class="label e">Đ</span><span class="label w">T</span>
  <canvas id="compassCanvas" width="350" height="350"></canvas>
</div>

<!-- Coords -->
<div class="coords" id="coords">Lat: --, Lng: --</div>

<script>
// ================== MAP CORE ==================
const map = L.map('map',{center:[10.776,106.7],zoom:12});

// Basemaps
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
const esriStreet = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',{attribution:'© Esri'});
const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'© Esri Imagery'});
const esriTopo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',{attribution:'© Esri Topo'});
const gStreet = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{attribution:'© Google'});
const gHybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{attribution:'© Google'});

L.control.layers({
  "🗺️ OSM":osm,"🗺️ Esri Street":esriStreet,"🛰️ Esri Imagery":esriImagery,
  "🗺️ Esri Topo":esriTopo,"🌍 Google Street":gStreet,"🛰️ Google Hybrid":gHybrid
},{},{collapsed:true}).addTo(map);

// For clearing colored areas later
let coloredLayers = [];
document.getElementById('btnClear').onclick = () => {
  coloredLayers.forEach(l=>l.setStyle({fillColor:null,fillOpacity:.15}));
  coloredLayers = [];
};

// ================== SEARCH (Places + LatLng) ==================
const qInp = document.getElementById('q');
let lastMarker = null;

// Autocomplete (try/catch để không chặn khi Places bị chặn)
let ac = null;
try{
  ac = new google.maps.places.Autocomplete(qInp,{componentRestrictions:{country:"vn"}});
  ac.addListener("place_changed",()=>{
    const p=ac.getPlace(); if(!p || !p.geometry) return;
    placeMarker(p.geometry.location.lat(), p.geometry.location.lng(), p.formatted_address||p.name);
  });
}catch(err){
  console.warn('Google Places không sẵn sàng, vẫn hỗ trợ nhập tọa độ thủ công.');
}

// Enter → parse Lat,Lng
qInp.addEventListener('keydown',ev=>{
  if(ev.key!=="Enter") return;
  const m=qInp.value.trim().match(/^(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)/);
  if(m){ const lat=parseFloat(m[1]),lng=parseFloat(m[2]); placeMarker(lat,lng,`Tọa độ: ${lat.toFixed(6)}, ${lng.toFixed(6)}`); }
});

function placeMarker(lat,lng,label){
  map.setView([lat,lng],17);
  if(lastMarker) map.removeLayer(lastMarker);
  lastMarker=L.marker([lat,lng]).addTo(map)
    .bindPopup(`<b>${label||''}</b><br><button id="svbtn">👁️ Xem Street View tại vị trí này</button>`).openPopup();
  setTimeout(()=>{const b=document.getElementById('svbtn'); if(b){b.onclick=()=>openStreetView(lat,lng);}},40);
}

// ================== STREET VIEW ==================
const svService = new google.maps.StreetViewService();
function openStreetView(lat,lng){
  const isMobile = window.innerWidth<=768;
  const w = isMobile ? 300 : 350;
  const h = isMobile ? 200 : 250;
  const html = `<div id="sv" style="width:${w}px;height:${h}px"></div>`;
  L.popup({maxWidth:w+30}).setLatLng([lat,lng]).setContent(html).openOn(map);
  setTimeout(()=>{
    svService.getPanorama({location:{lat:lat,lng:lng}, radius:60},(data,status)=>{
      if(status!=='OK'||!data||!data.location){
        const el=document.getElementById('sv'); if(el) el.innerHTML='<div style="padding:8px">Không có Street View tại đây.</div>'; return;
      }
      let heading=0;
      if(data.links && data.links.length){ heading=data.links[0].heading; }
      else if(google.maps.geometry && data.location && data.location.latLng){
        heading=google.maps.geometry.spherical.computeHeading(data.location.latLng,new google.maps.LatLng(lat,lng));
      }
      new google.maps.StreetViewPanorama(document.getElementById('sv'),{
        position:data.location.latLng,pov:{heading:heading,pitch:0,zoom:0},
        linksControl:true,zoomControl:true,panControl:true,addressControl:false
      });
    });
  },40);
}
map.on('contextmenu', e=> openStreetView(e.latlng.lat, e.latlng.lng));

// ================== COMPASS (center overlay) ==================
const compass = document.getElementById('compassOverlay');
const canvas = document.getElementById('compassCanvas'), ctx = canvas.getContext('2d');
let arrowHeading = 0; // degrees

function drawCompass(){
  const w=canvas.width,h=canvas.height,r=w/2-20;
  ctx.clearRect(0,0,w,h);
  ctx.strokeStyle='#999'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(w/2,h/2,r,0,Math.PI*2); ctx.stroke();
  ctx.save(); ctx.translate(w/2,h/2);
  for(let d=0; d<360; d+=10){
    const len=(d%30===0)?12:6, a=d*Math.PI/180;
    ctx.beginPath(); ctx.moveTo((r-len)*Math.cos(a),(r-len)*Math.sin(a)); ctx.lineTo(r*Math.cos(a),r*Math.sin(a)); ctx.stroke();
  }
  ctx.rotate((arrowHeading)*Math.PI/180);
  ctx.fillStyle='#d00'; ctx.beginPath(); ctx.moveTo(0,-r+18); ctx.lineTo(8,0); ctx.lineTo(-8,0); ctx.closePath(); ctx.fill();
  ctx.restore();
}
drawCompass();

document.getElementById('btnCompass').onclick = ()=>{
  const show = compass.style.display!=='block';
  compass.style.display = show ? 'block':'none';
  if(show) drawCompass();
};

// Device orientation (mobile)
function onDevOri(e){
  if(typeof e.alpha==='number'){
    arrowHeading = 360 - e.alpha;
    if(compass.style.display==='block') drawCompass();
  }
}
window.addEventListener('deviceorientationabsolute',onDevOri,true);
window.addEventListener('deviceorientation',onDevOri,true);

// GPS heading (when locating)
const locateCtrl = L.control.locate({strings:{title:"Vị trí của tôi"},showCompass:true,setView:'untilPanOrZoom'});
document.getElementById('btnGPS').onclick = ()=>{ if(!locateCtrl._map) locateCtrl.addTo(map); locateCtrl.start(); };
map.on('locationfound',e=>{
  if(typeof e.heading==='number' && !isNaN(e.heading)){
    arrowHeading = e.heading;
    if(compass.style.display==='block') drawCompass();
  }
});

// ================== MEASURE (standard only) ==================
document.getElementById('btnMeasure').onclick = ()=>{
  const m=document.getElementById('measureMenu');
  m.style.display = (m.style.display==='block') ? 'none' : 'block';
};
let activeDraw=null, drawnItems=new L.FeatureGroup().addTo(map);
function stopMeasure(){ if(activeDraw){ activeDraw.disable(); activeDraw=null; } }
function startDist(){ stopMeasure(); activeDraw=new L.Draw.Polyline(map,{shapeOptions:{color:varPri(),weight:3}}); activeDraw.enable(); }
function startArea(){ stopMeasure(); activeDraw=new L.Draw.Polygon(map,{shapeOptions:{color:varPri(),weight:2,fillOpacity:.2}}); activeDraw.enable(); }
document.getElementById('mDist').onclick=()=>{ document.getElementById('measureMenu').style.display='none'; startDist(); };
document.getElementById('mArea').onclick=()=>{ document.getElementById('measureMenu').style.display='none'; startArea(); };
document.getElementById('mFinish').onclick=()=>{ stopMeasure(); document.getElementById('measureMenu').style.display='none'; };
map.on(L.Draw.Event.CREATED, e=>{
  const layer=e.layer; drawnItems.addLayer(layer);
  if(e.layerType==='polyline'){
    const coords=layer.getLatLngs().map(ll=>[ll.lng,ll.lat]);
    let len=0; for(let i=1;i<coords.length;i++){ len+=turf.distance(coords[i-1],coords[i],{units:'kilometers'}); }
    layer.bindPopup('Chiều dài: '+(len*1000).toFixed(1)+' m').openPopup();
  }else if(e.layerType==='polygon'){
    const coords=[layer.getLatLngs()[0].map(ll=>[ll.lng,ll.lat])];
    const poly=turf.polygon([coords[0]]); const area=turf.area(poly);
    layer.bindPopup('Diện tích: '+area.toFixed(0)+' m²').openPopup();
  }
});
function varPri(){ return getComputedStyle(document.documentElement).getPropertyValue('--pri') || '#1f6feb'; }

// ================== SIDEBAR TSBĐ/TSSS ==================
const sidebar = document.getElementById('sidebar');
document.getElementById('sidebarToggle').onclick = ()=> sidebar.classList.add('open');
document.getElementById('sidebarClose').onclick = ()=> sidebar.classList.remove('open');

const tabTSBD=document.getElementById('tab-tsbd'), tabTSSS=document.getElementById('tab-tsss');
const paneTSBD=document.getElementById('pane-tsbd'), paneTSSS=document.getElementById('pane-tsss');
function setTab(which){
  if(which==='tsbd'){ tabTSBD.classList.add('active'); tabTSSS.classList.remove('active'); paneTSBD.style.display='block'; paneTSSS.style.display='none'; }
  else{ tabTSBD.classList.remove('active'); tabTSSS.classList.add('active'); paneTSBD.style.display='none'; paneTSSS.style.display='block'; }
}
tabTSBD.onclick=()=>setTab('tsbd'); tabTSSS.onclick=()=>setTab('tsss');

document.getElementById('tsbdPin').onclick=()=>{
  const lat=parseFloat(document.getElementById('tsbdLat').value);
  const lng=parseFloat(document.getElementById('tsbdLng').value);
  if(!isFinite(lat)||!isFinite(lng)){ alert('Nhập Lat/Lng hợp lệ'); return; }
  placeMarker(lat,lng,'TSBĐ');
};
document.getElementById('tsbdStreet').onclick=()=>{
  const lat=parseFloat(document.getElementById('tsbdLat').value);
  const lng=parseFloat(document.getElementById('tsbdLng').value);
  if(!isFinite(lat)||!isFinite(lng)){ alert('Nhập Lat/Lng hợp lệ'); return; }
  openStreetView(lat,lng);
};

// ================== POPUP & COLORING FROM GEOJSON ==================
const clickColors=['#FFD700','#FFA500','#FF4500','#8A2BE2','#1E90FF','#00CED1'];

// Load trực tiếp từ GitHub repo: Assets/TPHCM.geojson
loadGeo();
function loadGeo(){
  fetch(assets/TPHCM.geojson')
    .then(r=>{ if(!r.ok) throw new Error('Không tải được Assets/TPHCM.geojson'); return r.json(); })
    .then(drawGeo)
    .catch(err=>{
      console.error(err);
      alert('Không tìm thấy Assets/TPHCM.geojson. Vui lòng đảm bảo tệp này tồn tại trong repo ở thư mục Assets/');
    });
}

function drawGeo(geo){
  L.geoJSON(geo,{
    style:{color:"#555",weight:1,fillOpacity:.15},
    onEachFeature:(f,l)=>{
      const p=f.properties||{};
      const name = (p.ten_xa!=null)? String(p.ten_xa) : '—';
      const qh = p.quan_huyen ? `<div style="color:#5f6368">${p.quan_huyen}</div>` : '';
      const dt = (p.dtich_km2!=null)? `${p.dtich_km2} km²` : '—';
      const ds = (p.dan_so!=null)? `${Number(p.dan_so).toLocaleString('vi-VN')} người` : '—';
      const sn = (p.sap_nhap!=null && String(p.sap_nhap).trim()!=='' && String(p.sap_nhap).trim()!=='0')
                ? String(p.sap_nhap) : '—';

      // Trường hợp đặc biệt: Nhiêu Lộc (giữ nội dung chuẩn anh yêu cầu)
      const isNhieuLoc = name.normalize('NFC').toLowerCase().includes('nhiêu lộc') || name.normalize('NFD').toLowerCase().includes('nhieu loc');
      if(isNhieuLoc){
        l.bindPopup(`<b>Nhiêu Lộc</b>${qh}<br>Trước sáp nhập: Phường 9, Phường 11, Phường 12, Phường 14 (Quận 3)<br>Diện tích: 1.71 km²<br>Dân số: 88.090 người`);
      }else{
        l.bindPopup(`<b>${name}</b>${qh}<br>Trước sáp nhập: ${sn}<br>Diện tích: ${dt}<br>Dân số: ${ds}`);
      }

      // Đổi màu khi click
      l.on('click',()=>{
        const c = clickColors[(Math.random()*clickColors.length)|0];
        l.setStyle({fillColor:c,fillOpacity:.5});
        if(!coloredLayers.includes(l)) coloredLayers.push(l);
      });
    }
  }).addTo(map);
}

// ================== COORDS FOOTER ==================
map.on('mousemove', e=> document.getElementById('coords').textContent = `Lat:${e.latlng.lat.toFixed(5)}, Lng:${e.latlng.lng.toFixed(5)}`);
</script>
</body>
</html>
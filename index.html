<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HCM WebGIS ‚Äî Quy ho·∫°ch & H√†nh ch√≠nh</title>

<!-- Leaflet core -->
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Geocoder (autocomplete Nominatim) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.css">
<script src="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>

<!-- Locate control (GPS) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.78.0/dist/L.Control.Locate.min.css">
<script src="https://unpkg.com/leaflet.locatecontrol@0.78.0/dist/L.Control.Locate.min.js"></script>

<!-- Measure (ƒëo ƒë·ªô d√†i/di·ªán t√≠ch) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-measure/3.1.0/leaflet-measure.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-measure/3.1.0/leaflet-measure.min.js"></script>

<!-- Leaflet Draw (v·∫Ω) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.min.js"></script>

<!-- Compass -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-compass/dist/leaflet-compass.css">
<script src="https://unpkg.com/leaflet-compass/dist/leaflet-compass.min.js"></script>

<!-- Esri Leaflet (basemap Esri Streets/Imagery) -->
<script src="https://unpkg.com/esri-leaflet@3.0.11/dist/esri-leaflet.js"></script>

<!-- Fuse.js ƒë·ªÉ search theo t√™n ph∆∞·ªùng/x√£ -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<style>
  html, body, #map { height: 100%; margin: 0; }
  .topbar {
    position: absolute; left: 12px; top: 12px; z-index: 1000;
    display: flex; gap: 8px; flex-wrap: wrap;
  }
  .btn {
    background: #fff; border: 1px solid #ccc; border-radius: 10px;
    padding: 8px 12px; box-shadow: 0 1px 6px rgba(0,0,0,.1); cursor: pointer;
    display: inline-flex; align-items: center; gap: 8px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }
  .btn:hover { background:#f6f6f6; }
  .search-wrap {
    background: #fff; border:1px solid #ccc; border-radius: 12px;
    display:flex; align-items:center; padding:6px 10px; min-width: 360px;
    box-shadow: 0 1px 6px rgba(0,0,0,.1);
  }
  .search-wrap input {
    border: none; outline: none; width: 100%;
    font-size: 14px;
  }
  .legend {
    line-height: 1.2;
    padding: 8px 10px;
    background: rgba(255,255,255,.96);
    border: 1px solid #ccc; border-radius: 8px;
    box-shadow: 0 1px 6px rgba(0,0,0,.08);
  }
  .legend h4{margin:4px 0 8px;font-size:13px}
  .legend i {
    width: 14px; height: 14px; float: left; margin-right: 6px; opacity: 0.9; border:1px solid #999; border-radius: 2px;
  }
  .coords {
    position: absolute; left: 8px; bottom: 6px;
    z-index: 900; background: rgba(255,255,255,.9);
    padding: 2px 6px; border-radius: 6px; font: 12px/1.2 monospace;
    border: 1px solid #ddd;
  }
  .ward-suggest {
    position:absolute; top:50px; left:12px; z-index:1000;
    background:#fff; border:1px solid #ddd; border-radius:8px;
    display:none; max-height: 220px; overflow:auto;
    box-shadow:0 1px 6px rgba(0,0,0,.1);
  }
  .ward-suggest div{
    padding:6px 10px; cursor:pointer; font-size:13px;
  }
  .ward-suggest div:hover{ background:#f5f5f5; }
  /* tr√°nh menu layer ƒë√® n√∫t export */
  .leaflet-top.leaflet-right { margin-top: 90px; }
</style>
</head>
<body>
<div id="map"></div>

<!-- thanh c√¥ng c·ª• n·ªïi -->
<div class="topbar">
  <div class="search-wrap">
    <input id="searchBox" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c t√™n ph∆∞·ªùng‚Ä¶" />
  </div>
  <button id="btnClear" class="btn">üßπ X√≥a t√¥ m√†u</button>
  <button id="btnExport" class="btn">üì§ Xu·∫•t GeoJSON</button>
</div>

<!-- g·ª£i √Ω ph∆∞·ªùng -->
<div id="wardSuggest" class="ward-suggest"></div>

<div id="coords" class="coords">Lat: ‚Ä¶, Lng: ‚Ä¶</div>

<script>
/* ========== B·∫£n ƒë·ªì & n·ªÅn ========== */
const map = L.map('map', { zoomControl: true }).setView([10.78, 106.68], 12);

const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 20, attribution: '¬© OpenStreetMap'
}).addTo(map);

const esriStreets = L.esri.basemapLayer('Streets');
const esriImagery = L.esri.basemapLayer('Imagery');

/* L·ªõp ch·ªìng */
const adminLayer = L.geoJson(null);      // H√†nh ch√≠nh
const qhLayer = L.geoJson(null);         // Quy ho·∫°ch 1/2000
const selectedLayer = L.featureGroup();  // V√πng ƒë√£ t√¥

/* B·ªô chuy·ªÉn n·ªÅn & l·ªõp */
L.control.layers(
  {
    'OpenStreetMap': osm,
    'Esri Streets': esriStreets,
    'Esri Imagery': esriImagery
  },
  {
    'ƒê·ªãa gi·ªõi h√†nh ch√≠nh': adminLayer,
    'Quy ho·∫°ch 1/2000': qhLayer
  },
  { collapsed: false }
).addTo(map);

/* La b√†n */
L.control.compass({autoActive:true, showDigit:true, position:'topright'}).addTo(map);

/* GPS locate */
L.control.locate({
  position: 'topleft',
  strings: { title: "ƒê·ªãnh v·ªã GPS" },
  locateOptions: { enableHighAccuracy: true }
}).addTo(map);

/* Measure */
L.control.measure({
  position:'topleft',
  primaryLengthUnit: 'meters',
  secondaryLengthUnit: 'kilometers',
  primaryAreaUnit: 'sqmeters',
  activeColor: '#db4a29',
  completedColor: '#9b2d14'
}).addTo(map);

/* Draw */
const drawLayer = L.featureGroup().addTo(map);
new L.Control.Draw({
  position:'topleft',
  draw: {
    polygon: true, polyline: true, rectangle: true, circle: false, marker: true, circlemarker:false
  },
  edit: { featureGroup: drawLayer }
}).addTo(map);
map.on(L.Draw.Event.CREATED, e => drawLayer.addLayer(e.layer));

/* Hi·ªán Lat/Lng */
map.on('mousemove', e=>{
  document.getElementById('coords').textContent =
    `Lat: ${e.latlng.lat.toFixed(5)}, Lng: ${e.latlng.lng.toFixed(5)}`;
});

/* Geocoder (ƒë·ªãa ch·ªâ) */
L.Control.geocoder({
  defaultMarkGeocode: false,
  collapsed: true,
  placeholder: 'T√¨m ƒë·ªãa ch·ªâ‚Ä¶'
})
.on('markgeocode', function(e) {
  map.fitBounds(e.geocode.bbox);
  L.marker(e.geocode.center).addTo(map)
    .bindPopup(e.geocode.name).openPopup();
})
.addTo(map);

/* ========== T·∫£i d·ªØ li·ªáu ========== */
/* B·∫£n ƒë·ªì h√†nh ch√≠nh: assets/TPHCM.geojson  (ten_xa, sap_nhap, dtich_km2, dan_so) */
const ADMIN_URL = 'assets/TPHCM.geojson';

/* B·∫£n ƒë·ªì Quy ho·∫°ch ƒë√£ simplify: assets/QHPKSDD_SHAPE.json (MaQuyUoc, TenQuyUoc, ‚Ä¶) */
const QH_URL = 'assets/QHPKSDD_SHAPE.json';

/* M√†u t√¥ khi click h√†nh ch√≠nh (xoay v√≤ng) */
const clickPalette = [
  '#f6bf26', // v√†ng
  '#f2994a', // cam
  '#e74c3c', // ƒë·ªè
  '#9b59b6', // t√≠m
  '#2980b9', // xanh d∆∞∆°ng
  '#27aeae'  // xanh n∆∞·ªõc bi·ªÉn
];

/* Style h√†nh ch√≠nh m·∫∑c ƒë·ªãnh */
function adminStyle() {
  return { color:'#d35400', weight: 2, fillOpacity: 0.12, fillColor: '#f39c12' };
}

/* C·∫•u h√¨nh popup h√†nh ch√≠nh */
function adminPopup(props) {
  const ten = props.ten_xa ?? '(Kh√¥ng r√µ)';
  const sap = props.sap_nhap ?? '';
  const km2 = props.dtich_km2 != null ? Number(props.dtich_km2).toLocaleString('vi-VN') : '‚Äî';
  const dan = props.dan_so != null ? Number(props.dan_so).toLocaleString('vi-VN') : '‚Äî';

  return `<b>${ten}</b><br>${sap ? sap+'<br>' : ''}${km2} km¬≤ ‚Äì ${dan} ng∆∞·ªùi`;
}

let adminFeatures = [];     // ƒë·ªÉ search ph∆∞·ªùng
let fuse = null;            // Fuse.js cho search ph∆∞·ªùng

fetch(ADMIN_URL).then(r=>r.json()).then(data=>{
  adminLayer.addData(data);

  adminLayer.setStyle(adminStyle);

  adminLayer.eachLayer(layer=>{
    layer._colorIndex = -1; // index m√†u ƒëang d√πng

    layer.on('click', ()=>{
      // xoay m√†u
      layer._colorIndex = (layer._colorIndex + 1) % clickPalette.length;
      layer.setStyle({ fillOpacity: 0.45, fillColor: clickPalette[layer._colorIndex] });

      // th√™m v√†o selected
      selectedLayer.addLayer(layer);

      // popup
      layer.bindPopup(adminPopup(layer.feature.properties)).openPopup();
    });
  });

  // gom l·∫°i ƒë·ªÉ search ph∆∞·ªùng
  adminFeatures = data.features.map(f=>({
    name: f.properties.ten_xa || '',
    center: L.geoJSON(f).getBounds().getCenter(),
    bbox: L.geoJSON(f).getBounds()
  }));
  fuse = new Fuse(adminFeatures, { keys:['name'], includeScore:true, threshold:0.3 });

  adminLayer.addTo(map);
});

/* ========== Quy ho·∫°ch 1/2000 ========== */
/* B·∫£ng m√†u theo MaQuyUoc */
const QH_COLORS = {
  'ODT/ONT': '#e74c3c',     // ƒê·∫•t ·ªü
  'CX'     : '#2ecc71',     // C√¢y xanh
  'DGT'    : '#95a5a6',     // Giao th√¥ng
  'CC'     : '#f1c40f',     // C√¥ng c·ªông
  'MN'     : '#3498db',     // M·∫∑t n∆∞·ªõc
  'HTKT'   : '#9b59b6',     // H·∫° t·∫ßng k·ªπ thu·∫≠t
  'TG'     : '#e67e22'      // T√¥n gi√°o
};

function qhStyle(f) {
  const code = (f.properties?.MaQuyUoc || '').toUpperCase();
  const color = QH_COLORS[code] || '#bdc3c7';
  return { color: '#666', weight: 0.6, fillColor: color, fillOpacity: 0.35 };
}

fetch(QH_URL).then(r=>r.json()).then(data=>{
  qhLayer.addData(data).setStyle(qhStyle);
});

/* Legend cho Quy ho·∫°ch */
const legend = L.control({position:'bottomright'});
legend.onAdd = function(){
  const div = L.DomUtil.create('div','legend');
  div.innerHTML = '<h4>Ch√∫ gi·∫£i lo·∫°i ƒë·∫•t</h4>';
  const items = [
    ['#e74c3c','ƒê·∫•t ·ªü (ODT/ONT)'],
    ['#2ecc71','C√¢y xanh (CX)'],
    ['#95a5a6','Giao th√¥ng (DGT)'],
    ['#f1c40f','C√¥ng c·ªông (CC)'],
    ['#3498db','M·∫∑t n∆∞·ªõc (MN)'],
    ['#9b59b6','H·∫° t·∫ßng k·ªπ thu·∫≠t (HTKT)'],
    ['#e67e22','T√¥n gi√°o (TG)']
  ];
  items.forEach(([c,l])=>{
    div.innerHTML += `<div><i style="background:${c}"></i>${l}</div>`;
  });
  return div;
};
legend.addTo(map);

/* L·ªõp selected (v·∫Ω outline kh√°c ƒë·ªÉ xu·∫•t) */
selectedLayer.addTo(map);

/* N√∫t X√≥a t√¥ m√†u */
document.getElementById('btnClear').onclick = ()=>{
  adminLayer.eachLayer(l=>{
    l._colorIndex = -1;
    l.setStyle(adminStyle());
  });
  selectedLayer.clearLayers();
};

/* Xu·∫•t GeoJSON v√πng ƒë√£ t√¥ */
document.getElementById('btnExport').onclick = ()=>{
  const fc = [];
  adminLayer.eachLayer(l=>{
    if (l._colorIndex >= 0) fc.push(l.feature);
  });
  const blob = new Blob([JSON.stringify({type:'FeatureCollection', features:fc})],
                        {type:'application/json;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'hcm_selected.geojson';
  a.click();
  URL.revokeObjectURL(a.href);
};

/* ========== Search: ƒë·ªãa ch·ªâ (√¥ Leaflet Geocoder ƒë√£ c√≥) + ph∆∞·ªùng/x√£ (Fuse.js) ========== */
const sb = document.getElementById('searchBox');
const suggest = document.getElementById('wardSuggest');

function hideSuggest(){ suggest.style.display='none'; suggest.innerHTML=''; }

sb.addEventListener('input', ()=>{
  const q = sb.value.trim();
  hideSuggest();
  if (!q || !fuse) return;
  const res = fuse.search(q).slice(0,10);
  if (!res.length) return;
  res.forEach(r=>{
    const item = document.createElement('div');
    item.textContent = r.item.name;
    item.onclick = ()=>{
      map.fitBounds(r.item.bbox);
      L.circleMarker(r.item.center, {radius:6, color:'#2c3e50'}).addTo(map).bindPopup(r.item.name).openPopup();
      hideSuggest();
    };
    suggest.appendChild(item);
  });
  suggest.style.display='block';
});
map.on('click', hideSuggest);

/* ========== K·∫øt th√∫c ========== */
</script>
</body>
</html>

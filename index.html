<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HCM WebGIS v14.4 â€” OSM + TSBÄ/TSSS + Autocomplete</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸ—ºï¸%3C/text%3E%3C/svg%3E"/>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.0/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/leaflet-simple-map-screenshoter"></script>

<!-- Google Maps (Ä‘á»‹a chá»‰ + geometry) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places,geometry"></script>

<style>
:root{--pri:#00BFFF;--gold:#FFD700}
*{box-sizing:border-box}
html,body,#map{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial}
#map{position:absolute;inset:0}

/* search + suggest */
#searchWrap{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:1400;width:900px;max-width:94vw}
#search{width:100%;padding:12px 14px;border:1px solid #cfd4dc;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.15)}
#suggest{position:absolute;left:0;right:0;top:46px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.15);display:none;max-height:300px;overflow:auto}
.s-item{padding:10px 12px;cursor:pointer;border-bottom:1px solid #f2f2f2}
.s-item:hover{background:#f7fbff}
.s-sub{color:#6b7280;font-size:12px;margin-left:4px}

/* tools */
#tools{position:absolute;right:10px;top:72px;z-index:1200;display:flex;flex-direction:column;gap:10px}
.toolbtn{background:#fff;border:1px solid #ddd;border-radius:50%;width:48px;height:48px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.15);font-size:22px}
#btnClear{position:absolute;right:10px;top:240px;z-index:1200;background:#fff;border:1px solid #ddd;border-radius:12px;padding:8px 12px;box-shadow:0 2px 6px rgba(0,0,0,.15);cursor:pointer}

#measureMenu{position:absolute;right:70px;top:122px;background:#fff;border:1px solid #ddd;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.18);display:none;z-index:1300}
#measureMenu button{display:block;width:240px;padding:10px 14px;border:none;background:#fff;text-align:left;cursor:pointer;font-size:14px}
#measureMenu button:hover{background:#f1f5f9}

#sidebarToggle{position:absolute;left:10px;top:120px;z-index:1200;background:#fff;border:1px solid #ddd;border-radius:12px;padding:8px 12px;box-shadow:0 2px 6px rgba(0,0,0,.15);cursor:pointer}

/* sidebar TSBÄ/TSSS */
#sidebar{position:fixed;left:0;top:0;height:100%;width:380px;background:#fff;box-shadow:4px 0 20px rgba(0,0,0,.2);transform:translateX(-400px);transition:transform .28s ease;z-index:1600;display:flex;flex-direction:column}
#sidebar.open{transform:translateX(0)}
#sbHead{background:var(--pri);color:#fff;padding:14px 16px;font-weight:700;display:flex;align-items:center;justify-content:space-between}
#sidebarClose{border:none;background:transparent;color:#fff;font-size:22px;cursor:pointer}
#sbBody{padding:12px 12px 90px;overflow:auto}
.section{border:1px solid #e5e7eb;border-radius:12px;padding:10px 10px 6px;margin-bottom:10px}
.section h4{margin:0 0 8px;font-size:14px}
.form-row{display:flex;gap:8px;margin-bottom:8px}
.form-row input,.form-row select,.form-row textarea{flex:1;padding:9px;border:1px solid #cfd4dc;border-radius:10px}
.sm{font-size:12px;color:#6b7280}

.pin{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#003;font-weight:700;border:3px solid #004}
.pin.tsbd{background:var(--gold);border-color:#a06f00}
.pin.tsss{background:var(--pri);border-color:#0a4f7a;color:#fff}

/* compass overlay - chá»‰ váº¡ch & chá»¯ (trong suá»‘t ná»n) */
#compassOverlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:230px;height:230px;pointer-events:none;display:none;z-index:1300}
#compassCanvas{width:100%;height:100%}

.coords{position:absolute;left:10px;bottom:6px;background:rgba(255,255,255,.9);padding:4px 8px;border-radius:8px;font:12px monospace;z-index:1000}
.leaflet-popup-content{min-width:300px;max-width:360px}

/* responsive */
@media(max-width:768px){
  #searchWrap{width:94vw}
  #sidebar{width:92vw;transform:translateX(-100vw)}
  .leaflet-popup-content{min-width:260px;max-width:320px}
  #compassOverlay{width:210px;height:210px}
}
</style>
</head>
<body>

<div id="searchWrap">
  <input id="search" placeholder="ğŸ” Äá»‹a chá»‰ / PhÆ°á»ng-XÃ£ / TÃªn cÅ© trÆ°á»›c sÃ¡p nháº­p / Tá»a Ä‘á»™ (10.79,106.66)"/>
  <div id="suggest"></div>
</div>

<div id="map"></div>

<div id="tools">
  <button id="btnCompass" class="toolbtn" title="Báº­t/Táº¯t la bÃ n">ğŸ§­</button>
  <button id="btnMeasure" class="toolbtn" title="Äo (khoáº£ng cÃ¡ch/diá»‡n tÃ­ch)">ğŸ“</button>
  <button id="btnGPS" class="toolbtn" title="Äá»‹nh vá»‹">ğŸ“</button>
  <button id="btnShot" class="toolbtn" title="Chá»¥p JPG">ğŸ“¸</button>
</div>

<div id="measureMenu">
  <button id="mDist">ğŸ“ğŸ“ Äo khoáº£ng cÃ¡ch</button>
  <button id="mArea">â¬› Äo diá»‡n tÃ­ch</button>
  <button id="mFinish">ğŸ›‘ HoÃ n táº¥t Ä‘o</button>
</div>

<button id="btnClear">ğŸ§¹ XÃ³a tÃ´ mÃ u</button>

<button id="sidebarToggle">ğŸ“‹ TSBÄ / TSSS</button>
<div id="sidebar">
  <div id="sbHead"><span>ğŸ“‹ TSBÄ / TSSS</span><button id="sidebarClose">Ã—</button></div>
  <div id="sbBody">
    <div class="section">
      <h4>TSBÄ</h4>
      <div class="form-row"><input id="tsbdTen" placeholder="TÃªn/Äá»‹a chá»‰ TSBÄ"/><input id="tsbdGia" placeholder="GiÃ¡ (tá»·)" type="number"/></div>
      <div class="form-row"><input id="tsbdLat" placeholder="Lat"/><input id="tsbdLng" placeholder="Lng"/></div>
      <div class="form-row"><button id="tsbdPin">ğŸ“ Äáº·t Ä‘iá»ƒm</button><button id="tsbdStreet">ğŸ‘ï¸ Street View</button></div>
      <div class="sm">TSBÄ hiá»ƒn thá»‹ vÃ²ng trÃ²n <b>vÃ ng</b>.</div>
    </div>

    <div class="section">
      <h4>TSSS</h4>
      <div class="form-row"><input id="tsssTen" placeholder="TÃªn/Äá»‹a chá»‰ so sÃ¡nh"/><input id="tsssGia" placeholder="GiÃ¡ (tá»·)" type="number"/></div>
      <div class="form-row"><input id="tsssLat" placeholder="Lat"/><input id="tsssLng" placeholder="Lng"/></div>
      <div class="form-row"><button id="tsssAdd">â• ThÃªm TSSS</button><button id="tsssClear">ğŸ—‘ï¸ XÃ³a TSSS</button></div>
      <div id="tsssList" class="sm">ChÆ°a cÃ³ TSSS.</div>
    </div>

    <div class="section">
      <h4>LÆ°u / Táº£i dá»¯ liá»‡u</h4>
      <div class="form-row"><button id="btnExportCSV">ğŸ“„ Xuáº¥t CSV</button><button id="btnExportXLSX">ğŸ“˜ Xuáº¥t Excel (.xlsx)</button></div>
      <div class="form-row"><button id="btnExportKML">ğŸ—ºï¸ Táº¡o My Map (KML)</button><button id="btnOpenMyMaps">ğŸ“‚ Má»Ÿ My Maps</button></div>
      <div class="sm">File xuáº¥t cÃ³ cá»™t <b>Quáº­n/Huyá»‡n</b>. KML Ä‘á»ƒ import Google My Maps.</div>
    </div>
  </div>
</div>

<div id="compassOverlay"><canvas id="compassCanvas" width="230" height="230"></canvas></div>
<div id="coords" class="coords">Lat: --, Lng: --</div>

<script>
/* ====== MAP & BASE ====== */
const map=L.map('map',{center:[10.775,106.7],zoom:12});
const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(map);
const gSt=L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}');
const gHy=L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}');
L.control.layers({"ğŸ—ºï¸ OSM":osm,"ğŸŒ Google Street":gSt,"ğŸ›°ï¸ Google Hybrid":gHy}).addTo(map);

const coordsEl=document.getElementById('coords');
map.on('mousemove',e=>{coordsEl.textContent=`Lat: ${e.latlng.lat.toFixed(5)}, Lng: ${e.latlng.lng.toFixed(5)}`;});

/* ====== SIDEBAR ====== */
const sidebar=document.getElementById('sidebar');
document.getElementById('sidebarToggle').onclick=()=>sidebar.classList.add('open');
document.getElementById('sidebarClose').onclick=()=>sidebar.classList.remove('open');

/* ====== ADMIN BOUNDARIES ====== */
let wardLayer=null,wardFeatures=[],coloredLayers=[],searchIndex=[];
const RAW_GEO='https://raw.githubusercontent.com/Minhcd81/HCM/main/assets/TPHCM.geojson';

fetch(RAW_GEO).then(r=>r.json()).then(geo=>{
  wardLayer=L.geoJSON(geo,{
    style:{color:'#555',weight:1,fillOpacity:.1},
    onEachFeature:(f,layer)=>{
      const p=f.properties||{};
      const ten=p.ten_xa||'', qh=p.quan_huyen||'';
      const sn=(p.sap_nhap&&p.sap_nhap!=='0')?p.sap_nhap:'â€”';
      const dt=(p.dtich_km2!=null)?`${p.dtich_km2} kmÂ²`:'â€”';
      const ds=(p.dan_so!=null)?`${Number(p.dan_so).toLocaleString('vi-VN')} ngÆ°á»i`:'â€”';

      layer.bindPopup(buildWardPopup(ten,qh,sn,dt,ds, turf.centerOfMass(f).geometry.coordinates));
      layer.on('click',()=>{
        colorLayer(layer);
        layer.openPopup();
      });

      wardFeatures.push(f);
      // index cho autocomplete
      const aliases=[ten,p.sap_nhap].filter(Boolean).join(' | ');
      searchIndex.push({
        key: removeTone(`${ten} ${p.sap_nhap||''} ${qh}`),
        ten, qh, sn, dt, ds,
        center: turf.centerOfMass(f).geometry.coordinates,
        bbox: turf.bbox(f),
        layerRef: layer
      });
    }
  }).addTo(map);
}).catch(e=>{console.error(e); alert('KhÃ´ng táº£i Ä‘Æ°á»£c GeoJSON hÃ nh chÃ­nh.');});

function buildWardPopup(ten,qh,sn,dt,ds,centerLngLat){
  const [lng,lat]=centerLngLat||[106.7,10.77];
  return `<b>${ten}</b><br><small>${qh}</small>
    <div style="margin-top:6px">TrÆ°á»›c sÃ¡p nháº­p: ${sn}<br>Diá»‡n tÃ­ch: ${dt}<br>DÃ¢n sá»‘: ${ds}</div>
    <button class="sv-btn" data-lat="${lat}" data-lng="${lng}" style="margin-top:8px">ğŸ‘ï¸ Xem Street View táº¡i vá»‹ trÃ­ nÃ y</button>`;
}
function colorLayer(layer){
  layer.setStyle({fillColor:randColor(),fillOpacity:.45});
  if(!coloredLayers.includes(layer)) coloredLayers.push(layer);
}
document.getElementById('btnClear').onclick=()=>{coloredLayers.forEach(l=>l.setStyle({fillColor:null,fillOpacity:.1})); coloredLayers=[];};
function randColor(){const c=['#FFD700','#FFA500','#FF4500','#8A2BE2','#1E90FF','#00CED1'];return c[(Math.random()*c.length)|0];}
function findQuanHuyen(lat,lng){
  if(!wardFeatures.length) return '';
  const pt=turf.point([lng,lat]);
  for(const f of wardFeatures){if(turf.booleanPointInPolygon(pt,f)) return (f.properties?.quan_huyen||'').toString().trim();}
  return '';
}

/* ====== SEARCH: Google Places + ná»™i bá»™ (phÆ°á»ng/xÃ£) ====== */
const searchInp=document.getElementById('search');
const suggest=document.getElementById('suggest');

// Google autocomplete cho Ä‘á»‹a chá»‰
try{
  const gAC=new google.maps.places.Autocomplete(searchInp,{types:['geocode'],componentRestrictions:{country:'vn'}});
  gAC.addListener('place_changed',()=>{
    const pl=gAC.getPlace();
    if(pl && pl.geometry){
      const lat=pl.geometry.location.lat(), lng=pl.geometry.location.lng();
      map.setView([lat,lng],17);
      L.marker([lat,lng]).addTo(map)
       .bindPopup(`<b>${pl.formatted_address}</b><br><button class="sv-btn" data-lat="${lat}" data-lng="${lng}" style="margin-top:6px">ğŸ‘ï¸ Xem Street View táº¡i vá»‹ trÃ­ nÃ y</button>`)
       .openPopup();
      suggest.style.display='none';
    }
  });
}catch(e){console.warn('Google Places unavailable',e);}

// Autocomplete ná»™i bá»™ theo GeoJSON (6â€“8 gá»£i Ã½)
let suggestLimit=8;
searchInp.addEventListener('input',()=>{
  const q=removeTone(searchInp.value.trim());
  if(q.length<3){suggest.style.display='none'; return;}
  const hits=searchIndex.filter(x=>x.key.includes(q)).slice(0,suggestLimit);
  if(hits.length===0){suggest.style.display='none';return;}
  suggest.innerHTML = hits.map(h=>`<div class="s-item" data-id="${h.key}">
      <b>${h.ten}</b> <span class="s-sub">${h.qh}</span>
      ${h.sn && h.sn!=='â€”'?`<div class="s-sub">TÃªn cÅ©: ${h.sn}</div>`:''}
    </div>`).join('');
  suggest.style.display='block';
});
suggest.addEventListener('click',ev=>{
  const item=ev.target.closest('.s-item'); if(!item) return;
  const id=item.getAttribute('data-id');
  const h=searchIndex.find(x=>x.key===id); if(!h) return;
  suggest.style.display='none';
  // zoom tá»›i bbox, tÃ´ mÃ u + má»Ÿ popup
  if(h.layerRef){ colorLayer(h.layerRef); map.fitBounds([[h.bbox[1],h.bbox[0]],[h.bbox[3],h.bbox[2]]]); h.layerRef.openPopup(); }
});

// Street View cho má»i popup (event delegation)
map.on('popupopen',e=>{
  const btn=e.popup.getElement().querySelector('.sv-btn');
  if(btn){
    btn.addEventListener('click',()=>{
      const lat=btn.getAttribute('data-lat'), lng=btn.getAttribute('data-lng');
      window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`,'_blank');
    },{once:true});
  }
});

/* ====== MEASURE (khoáº£ng cÃ¡ch/diá»‡n tÃ­ch) ====== */
const drawnItems=new L.FeatureGroup().addTo(map);
let activeDraw=null;
function stopMeasure(){if(activeDraw){activeDraw.disable(); activeDraw=null;}}
document.getElementById('btnMeasure').onclick=()=>{
  const m=document.getElementById('measureMenu');
  m.style.display=(m.style.display==='block')?'none':'block';
};
document.getElementById('mDist').onclick=()=>{stopMeasure(); activeDraw=new L.Draw.Polyline(map,{shapeOptions:{color:getPrimary()}}); activeDraw.enable(); document.getElementById('measureMenu').style.display='none';};
document.getElementById('mArea').onclick=()=>{stopMeasure(); activeDraw=new L.Draw.Polygon(map,{shapeOptions:{color:getPrimary(),fillOpacity:.2}}); activeDraw.enable(); document.getElementById('measureMenu').style.display='none';};
document.getElementById('mFinish').onclick=()=>{stopMeasure(); document.getElementById('measureMenu').style.display='none';};
map.on(L.Draw.Event.CREATED, e=>{
  const layer=e.layer; drawnItems.addLayer(layer);
  if(e.layerType==='polyline'){
    const coords=layer.getLatLngs().map(ll=>[ll.lng,ll.lat]); let len=0;
    for(let i=1;i<coords.length;i++) len+=turf.distance(coords[i-1],coords[i],{units:'kilometers'});
    layer.bindPopup('Chiá»u dÃ i: '+(len*1000).toFixed(1)+' m').openPopup();
  }else if(e.layerType==='polygon'){
    const ring=[layer.getLatLngs()[0].map(ll=>[ll.lng,ll.lat])];
    const area=turf.area(turf.polygon([ring[0]]));
    layer.bindPopup('Diá»‡n tÃ­ch: '+area.toFixed(0)+' mÂ²').openPopup();
  }
});
function getPrimary(){return getComputedStyle(document.documentElement).getPropertyValue('--pri')||'#00BFFF';}

/* ====== COMPASS (mobile + web) ====== */
const compassEl=document.getElementById('compassOverlay');
const cv=document.getElementById('compassCanvas'), ctx=cv.getContext('2d');
let compassOn=false, heading=0;
document.getElementById('btnCompass').onclick=async ()=>{
  if(typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){
    try{ const perm=await DeviceOrientationEvent.requestPermission(); if(perm!=='granted') return alert('KhÃ´ng cÃ³ quyá»n cáº£m biáº¿n.'); }catch{}
  }
  compassOn=!compassOn; compassEl.style.display=compassOn?'block':'none'; if(compassOn) drawCompass();
};
window.addEventListener('deviceorientationabsolute',onOrient,true);
window.addEventListener('deviceorientation',onOrient,true);
function onOrient(e){
  if(!compassOn) return;
  let a = (typeof e.webkitCompassHeading==='number') ? e.webkitCompassHeading : (typeof e.alpha==='number'? (360 - e.alpha) : 0);
  heading = (a+360)%360; drawCompass();
}
function drawCompass(){
  const R=cv.width/2, C=R;
  ctx.clearRect(0,0,cv.width,cv.height);
  // vÃ²ng & váº¡ch
  ctx.strokeStyle='rgba(0,0,0,.38)'; ctx.lineWidth=1.3;
  ctx.beginPath(); ctx.arc(C,C,R-6,0,Math.PI*2); ctx.stroke();
  for(let d=0; d<360; d+=10){
    const len=(d%30===0)?10:5, a=(d-heading)*Math.PI/180;
    const r1=R-14, r2=r1-len;
    ctx.beginPath(); ctx.moveTo(C+Math.cos(a)*r1, C+Math.sin(a)*r1);
    ctx.lineTo(C+Math.cos(a)*r2, C+Math.sin(a)*r2); ctx.stroke();
  }
  label('B',0); label('Ä',90); label('N',180); label('T',270);
  function label(t,deg){const a=(deg-heading)*Math.PI/180, r=R-34; ctx.fillStyle='#111'; ctx.font='700 14px Segoe UI'; ctx.textAlign='center'; ctx.fillText(t, C+Math.cos(a)*r, C+Math.sin(a)*r+5);}
  // kim Ä‘á»
  ctx.save(); ctx.translate(C,C); ctx.rotate((-heading)*Math.PI/180);
  ctx.fillStyle='#d00'; ctx.beginPath(); ctx.moveTo(0,-(R-34)); ctx.lineTo(7,0); ctx.lineTo(-7,0); ctx.closePath(); ctx.fill(); ctx.restore();
}

/* ====== GPS locate ====== */
const locateCtrl=L.control.locate({strings:{title:"Vá»‹ trÃ­ cá»§a tÃ´i"},showCompass:true,setView:'untilPanOrZoom'});
document.getElementById('btnGPS').onclick=()=>{ if(!locateCtrl._map) locateCtrl.addTo(map); locateCtrl.start(); };

/* ====== SCREENSHOT JPG ====== */
const screenshoter=new L.simpleMapScreenshoter({hidden:true,mimeType:'image/jpeg',quality:.92,domtoimageOptions:{bgcolor:'#ffffff'}}).addTo(map);
document.getElementById('btnShot').onclick=()=>{
  screenshoter.takeScreen('blob').then(blob=>{
    const linkShot=document.createElement('a');
    linkShot.href=URL.createObjectURL(blob);
    linkShot.download=`HCM_Map_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'')}.jpg`;
    linkShot.click();
  });
};

/* ====== TSBÄ / TSSS ====== */
function iconTSBD(){return L.divIcon({className:'',html:`<div class="pin tsbd">TSBÄ</div>`,iconSize:[34,34],iconAnchor:[17,17]});}
function iconTSSS(){return L.divIcon({className:'',html:`<div class="pin tsss">TSSS</div>`,iconSize:[34,34],iconAnchor:[17,17]});}

let tsbdMarker=null; const tsssMarkers=[];
const elTSBD={ten:document.getElementById('tsbdTen'),gia:document.getElementById('tsbdGia'),lat:document.getElementById('tsbdLat'),lng:document.getElementById('tsbdLng')};
const elTSSS={ten:document.getElementById('tsssTen'),gia:document.getElementById('tsssGia'),lat:document.getElementById('tsssLat'),lng:document.getElementById('tsssLng')};

document.getElementById('tsbdPin').onclick=()=>{
  const lat=parseFloat(elTSBD.lat.value), lng=parseFloat(elTSBD.lng.value);
  if(!isFinite(lat)||!isFinite(lng)){alert('Nháº­p Lat/Lng há»£p lá»‡ cho TSBÄ');return;}
  if(tsbdMarker) map.removeLayer(tsbdMarker);
  tsbdMarker=L.marker([lat,lng],{icon:iconTSBD()}).addTo(map);
  const qh=findQuanHuyen(lat,lng);
  const html=`<b>${elTSBD.ten.value||'TSBÄ'}</b><br><small>${qh||'â€”'}</small>${elTSBD.gia.value?`<br>GiÃ¡: ${elTSBD.gia.value} tá»·`:''}<br><button class="sv-btn" data-lat="${lat}" data-lng="${lng}">ğŸ‘ï¸ Street View</button>`;
  tsbdMarker.bindPopup(html).openPopup();
  map.setView([lat,lng],17);
};
document.getElementById('tsbdStreet').onclick=()=>{
  const lat=parseFloat(elTSBD.lat.value), lng=parseFloat(elTSBD.lng.value);
  if(!isFinite(lat)||!isFinite(lng)){alert('Nháº­p Lat/Lng há»£p lá»‡ cho TSBÄ');return;}
  window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`,'_blank');
};

document.getElementById('tsssAdd').onclick=()=>{
  const lat=parseFloat(elTSSS.lat.value), lng=parseFloat(elTSSS.lng.value);
  if(!isFinite(lat)||!isFinite(lng)){alert('Nháº­p Lat/Lng há»£p lá»‡ cho TSSS');return;}
  const m=L.marker([lat,lng],{icon:iconTSSS()}).addTo(map);
  m.meta={name:elTSSS.ten.value||'TSSS',price:isFinite(+elTSSS.gia.value)?+elTSSS.gia.value:null};
  const qh=findQuanHuyen(lat,lng);
  const html=`<b>${m.meta.name}</b><br><small>${qh||'â€”'}</small>${m.meta.price!=null?`<br>GiÃ¡: ${m.meta.price} tá»·`:''}<br><button class="sv-btn">ğŸ‘ï¸ Street View</button>`;
  m.bindPopup(html); m.on('popupopen',()=>{ const b=e.popup?.getElement?.()?.querySelector?.('.sv-btn');});
  tsssMarkers.push(m); map.setView([lat,lng],17); renderList();
};
document.getElementById('tsssClear').onclick=()=>{tsssMarkers.forEach(m=>map.removeLayer(m)); tsssMarkers.length=0; renderList();};
function renderList(){
  const box=document.getElementById('tsssList');
  if(tsssMarkers.length===0){box.textContent='ChÆ°a cÃ³ TSSS.';return;}
  box.innerHTML=tsssMarkers.map(m=>{const p=m.getLatLng();const nm=m.meta?.name||'TSSS';const pr=m.meta?.price!=null?` â€” ${m.meta.price} tá»·`:'';return `â€¢ ${nm} â€” ${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}${pr}`;}).join('<br>');
}

/* ====== EXPORT ====== */
function rowsForExport(){
  if(!tsbdMarker){alert('Äáº·t Ä‘iá»ƒm TSBÄ trÆ°á»›c khi xuáº¥t');return null;}
  const a=tsbdMarker.getLatLng(); const qhA=findQuanHuyen(a.lat,a.lng);
  const rows=[{Loai:'TSBD',Ten:elTSBD.ten.value||'TSBÄ',Lat:+a.lat.toFixed(6),Lng:+a.lng.toFixed(6),Quan_Huyen:qhA||'',Gia_ty:isFinite(+elTSBD.gia.value)?+elTSBD.gia.value:'',Khoang_cach:'',Ghi_chu:''}];
  tsssMarkers.forEach(m=>{const b=m.getLatLng(); const qhB=findQuanHuyen(b.lat,b.lng); const dkm=turf.distance([a.lng,a.lat],[b.lng,b.lat],{units:'kilometers'}); rows.push({Loai:'TSSS',Ten:m.meta?.name||'TSSS',Lat:+b.lat.toFixed(6),Lng:+b.lng.toFixed(6),Quan_Huyen:qhB||'',Gia_ty:(m.meta?.price!=null)?m.meta.price:'',Khoang_cach:`${(dkm*1000).toFixed(1)} m`,Ghi_chu:''});});
  return rows;
}
document.getElementById('btnExportCSV').onclick=()=>{
  const rows=rowsForExport(); if(!rows) return;
  const headers=['Loai','Ten','Lat','Lng','Quan_Huyen','Gia_ty','Khoang_cach','Ghi_chu'];
  const csv=[headers.join(','), ...rows.map(r=>headers.map(h=>{const v=String(r[h]??'');return /[",\n]/.test(v)?`"${v.replace(/"/g,'""')}"`:v;}).join(','))].join('\n');
  const blob=new Blob([`\uFEFF${csv}`],{type:'text/csv;charset=utf-8;'});
  const linkCSV=document.createElement('a'); linkCSV.href=URL.createObjectURL(blob);
  linkCSV.download=`TS_Export_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'')}.csv`; linkCSV.click();
};
document.getElementById('btnExportXLSX').onclick=()=>{
  const rows=rowsForExport(); if(!rows) return;
  const ws=XLSX.utils.json_to_sheet(rows); const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'DATA');
  XLSX.writeFile(wb,`TS_Export_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'')}.xlsx`);
};
document.getElementById('btnExportKML').onclick=()=>{
  if(!tsbdMarker){alert('Äáº·t Ä‘iá»ƒm TSBÄ trÆ°á»›c khi xuáº¥t KML');return;}
  const a=tsbdMarker.getLatLng(); const qhA=findQuanHuyen(a.lat,a.lng);
  function esc(s){return String(s??'').replace(/[<&>]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));}
  function placemark(name,desc,lat,lng,style){return `<Placemark><name>${esc(name)}</name><description>${esc(desc)}</description><styleUrl>#${style}</styleUrl><Point><coordinates>${lng},${lat},0</coordinates></Point></Placemark>`;}
  let kml=`<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document>
  <name>HCM_TSBD_TSSS_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'')}</name>
  <Style id="tsbd"><IconStyle><scale>1.2</scale><Icon><href>http://maps.google.com/mapfiles/kml/paddle/ylw-circle.png</href></Icon></IconStyle></Style>
  <Style id="tsss"><IconStyle><scale>1.2</scale><Icon><href>http://maps.google.com/mapfiles/kml/paddle/blu-circle.png</href></Icon></IconStyle></Style>`;
  kml+=placemark(elTSBD.ten.value||'TSBÄ',`Quáº­n/Huyá»‡n: ${qhA||'â€”'}${elTSBD.gia.value?` | GiÃ¡: ${elTSBD.gia.value} tá»·`:''}`,a.lat,a.lng,'tsbd');
  tsssMarkers.forEach(m=>{const b=m.getLatLng(); const qh=findQuanHuyen(b.lat,b.lng);
    kml+=placemark(m.meta?.name||'TSSS',`Quáº­n/Huyá»‡n: ${qh||'â€”'}${m.meta?.price!=null?` | GiÃ¡: ${m.meta.price} tá»·`:''}`,b.lat,b.lng,'tsss');
  });
  kml+='</Document></kml>';
  const blob=new Blob([kml],{type:'application/vnd.google-earth.kml+xml'});
  const linkKML=document.createElement('a'); linkKML.href=URL.createObjectURL(blob);
  linkKML.download=`HCM_TSBD_TSSS_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'')}.kml`; linkKML.click();
};
document.getElementById('btnOpenMyMaps').onclick=()=>window.open('https://www.google.com/mymaps','_blank');

/* ====== helpers ====== */
function removeTone(str){return str.toLowerCase()
  .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
  .replace(/Ä‘/g,'d').replace(/[^a-z0-9\s]/g,'').replace(/\s+/g,' ').trim();}
</script>
</body>
</html>

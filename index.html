<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>B·∫£n ƒë·ªì TP.HCM - C√≥ t·∫£i ƒë·ªãa gi·ªõi h√†nh ch√≠nh</title>

<!-- üó∫Ô∏è Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- ‚úÖ Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places"></script>

<!-- ‚úÖ Leaflet.GoogleMutant -->
<script src="https://cdn.jsdelivr.net/npm/leaflet.gridlayer.googlemutant@0.11.2/dist/Leaflet.GoogleMutant.min.js"></script>

<!-- ‚úÖ Leaflet.EasyPrint -->
<script src="https://cdn.jsdelivr.net/npm/leaflet-easyprint@2.1.9/dist/leaflet.easyPrint.js"></script>

<!-- üß© Plugins -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.css"/>
<script src="https://unpkg.com/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.css"/>
<script src="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-easybutton@2.4.0/src/easy-button.css"/>
<script src="https://unpkg.com/leaflet-easybutton@2.4.0/src/easy-button.js"></script>

<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<style>
  html, body, #map { height: 100%; margin: 0; font-family: "Segoe UI", Arial, sans-serif; }
  .panel {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 9999;
    background: rgba(255,255,255,0.95);
    padding: 10px;
    border-radius: 8px;
    width: 200px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    font-size: 13px;
  }
  .legend {
    position: absolute;
    bottom: 10px;
    left: 10px;
    background: rgba(255, 255, 255, 0.9);
    padding: 8px 12px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    font-size: 13px;
  }
</style>
</head>
<body>
<div id="map"></div>

<!-- üîß B·∫£ng c√¥ng c·ª• -->
<div class="panel">
  <b>ƒê·ªãa gi·ªõi HCM ‚Äì simplify</b><br>
  Ngu·ªìn: <i>assets/hcm_admin_shp.zip</i><br>
  <label>M·ª©c ƒë∆°n gi·∫£n h√≥a:</label>
  <select id="tolerance">
    <option value="0.00005">5 m</option>
    <option value="0.0001" selected>10 m</option>
    <option value="0.0002">20 m</option>
  </select><br><br>
  <button id="loadBtn">üìÇ T·∫£i & hi·ªÉn th·ªã</button>
  <button id="downloadBtn">üíæ T·∫£i GeoJSON</button>
</div>

<script>
// ===== 1Ô∏è‚É£ Kh·ªüi t·∫°o b·∫£n ƒë·ªì =====
const map = L.map("map", { center: [10.77, 106.7], zoom: 12 });

// ---- Google base maps ----
const roadmap = L.gridLayer.googleMutant({ type: "roadmap" });
const satellite = L.gridLayer.googleMutant({ type: "satellite" });
const hybrid = L.gridLayer.googleMutant({ type: "hybrid" });
roadmap.addTo(map);

const baseMaps = {
  "Google ƒê∆∞·ªùng ph·ªë": roadmap,
  "Google V·ªá tinh": satellite,
  "Google K·∫øt h·ª£p": hybrid
};

// ===== 2Ô∏è‚É£ C√¥ng c·ª• =====
L.control.layers(baseMaps, null, { collapsed: true, position: "topright" }).addTo(map);
L.control.locate({ position: "topleft", strings: { title: "ƒê·ªãnh v·ªã GPS" } }).addTo(map);
L.Control.geocoder({ position: "topleft", placeholder: "T√¨m ki·∫øm ƒë·ªãa ch·ªâ..." }).addTo(map);
L.control.scale({ metric: true }).addTo(map);
L.control.measure({ position: "topleft", primaryLengthUnit: "meters" }).addTo(map);

const drawnItems = new L.FeatureGroup().addTo(map);
new L.Control.Draw({ edit: { featureGroup: drawnItems } }).addTo(map);

// ===== 3Ô∏è‚É£ T·∫£i shapefile ƒë·ªãa gi·ªõi =====
let currentLayer = null;
let geoLayer = null;
const styleDefault = () => ({ color: "#2262CC", weight: 1.2, fillOpacity: 0.05 });
const styleHighlight = () => ({ color: "#0B5ED7", weight: 3, fillColor: "#FFD43B", fillOpacity: 0.5 });

function simplifyGeoJSON(geojson, tolerance) {
  const simplified = turf.simplify(geojson, { tolerance: parseFloat(tolerance), highQuality: false });
  return simplified;
}

async function loadBoundary() {
  if (geoLayer) map.removeLayer(geoLayer);
  const tol = document.getElementById("tolerance").value;
  const data = await shp("assets/hcm_admin_shp.zip");
  const simplified = simplifyGeoJSON(data, tol);
  geoLayer = L.geoJSON(simplified, {
    style: styleDefault,
    onEachFeature: (f, l) => {
      const p = f.properties;
      l.bindTooltip(`${p.loai || ""} ${p.ten_xa || ""}`);
      l.on("click", () => {
        if (currentLayer) geoLayer.resetStyle(currentLayer);
        currentLayer = l;
        l.setStyle(styleHighlight());
        L.popup({ maxWidth: 300 })
          .setLatLng(l.getBounds().getCenter())
          .setContent(`<b>${p.loai || ""} ${p.ten_xa || ""}</b><br>${p.ten_tinh || "TP.HCM"}`)
          .openOn(map);
      });
    }
  }).addTo(map);
  map.fitBounds(geoLayer.getBounds());
  alert("‚úÖ ƒê√£ t·∫£i ƒë·ªãa gi·ªõi HCM v·ªõi tolerance " + tol);
}

document.getElementById("loadBtn").onclick = loadBoundary;
document.getElementById("downloadBtn").onclick = () => {
  if (!geoLayer) return alert("‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i!");
  const geojson = geoLayer.toGeoJSON();
  const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "HCM_boundary_simplified.geojson";
  a.click();
};

// ===== 4Ô∏è‚É£ Legend =====
L.control({ position: "bottomleft" }).onAdd = function() {
  const div = L.DomUtil.create("div", "legend");
  div.innerHTML = `
    <b>Ch√∫ gi·∫£i</b><br>
    <span style="display:inline-block;width:14px;height:14px;background:#2262CC;border:1px solid #2262CC;margin-right:4px"></span> ƒê·ªãa gi·ªõi<br>
    <span style="display:inline-block;width:14px;height:14px;background:#FFD43B;border:1px solid #0B5ED7;margin-right:4px"></span> Khi ch·ªçn
  `;
  return div;
}.addTo(map);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Vietnam WebGIS v15 â€” Full 34 Provinces (PropTechViet)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places,geometry"></script>
<style>
html,body,#map{height:100%;margin:0}
body{font-family:Roboto,Arial,Helvetica,sans-serif}
#map{z-index:1}
#sidebar{position:absolute;left:10px;top:10px;width:270px;background:#fff;padding:10px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.25);z-index:1000}
#sidebar select,#sidebar button{width:100%;margin-top:6px;padding:8px;border-radius:6px;border:1px solid #ccc}
#tools{position:absolute;right:10px;top:60px;z-index:1200;display:flex;flex-direction:column;gap:8px}
.toolbtn{background:#fff;border:1px solid #ccc;border-radius:50%;width:48px;height:48px;cursor:pointer;font-size:22px;text-align:center;line-height:48px;box-shadow:0 2px 8px rgba(0,0,0,.2)}
.toolbtn:hover{background:#eaf6ff}
.popup-street{width:320px;height:180px;border:0;border-radius:8px}
.leaflet-popup-content-wrapper{border-radius:10px}
</style>
</head>
<body>
<div id="sidebar">
<h3>PropTechViet WebGIS</h3>
<select id="provinceSelect"></select>
<button id="loadProvince">Táº£i tá»‰nh nÃ y</button>
<button id="toggleHeat">ğŸ”¥ Báº­t/Táº¯t Heatmap</button>
<button id="locateTSBD">ğŸ“ Äá»‹nh vá»‹ TSBÄ</button>
</div>
<div id="tools">
<div class="toolbtn" id="btnMeasure" title="Äo khoáº£ng cÃ¡ch">ğŸ“</div>
<div class="toolbtn" id="btnArea" title="Äo diá»‡n tÃ­ch">ğŸ“</div>
<div class="toolbtn" id="btnStreet" title="StreetView">ğŸ‘ï¸</div>
<div class="toolbtn" id="btnCompass" title="La bÃ n">ğŸ§­</div>
</div>
<div id="map"></div>

<script>
// === DANH SÃCH 34 Tá»ˆNH/THÃ€NH CHUáº¨N ===
const PROVINCES=[
{name:'An Giang',slug:'angiang'},
{name:'Báº¯c Ninh',slug:'bacninh'},
{name:'LÃ¢m Äá»“ng',slug:'lamdong'},
{name:'CÃ  Mau',slug:'camau'},
{name:'Cáº§n ThÆ¡',slug:'cantho'},
{name:'Cao Báº±ng',slug:'caobang'},
{name:'ÄÃ  Náºµng',slug:'danang'},
{name:'Äáº¯k Láº¯k',slug:'daklak'},
{name:'Äiá»‡n BiÃªn',slug:'dienbien'},
{name:'Äá»“ng Nai',slug:'dongnai'},
{name:'Äá»“ng ThÃ¡p',slug:'dongthap'},
{name:'Gia Lai',slug:'gialai'},
{name:'TP HÃ  Ná»™i',slug:'hanoi'},
{name:'HÃ  TÄ©nh',slug:'hatinh'},
{name:'Háº£i PhÃ²ng',slug:'haiphong'},
{name:'HÆ°ng YÃªn',slug:'hungyen'},
{name:'KhÃ¡nh HÃ²a',slug:'khanhhoa'},
{name:'Lai ChÃ¢u',slug:'laichau'},
{name:'Láº¡ng SÆ¡n',slug:'langson'},
{name:'LÃ o Cai',slug:'laocai'},
{name:'Nghá»‡ An',slug:'nghean'},
{name:'Ninh BÃ¬nh',slug:'ninhbinh'},
{name:'PhÃº Thá»',slug:'phutho'},
{name:'Quáº£ng NgÃ£i',slug:'quangngai'},
{name:'Quáº£ng Ninh',slug:'quangninh'},
{name:'Quáº£ng Trá»‹',slug:'quangtri'},
{name:'SÆ¡n La',slug:'sonla'},
{name:'TÃ¢y Ninh',slug:'tayninh'},
{name:'ThÃ¡i NguyÃªn',slug:'thainguyen'},
{name:'Thanh HÃ³a',slug:'thanhhoa'},
{name:'TP Huáº¿',slug:'hue'},
{name:'TP.HCM',slug:'hcm'},
{name:'TuyÃªn Quang',slug:'tuyenquang'},
{name:'VÄ©nh Long',slug:'vinhlong'}
];

// === KHá»I Táº O MAP ===
let map=L.map('map',{center:[10.78,106.67],zoom:8});
let osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'Â© OSM'}).addTo(map);
let gHybrid=L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{attribution:'Â© Google'});
let gStreet=L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}');
let currentProvinceLayer,heatLayer,tsbdMarker;

// === Táº O DANH SÃCH Tá»ˆNH TRONG DROPDOWN ===
let sel=document.getElementById('provinceSelect');
PROVINCES.forEach(p=>{
 let opt=document.createElement('option');opt.value=p.slug;opt.textContent=p.name;sel.appendChild(opt);
});

// === LOAD GEOJSON Cá»¦A 1 Tá»ˆNH ===
async function loadProvince(slug){
  if(currentProvinceLayer) map.removeLayer(currentProvinceLayer);
  try{
    const res=await fetch(`assets/${slug}.geojson`);
    const geo=await res.json();
    const color="#"+Math.floor(Math.random()*16777215).toString(16);
    currentProvinceLayer=L.geoJSON(geo,{
      style:{color:'#555',weight:1,fillColor:color,fillOpacity:.25},
      onEachFeature:(f,layer)=>{
        const p=f.properties||{};
        const ten=p.ten_xa||p.NAME_3||'';
        const qh=p.quan_huyen||p.NAME_2||'';
        const tinh=p.tinh||p.NAME_1||'';
        layer.bindPopup(`<b>${ten}</b><br>${qh}, ${tinh}`);
        layer.on('mouseover',()=>layer.setStyle({fillOpacity:.55}));
        layer.on('mouseout',()=>layer.setStyle({fillOpacity:.25}));
      }
    }).addTo(map);
    map.fitBounds(currentProvinceLayer.getBounds());
  }catch(e){alert("KhÃ´ng táº£i Ä‘Æ°á»£c dá»¯ liá»‡u tá»‰nh "+slug);}
}

// === NÃšT LOAD ===
document.getElementById('loadProvince').onclick=()=>{loadProvince(sel.value);};

// === NÃšT HEATMAP DEMO ===
document.getElementById('toggleHeat').onclick=()=>{
 if(heatLayer){map.removeLayer(heatLayer);heatLayer=null;return;}
 const pts=[];
 if(currentProvinceLayer){
  currentProvinceLayer.eachLayer(l=>{
    const c=l.getBounds().getCenter();
    pts.push([c.lat,c.lng,Math.random()*5]);
  });
 }
 heatLayer=L.heatLayer(pts,{radius:25,blur:15,maxZoom:12}).addTo(map);
};

// === Äá»ŠNH Vá»Š TSBÄ ===
document.getElementById('locateTSBD').onclick=()=>{
 map.locate({setView:true,maxZoom:16});
 map.on('locationfound',e=>{
  if(tsbdMarker) map.removeLayer(tsbdMarker);
  tsbdMarker=L.marker(e.latlng,{title:'TSBÄ',riseOnHover:true}).addTo(map);
  const lat=e.latlng.lat.toFixed(6),lng=e.latlng.lng.toFixed(6);
  tsbdMarker.bindPopup(`TSBÄ<br>Lat:${lat}<br>Lng:${lng}<br><button onclick="openStreet(${lat},${lng})">ğŸ‘ï¸ Street View</button>`).openPopup();
 });
};

// === STREET VIEW POPUP ===
function openStreet(lat,lng){
 const svUrl=`https://www.google.com/maps/embed?pb=!4v!6m8!1m7!1sCAoSLEFGMVFpcE9...!2m2!1d${lat}!2d${lng}!3f0!4f0!5f0.7820865974627469`;
 const html=`<iframe class="popup-street" src="https://www.google.com/maps?q=&layer=c&cbll=${lat},${lng}&cbp=11,0,0,0,0&z=18" allowfullscreen></iframe>`;
 L.popup().setLatLng([lat,lng]).setContent(html).openOn(map);
}

// === CÃ”NG Cá»¤ ÄO KHOáº¢NG CÃCH & DIá»†N TÃCH (Ä‘Æ¡n giáº£n) ===
let measureLine=null;
document.getElementById('btnMeasure').onclick=()=>{
 map.once('click',e=>{
   if(measureLine){map.removeLayer(measureLine);}
   let start=e.latlng;
   map.on('mousemove',ev=>{
     if(measureLine) map.removeLayer(measureLine);
     measureLine=L.polyline([start,ev.latlng],{color:'#00BFFF'}).addTo(map);
     let dist=map.distance(start,ev.latlng).toFixed(1);
     measureLine.bindTooltip(dist+" m").openTooltip();
   });
   map.once('click',()=>{map.off('mousemove');});
 });
};

// === DIá»†N TÃCH ===
document.getElementById('btnArea').onclick=()=>{
 let pts=[];let poly=null;
 map.on('click',e=>{
   pts.push(e.latlng);
   if(poly) map.removeLayer(poly);
   poly=L.polygon(pts,{color:'#00BFFF',fillOpacity:.3}).addTo(map);
   if(pts.length>2){
     const area=L.GeometryUtil.geodesicArea(pts);
     poly.bindTooltip((area/1000000).toFixed(3)+" kmÂ²").openTooltip();
   }
 });
};

// === LA BÃ€N GIáº¢ Láº¬P ===
document.getElementById('btnCompass').onclick=()=>{
 alert("ğŸ§­ HÆ°á»›ng Báº¯c: 0Â°, Nam: 180Â°, ÄÃ´ng: 90Â°, TÃ¢y: 270Â°");
};
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>HCM WebGIS â€“ Báº£n Ä‘á»“ hÃ nh chÃ­nh + OSM/Esri/Bing</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>

<style>
  html, body, #map {height:100%; margin:0; padding:0;}
  .leaflet-bar button {display:block; width:100%; border:none; background:white; padding:5px; cursor:pointer;}
  .leaflet-bar button:hover {background:#eee;}
</style>
</head>
<body>
<div id="map"></div>

<!-- JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.min.js"></script>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

<script>
window.onload = function() {
  // --- Khá»Ÿi táº¡o báº£n Ä‘á»“ ---
  const map = L.map('map', {center: [10.776,106.7], zoom: 12});

  // --- CÃ¡c lá»›p ná»n ---
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: 'Â© OpenStreetMap'}).addTo(map);
  const esriStreet = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {attribution:'Â© Esri'});
  const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution:'Â© Esri'});
  const bing = L.tileLayer('https://ecn.t{s}.tiles.virtualearth.net/tiles/a{q}.jpeg?g=1&key=YOUR_BING_API_KEY', {subdomains:['t0','t1','t2','t3'], attribution:'Â© Bing Maps'});

  const baseMaps = {
    "ğŸ—ºï¸ OpenStreetMap": osm,
    "ğŸ§­ Esri Streets": esriStreet,
    "ğŸ›°ï¸ Esri Imagery": esriImagery,
    "ğŸŒ¤ï¸ Bing Aerial": bing
  };

  // --- Lá»›p hÃ nh chÃ­nh ---
  let hcmLayer;
  const hanhChinhGroup = L.layerGroup();

  // --- Náº¡p Ä‘á»‹a giá»›i ---
  async function loadHCM() {
    try {
      const res = await fetch('assets/TPHCM.geojson');
      const data = await res.json();
      if (hcmLayer) hanhChinhGroup.removeLayer(hcmLayer);

      hcmLayer = L.geoJSON(data, {
        style: { color: "#ff0000", weight: 1, fillOpacity: 0.1 },
        onEachFeature: (f, l) => {
          const p = f.properties || {};
          l.bindPopup(`<b>${p.ten_xa || ''}</b><br>${p.quan_huyen || ''}<br>${p.dtich_km2 || ''} kmÂ²<br>${p.dan_so || ''} ngÆ°á»i`);
          l.on('click', () => highlight(l));
        }
      }).addTo(hanhChinhGroup);

      alert("âœ… ÄÃ£ náº¡p báº£n Ä‘á»“ hÃ nh chÃ­nh!");
    } catch(e) {
      alert("âŒ KhÃ´ng thá»ƒ táº£i file 'assets/TPHCM.geojson'");
      console.error(e);
    }
  }

  // --- TÃ´ mÃ u ---
  const colored = [];
  function highlight(layer){
    const colors = ["#FFD700","#FFA500","#1E90FF","#32CD32","#FF69B4"];
    const c = colors[Math.floor(Math.random()*colors.length)];
    layer.setStyle({ fillColor:c, fillOpacity:0.5 });
    colored.push(layer);
  }
  function clearColors(){
    colored.forEach(l => l.setStyle({ fillOpacity:0.1, fillColor:null }));
    colored.length = 0;
  }

  // --- ThÃªm cÃ´ng cá»¥ ---
  L.control.scale().addTo(map);
  L.control.locate({strings:{title:"Äá»‹nh vá»‹ GPS"}}).addTo(map);
  L.control.measure({primaryLengthUnit:'meters', primaryAreaUnit:'sqmeters'}).addTo(map);

  // --- Layer control ---
  const overlayMaps = { "ğŸ—ºï¸ Báº£n Ä‘á»“ hÃ nh chÃ­nh": hanhChinhGroup };
  L.control.layers(baseMaps, overlayMaps).addTo(map);

  // --- Panel ---
  const panel = L.control({position:'topright'});
  panel.onAdd = function(){
    const div = L.DomUtil.create('div','leaflet-bar');
    div.innerHTML = `
      <button onclick="window._loadHCM()">ğŸ—ºï¸ Náº¡p Ä‘á»‹a giá»›i</button>
      <button onclick="window._hideHCM()">áº¨n Ä‘á»‹a giá»›i</button>
      <button onclick="window._clearColors()">ğŸ¨ XÃ³a tÃ´ mÃ u</button>
    `;
    return div;
  };
  panel.addTo(map);

  // --- Cho phÃ©p gá»i tá»« ngoÃ i ---
  window._loadHCM = loadHCM;
  window._hideHCM = () => { if (hcmLayer) hanhChinhGroup.removeLayer(hcmLayer); };
  window._clearColors = clearColors;
};
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HCM WebGIS ‚Äì Google & ƒê·ªãa gi·ªõi h√†nh ch√≠nh</title>

<!-- Leaflet core -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- GoogleMutant stable -->
<script src="https://cdn.jsdelivr.net/npm/leaflet.gridlayer.googlemutant@0.10.2/Leaflet.GoogleMutant.min.js"></script>

<!-- Leaflet Plugins -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.css"/>
<script src="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.css"/>
<script src="https://unpkg.com/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.js"></script>

<script src="https://unpkg.com/leaflet.browser.print/dist/leaflet.browser.print.min.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<style>
html, body, #map { height:100%; margin:0; font-family:Segoe UI, Arial, sans-serif; }
#search { position:absolute; top:10px; left:50px; z-index:1000; width:320px;
  padding:6px 10px; border:1px solid #ccc; border-radius:6px; box-shadow:0 2px 4px rgba(0,0,0,.2); }
.panel { position:absolute; top:10px; right:10px; background:rgba(255,255,255,.95);
  padding:10px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.2); font-size:13px; width:220px; }
.panel button, .panel select { width:100%; margin-top:5px; padding:6px; }
.legend { position:absolute; bottom:10px; left:10px; background:rgba(255,255,255,.9);
  padding:8px 12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.2); font-size:13px; }
</style>
</head>

<body>
<input id="search" type="text" placeholder="üîé Nh·∫≠p ƒë·ªãa ch·ªâ (VD: 961 Ho√†ng Sa, Qu·∫≠n 3)" />
<div id="map"></div>

<div class="panel">
  <b>ƒê·ªãa gi·ªõi HCM ‚Äì simplify</b><br>
  <small>Ngu·ªìn: assets/hcm_admin_shp.zip</small><br>
  <label>ƒê·ªô ƒë∆°n gi·∫£n h√≥a:</label>
  <select id="tol">
    <option value="0.00005">5 m (chi ti·∫øt)</option>
    <option value="0.0001" selected>10 m</option>
    <option value="0.0002">20 m (nh·∫π)</option>
  </select>
  <button id="load">üìÇ N·∫°p ƒë·ªãa gi·ªõi</button>
  <button id="toggle">üëÅÔ∏è ·∫®n/Hi·ªán ƒë·ªãa gi·ªõi</button>
  <button id="tools">‚öôÔ∏è ·∫®n/Hi·ªán c√¥ng c·ª•</button>
</div>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places"></script>
<script>
window.onload = function() {
  const map = L.map('map',{center:[10.77,106.7],zoom:12});

  // ===== Base maps =====
  const gRoad = L.gridLayer.googleMutant({ type: "roadmap" });
  const gSat  = L.gridLayer.googleMutant({ type: "satellite" });
  const gHy   = L.gridLayer.googleMutant({ type: "hybrid" });
  const osm   = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
  const esriS = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}');
  const esriI = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
  gRoad.addTo(map);

  L.control.layers({
    "Google ƒê∆∞·ªùng ph·ªë": gRoad,
    "Google V·ªá tinh": gSat,
    "Google Hybrid": gHy,
    "OpenStreetMap": osm,
    "Esri Streets": esriS,
    "Esri Satellite": esriI
  }, null, { position:"bottomleft" }).addTo(map);

  // ===== C√¥ng c·ª• =====
  const gps = L.control.locate({ position:"topleft" }).addTo(map);
  const measure = L.control.measure({ position:"topleft" }).addTo(map);
  const drawnItems = new L.FeatureGroup().addTo(map);
  new L.Control.Draw({ edit:{featureGroup: drawnItems} }).addTo(map);
  map.on(L.Draw.Event.CREATED, e => drawnItems.addLayer(e.layer));
  L.control.browserPrint({ position:"topleft" }).addTo(map);
  L.Control.geocoder({ position:"topleft" }).addTo(map);
  L.control.scale({ metric:true }).addTo(map);

  // ·∫®n / hi·ªán to√†n b·ªô c√¥ng c·ª•
  let toolsVisible = true;
  document.getElementById("tools").onclick = () => {
    toolsVisible = !toolsVisible;
    document.querySelectorAll(".leaflet-control").forEach(el=>{
      if (!el.classList.contains("leaflet-control-layers"))
        el.style.display = toolsVisible ? "" : "none";
    });
  };

  // ===== Google Search Autocomplete =====
  const input = document.getElementById("search");
  const check = setInterval(()=>{
    if (window.google && google.maps && google.maps.places) {
      clearInterval(check);
      const ac = new google.maps.places.Autocomplete(input, { types:["geocode"] });
      ac.addListener("place_changed", ()=>{
        const p = ac.getPlace();
        if (!p.geometry) return;
        const lat=p.geometry.location.lat(), lng=p.geometry.location.lng();
        map.setView([lat,lng],16);
        L.marker([lat,lng]).addTo(map).bindPopup(`<b>${p.formatted_address}</b>`).openPopup();
      });
    }
  }, 500);

  // ===== ƒê·ªãa gi·ªõi h√†nh ch√≠nh =====
  let layer=null, visible=true;
  const stDef = { color:"#1565C0", weight:1.2, fillOpacity:0.05 };
  const stHigh = { color:"#F57C00", weight:3, fillColor:"#FFE082", fillOpacity:0.5 };
  const popup = p => `<b>${p.ten_xa||"Kh√¥ng r√µ"}</b><br>
    Qu·∫≠n/Huy·ªán: ${p.quan_huyen||"‚Äì"}<br>
    Di·ªán t√≠ch: ${p.dtich_km2||"‚Äì"} km¬≤<br>
    D√¢n s·ªë: ${p.dan_so?Number(p.dan_so).toLocaleString("vi-VN"):"‚Äì"} ng∆∞·ªùi<br>
    S√°p nh·∫≠p: ${p.sap_nhap||"‚Äì"}`;

  async function loadBoundary(){
    if (layer) map.removeLayer(layer);
    const tol = parseFloat(document.getElementById("tol").value);
    const data = await shp("assets/hcm_admin_shp.zip");
    const simp = turf.simplify(data,{tolerance:tol,highQuality:false});
    layer = L.geoJSON(simp,{
      style:()=>stDef,
      onEachFeature:(f,l)=>{
        const p=f.properties;
        l.bindTooltip(p.ten_xa||"");
        l.on("click",()=>{
          layer.resetStyle();
          l.setStyle(stHigh);
          L.popup({maxWidth:300})
            .setLatLng(l.getBounds().getCenter())
            .setContent(popup(p))
            .openOn(map);
        });
      }
    }).addTo(map);
    map.fitBounds(layer.getBounds());
  }

  document.getElementById("load").onclick = loadBoundary;
  document.getElementById("toggle").onclick = () => {
    if (!layer) return;
    visible = !visible;
    visible ? map.addLayer(layer) : map.removeLayer(layer);
  };

  // Legend
  L.control({position:"bottomright"}).onAdd=function(){
    const div=L.DomUtil.create("div","legend");
    div.innerHTML=`<b>Ch√∫ gi·∫£i</b><br>
      <span style="display:inline-block;width:14px;height:14px;background:#1565C0;margin-right:6px"></span> ƒê·ªãa gi·ªõi<br>
      <span style="display:inline-block;width:14px;height:14px;background:#FFE082;margin-right:6px"></span> Khi ch·ªçn`;
    return div;
  }.addTo(map);
};
</script>
</body>
</html>

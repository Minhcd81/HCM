<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Địa giới hành chính TP.HCM – Simplify & Leaflet</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- shpjs: đọc shapefile .zip -> GeoJSON -->
  <script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>

  <!-- Turf.js: simplify hình học -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <style>
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #map { width:100%; height:100%; }
    .panel {
      position:absolute; top:10px; right:10px; z-index:9999;
      background:#fff; padding:10px; border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.15); font-size:13px; width:260px;
    }
    .panel input, .panel select, .panel button { width:100%; margin-top:6px; font-size:13px; }
    .legend {
      position:absolute; left:10px; bottom:10px; z-index:9999;
      background:#fff; padding:8px 10px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.15);
      font-size:13px;
    }
  </style>
</head>
<body>
<div id="map"></div>

<div class="panel">
  <b>Địa giới HCM – simplify</b>
  <div style="margin-top:6px">Nguồn: <code>assets/hcm_admin_shp.zip</code></div>
  <label style="margin-top:8px">Mức đơn giản hoá (tolerance, mét ước tính*):</label>
  <select id="tol">
    <option value="10">10 m (chi tiết)</option>
    <option value="20" selected>20 m (khuyến nghị)</option>
    <option value="35">35 m</option>
    <option value="50">50 m (nhẹ)</option>
    <option value="75">75 m (rất nhẹ)</option>
  </select>
  <button id="btnLoad">Tải & hiển thị</button>
  <button id="btnDownload" disabled>Tải GeoJSON đã simplify</button>
  <small style="display:block;margin-top:6px;color:#666">
    *Turf dùng đơn vị độ, ở đây có nội suy gần đúng theo vĩ độ HCM.
  </small>
</div>

<div class="legend">
  <b>Chú giải</b><br>
  <span style="display:inline-block;width:12px;height:12px;background:#2262CC;margin-right:6px;"></span>
  Địa giới (simplify)
</div>

<script>
  // ====== 1) Khởi tạo bản đồ ======
  const map = L.map('map', { center: [10.77, 106.7], zoom: 11 });
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 20, attribution: '&copy; OpenStreetMap'
  }).addTo(map);
  const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 20, attribution: '&copy; Esri'
  });
  L.control.layers({ 'OSM': osm, 'Esri Satellite': esriSat }, null, {collapsed:true}).addTo(map);

  // ====== 2) Hàm util: giữ 8 trường, popup/tooltip ======
  function pickProperties(props) {
    return {
      ma_xa: props.ma_xa ?? null,
      ten_xa: props.ten_xa ?? props.ten ?? null,
      loai: props.loai ?? null,
      dan_so: props.dan_so ?? null,
      dtich_km2: props.dtich_km2 ?? null,
      matdo_km2: props.matdo_km2 ?? null,
      tru_so: props.tru_so ?? null,
      ten_tinh: props.ten_tinh ?? "TP. Hồ Chí Minh"
    };
  }

  function bindPopupAndTooltip(layer, p) {
    const dan_so = (p.dan_so != null && p.dan_so !== '') ? Number(p.dan_so).toLocaleString('vi-VN') : '–';
    const matdo  = (p.matdo_km2 != null && p.matdo_km2 !== '') ? Number(p.matdo_km2).toLocaleString('vi-VN') : '–';
    const dtich  = (p.dtich_km2 != null && p.dtich_km2 !== '') ? p.dtich_km2 : '–';
    const loai   = p.loai ? p.loai : '';
    const name   = p.ten_xa ? p.ten_xa : 'Không rõ tên';

    const html = `
      <b>${loai} ${name}</b><br/>
      Tỉnh/TP: ${p.ten_tinh || 'TP. Hồ Chí Minh'}<br/>
      Dân số: ${dan_so} người<br/>
      Diện tích: ${dtich} km²<br/>
      Mật độ: ${matdo} người/km²<br/>
      Trụ sở: ${p.tru_so || '–'}<br/>
      Mã hành chính: ${p.ma_xa || '–'}
    `;
    layer.bindPopup(html);
    layer.bindTooltip(`${loai} ${name}`, {permanent:false});
  }

  // ====== 3) Chuyển shapefile -> GeoJSON & simplify ======
  let currentLayer = null;
  let simplifiedGeoJSON = null;

  function approxMetersToDegrees(m) {
    // gần đúng tại vĩ độ ~10.77 (HCM): 1 độ ~ 111320 m
    return m / 111320;
  }

  async function loadAndSimplify() {
    try {
      const tolMeters = Number(document.getElementById('tol').value);
      const tolDegrees = approxMetersToDegrees(tolMeters);

      // Đọc shapefile zip
      const url = 'assets/hcm_admin_shp.zip';
      const raw = await window.shp(url); // -> GeoJSON (FeatureCollection)

      // Chỉ giữ 8 trường và chuẩn hoá popup
      const cleaned = {
        type: 'FeatureCollection',
        features: raw.features.map(f => ({
          type: 'Feature',
          properties: pickProperties(f.properties || {}),
          geometry: f.geometry
        }))
      };

      // Simplify bằng Turf (preserve topology)
      simplifiedGeoJSON = turf.simplify(cleaned, {
        tolerance: tolDegrees,
        highQuality: false,
        mutate: false
      });

      // Vẽ lên bản đồ
      if (currentLayer) currentLayer.remove();
      currentLayer = L.geoJSON(simplifiedGeoJSON, {
        style: { color:'#2262CC', weight:1.2, fillOpacity:0.05 },
        onEachFeature: (feat, layer) => bindPopupAndTooltip(layer, feat.properties || {})
      }).addTo(map);

      // Fit bounds
      try { map.fitBounds(currentLayer.getBounds(), {padding:[20,20]}); } catch(e){}

      // Bật nút download
      document.getElementById('btnDownload').disabled = false;
      alert('Đã tải & simplify xong!');

    } catch (err) {
      console.error(err);
      alert('Có lỗi khi tải/simplify shapefile. Kiểm tra lại assets/hcm_admin_shp.zip (đủ .shp + .shx + .dbf + .prj + .cpg).');
    }
  }

  // ====== 4) Sự kiện nút ======
  document.getElementById('btnLoad').addEventListener('click', loadAndSimplify);

  document.getElementById('btnDownload').addEventListener('click', () => {
    if (!simplifiedGeoJSON) return;
    const blob = new Blob([JSON.stringify(simplifiedGeoJSON)], {type:'application/json;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'dia_gioi_hcm_sua_font_simplify.geojson';
    a.click();
    URL.revokeObjectURL(url);
  });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HCM WebGIS v14.5 ‚Äî OSM + TSBƒê/TSSS + Autocomplete + StreetView popup</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüó∫Ô∏è%3C/text%3E%3C/svg%3E"/>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.0/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/leaflet-simple-map-screenshoter"></script>

<!-- Google Maps (Places + StreetView) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places,geometry"></script>

<style>
:root{--pri:#00BFFF;--gold:#FFD700}
*{box-sizing:border-box}
html,body,#map{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial}
#map{position:absolute;inset:0}

/* search + suggest */
#searchWrap{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:1400;width:900px;max-width:94vw}
#search{width:100%;padding:12px 14px;border:1px solid #cfd4dc;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.15)}
#suggest{position:absolute;left:0;right:0;top:46px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.15);display:none;max-height:300px;overflow:auto}
.s-item{padding:10px 12px;cursor:pointer;border-bottom:1px solid #f2f2f2}
.s-item:hover{background:#f7fbff}
.s-sub{color:#6b7280;font-size:12px;margin-left:4px}

/* tools */
#tools{position:absolute;right:10px;top:72px;z-index:1200;display:flex;flex-direction:column;gap:10px}
.toolbtn{background:#fff;border:1px solid #ddd;border-radius:50%;width:48px;height:48px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.15);font-size:22px}
#btnClear{position:absolute;right:10px;top:240px;z-index:1200;background:#fff;border:1px solid #ddd;border-radius:12px;padding:8px 12px;box-shadow:0 2px 6px rgba(0,0,0,.15);cursor:pointer}

#measureMenu{position:absolute;right:70px;top:122px;background:#fff;border:1px solid #ddd;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.18);display:none;z-index:1300}
#measureMenu button{display:block;width:240px;padding:10px 14px;border:none;background:#fff;text-align:left;cursor:pointer;font-size:14px}
#measureMenu button:hover{background:#f1f5f9}

#sidebarToggle{position:absolute;left:10px;top:120px;z-index:1200;background:#fff;border:1px solid #ddd;border-radius:12px;padding:8px 12px;box-shadow:0 2px 6px rgba(0,0,0,.15);cursor:pointer}

/* sidebar TSBƒê/TSSS (gi·ªØ g·ªçn, 1 tab) */
#sidebar{position:fixed;left:0;top:0;height:100%;width:380px;background:#fff;box-shadow:4px 0 20px rgba(0,0,0,.2);transform:translateX(-400px);transition:transform .28s ease;z-index:1600;display:flex;flex-direction:column}
#sidebar.open{transform:translateX(0)}
#sbHead{background:var(--pri);color:#fff;padding:14px 16px;font-weight:700;display:flex;align-items:center;justify-content:space-between}
#sidebarClose{border:none;background:transparent;color:#fff;font-size:22px;cursor:pointer}
#sbBody{padding:12px 12px 90px;overflow:auto}
.section{border:1px solid #e5e7eb;border-radius:12px;padding:10px 10px 6px;margin-bottom:10px}
.section h4{margin:0 0 8px;font-size:14px}
.form-row{display:flex;gap:8px;margin-bottom:8px}
.form-row input,.form-row select,.form-row textarea{flex:1;padding:9px;border:1px solid #cfd4dc;border-radius:10px}
.sm{font-size:12px;color:#6b7280}

/* marker style */
.pin{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#003;font-weight:700;border:3px solid #004}
.pin.tsbd{background:var(--gold);border-color:#a06f00}
.pin.tsss{background:var(--pri);border-color:#0a4f7a;color:#fff}

/* compass overlay */
#compassOverlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:230px;height:230px;pointer-events:none;display:none;z-index:1300}
#compassCanvas{width:100%;height:100%}

.coords{position:absolute;left:10px;bottom:6px;background:rgba(255,255,255,.9);padding:4px 8px;border-radius:8px;font:12px monospace;z-index:1000}
.leaflet-popup-content{min-width:300px;max-width:360px}
@media(max-width:768px){
  #searchWrap{width:94vw}
  #sidebar{width:92vw;transform:translateX(-100vw)}
  .leaflet-popup-content{min-width:260px;max-width:320px}
  #compassOverlay{width:210px;height:210px}
}
</style>
</head>
<body>

<div id="searchWrap">
  <input id="search" placeholder="üîç ƒê·ªãa ch·ªâ / Ph∆∞·ªùng-X√£ / T√™n c≈© / T·ªça ƒë·ªô (10.79,106.66)"/>
  <div id="suggest"></div>
</div>

<div id="map"></div>

<div id="tools">
  <button id="btnCompass" class="toolbtn" title="B·∫≠t/T·∫Øt la b√†n">üß≠</button>
  <button id="btnMeasure" class="toolbtn" title="ƒêo (kho·∫£ng c√°ch/di·ªán t√≠ch)">üìè</button>
  <button id="btnGPS" class="toolbtn" title="ƒê·ªãnh v·ªã">üìç</button>
  <button id="btnShot" class="toolbtn" title="Ch·ª•p JPG">üì∏</button>
</div>

<div id="measureMenu">
  <button id="mDist">üìçüìç ƒêo kho·∫£ng c√°ch</button>
  <button id="mArea">‚¨õ ƒêo di·ªán t√≠ch</button>
  <button id="mFinish">üõë Ho√†n t·∫•t ƒëo</button>
</div>

<button id="btnClear">üßπ X√≥a t√¥ m√†u</button>

<button id="sidebarToggle">üìã TSBƒê / TSSS</button>
<div id="sidebar">
  <div id="sbHead"><span>üìã TSBƒê / TSSS</span><button id="sidebarClose">√ó</button></div>
  <div id="sbBody">
    <div class="section">
      <h4>TSBƒê</h4>
      <div class="form-row"><input id="tsbdTen" placeholder="T√™n/ƒê·ªãa ch·ªâ TSBƒê"/><input id="tsbdGia" placeholder="Gi√° (t·ª∑)" type="number"/></div>
      <div class="form-row"><input id="tsbdLat" placeholder="Lat"/><input id="tsbdLng" placeholder="Lng"/></div>
      <div class="form-row"><button id="tsbdPin">üìç ƒê·∫∑t ƒëi·ªÉm</button><button id="tsbdStreet">üëÅÔ∏è Street View</button></div>
      <div class="sm">TSBƒê hi·ªÉn th·ªã v√≤ng tr√≤n <b>v√†ng</b>.</div>
    </div>

    <div class="section">
      <h4>TSSS</h4>
      <div class="form-row"><input id="tsssTen" placeholder="T√™n/ƒê·ªãa ch·ªâ so s√°nh"/><input id="tsssGia" placeholder="Gi√° (t·ª∑)" type="number"/></div>
      <div class="form-row"><input id="tsssLat" placeholder="Lat"/><input id="tsssLng" placeholder="Lng"/></div>
      <div class="form-row"><button id="tsssAdd">‚ûï Th√™m TSSS</button><button id="tsssClear">üóëÔ∏è X√≥a TSSS</button></div>
      <div id="tsssList" class="sm">Ch∆∞a c√≥ TSSS.</div>
    </div>

    <div class="section">
      <h4>L∆∞u / T·∫£i d·ªØ li·ªáu</h4>
      <div class="form-row"><button id="btnExportCSV">üìÑ Xu·∫•t CSV</button><button id="btnExportXLSX">üìò Xu·∫•t Excel (.xlsx)</button></div>
      <div class="form-row"><button id="btnExportKML">üó∫Ô∏è T·∫°o My Map (KML)</button><button id="btnOpenMyMaps">üìÇ M·ªü My Maps</button></div>
      <div class="sm">File xu·∫•t c√≥ c·ªôt <b>Qu·∫≠n/Huy·ªán</b>. KML ƒë·ªÉ import Google My Maps.</div>
    </div>
  </div>
</div>

<div id="compassOverlay"><canvas id="compassCanvas" width="230" height="230"></canvas></div>
<div id="coords" class="coords">Lat: --, Lng: --</div>

<script>
/* ====== MAP & BASE ====== */
const map=L.map('map',{center:[10.775,106.7],zoom:12});
const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
const gSt=L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}');
const gHy=L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}');
L.control.layers({"üó∫Ô∏è OSM":osm,"üåç Google Street":gSt,"üõ∞Ô∏è Google Hybrid":gHy}).addTo(map);

const coordsEl=document.getElementById('coords');
map.on('mousemove',e=>{coordsEl.textContent=`Lat: ${e.latlng.lat.toFixed(5)}, Lng: ${e.latlng.lng.toFixed(5)}`;});

/* ====== SIDEBAR ====== */
const sidebar=document.getElementById('sidebar');
document.getElementById('sidebarToggle').onclick=()=>sidebar.classList.add('open');
document.getElementById('sidebarClose').onclick=()=>sidebar.classList.remove('open');

/* ====== ADMIN BOUNDARIES ====== */
let wardLayer=null,wardFeatures=[],coloredLayers=[],searchIndex=[];
const RAW_GEO='https://raw.githubusercontent.com/Minhcd81/HCM/main/assets/TPHCM.geojson';

fetch(RAW_GEO).then(r=>r.json()).then(geo=>{
  wardLayer=L.geoJSON(geo,{
    style:{color:'#555',weight:1,fillOpacity:.1},
    onEachFeature:(f,layer)=>{
      const p=f.properties||{};
      const ten=p.ten_xa||'', qh=p.quan_huyen||'';
      const sn=(p.sap_nhap&&p.sap_nhap!=='0')?p.sap_nhap:'‚Äî';
      const dt=(p.dtich_km2!=null)?`${p.dtich_km2} km¬≤`:'‚Äî';
      const ds=(p.dan_so!=null)?`${Number(p.dan_so).toLocaleString('vi-VN')} ng∆∞·ªùi`:'‚Äî';

      layer.bindPopup(buildWardPopup(ten,qh,sn,dt,ds, turf.centerOfMass(f).geometry.coordinates));
      layer.on('click',()=>{ colorLayer(layer); layer.openPopup(); });

      wardFeatures.push(f);
      searchIndex.push({
        key: norm(`${ten} ${p.sap_nhap||''} ${qh}`),
        ten,qh,sn,dt,ds,
        center: turf.centerOfMass(f).geometry.coordinates,
        bbox: turf.bbox(f),
        layerRef: layer
      });
    }
  }).addTo(map);
}).catch(e=>{console.error(e); alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c GeoJSON h√†nh ch√≠nh.');});

function buildWardPopup(ten,qh,sn,dt,ds,centerLngLat){
  const [lng,lat]=centerLngLat||[106.7,10.77];
  return `<b>${ten}</b><br><small>${qh}</small>
    <div style="margin-top:6px">Tr∆∞·ªõc s√°p nh·∫≠p: ${sn}<br>Di·ªán t√≠ch: ${dt}<br>D√¢n s·ªë: ${ds}</div>
    <button class="sv-btn" data-lat="${lat}" data-lng="${lng}" style="margin-top:8px">üëÅÔ∏è Street View</button>
    <div class="sv-wrap" style="margin-top:6px"></div>`;
}
function colorLayer(layer){ layer.setStyle({fillColor:randColor(),fillOpacity:.45}); if(!coloredLayers.includes(layer)) coloredLayers.push(layer); }
document.getElementById('btnClear').onclick=()=>{ coloredLayers.forEach(l=>l.setStyle({fillColor:null,fillOpacity:.1})); coloredLayers=[]; };
function randColor(){const c=['#FFD700','#FFA500','#FF4500','#8A2BE2','#1E90FF','#00CED1'];return c[(Math.random()*c.length)|0];}
function findQuanHuyen(lat,lng){
  if(!wardFeatures.length) return '';
  const pt=turf.point([lng,lat]);
  for(const f of wardFeatures){ if(turf.booleanPointInPolygon(pt,f)) return (f.properties?.quan_huyen||'').toString().trim(); }
  return '';
}

/* ====== SEARCH: Google Places + n·ªôi b·ªô + t·ªça ƒë·ªô ====== */
const searchInp=document.getElementById('search');
const suggest=document.getElementById('suggest');

function tryParseLatLng(txt){
  const t=txt.trim().replace(/\s+/g,' ').replace(/;/g,',');
  const m=t.match(/(-?\d{1,2}\.\d+)[,\s]+(-?\d{1,3}\.\d+)/);
  if(!m) return null;
  const lat=parseFloat(m[1]), lng=parseFloat(m[2]);
  if(Math.abs(lat)<=90 && Math.abs(lng)<=180) return {lat,lng};
  return null;
}

// Google Autocomplete cho ƒë·ªãa ch·ªâ
try{
  const gAC=new google.maps.places.Autocomplete(searchInp,{types:['geocode'],componentRestrictions:{country:'vn'}});
  gAC.addListener('place_changed',()=>{
    const pl=gAC.getPlace();
    if(pl && pl.geometry){
      const lat=pl.geometry.location.lat(), lng=pl.geometry.location.lng();
      dropTSMarker(lat,lng,pl.formatted_address);
      suggest.style.display='none';
    }
  });
}catch(e){console.warn('Google Places unavailable',e);}

// Autocomplete n·ªôi b·ªô (6‚Äì8)
let suggestLimit=8;
searchInp.addEventListener('input',()=>{
  const coord=tryParseLatLng(searchInp.value);
  if(coord){ suggest.style.display='none'; return; } // nh·∫≠p t·ªça ƒë·ªô: kh√¥ng show list n·ªôi b·ªô

  const q=norm(searchInp.value);
  if(q.length<3){suggest.style.display='none'; return;}
  const hits=searchIndex.filter(x=>x.key.includes(q)).slice(0,suggestLimit);
  if(hits.length===0){suggest.style.display='none';return;}
  suggest.innerHTML = hits.map(h=>`<div class="s-item" data-id="${h.key}">
      <b>${h.ten}</b> <span class="s-sub">${h.qh}</span>
      ${h.sn && h.sn!=='‚Äî'?`<div class="s-sub">T√™n c≈©: ${h.sn}</div>`:''}
    </div>`).join('');
  suggest.style.display='block';
});

// enter ‚Üí n·∫øu l√† t·ªça ƒë·ªô: ƒë·∫∑t TS marker
searchInp.addEventListener('keydown',e=>{
  if(e.key==='Enter'){
    const coord=tryParseLatLng(searchInp.value);
    if(coord){ dropTSMarker(coord.lat,coord.lng); e.preventDefault(); }
  }
});

// click g·ª£i √Ω n·ªôi b·ªô
suggest.addEventListener('click',ev=>{
  const item=ev.target.closest('.s-item'); if(!item) return;
  const h=searchIndex.find(x=>x.key===item.getAttribute('data-id')); if(!h) return;
  suggest.style.display='none';
  if(h.layerRef){ colorLayer(h.layerRef); map.fitBounds([[h.bbox[1],h.bbox[0]],[h.bbox[3],h.bbox[2]]]); h.layerRef.openPopup(); }
});

// Street View trong m·ªçi popup (event delegation)
map.on('popupopen',e=>{
  const root=e.popup.getElement();
  const btn=root.querySelector('.sv-btn');
  if(btn){
    btn.addEventListener('click',()=>{
      const lat=parseFloat(btn.getAttribute('data-lat'));
      const lng=parseFloat(btn.getAttribute('data-lng'));
      const wrap=root.querySelector('.sv-wrap');
      if(!wrap) return;
      wrap.innerHTML='<div style="width:100%;height:180px;border-radius:8px;overflow:hidden" id="svp_'+Date.now()+'"></div>';
      const div=wrap.firstChild;
      const svs=new google.maps.StreetViewService();
      const loc=new google.maps.LatLng(lat,lng);
      svs.getPanorama({location:loc,radius:50},(data,status)=>{
        if(status==='OK'&&data&&data.location){
          new google.maps.StreetViewPanorama(div,{
            pano:data.location.pano,
            pov:{heading:0,pitch:0},
            zoom:1,
            addressControl:false,
            linksControl:true,
            panControl:false,
            fullscreenControl:false
          });
        }else{
          wrap.innerHTML='<div style="padding:8px;background:#fff3cd;border:1px solid #ffeeba;border-radius:8px">‚õî Kh√¥ng c√≥ Street View g·∫ßn v·ªã tr√≠ n√†y.</div>';
        }
      });
    },{once:true});
  }
});

/* ====== TS marker (xanh d∆∞∆°ng c√≥ ch·ªØ TS) + reverse geocode ====== */
function iconTS(){return L.divIcon({className:'',html:`<div class="pin tsss">TS</div>`,iconSize:[34,34],iconAnchor:[17,17]});}
let tsMarker=null;
function dropTSMarker(lat,lng,addrText=''){
  if(tsMarker) map.removeLayer(tsMarker);
  tsMarker=L.marker([lat,lng],{icon:iconTS()}).addTo(map);
  map.setView([lat,lng],17);
  // reverse geocode n·∫øu ch∆∞a c√≥ text
  if(!addrText){
    try{
      const geocoder=new google.maps.Geocoder();
      geocoder.geocode({location:{lat,lng}},(res,st)=>{
        addrText = (st==='OK' && res && res[0]) ? res[0].formatted_address : `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        bindTsPopup(lat,lng,addrText);
      });
    }catch{ bindTsPopup(lat,lng,`${lat.toFixed(6)}, ${lng.toFixed(6)}`); }
  }else{
    bindTsPopup(lat,lng,addrText);
  }
}
function bindTsPopup(lat,lng,addr){
  const qh=findQuanHuyen(lat,lng);
  const html=`<b>${addr}</b><br><small>${qh||'‚Äî'}</small>
    <div style="margin-top:6px">
      <button class="sv-btn" data-lat="${lat}" data-lng="${lng}">üëÅÔ∏è Street View</button>
      <div class="sv-wrap" style="margin-top:6px"></div>
    </div>`;
  tsMarker.bindPopup(html).openPopup();
}

/* ====== MEASURE (kho·∫£ng c√°ch/di·ªán t√≠ch) ====== */
const drawnItems=new L.FeatureGroup().addTo(map);
let activeDraw=null;
function stopMeasure(){if(activeDraw){activeDraw.disable(); activeDraw=null;}}
document.getElementById('btnMeasure').onclick=()=>{
  const m=document.getElementById('measureMenu');
  m.style.display=(m.style.display==='block')?'none':'block';
};
document.getElementById('mDist').onclick=()=>{stopMeasure(); activeDraw=new L.Draw.Polyline(map,{shapeOptions:{color:getPrimary()}}); activeDraw.enable(); document.getElementById('measureMenu').style.display='none';};
document.getElementById('mArea').onclick=()=>{stopMeasure(); activeDraw=new L.Draw.Polygon(map,{shapeOptions:{color:getPrimary(),fillOpacity:.2}}); activeDraw.enable(); document.getElementById('measureMenu').style.display='none';};
document.getElementById('mFinish').onclick=()=>{stopMeasure(); document.getElementById('measureMenu').style.display='none';};
map.on(L.Draw.Event.CREATED, e=>{
  const layer=e.layer; drawnItems.addLayer(layer);
  if(e.layerType==='polyline'){
    const coords=layer.getLatLngs().map(ll=>[ll.lng,ll.lat]); let len=0;
    for(let i=1;i<coords.length;i++) len+=turf.distance(coords[i-1],coords[i],{units:'kilometers'});
    layer.bindPopup('Chi·ªÅu d√†i: '+(len*1000).toFixed(1)+' m').openPopup();
  }else if(e.layerType==='polygon'){
    const ring=[layer.getLatLngs()[0].map(ll=>[ll.lng,ll.lat])];
    const area=turf.area(turf.polygon([ring[0]]));
    layer.bindPopup('Di·ªán t√≠ch: '+area.toFixed(0)+' m¬≤').openPopup();
  }
});
function getPrimary(){return getComputedStyle(document.documentElement).getPropertyValue('--pri')||'#00BFFF';}

/* ====== COMPASS (mobile + web) ====== */
const compassEl=document.getElementById('compassOverlay');
const cv=document.getElementById('compassCanvas'), ctx=cv.getContext('2d');
let compassOn=false, heading=0;
document.getElementById('btnCompass').onclick=async ()=>{
  if(typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){
    try{ const perm=await DeviceOrientationEvent.requestPermission(); if(perm!=='granted') return alert('Kh√¥ng c√≥ quy·ªÅn c·∫£m bi·∫øn.'); }catch{}
  }
  compassOn=!compassOn; compassEl.style.display=compassOn?'block':'none'; if(compassOn) drawCompass();
};
window.addEventListener('deviceorientationabsolute',onOrient,true);
window.addEventListener('deviceorientation',onOrient,true);
function onOrient(e){
  if(!compassOn) return;
  let a = (typeof e.webkitCompassHeading==='number') ? e.webkitCompassHeading : (typeof e.alpha==='number'? (360 - e.alpha) : 0);
  heading = (a+360)%360; drawCompass();
}
function drawCompass(){
  const R=cv.width/2, C=R;
  ctx.clearRect(0,0,cv.width,cv.height);
  ctx.strokeStyle='rgba(0,0,0,.38)'; ctx.lineWidth=1.3;
  ctx.beginPath(); ctx.arc(C,C,R-6,0,Math.PI*2); ctx.stroke();
  for(let d=0; d<360; d+=10){
    const len=(d%30===0)?10:5, a=(d-heading)*Math.PI/180;
    const r1=R-14, r2=r1-len;
    ctx.beginPath(); ctx.moveTo(C+Math.cos(a)*r1, C+Math.sin(a)*r1);
    ctx.lineTo(C+Math.cos(a)*r2, C+Math.sin(a)*r2); ctx.stroke();
  }
  label('B',0); label('ƒê',90); label('N',180); label('T',270);
  function label(t,deg){const a=(deg-heading)*Math.PI/180, r=R-34; ctx.fillStyle='#111'; ctx.font='700 14px Segoe UI'; ctx.textAlign='center'; ctx.fillText(t, C+Math.cos(a)*r, C+Math.sin(a)*r+5);}
  ctx.save(); ctx.translate(C,C); ctx.rotate((-heading)*Math.PI/180);
  ctx.fillStyle='#d00'; ctx.beginPath(); ctx.moveTo(0,-(R-34)); ctx.lineTo(7,0); ctx.lineTo(-7,0); ctx.closePath(); ctx.fill(); ctx.restore();
}

/* ====== GPS locate ====== */
const locateCtrl=L.control.locate({strings:{title:"V·ªã tr√≠ c·ªßa t√¥i"},showCompass:true,setView:'untilPanOrZoom'});
document.getElementById('btnGPS').onclick=()=>{ if(!locateCtrl._map) locateCtrl.addTo(map); locateCtrl.start(); };

/* ====== SCREENSHOT JPG ====== */
const screenshoter=new L.simpleMapScreenshoter({hidden:true,mimeType:'image/jpeg',quality:.92,domtoimageOptions:{bgcolor:'#ffffff'}}).addTo(map);
document.getElementById('btnShot').onclick=()=>{
  screenshoter.takeScreen('blob').then(blob=>{
    const linkShot=document.createElement('a');
    linkShot.href=URL.createObjectURL(blob);
    linkShot.download=`HCM_Map_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'')}.jpg`;
    linkShot.click();
  });
};

/* ====== TSBƒê / TSSS (r√∫t g·ªçn, gi·ªØ t√≠nh nƒÉng ch√≠nh) ====== */
function iconTSBD(){return L.divIcon({className:'',html:`<div class="pin tsbd">TSBƒê</div>`,iconSize:[34,34],iconAnchor:[17,17]});}
function iconTSSS(){return L.divIcon({className:'',html:`<div class="pin tsss">TSSS</div>`,iconSize:[34,34],iconAnchor:[17,17]});}
let tsbdMarker=null; const tsssMarkers=[];
const elTSBD={ten:document.getElementById('tsbdTen'),gia:document.getElementById('tsbdGia'),lat:document.getElementById('tsbdLat'),lng:document.getElementById('tsbdLng')};
const elTSSS={ten:document.getElementById('tsssTen'),gia:document.getElementById('tsssGia'),lat:document.getElementById('tsssLat'),lng:document.getElementById('tsssLng')};

document.getElementById('tsbdPin').onclick=()=>{
  const lat=parseFloat(elTSBD.lat.value), lng=parseFloat(elTSBD.lng.value);
  if(!isFinite(lat)||!isFinite(lng)){alert('Nh·∫≠p Lat/Lng h·ª£p l·ªá cho TSBƒê');return;}
  if(tsbdMarker) map.removeLayer(tsbdMarker);
  tsbdMarker=L.marker([lat,lng],{icon:iconTSBD()}).addTo(map);
  const qh=findQuanHuyen(lat,lng);
  const html=`<b>${elTSBD.ten.value||'TSBƒê'}</b><br><small>${qh||'‚Äî'}</small>${elTSBD.gia.value?`<br>Gi√°: ${elTSBD.gia.value} t·ª∑`:''}<br><button class="sv-btn" data-lat="${lat}" data-lng="${lng}">üëÅÔ∏è Street View</button><div class="sv-wrap" style="margin-top:6px"></div>`;
  tsbdMarker.bindPopup(html).openPopup();
  map.setView([lat,lng],17);
};
document.getElementById('tsbdStreet').onclick=()=>{
  const lat=parseFloat(elTSBD.lat.value), lng=parseFloat(elTSBD.lng.value);
  if(!isFinite(lat)||!isFinite(lng)){alert('Nh·∫≠p Lat/Lng h·ª£p l·ªá cho TSBƒê');return;}
  // m·ªü tr·ª±c ti·∫øp pano (gi·ªØ cho nhanh thao t√°c)
  window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`,'_blank');
};

document.getElementById('tsssAdd').onclick=()=>{
  const lat=parseFloat(elTSSS.lat.value), lng=parseFloat(elTSSS.lng.value);
  if(!isFinite(lat)||!isFinite(lng)){alert('Nh·∫≠p Lat/Lng h·ª£p l·ªá cho TSSS');return;}
  const m=L.marker([lat,lng],{icon:iconTSSS()}).addTo(map);
  m.meta={name:elTSSS.ten.value||'TSSS',price:isFinite(+elTSSS.gia.value)?+elTSSS.gia.value:null};
  const qh=findQuanHuyen(lat,lng);
  const html=`<b>${m.meta.name}</b><br><small>${qh||'‚Äî'}</small>${m.meta.price!=null?`<br>Gi√°: ${m.meta.price} t·ª∑`:''}<br><button class="sv-btn" data-lat="${lat}" data-lng="${lng}">üëÅÔ∏è Street View</button><div class="sv-wrap" style="margin-top:6px"></div>`;
  m.bindPopup(html);
  tsssMarkers.push(m); map.setView([lat,lng],17); renderList();
};
document.getElementById('tsssClear').onclick=()=>{tsssMarkers.forEach(m=>map.removeLayer(m)); tsssMarkers.length=0; renderList();};
function renderList(){
  const box=document.getElementById('tsssList');
  if(tsssMarkers.length===0){box.textContent='Ch∆∞a c√≥ TSSS.';return;}
  box.innerHTML=tsssMarkers.map(m=>{const p=m.getLatLng();const nm=m.meta?.name||'TSSS';const pr=m.meta?.price!=null?` ‚Äî ${m.meta.price} t·ª∑`:'';return `‚Ä¢ ${nm} ‚Äî ${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}${pr}`;}).join('<br>');
}

/* ====== EXPORT ====== */
function rowsForExport(){
  if(!tsbdMarker){alert('ƒê·∫∑t ƒëi·ªÉm TSBƒê tr∆∞·ªõc khi xu·∫•t');return null;}
  const a=tsbdMarker.getLatLng(); const qhA=findQuanHuyen(a.lat,a.lng);
  const rows=[{Loai:'TSBD',Ten:elTSBD.ten.value||'TSBƒê',Lat:+a.lat.toFixed(6),Lng:+a.lng.toFixed(6),Quan_Huyen:qhA||'',Gia_ty:isFinite(+elTSBD.gia.value)?+elTSBD.gia.value:'',Khoang_cach:'',Ghi_chu:''}];
  tsssMarkers.forEach(m=>{const b=m.getLatLng(); const qhB=findQuanHuyen(b.lat,b.lng); const dkm=turf.distance([a.lng,a.lat],[b.lng,b.lat],{units:'kilometers'}); rows.push({Loai:'TSSS',Ten:m.meta?.name||'TSSS',Lat:+b.lat.toFixed(6),Lng:+b.lng.toFixed(6),Quan_Huyen:qhB||'',Gia_ty:(m.meta?.price!=null)?m.meta.price:'',Khoang_cach:`${(dkm*1000).toFixed(1)} m`,Ghi_chu:''});});
  return rows;
}
document.getElementById('btnExportCSV').onclick=()=>{
  const rows=rowsForExport(); if(!rows) return;
  const headers=['Loai','Ten','Lat','Lng','Quan_Huyen','Gia_ty','Khoang_cach','Ghi_chu'];
  const csv=[headers.join(','), ...rows.map(r=>headers.map(h=>{const v=String(r[h]??'');return /[",\n]/.test(v)?`"${v.replace(/"/g,'""')}"`:v;}).join(','))].join('\n');
  const blob=new Blob([`\uFEFF${csv}`],{type:'text/csv;charset=utf-8;'});
  const linkCSV=document.createElement('a'); linkCSV.href=URL.createObjectURL(blob);
  linkCSV.download=`TS_Export_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'')}.csv`; linkCSV.click();
};
document.getElementById('btnExportXLSX').onclick=()=>{
  const rows=rowsForExport(); if(!rows) return;
  const ws=XLSX.utils.json_to_sheet(rows); const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'DATA');
  XLSX.writeFile(wb,`TS_Export_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'')}.xlsx`);
};
document.getElementById('btnExportKML').onclick=()=>{
  if(!tsbdMarker){alert('ƒê·∫∑t ƒëi·ªÉm TSBƒê tr∆∞·ªõc khi xu·∫•t KML');return;}
  const a=tsbdMarker.getLatLng(); const qhA=findQuanHuyen(a.lat,a.lng);
  function esc(s){return String(s??'').replace(/[<&>]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));}
  function placemark(name,desc,lat,lng,style){return `<Placemark><name>${esc(name)}</name><description>${esc(desc)}</description><styleUrl>#${style}</styleUrl><Point><coordinates>${lng},${lat},0</coordinates></Point></Placemark>`;}
  let kml=`<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document>
  <name>HCM_TSBD_TSSS_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'')}</name>
  <Style id="tsbd"><IconStyle><scale>1.2</scale><Icon><href>http://maps.google.com/mapfiles/kml/paddle/ylw-circle.png</href></Icon></IconStyle></Style>
  <Style id="tsss"><IconStyle><scale>1.2</scale><Icon><href>http://maps.google.com/mapfiles/kml/paddle/blu-circle.png</href></Icon></IconStyle></Style>`;
  kml+=placemark(elTSBD.ten.value||'TSBƒê',`Qu·∫≠n/Huy·ªán: ${qhA||'‚Äî'}${elTSBD.gia.value?` | Gi√°: ${elTSBD.gia.value} t·ª∑`:''}`,a.lat,a.lng,'tsbd');
  tsssMarkers.forEach(m=>{const b=m.getLatLng(); const qh=findQuanHuyen(b.lat,b.lng);
    kml+=placemark(m.meta?.name||'TSSS',`Qu·∫≠n/Huy·ªán: ${qh||'‚Äî'}${m.meta?.price!=null?` | Gi√°: ${m.meta.price} t·ª∑`:''}`,b.lat,b.lng,'tsss');
  });
  kml+='</Document></kml>';
  const blob=new Blob([kml],{type:'application/vnd.google-earth.kml+xml'});
  const linkKML=document.createElement('a'); linkKML.href=URL.createObjectURL(blob);
  linkKML.download=`HCM_TSBD_TSSS_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'')}.kml`; linkKML.click();
};
document.getElementById('btnOpenMyMaps').onclick=()=>window.open('https://www.google.com/mymaps','_blank');

/* ====== helpers ====== */
function norm(str){return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/ƒë/g,'d').replace(/[^a-z0-9\s]/g,'').replace(/\s+/g,' ').trim();}
</script>
</body>
</html>

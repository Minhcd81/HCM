<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>B·∫£n ƒë·ªì TP.HCM - Final Fix (GoogleMutant + EasyPrint)</title>

<!-- üó∫Ô∏è Leaflet core -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- ‚úÖ Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places"></script>

<!-- ‚úÖ Leaflet.GoogleMutant (ƒë∆∞·ªùng d·∫´n ·ªïn ƒë·ªãnh, kh√¥ng l·ªói 404) -->
<script src="https://cdn.jsdelivr.net/npm/leaflet.gridlayer.googlemutant@0.12.0/Leaflet.GoogleMutant.min.js"></script>

<!-- üß© Plugins kh√°c -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.css"/>
<script src="https://unpkg.com/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.css"/>
<script src="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-easybutton@2.4.0/src/easy-button.css"/>
<script src="https://unpkg.com/leaflet-easybutton@2.4.0/src/easy-button.js"></script>

<!-- ‚úÖ EasyPrint b·∫£n ho·∫°t ƒë·ªông -->
<script src="https://cdn.jsdelivr.net/npm/leaflet-easyprint@2.1.9/dist/leaflet.easyPrint.js"></script>

<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<style>
  html, body, #map { height: 100%; margin: 0; }
  .legend {
    position: absolute;
    bottom: 10px;
    left: 10px;
    background: rgba(255,255,255,0.9);
    padding: 8px 12px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    font-size: 13px;
  }
</style>
</head>

<body>
<div id="map"></div>

<script>
// ===== 1Ô∏è‚É£ Kh·ªüi t·∫°o b·∫£n ƒë·ªì =====
const map = L.map("map", { center: [10.77, 106.7], zoom: 11 });

// ---- Google base maps ----
const roadmap = L.gridLayer.googleMutant({ type: "roadmap" });
const satellite = L.gridLayer.googleMutant({ type: "satellite" });
const hybrid = L.gridLayer.googleMutant({ type: "hybrid" });
roadmap.addTo(map);

const baseMaps = {
  "Google ƒê∆∞·ªùng ph·ªë": roadmap,
  "Google V·ªá tinh": satellite,
  "Google K·∫øt h·ª£p": hybrid
};

// ===== 2Ô∏è‚É£ C√¥ng c·ª• =====
L.control.layers(baseMaps, null, { collapsed: true, position: "topright" }).addTo(map);
L.control.locate({ position: "topleft", strings: { title: "ƒê·ªãnh v·ªã GPS" } }).addTo(map);
L.Control.geocoder({ position: "topleft", placeholder: "T√¨m ki·∫øm ƒë·ªãa ch·ªâ..." }).addTo(map);
L.control.scale({ metric: true }).addTo(map);

// ===== 3Ô∏è‚É£ ƒêo, v·∫Ω, in =====
L.control.measure({ position: "topleft", primaryLengthUnit: "meters", primaryAreaUnit: "sqmeters" }).addTo(map);
const drawnItems = new L.FeatureGroup().addTo(map);
new L.Control.Draw({
  edit: { featureGroup: drawnItems },
  draw: { polygon: true, rectangle: true, polyline: true, circle: true, marker: true }
}).addTo(map);
map.on(L.Draw.Event.CREATED, e => drawnItems.addLayer(e.layer));

L.easyPrint({
  title: "In b·∫£n ƒë·ªì",
  position: "topleft",
  filename: "ban_do_HCM"
}).addTo(map);

// ===== 4Ô∏è‚É£ Hi·ªÉn th·ªã shapefile =====
let currentLayer = null;
function styleDefault() { return { color: "#2262CC", weight: 1.2, fillOpacity: 0.05 }; }
function styleHighlight() { return { color: "#0B5ED7", weight: 3, fillColor: "#FFD43B", fillOpacity: 0.5 }; }

function popupContent(p) {
  const dan_so = p.dan_so ? p.dan_so.toLocaleString("vi-VN") : "‚Äì";
  const matdo = p.matdo_km2 ? p.matdo_km2.toLocaleString("vi-VN") : "‚Äì";
  const dtich = p.dtich_km2 || "‚Äì";
  return `<b>${p.loai || ""} ${p.ten_xa || ""}</b><br>
          T·ªânh/TP: ${p.ten_tinh || "TP. H·ªì Ch√≠ Minh"}<br>
          D√¢n s·ªë: ${dan_so} ng∆∞·ªùi<br>
          Di·ªán t√≠ch: ${dtich} km¬≤<br>
          M·∫≠t ƒë·ªô: ${matdo} ng∆∞·ªùi/km¬≤<br>
          Tr·ª• s·ªü: ${p.tru_so || "‚Äì"}<br>
          M√£ h√†nh ch√≠nh: ${p.ma_xa || "‚Äì"}`;
}

(async function() {
  try {
    const geojson = await shp("assets/hcm_admin_shp.zip");
    const layer = L.geoJSON(geojson, {
      style: styleDefault,
      onEachFeature: (f, l) => {
        const p = f.properties;
        const centroid = turf.centroid(f).geometry.coordinates;
        l.on("click", () => {
          if (currentLayer) layer.resetStyle(currentLayer);
          currentLayer = l;
          l.setStyle(styleHighlight());
          L.popup({ maxWidth: 300 })
            .setLatLng([centroid[1], centroid[0]])
            .setContent(popupContent(p))
            .openOn(map);
        });
        l.bindTooltip(`${p.loai || ""} ${p.ten_xa || ""}`);
      }
    }).addTo(map);
    map.fitBounds(layer.getBounds());
  } catch (e) {
    console.error("Kh√¥ng t·∫£i ƒë∆∞·ª£c shapefile:", e);
  }
})();

// ===== 5Ô∏è‚É£ N√∫t t·∫£i GeoJSON v√† X√≥a =====
L.easyButton("üíæ", () => {
  const data = drawnItems.toGeoJSON();
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "drawn_features.geojson";
  a.click();
}, "T·∫£i GeoJSON ƒë√£ v·∫Ω").addTo(map);

L.easyButton("üóëÔ∏è", () => {
  drawnItems.clearLayers();
  alert("ƒê√£ x√≥a to√†n b·ªô ƒë·ªëi t∆∞·ª£ng ƒë√£ v·∫Ω!");
}, "X√≥a t·∫•t c·∫£").addTo(map);

// ===== 6Ô∏è‚É£ Legend =====
L.control({ position: "bottomleft" }).onAdd = function() {
  const div = L.DomUtil.create("div", "legend");
  div.innerHTML = `
    <b>Ch√∫ gi·∫£i</b><br>
    <span style="display:inline-block;width:14px;height:14px;background:#2262CC;border:1px solid #2262CC;margin-right:4px"></span> ƒê·ªãa gi·ªõi<br>
    <span style="display:inline-block;width:14px;height:14px;background:#FFD43B;border:1px solid #0B5ED7;margin-right:4px"></span> Khi ch·ªçn<br>
    <b>C√¥ng c·ª•:</b> V·∫Ω, ƒëo, in, t·∫£i GeoJSON, x√≥a ƒë·ªëi t∆∞·ª£ng
  `;
  return div;
}.addTo(map);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WebGIS ‚Äî Search t√¥ m√†u Ph∆∞·ªùng/X√£ (34 t·ªânh)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<!-- GI·ªÆ NGUY√äN API KEY C·ª¶A ANH -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places,geometry"></script>

<style>
html,body,#map{height:100%;margin:0}
body{font-family:system-ui,Segoe UI,Roboto,Arial}
#searchbar{position:absolute;left:50%;top:12px;transform:translateX(-50%);z-index:1200;width:860px;max-width:94vw}
#q{width:100%;padding:12px 14px;border:1px solid #cfd4dc;border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.15)}
#tools{position:absolute;right:12px;top:74px;z-index:1200;display:flex;flex-direction:column;gap:10px}
.tool{width:46px;height:46px;border-radius:50%;background:#fff;border:1px solid #ddd;box-shadow:0 2px 8px rgba(0,0,0,.2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px}
#map .leaflet-popup-content{min-width:270px}
.badge{display:inline-block;padding:2px 6px;border-radius:6px;background:#eef4ff;border:1px solid #d7e3ff;color:#2051d8;font-size:12px;margin-left:6px}
.coords{position:absolute;left:8px;bottom:6px;background:rgba(255,255,255,.9);padding:4px 8px;border-radius:8px;font:12px monospace;z-index:1000}
@media(max-width:640px){#searchbar{top:10px} .tool{width:44px;height:44px}}
</style>
</head>
<body>
<div id="searchbar">
  <input id="q" placeholder="üîç ƒê·ªãa ch·ªâ / ph∆∞·ªùng (t√™n c≈© c≈©ng ƒë∆∞·ª£c) / t·ªça ƒë·ªô (vd: 10.79844, 106.65855)" autocomplete="off">
</div>

<div id="tools">
  <div class="tool" id="btnClear" title="X√≥a t√¥ m√†u">üßπ</div>
  <div class="tool" id="btnGPS"   title="ƒê·ªãnh v·ªã">üìç</div>
  <div class="tool" id="btnEye"   title="Xem Street View (v·ªã tr√≠ hi·ªán t·∫°i)">üëÅÔ∏è</div>
</div>

<div id="map"></div>
<div class="coords" id="coords">Lat: ‚Äî, Lng: ‚Äî</div>

<script>
// ============= MAP =============
const map=L.map('map',{center:[10.77,106.67],zoom:12});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19,attribution:'¬© OpenStreetMap'
}).addTo(map);

let placeMarker=null, wardLayer=null;
const geoCache={}; // slug -> GeoJSON

map.on('mousemove',e=>{
  document.getElementById('coords').textContent=`Lat:${e.latlng.lat.toFixed(5)}, Lng:${e.latlng.lng.toFixed(5)}`;
});

// ============= SLUG 34 T·ªàNH (ƒë·∫∑t theo t√™n file trong /assets) =============
const SLUG = {
 'TP H√† N·ªôi':'hanoi','H√† N·ªôi':'hanoi','Ha Noi':'hanoi',
 'TP.HCM':'hcm','Th√†nh ph·ªë H·ªì Ch√≠ Minh':'hcm','Ho Chi Minh City':'hcm',
 'ƒê√† N·∫µng':'danang','Da Nang':'danang',
 'Th·ª´a Thi√™n Hu·∫ø':'hue','TP Hu·∫ø':'hue','Hue':'hue',
 'H·∫£i Ph√≤ng':'haiphong','Hai Phong':'haiphong',
 'An Giang':'angiang','B·∫Øc Ninh':'bacninh','L√¢m ƒê·ªìng':'lamdong','C√† Mau':'camau','C·∫ßn Th∆°':'cantho','Cao B·∫±ng':'caobang',
 'ƒê·∫Øk L·∫Øk':'daklak','ƒêi·ªán Bi√™n':'dienbien','ƒê·ªìng Nai':'dongnai','ƒê·ªìng Th√°p':'dongthap','Gia Lai':'gialai',
 'H√† Tƒ©nh':'hatinh','H∆∞ng Y√™n':'hungyen','Kh√°nh H√≤a':'khanhhoa','Lai Ch√¢u':'laichau','L·∫°ng S∆°n':'langson','L√†o Cai':'laocai',
 'Ngh·ªá An':'nghean','Ninh B√¨nh':'ninhbinh','Ph√∫ Th·ªç':'phutho','Qu·∫£ng Ng√£i':'quangngai','Qu·∫£ng Ninh':'quangninh','Qu·∫£ng Tr·ªã':'quangtri',
 'S∆°n La':'sonla','T√¢y Ninh':'tayninh','Th√°i Nguy√™n':'thainguyen','Thanh H√≥a':'thanhhoa','Tuy√™n Quang':'tuyenquang','Vƒ©nh Long':'vinhlong'
};

// ============= GOOGLE AUTOCOMPLETE =============
const input=document.getElementById('q');
const ac=new google.maps.places.Autocomplete(input,{
  fields:['geometry','formatted_address','address_components','name'],
  componentRestrictions:{country:'vn'}
});
ac.addListener('place_changed', async ()=>{
  const pl=ac.getPlace();
  if(!pl || !pl.geometry){
    const ll=parseLatLng(input.value);
    if(ll){ goto(ll.lat,ll.lng,true); return; }
    alert('Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c v·ªã tr√≠.'); return;
  }
  const lat=pl.geometry.location.lat(), lng=pl.geometry.location.lng();
  goto(lat,lng,true, pl);
});

// Nh·∫≠p "lat, lng"
function parseLatLng(txt){
  const m=txt.trim().match(/(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)/);
  if(!m) return null;
  const lat=parseFloat(m[1]), lng=parseFloat(m[2]);
  if(isFinite(lat)&&isFinite(lng)) return {lat,lng};
  return null;
}

// ============= MOVE & COLOR =============
async function goto(lat,lng, openPopup=false, placeObj=null){
  map.setView([lat,lng], 17);
  if(placeMarker) map.removeLayer(placeMarker);
  placeMarker=L.marker([lat,lng]).addTo(map);

  // popup c∆° b·∫£n + n√∫t üëÅÔ∏è (nh·∫•n m·ªõi m·ªü)
  const addr=(placeObj && placeObj.formatted_address) ? placeObj.formatted_address : `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
  placeMarker.bindPopup(`
    <b>${addr}</b>
    <div style="margin-top:6px"><button onclick="openSV(${lat},${lng})">üëÅÔ∏è Xem Street View</button></div>
  `);
  if(openPopup) placeMarker.openPopup();

  // x√°c ƒë·ªãnh t·ªânh t·ª´ address_components
  let pName=null;
  if(placeObj && placeObj.address_components){
    const f=placeObj.address_components.find(c=>c.types.includes('administrative_area_level_1'));
    if(f) pName=f.long_name;
  }
  if(!pName){
    // fallback reverse geocode (nhanh)
    try{
      const g=new google.maps.Geocoder();
      g.geocode({location:{lat,lng}},(res,st)=>{
        if(st==='OK'&&res?.[0]){
          const c=res[0].address_components||[];
          const f=c.find(x=>x.types.includes('administrative_area_level_1'));
          highlightByProvince(f?.long_name||null);
        } else highlightByProvince(null);
      });
    }catch(e){ highlightByProvince(null); }
  }else{
    highlightByProvince(pName);
  }
}

// t√¥ ph∆∞·ªùng n·∫øu c√≥ geojson c·ªßa t·ªânh
async function highlightByProvince(provinceName){
  if(!provinceName) return;
  const slug = SLUG[provinceName] || SLUG[provinceName.replace('Th√†nh ph·ªë ','TP ')];
  if(!slug) return;

  try{
    const gj=await getGeo(slug);
    const {lat,lng}=placeMarker.getLatLng();
    const pt=turf.point([lng,lat]);

    let found=null;
    for(const f of gj.features){
      if(!f || !f.geometry) continue;
      if(turf.booleanPointInPolygon(pt,f)){ found=f; break; }
    }
    if(!found) return;

    if(wardLayer) map.removeLayer(wardLayer);
    wardLayer=L.geoJSON(found,{style:{color:'#ff6b00',weight:2,fillColor:'#ffd9a6',fillOpacity:.45}}).addTo(map);

    const p=found.properties||{};
    const xa = p.ten_xa || p.xa || p.NAME_3 || '‚Äî';
    const qh = p.quan_huyen || p.NAME_2 || '‚Äî';
    const tinh = p.tinh || p.NAME_1 || provinceName || '‚Äî';
    const dt = p.dtich_km2 ? `${(+p.dtich_km2).toLocaleString('vi-VN')} km¬≤` : (p.area ? p.area+' km¬≤' : '‚Äî');
    const ds = p.dan_so ? `${(+p.dan_so).toLocaleString('vi-VN')} ng∆∞·ªùi` : '‚Äî';
    const sn = p.sap_nhap || p.ten_cu || '';

    const ll=placeMarker.getLatLng();
    const html=`
      <div>
        <div style="font-weight:700">${xa} <span class="badge">${tinh}</span></div>
        <div>${qh}</div>
        <div>Di·ªán t√≠ch: ${dt} ‚Ä¢ D√¢n s·ªë: ${ds}</div>
        ${sn?`<div>Tr∆∞·ªõc s√°p nh·∫≠p: ${sn}</div>`:''}
        <div style="margin-top:6px"><button onclick="openSV(${ll.lat},${ll.lng})">üëÅÔ∏è Xem Street View t·∫°i v·ªã tr√≠ n√†y</button></div>
      </div>`;
    L.popup({offset:[0,-6]}).setLatLng(ll).setContent(html).openOn(map);

  }catch(e){
    // kh√¥ng c√≥ file t·ªânh -> b·ªè qua
  }
}

async function getGeo(slug){
  if(geoCache[slug]) return geoCache[slug];
  const res=await fetch(`assets/${slug}.geojson`);
  if(!res.ok) throw new Error('missing geojson');
  const gj=await res.json(); geoCache[slug]=gj; return gj;
}

// ============= TOOLS =============
document.getElementById('btnClear').onclick=()=>{ if(wardLayer){map.removeLayer(wardLayer);wardLayer=null;} };
document.getElementById('btnGPS').onclick=()=>{
  map.locate({setView:true,maxZoom:17});
  map.once('locationfound',e=>goto(e.latlng.lat,e.latlng.lng,true));
};
document.getElementById('btnEye').onclick=()=>{
  if(!placeMarker){alert('Ch∆∞a c√≥ v·ªã tr√≠. T√¨m ƒë·ªãa ch·ªâ/to·∫° ƒë·ªô tr∆∞·ªõc.');return;}
  const {lat,lng}=placeMarker.getLatLng(); openSV(lat,lng);
};

// street view (ch·ªâ hi·ªán khi b·∫•m üëÅÔ∏è)
window.openSV=(lat,lng)=>{
  const html=`<iframe style="width:340px;max-width:86vw;height:200px;border:0;border-radius:8px"
      src="https://www.google.com/maps?q=&layer=c&cbll=${lat},${lng}&cbp=11,0,0,0,0&z=18" allowfullscreen></iframe>`;
  L.popup().setLatLng([lat,lng]).setContent(html).openOn(map);
};
</script>
</body>
</html>

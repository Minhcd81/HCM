<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HCM WebGIS ‚Äî Street View iFrame + Esri + Google</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-compass/dist/leaflet-compass.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.js"></script>
<script src="https://unpkg.com/leaflet-compass/dist/leaflet-compass.min.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<style>
  html,body,#map{height:100%;margin:0}
  #searchbar{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:1400;width:520px}
  #q{width:100%;padding:10px 12px;border:1px solid #bbb;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.15)}
  .coords{position:absolute;left:10px;bottom:6px;background:rgba(255,255,255,.9);padding:4px 8px;border-radius:6px;font:12px monospace;z-index:1000}
  .leaflet-bar button{display:block;width:100%;border:none;background:#fff;padding:8px;cursor:pointer}
  .leaflet-bar button:hover{background:#eee}
  #legend{position:absolute;right:10px;bottom:10px;background:#fff;padding:8px 10px;border-radius:8px;font-size:12px;box-shadow:0 2px 6px rgba(0,0,0,.2)}
  #legend i{display:inline-block;width:14px;height:14px;margin-right:6px;vertical-align:middle}
</style>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&libraries=places,geometry"></script>
</head>
<body>
<div id="searchbar"><input id="q" placeholder="üîç ƒê·ªãa ch·ªâ, ph∆∞·ªùng/x√£, ho·∫∑c nh·∫≠p t·ªça ƒë·ªô: 10.79844, 106.65855"></div>
<div id="map"></div>
<div id="legend">
  <b>Ch√∫ gi·∫£i lo·∫°i ƒë·∫•t</b><br>
  <i style="background:#e41a1c"></i> ƒê·∫•t ·ªü (ODT/ONT) &nbsp;
  <i style="background:#4daf4a"></i> C√¢y xanh (CX) &nbsp;
  <i style="background:#999"></i> Giao th√¥ng (DGT) &nbsp;
  <i style="background:#ffcc00"></i> C√¥ng c·ªông (CC) &nbsp;
  <i style="background:#6baed6"></i> M·∫∑t n∆∞·ªõc (MN)
</div>
<div class="coords" id="coords">Lat: --, Lng: --</div>
<script>
const map=L.map('map',{center:[10.776,106.7],zoom:12});
const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
const esriStreet=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',{attribution:'¬© Esri'});
const esriImagery=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'¬© Esri Imagery'});
const esriTopo=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',{attribution:'¬© Esri Topo'});
const gStreet=L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA',{attribution:'¬© Google'});
const gHybrid=L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}&key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA',{attribution:'¬© Google'});
L.control.layers({"üó∫Ô∏è OSM":osm,"üó∫Ô∏è Esri Street":esriStreet,"üõ∞Ô∏è Esri Imagery":esriImagery,"üó∫Ô∏è Esri Topo":esriTopo,"üåç Google Street":gStreet,"üõ∞Ô∏è Google Hybrid":gHybrid},{},{collapsed:true}).addTo(map);

function colorBy(code){const lut={"ODT":"#e41a1c","ONT":"#e41a1c","CX":"#4daf4a","DGT":"#999","CC":"#ffcc00","MN":"#6baed6","HTKT":"#984ea3","TG":"#fdb462"};for(const k in lut){if(code&&code.includes(k))return lut[k];}return"#ccc";}
const hanhChinh=L.layerGroup().addTo(map),quyHoach=L.layerGroup().addTo(map);
let coloredLayers=[];
fetch('assets/TPHCM.geojson').then(r=>r.json()).then(geo=>{
  const layer=L.geoJSON(geo,{style:{color:"#ff6600",weight:1,fillOpacity:.1},onEachFeature:(f,l)=>{
    const p=f.properties||{};l.bindPopup(`<b>${p.ten_xa||''}</b><br>${p.quan_huyen||''}<br>${(p.dtich_km2||'-')} km¬≤<br>${p.dan_so? p.dan_so.toLocaleString()+' ng∆∞·ªùi':'-'}`);
    l.on('click',()=>{l.setStyle({fillColor:"#ff79c6",fillOpacity:.45});if(!coloredLayers.includes(l))coloredLayers.push(l);});
  }});hanhChinh.addLayer(layer);
});
fetch('assets/QHPKSDD_SHAPE.json').then(r=>r.json()).then(geo=>{
  const layer=L.geoJSON(geo,{style:f=>({color:"#666",weight:.4,fillColor:colorBy(f.properties?.MaQuyUoc),fillOpacity:.5}),onEachFeature:(f,l)=>l.bindPopup(`<b>${f.properties?.MaQuyUoc||''}</b> - ${f.properties?.TenLoaiDat||''}`)});quyHoach.addLayer(layer);
});
L.control.locate({strings:{title:"ƒê·ªãnh v·ªã GPS"}}).addTo(map);
L.control.measure({primaryLengthUnit:'meters',primaryAreaUnit:'sqmeters'}).addTo(map);
L.control.compass({autoActive:true,position:'topright'}).addTo(map);
const panel=L.control({position:'topright'});panel.onAdd=function(){const d=L.DomUtil.create('div','leaflet-bar');d.innerHTML=`<button id="btnClear">üßπ X√≥a t√¥ m√†u</button>`;return d;};panel.addTo(map);
document.addEventListener('click',e=>{if(e.target&&e.target.id==='btnClear'){coloredLayers.forEach(l=>l.setStyle({fillColor:null,fillOpacity:.1}));coloredLayers=[];}});

const qInp=document.getElementById('q');const ac=new google.maps.places.Autocomplete(qInp,{componentRestrictions:{country:"vn"}});
let lastMarker=null;
function flyAndMark(lat,lng,label){map.setView([lat,lng],17);if(lastMarker)map.removeLayer(lastMarker);lastMarker=L.marker([lat,lng]).addTo(map).bindPopup(`<b>${label||''}</b><br><button id="svbtn">Xem Street View t·∫°i v·ªã tr√≠ n√†y</button>`).openPopup();setTimeout(()=>{const btn=document.getElementById('svbtn');if(btn){btn.onclick=()=>openStreetViewIframe(lat,lng);}},60);}
ac.addListener("place_changed",()=>{const p=ac.getPlace();if(!p.geometry)return;flyAndMark(p.geometry.location.lat(),p.geometry.location.lng(),p.formatted_address||p.name);});
qInp.addEventListener('keydown',ev=>{if(ev.key!=="Enter")return;const m=qInp.value.trim().match(/^(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)/);if(m){const lat=parseFloat(m[1]),lng=parseFloat(m[2]);flyAndMark(lat,lng,`T·ªça ƒë·ªô: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);}});

function openStreetViewIframe(lat,lng,heading){const h=(typeof heading==='number'?heading:0).toFixed(0);const url=`https://www.google.com/maps?layer=c&cbll=${lat},${lng}&cbp=12,${h},0,0,0`;const html=`<iframe src="${url}" width="350" height="250" style="border:0" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>`;L.popup({maxWidth:380}).setLatLng([lat,lng]).setContent(html).openOn(map);}
map.on('contextmenu',e=>openStreetViewIframe(e.latlng.lat,e.latlng.lng));
map.on('mousemove',e=>document.getElementById('coords').textContent=`Lat:${e.latlng.lat.toFixed(5)}, Lng:${e.latlng.lng.toFixed(5)}`);
</script>
</body>
</html>
